<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0">
<meta name="author" content="Tigase Team">
<title>Tigase Development Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Tigase Development Guide</h1>
<div class="details">
<span id="author" class="author">Tigase Team</span><br>
<span id="email" class="email"><a href="mailto:team@tigase.com">team@tigase.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_tests">1. Tests</a>
<ul class="sectlevel2">
<li><a href="#_tests_2">1.1. Tests</a></li>
</ul>
</li>
<li><a href="#_tigase_db_schema_explained">2. Tigase DB Schema Explained</a></li>
<li><a href="#_basic_information">3. Basic Information</a>
<ul class="sectlevel2">
<li><a href="#_tigase_server_elements">3.1. Tigase Server Elements</a></li>
<li><a href="#_connector">3.2. Connector</a></li>
</ul>
</li>
<li><a href="#_why_the_most_recent_jdk">4. Why the most recent JDK?</a></li>
<li><a href="#_hack_tigase_jabber_xmpp_server_in_eclipse">5. Hack Tigase Jabber/XMPP Server in Eclipse</a>
<ul class="sectlevel2">
<li><a href="#_jdk_1_6_0_setup">5.1. JDK-1.6.0 Setup</a></li>
<li><a href="#_subclipse_installation">5.2. Subclipse Installation</a></li>
<li><a href="#_project_import">5.3. Project Import</a></li>
</ul>
</li>
<li><a href="#_api_changes_in_the_tigase_server_5_x">6. API changes in the Tigase Server 5.x</a></li>
<li><a href="#_server_compilation">7. Server Compilation</a></li>
<li><a href="#_tigase_xmpp_server_5_2_0_and_later_compilation_and_generating_distribution_packages">8. Tigase XMPP Server 5.2.0 and later - Compilation and Generating Distribution Packages</a>
<ul class="sectlevel2">
<li><a href="#_distribution_packages">8.1. Distribution Packages</a></li>
<li><a href="#_building_server_and_generating_packages">8.2. Building Server and Generating Packages</a></li>
<li><a href="#_running_server">8.3. Running Server</a></li>
</ul>
</li>
<li><a href="#scv4ol">9. Tigase Packages Dependency Change - Server Compilation Version 4.x or Later</a></li>
<li><a href="#scv23">10. Server Compilation - version 2.x and 3.x</a></li>
<li><a href="#maven2support">11. Maven 2.x Support</a></li>
<li><a href="#mavenguide">12. A Very Short Maven Guide</a>
<ul class="sectlevel2">
<li><a href="#_snapshot_compilation_and_snapshot_package_generation">12.1. Snapshot Compilation and Snapshot Package Generation</a></li>
<li><a href="#_release_compilation_generation">12.2. Release Compilation, Generation</a></li>
<li><a href="#_generating_tar_gz_tar_bz2_file_with_sources_only">12.3. Generating tar.gz, tar.bz2 File With Sources Only</a></li>
</ul>
</li>
<li><a href="#_generating_tigase_installer">13. Generating Tigase Installer</a></li>
<li><a href="#_plugin_development">14. Plugin Development</a></li>
<li><a href="#saslcmac">15. SASL Custom Mechanisms and Configuration</a>
<ul class="sectlevel2">
<li><a href="#_basic_sasl_configuration">15.1. Basic SASL Configuration</a></li>
<li><a href="#_logging_authentication">15.2. Logging/Authentication</a></li>
<li><a href="#cmd">15.3. Custom Mechanisms Development</a></li>
</ul>
</li>
<li><a href="#How_Packets_are_Processed_by_the_SM_and_Plugins">16. How Packets are Processed by the SM and Plugins</a>
<ul class="sectlevel2">
<li><a href="#_introduction">16.1. Introduction</a></li>
</ul>
</li>
<li><a href="#wpc">17. Writing Plugin Code</a>
<ul class="sectlevel2">
<li><a href="#_using_annotation_support">17.1. Using annotation support</a></li>
<li><a href="#_using_older_non_annotation_based_implementation">17.2. Using older non-annotation based implementation</a></li>
<li><a href="#_implementation_of_processing_method">17.3. Implementation of processing method</a></li>
</ul>
</li>
<li><a href="#pluginconf">18. Plugin Configuration</a></li>
<li><a href="#componentdevelpoment">19. Component Development</a></li>
<li><a href="#cil1">20. Component Implementation - Lesson 1 - Basics</a></li>
<li><a href="#cil2">21. Component Implementation - Lesson 2 - Configuration</a></li>
<li><a href="#cil3">22. Component Implementation - Lesson 3 - Multi-Threading</a></li>
<li><a href="#cil4">23. Component Implementation - Lesson 4 - Service Discovery</a></li>
<li><a href="#cil5">24. Component Implementation - Lesson 5 - Statistics</a></li>
<li><a href="#cil6">25. Component Implementation - Lesson 6 - Scripting Support</a>
<ul class="sectlevel2">
<li><a href="#ConfigurationAPI">25.1. Configuration API</a></li>
</ul>
</li>
<li><a href="#packetfiltering">26. Packet Filtering in Component</a>
<ul class="sectlevel2">
<li><a href="#_the_packet_filter_api">26.1. The Packet Filter API</a></li>
<li><a href="#_configuration">26.2. Configuration</a></li>
</ul>
</li>
<li><a href="#cil8">27. Component Implementation - Lesson 8 - Startup Time</a></li>
<li><a href="#cil7">28. Component Implementation - Lesson 7 - Data Repository</a></li>
<li><a href="#apiVirtualDomain">29. API Description for Virtual Domains Management in the Tigase Server</a></li>
<li><a href="#_experimental">30. Experimental</a>
<ul class="sectlevel2">
<li><a href="#DynamicRosters">30.1. Dynamic Rosters</a></li>
</ul>
</li>
<li><a href="#mobileoptimizations">31. Mobile Optimizations</a>
<ul class="sectlevel2">
<li><a href="#_problem_description_2">31.1. Problem Description</a></li>
<li><a href="#_solution">31.2. Solution</a></li>
<li><a href="#_queueing_algorithms">31.3. Queueing Algorithms</a></li>
<li><a href="#_configuration_3">31.4. Configuration</a></li>
</ul>
</li>
<li><a href="#boshsessioncache">32. Bosh Session Cache</a>
<ul class="sectlevel2">
<li><a href="#_problem_description_3">32.1. Problem Description</a></li>
<li><a href="#_bosh_session_cache_description">32.2. Bosh Session Cache Description</a></li>
<li><a href="#_cache_protocol">32.3. Cache Protocol</a></li>
</ul>
</li>
<li><a href="#_tigase_test_suite">33. Tigase Test Suite</a></li>
<li><a href="#_test_suite_scripting_language">34. Test Suite Scripting Language</a></li>
<li><a href="#_writing_tests_for_plugins">35. Writing Tests for Plugins</a></li>
<li><a href="#_test_case_parameters_description">36. Test Case Parameters Description</a>
<ul class="sectlevel2">
<li><a href="#_test_report_configuration">36.1. Test Report Configuration</a></li>
<li><a href="#_basic_test_parameters">36.2. Basic Test Parameters</a></li>
<li><a href="#_test_case_parameters">36.3. Test Case Parameters</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_tests"><a class="anchor" href="#_tests"></a>1. Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mateusz Fiolka
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="sect2">
<h3 id="_tests_2"><a class="anchor" href="#_tests_2"></a>1.1. Tests</h3>
<div class="paragraph">
<p>Tests are very important part of Tigase server development process.</p>
</div>
<div class="paragraph">
<p>Each release goes through fully automated testing process. All server functions are considered implemented only when they pass testing cycle. Tigase test suite is used for all our automatic tests which allows to define different test scenarios.</p>
</div>
<div class="paragraph">
<p>There is no tweaking on databases for tests. All databases are installed in standard way and run with default settings. Database is cleared each time before test cycle starts.</p>
</div>
<div class="paragraph">
<p>There are no modifications to Tigase configuration file as well. All tests are performed on default configuration generated by configuration wizards.</p>
</div>
<div class="paragraph">
<p>The server is tested in all supported environments:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>XMLDB</strong> - tests with built-in simple XML database. This is simple and efficient solution for small installations. I recommend it for services with up to 100 user accounts although it was successfully tested with 10,000 user accounts.</p>
</li>
<li>
<p><strong>MySQL</strong> - tests with <a href="http://www.mysql.com/">MySQL</a> database. Much slower than XMLDB but may handle much more user accounts.</p>
</li>
<li>
<p><strong>PostgreSQL</strong> - tests with <a href="http://www.postgresql.org/">PostgreSQL</a> database. Again it is much slower than XMLDB but may handle much more user accounts. This is basically exactly the same code as for MySQL database (SQL Connector) but tests are executed to make sure the code is compatible with all supported SQL databases and to compare performance.</p>
</li>
<li>
<p><strong>Distributed</strong> - is test for distributed installation where c2s and s2s components run on separated machine which connects using external component protocol (<a href="http://www.xmpp.org/extensions/xep-0114.html">XEP-0114</a>) to another machine with SessionManager running.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_functional_tests"><a class="anchor" href="#_functional_tests"></a>1.1.1. Functional Tests</h4>
<div class="paragraph">
<p>Basic checking if all the functions work at correctly. These tests are performed every time the code is sent to source repository.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PGSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.2-b889</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/func/xmldb/functional-tests.html">00:00:12</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/func/mysql/functional-tests.html">00:00:17</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/func/pgsql/functional-tests.html">00:00:17</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.2-b880</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/func/xmldb/functional-tests.html">00:00:13</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/func/mysql/functional-tests.html">00:00:15</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/func/pgsql/functional-tests.html">00:00:15</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.2-b700</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/func/xmldb/functional-tests.html">00:00:22</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/func/mysql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/func/pgsql/functional-tests.html">00:00:25</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/func/sm-mysql/functional-tests.html">00:00:25</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.5-b606</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/func/xmldb/functional-tests.html">00:00:22</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/func/mysql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/func/pgsql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/func/sm-mysql/functional-tests.html">00:00:24</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.3-b548</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/func/xmldb/functional-tests.html">00:00:22</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/func/mysql/functional-tests.html">00:00:23</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/func/pgsql/functional-tests.html">00:00:25</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/func/sm-mysql/functional-tests.html">00:00:25</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.1-b528</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/func/xmldb/functional-tests.html">00:00:21</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/func/mysql/functional-tests.html">00:00:23</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/func/pgsql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/func/sm-mysql/functional-tests.html">00:00:25</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.6-b434</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/func/xmldb/functional-tests.html">00:00:21</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/func/mysql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/func/pgsql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/func/sm-mysql/functional-tests.html">00:00:25</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.5-b422</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/func/xmldb/functional-tests.html">00:00:21</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/func/mysql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/func/pgsql/functional-tests.html">00:00:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/func/sm-mysql/functional-tests.html">00:00:26</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.3-b409</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/func/xmldb/functional-tests.html">00:00:27</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/func/mysql/functional-tests.html">00:00:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/func/pgsql/functional-tests.html">00:00:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/func/sm-mysql/functional-tests.html">00:00:32</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7.2-b378</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/func/xmldb/functional-tests.html">00:00:30</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/func/mysql/functional-tests.html">00:00:34</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/func/pgsql/functional-tests.html">00:00:33</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/func/sm-mysql/functional-tests.html">00:00:35</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.4-b300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/func/xmldb/functional-tests.html">00:00:30</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/func/mysql/functional-tests.html">00:00:32</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/func/pgsql/functional-tests.html">00:00:35</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/func/sm-mysql/functional-tests.html">00:00:39</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.4-b295</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/func/xmldb/functional-tests.html">00:00:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/func/mysql/functional-tests.html">00:00:32</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/func/pgsql/functional-tests.html">00:00:45</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/func/sm-mysql/functional-tests.html">00:00:36</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.0-b287</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/func/xmldb/functional-tests.html">00:00:31</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/func/mysql/functional-tests.html">00:00:34</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/func/pgsql/functional-tests.html">00:00:47</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/func/sm-mysql/functional-tests.html">00:00:43</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.5.0-b279</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/func/xmldb/functional-tests.html">00:00:30</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/func/mysql/functional-tests.html">00:00:34</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/func/pgsql/functional-tests.html">00:00:45</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/func/sm-mysql/functional-tests.html">00:00:43</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.0-b263</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/func/xmldb/functional-tests.html">00:00:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/func/mysql/functional-tests.html">00:00:33</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/func/pgsql/functional-tests.html">00:00:45</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/func/sm-mysql/functional-tests.html">00:00:44</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3.4-b226</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/functional-tests.html">00:00:48</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_performance_tests"><a class="anchor" href="#_performance_tests"></a>1.1.2. Performance Tests</h4>
<div class="paragraph">
<p>Checking whether the function performs well enough.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PGSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.2-b889</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/perf/xmldb/performance-tests.html">00:12:17</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/perf/mysql/performance-tests.html">00:13:42</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b889/perf/pgsql/performance-tests.html">00:17:10</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">none</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.3.2-b880</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/perf/xmldb/performance-tests.html">00:13:39</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/perf/mysql/performance-tests.html">00:14:09</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.3.2-b880/perf/pgsql/performance-tests.html">00:17:39</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3.0.2-b700</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/perf/xmldb/performance-tests.html">00:10:26</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/perf/mysql/performance-tests.html">00:11:00</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/perf/pgsql/performance-tests.html">00:12:08</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/3.0.2-b700/perf/sm-mysql/performance-tests.html">00:24:05</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.5-b606</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/perf/xmldb/performance-tests.html">00:09:54</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/perf/mysql/performance-tests.html">00:11:18</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/perf/pgsql/performance-tests.html">00:37:08</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.5-b606/perf/sm-mysql/performance-tests.html">00:16:20</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.3-b548</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/perf/xmldb/performance-tests.html">00:10:00</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/perf/mysql/performance-tests.html">00:11:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/perf/pgsql/performance-tests.html">00:36:43</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.3-b548/perf/sm-mysql/performance-tests.html">00:16:47</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.9.1-b528</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/perf/xmldb/performance-tests.html">00:09:46</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/perf/mysql/performance-tests.html">00:11:15</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/perf/pgsql/performance-tests.html">00:36:12</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.9.1-b528/perf/sm-mysql/performance-tests.html">00:16:36</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.6-b434</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/perf/xmldb/performance-tests.html">00:10:02</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/perf/mysql/performance-tests.html">00:11:45</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/perf/pgsql/performance-tests.html">00:36:36</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.6-b434/perf/sm-mysql/performance-tests.html">00:17:36</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.5-b422</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/perf/xmldb/performance-tests.html">00:12:37</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/perf/mysql/performance-tests.html">00:14:40</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/perf/pgsql/performance-tests.html">00:38:59</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.5-b422/perf/sm-mysql/performance-tests.html">00:21:40</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.8.3-b409</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/perf/xmldb/performance-tests.html">00:12:32</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/perf/mysql/performance-tests.html">00:14:26</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/perf/pgsql/performance-tests.html">00:37:57</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.8.3-b409/perf/sm-mysql/performance-tests.html">00:21:26</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.7.2-b378</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/perf/xmldb/performance-tests.html">00:12:28</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/perf/mysql/performance-tests.html">00:14:57</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/perf/pgsql/performance-tests.html">00:37:09</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.7.2-b378/perf/sm-mysql/performance-tests.html">00:22:20</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.4-b300</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/perf/xmldb/performance-tests.html">00:12:46</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/perf/mysql/performance-tests.html">00:14:59</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/perf/pgsql/performance-tests.html">00:36:56</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b300/perf/sm-mysql/performance-tests.html">00:35:00</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.4-b295</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/perf/xmldb/performance-tests.html">00:12:23</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/perf/mysql/performance-tests.html">00:14:59</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/perf/pgsql/performance-tests.html">00:42:24</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.4-b295/perf/sm-mysql/performance-tests.html">00:30:18</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.6.0-b287</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/perf/xmldb/performance-tests.html">00:13:50</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/perf/mysql/performance-tests.html">00:16:53</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/perf/pgsql/performance-tests.html">00:48:17</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.6.0-b287/perf/sm-mysql/performance-tests.html">00:49:06</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.5.0-b279</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/perf/xmldb/performance-tests.html">00:13:29</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/perf/mysql/performance-tests.html">00:16:58</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/perf/pgsql/performance-tests.html">00:47:15</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.5.0-b279/perf/sm-mysql/performance-tests.html">00:41:52</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.4.0-b263</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/perf/xmldb/performance-tests.html">00:13:20</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/perf/mysql/performance-tests.html">00:16:21</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/perf/pgsql/performance-tests.html">00:43:56</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/2.4.0-b263/perf/sm-mysql/performance-tests.html">00:42:08</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3.4-b226</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/performance-tests.html">01:23:30</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_stability_tests"><a class="anchor" href="#_stability_tests"></a>1.1.3. Stability Tests</h4>
<div class="paragraph">
<p>Checking whether the function behaves well in long term run. It must handle hundreds of requests a second in several hours server run.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Version</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">XMLDB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MySQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">PGSQL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Distributed</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2.3.4-b226</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="tests/stability-tests.html">16:06:31</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">None</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_db_schema_explained"><a class="anchor" href="#_tigase_db_schema_explained"></a>2. Tigase DB Schema Explained</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2011-07-12 00:56</p>
</div>
<div class="paragraph">
<p>The schema basics, how it looks like and brief explanation to all rows can be found in the <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/database/mysql-schema-4-schema.sql">schema creation script</a>. However, this is hardly enough to understand how it works and how access all the data. There are only 3 basic tables which actually keep all the Tigase server users' data: <strong>tig_users</strong>, <strong>tig_nodes</strong> and <strong>tig_pairs</strong>. Therefore it is not clear at first how the Tigase data is organised.</p>
</div>
<div class="paragraph">
<p>Before you can understand the Tigase XMPP Server database schema, how it works and how to use it, is it essential to know what were the goals and why it works that way. Let&#8217;s start with the API as this gives you the best introduction.</p>
</div>
<div class="paragraph">
<p>Simplified access can be got through methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> setData(BareJID user, <span class="predefined-type">String</span> key, <span class="predefined-type">String</span> value);
<span class="predefined-type">String</span> getData(BareJID user, <span class="predefined-type">String</span> key);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And more complex version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> setData(BareJID user, <span class="predefined-type">String</span> subnode, <span class="predefined-type">String</span> key, <span class="predefined-type">String</span> value);
<span class="predefined-type">String</span> getData(BareJID user, <span class="predefined-type">String</span> subnode, <span class="predefined-type">String</span> key, <span class="predefined-type">String</span> def);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even though, the API contanins more methods, the rest is more or less variation of presented above. Complete API description for all access methods is available in JavaDoc documentation to <a href="https://projects.tigase.org/projects/tigase-server/repository/entry/trunk/src/main/java/tigase/db/UserRepository.java">UserRepository</a> interface. So we are not going into much details here except the main idea.</p>
</div>
<div class="paragraph">
<p>We are more or less operate on &lt;*key*, <strong>value</strong>&gt; pairs for the particular user. The idea befind this was to make the API very simple and also at the same time very flexible, so adding a new plugin or component would not require database schema change, adding new tables, conversion of the DB schema to a new version, etc&#8230;&#8203;.</p>
</div>
<div class="paragraph">
<p>As a result <strong>UserRepository</strong> interface is exposed to all the Tigase code, mainly components and plugins (let&#8217;s call all of them modules), and these modules simply call set/get methods to store or access module specific data.</p>
</div>
<div class="paragraph">
<p>As plugins or components are developed independently it may easily happen that developer choses the same key name to store some information. To avoid key name conclicts in the database a <em>node</em> concept has been introduced. Therefore, most modules when set/get key value they also provide a subnode part, which in most cases is just XMLNS or some other unique string.</p>
</div>
<div class="paragraph">
<p>The <em>node</em> thing is a little bit like directory in a filesystem, it may contain subnodes which makes the Tigase database kind of hierarchical structure. And the notation is also similar to filesystem. You use just '<strong>/</strong>' to separate node levels. In practice you can have database organised like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">user-name<span class="variable">@domain</span>  <span class="comment">--&gt; (key, value) pairs</span>
                   |
               roster <span class="comment">--&gt;</span>
                       |
                     item1 <span class="comment">--&gt; (key1, value1) pairs.</span>
                       |
                     item2 <span class="comment">--&gt; (key1, value1) pairs.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>So to access item&#8217;s 1 data from the roster you could call method like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">getData(<span class="string"><span class="delimiter">&quot;</span><span class="content">user-name@domain</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">roster/item1</span><span class="delimiter">&quot;</span></span>, key1, def1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is huge convenience for the developer, as he can focus ont he module logic instead of worrying about data storage implementation and organisation. Especially at prototypic phase it speeds development up and allows for a quick experiments with differnent solutions. In practice, accessing user&#8217;s roster in such a way would be highly inefficient so the roster is stored a bit differently but you get the idea. Also there is a more complex API used in some places allowing for more direct access to the database and store data in any format optimised for the particular use case.</p>
</div>
<div class="paragraph">
<p>Right now such a hierarchical structure is implemented on top of SQL databases but initially Tigase&#8217;s database was implemented as XML structure, so it was natural and simple.</p>
</div>
<div class="paragraph">
<p>In the SQL database we simulate hierarchical structure with three tables:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>tig_users</strong> - with main users data, user id (JID), optional password, active flag, creation time and some other basic properties of the account. All of them could be actually stored in tig_pairs but for performance reasons they are in one place to quickly access them with single, simple query.</p>
</li>
<li>
<p><strong>tig_nodes</strong> - is a table where the hierarchy is implemented. When Tigase was storing data in XML database the hierarchy was quite complex. However, in SQL database it resulted in a very slow access to the data and now more flat structure is used by most components. Please note, every user&#8217;s entry has something called root node, which is represented by <em>root</em> string;</p>
</li>
<li>
<p><strong>tig_pairs</strong> - this is the table where all the user&#8217;s information is stored in form of the &lt;key, value&gt; pairs.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ok, so we now know how the data is organised. Now we are going to learn how to access the data directly in the database using SQL queries.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume we have a user <em>admin@test-d</em> for whom we want to retrieve the roster. We could simply execute query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">select</span> pval
  <span class="keyword">from</span> tig_users, tig_pairs
  <span class="keyword">where</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">admin@test-d</span><span class="delimiter">'</span></span> <span class="keyword">and</span>
        tig_users.uid = tig_pairs.uid <span class="keyword">and</span>
        pkey = <span class="string"><span class="delimiter">'</span><span class="content">roster</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, if multiple modules store data under the key <em>roster</em> for a single user, we would receive mutliple results. To access the correct <em>roster</em> we have to know also node hierarchy for this particular key. The main user&#8217;s roster is stored under the <em>root</em> node, so the query would look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">select</span> pval
  <span class="keyword">from</span> tig_users, tig_nodes, tig_pairs
  <span class="keyword">where</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">admin@test-d</span><span class="delimiter">'</span></span> <span class="keyword">and</span>
            tig_users.uid = tig_nodes.uid <span class="keyword">and</span>
            node = <span class="string"><span class="delimiter">'</span><span class="content">root</span><span class="delimiter">'</span></span> <span class="keyword">and</span>
            tig_users.uid = tig_pairs.uid <span class="keyword">and</span>
           pkey = <span class="string"><span class="delimiter">'</span><span class="content">roster</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>How exactly the information is stored in the <strong>tig_pairs</strong> table depends on the particular module. For the roster it looks a bit like XML content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;contact</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">all-xmpp-test@test-d</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">subs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">preped</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">simple</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">all-xmpp-test</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_information"><a class="anchor" href="#_basic_information"></a>3. Basic Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="sect2">
<h3 id="_tigase_server_elements"><a class="anchor" href="#_tigase_server_elements"></a>3.1. Tigase Server Elements</h3>
<div class="paragraph">
<p>To make it easier to get into the code below are defined basic terms in Tigase server world and there is a brief explanation how the server is designed and implemented. This document also points you to basic interfaces and implementations which can be used as example code reference.</p>
</div>
<div class="paragraph">
<p>Logically all server code can be divided into 3 kinds of modules: <strong>components</strong>, <strong>plug-ins</strong> and <strong>connectors</strong>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Component</strong> is the main element of Tigase server is. Component is a bigger piece of code which can have separate address, can receive and send stanzas, can be configured and respond to numerous events. Sample components implemented for Tigase server are: <em>c2s connection manager</em>, <em>s2s connection manager</em>, <em>session manager</em>, <em>XEP-0114 - external component connection manager</em>, <em>MUC - multi user char rooms</em>.</p>
</li>
<li>
<p><strong>Plug-in</strong> is usually small piece of code responsible for processing particular XMPP stanza. It doesn&#8217;t have own address. As a result of stanza processing it can produce new XMPP stanzas. Plug-ins are loaded by <em>session manager</em> component or <em>c2s connection manager</em> component. Sample plug-ins are: <em>vCard</em> stanza processing, <em>jabber:iq:register</em> to register new user accounts, <em>presence</em> stanza processing, <em>jabber:iq:auth</em> for non-sasl authentication and so on&#8230;&#8203;.</p>
</li>
<li>
<p><strong>Connector</strong> is a module responsible to for access to data repository like database, LDAP to store and retrieve user data. There are 2 kinds of connectors: authentication connectors and user data connectors. Both of them are independent and can connect to different data sources. Sample connectors are: <em>JDBC database</em> connector, <em>XMLDB - embedded database</em> connector, <em>Drupal database</em> connector, <em>LibreSource database</em> connector.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is API defined for each kind of above modules and all you have to do is implementation of specific interface. Then the module can be loaded to the server based on configuration settings. There are also available abstract classes implementing these interfaces to make development easier.</p>
</div>
<div class="paragraph">
<p>Here is a brief list of all interfaces to look at and for more details you have to refer to the guide for specific kind of module.</p>
</div>
<div class="sect3">
<h4 id="_component"><a class="anchor" href="#_component"></a>3.1.1. Component</h4>
<div class="paragraph">
<p>This is list of interfaces to look at when you work on a new component:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>tigase.server.ServerComponent</strong> - this is the very basic interface for component. All components must implement it.</p>
</li>
<li>
<p><strong>tigase.server.MessageReceiver</strong> - this interface extends <code>ServerComponent</code> and is required to implement by components which want to receive data packets like <em>session manager</em>, <em>c2s connection manager</em> and so on&#8230;&#8203;</p>
</li>
<li>
<p><strong>tigase.conf.Configurable</strong> - implementing this interface is required to make it configurable. For each object of this type configuration is pushed to it at any time at runtime. This is necessary to make it possible to change configuration at runtime. Implementation should be careful enough to handle this properly.</p>
</li>
<li>
<p><strong>tigase.disco.XMPPService</strong> - Objects of which inherit this interface can respond to "ServiceDiscovery" requests.</p>
</li>
<li>
<p><strong>tigase.stats.StatisticsContainer</strong> - Objects which inherits this type can return runtime statistics. Any object can collect job statistics and implementing this interface guarantees that statistics will be presented in consisted way to user who wants to see them.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Instead of implementing above interfaces directly I would recommend to extend one of existing abstract classes which take care of the most of "dirty and boring" stuff. Here is a list the most useful abstract classes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>tigase.server.AbstractMessageReceiver</strong> - implements 4 basic interfaces:</p>
<div class="paragraph">
<p><code>ServerComponent</code>, <code>MessageReceiver</code>, <code>Configurable</code> and <code>StatisticsContainer</code>. It also manages internal data queues using own threads which prevents from dead-locks. It offers even-driven data processing which means whenever packet arrives <code>abstract void processPacket(Packet packet);</code> method is called to process it. You have to implement this abstract method in your component. If your component wants to send a packet (in response to data it received for example) it needs to call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">boolean</span> addOutPacket(Packet packet)</code></pre>
</div>
</div>
<div class="paragraph">
<p>method. This is it, I mean basic implementation.</p>
</div>
</li>
<li>
<p><strong>tigase.server.ConnectionManager</strong> - this is an extension of <code>AbstractMessageReceiver</code> abstract class. As its name says this class takes care of all network connection management stuff. If your component needs to send and receive data directly from the network (like c2s connection, s2s connection or external component) you should use this implementation as a basic class. It takes care of all things related to networking, I/O, reconnecting, listening on socket, connecting and so on. If you extend this class you have to expect data coming from to sources: from the <code>MessageRouter</code> and this is when</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">abstract</span> <span class="type">void</span> processPacket(Packet packet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>method is called and from network connection and then</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">abstract</span> <span class="predefined-type">Queue</span> processSocketData(XMPPIOService serv);</code></pre>
</div>
</div>
<div class="paragraph">
<p>method is called.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_plug_in"><a class="anchor" href="#_plug_in"></a>3.1.2. Plug-in</h4>
<div class="paragraph">
<p>All Tigase plugins currently implemented are located in package: tigase.xmpp.impl. You can use this code as a sample code base. There are 3 types of plug-ins and they are defined in interfaces located in <code>tigase.xmpp</code> package:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>XMPPProcessorIfc</strong> - the most important and basic plug-in. This is the most common plug-in type which just processes stanzas in normal mode. It receives packets, processes them on behalf of the user and returns resulting stanzas.</p>
</li>
<li>
<p><strong>XMPPPreprocessorIfc</strong> -</p>
</li>
<li>
<p><strong>XMPPPostprocessorIfc</strong> -</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connector"><a class="anchor" href="#_connector"></a>3.2. Connector</h3>
<div class="sect3">
<h4 id="_data_stanzas_packets_data_flow_and_processing"><a class="anchor" href="#_data_stanzas_packets_data_flow_and_processing"></a>3.2.1. Data, Stanzas, Packets - Data Flow and Processing</h4>
<div class="paragraph">
<p>Data received from the network are read from the network sockets as bytes by code in <code>tigase.io</code> package. Bytes then are changed into characters in classes of <code>tigase.net</code> package and as characters they are put to XML parser (<code>tigase.xml</code>) which turns them to XML DOM structures.</p>
</div>
<div class="paragraph">
<p>All data inside the server are exchanged in XML DOM form as this is the format used by XMPP protocol. For basic XML data processing (parsing characters stream, building DOM, manipulate XML elements and attributes) we use <a href="https://svn.tigase.org/reps/tigase-xmltools/trunk/">Tigase XML parser and DOM builder</a>.</p>
</div>
<div class="paragraph">
<p>Each stanza is stored in <code>tigase.xml.Element</code> object. Every Element can contain any number of <code>child Elements</code> and any number of attributes. You can access all these data through the class API.</p>
</div>
<div class="paragraph">
<p>To simplify some, most common operations Element is wrapped in <code>tigase.server.Packet</code> class which offer another level of API for the most common operations like preparation of response stanza based on the element it contains (swap to/from values, put type=result attribute and so on&#8230;&#8203;).</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_why_the_most_recent_jdk"><a class="anchor" href="#_why_the_most_recent_jdk"></a>4. Why the most recent JDK?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>Well there are many reasons but the main is that I am the only one developer working on source code at the moment. So the whole approach is to make life easier for me, make the project easier to maintain and development more efficient.</p>
</div>
<div class="paragraph">
<p>Here is the list:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Easy to maintain</strong> - No third-party libraries are used for the project which makes this project much easier to maintain. I don&#8217;t have to worry about compatibility beetwen particular version of library used I don&#8217;t have to worry about upgrading my environment if library version change and old version is not supported anymore. If I change machine on which I do development the only thing I need is just to download JDK.</p>
</li>
<li>
<p><strong>Easy to deploy</strong> -  Another reason to not use third-party tools. Make it easier for end-user to install and use the server.</p>
</li>
<li>
<p><strong>Efficient development</strong> -  As no third-party libraries are used I need either to implement many things on my own or use as much as possible of JDK functionality. And this is exactly what I do. I try to use as much as possible of existing library provided with JDK and the rest is implemented on my own.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What features of JDK-1.5 are critical for Tigase development? Why I can&#8217;t simply reimplement some code to make it compatible with earlier JDK versions?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Non-blocking I/O for SSL/TLS</strong> -  This is functionality which can&#8217;t be simply reimplemented for JDK-1.4. And as whole server uses NIO it doesn&#8217;t make sense to use blocking I/O for SSL and TLS.</p>
</li>
<li>
<p><strong>SASL</strong> -  This could be reimplemented for JDK-1.4 with not that big effort.</p>
</li>
<li>
<p><strong>Concurrent package</strong> -  This could be reimplemented for JDK-1.4 but the effort could be high. And this is critical part of the server as it uses multi-threading and concurrent processing.</p>
</li>
<li>
<p><strong>Security package</strong> -  There number of extensions to security package which make my live easier and development more efficient.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>I think above list is enough to decide to use JDK-1.5. But why JDK-1.6? Well, the is actually only 1 main reason so far:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>LinkedHashMap</strong> -  in JDK-1.6 is a basement for the Tigase cache implementation.</p>
</li>
<li>
<p><strong>Light HTTP server</strong> -  JDK-1.6 offers built-in light HTTP server which is needed to implement HTTP binding (JEP-0124) and HTTP user interface to monitor server activity and work with the server configuration.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hack_tigase_jabber_xmpp_server_in_eclipse"><a class="anchor" href="#_hack_tigase_jabber_xmpp_server_in_eclipse"></a>5. Hack Tigase Jabber/XMPP Server in Eclipse</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bartosz Malkowski &lt;<a href="mailto:bmalkowski@tigase.pl">bmalkowski@tigase.pl</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p><a href="files/tigase-server.psf">tigase-server.psf  424 bytes</a></p>
</div>
<div class="paragraph">
<p><a href="files/eclipse-config.tar_.gz">eclipse-config.tar_.gz  1.01 KB</a></p>
</div>
<div class="paragraph">
<p>If you want to write a code for <strong>Tigase</strong> server you might want to use <a href="http://www.eclipse.org/">Eclipse</a>. Here is a guide how to start working on source code using this IDE.</p>
</div>
<div class="paragraph">
<p>All you need to start is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Installed and working copy of <a href="http://www.eclipse.org/">Eclipse</a></p>
</li>
<li>
<p>Installed and working copy of <a href="http://java.sun.com/javase/downloads/ea.jsp">JDK-1.6.0Beta2</a> at least.</p>
</li>
<li>
<p>Installed and working <a href="http://subclipse.tigris.org/">Subclipse</a> pluggin for Eclipse.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_jdk_1_6_0_setup"><a class="anchor" href="#_jdk_1_6_0_setup"></a>5.1. JDK-1.6.0 Setup</h3>
<div class="paragraph">
<p>After installation JDK-1.6.0 in your operating system, run Eclipse and select  Window/Preferences.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/preferences-jre.png" alt="preferences-jre"></span></p>
</div>
<div class="paragraph">
<p>In section Java/Installed JREs press <strong>Add</strong> button. In the new opened window enter path to installed JDK-6. In my case it is <strong>/opt/jdk1.6.0</strong>. It also good to set name to <strong>sun-jdk-1.6.0</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/preferences-jre-add.png" alt="preferences-jre-add"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_subclipse_installation"><a class="anchor" href="#_subclipse_installation"></a>5.2. Subclipse Installation</h3>
<div class="paragraph">
<p>As Eclipse doesn&#8217;t contain built-in support for Subversion repositories you have to add new plugin.  Detailed instruction for Subclipse installation is on page:</p>
</div>
<div class="paragraph">
<p><a href="http://subclipse.tigris.org/install.html">subclipse.tigris.org/install.html</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_project_import"><a class="anchor" href="#_project_import"></a>5.3. Project Import</h3>
<div class="paragraph">
<p>From menu File in Eclipse execute <strong>Import</strong>. Next, highlight section <strong>Team/Team
Project Set</strong> and press <strong>Next</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/import-project.png" alt="import-project"></span></p>
</div>
<div class="paragraph">
<p>Enter file name <strong>tigase-server.psf</strong> in field <strong>File</strong> and press <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p>The file is attached to this article.</p>
</div>
<div class="paragraph">
<p>Because <a href="http://www.tigase.net/user/1">kobit</a> has objections to add Eclipse configuration files to subversion repository you have to do it on your own.</p>
</div>
<div class="paragraph">
<p>That&#8217;s it. Start hacking now!</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_api_changes_in_the_tigase_server_5_x"><a class="anchor" href="#_api_changes_in_the_tigase_server_5_x"></a>6. API changes in the Tigase Server 5.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>The API changes can affect you only if you develop own code to run inside the Tigase server. The changes are not extensive but in some circumstances may require many simple changes in a few files.</p>
</div>
<div class="paragraph">
<p>All the changes are related to introducing tigase.xmpp.JID and tigase.xmpp.BareJID classes. It is recommended to use them for all operations performed on the user JID instead of the String class which was used before changes.</p>
</div>
<div class="paragraph">
<p>There are a few advantages of using the new classes. First of all they do all the user JID checking and parsing, they also perform stringprep processing. Therefore if you use data kept by instance of the JID or BareJID you can be sure they are valid and correct.</p>
</div>
<div class="paragraph">
<p>These are not all advantages however. Working with a profiler and optimising the Tigase code I noticed that a lot of CPU power is used by JID parsing code. JIDs and parts of the JIDs are used in many places of the stanza processing and the parsing is performed over and over again in all these places, wasting CPU cycles, memory and time.  Therefore, great benefits from these new class are in performance if once parsed JIDs are reused in all further stanza processing.</p>
</div>
<div class="paragraph">
<p>This is where the tigase.server.Packet class comes in handy. Instance of the Packet class encloses XML stanza and pre-parses some, the most commonly used elements of the stanza. Stanza source and destination addresses are among them. As an effect there are all new methods available in the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JID getStanzaFrom();
JID getStanzaTo();
JID getFrom();
JID getTo();
JID getPacketFrom();
JID getPacketTo();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas following methods are still available but have been deprecated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> getElemFrom();
<span class="predefined-type">String</span> getElemTo();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please refer to the JavaDoc documentation for the <code>Packet</code> class and methods to learn all the details of these methods and difference between them.</p>
</div>
<div class="paragraph">
<p>Another difference is that you can no longer create the <code>Packet</code> instance using a constructor. Instead there are a few factory methods available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">static</span> Packet packetInstance(<span class="predefined-type">Element</span> elem);
<span class="directive">static</span> Packet packetInstance(<span class="predefined-type">Element</span> elem,
    JID stanzaFrom, JID stanzaTo);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, please refer to the JavaDoc documentation for all the details. The main point of using these methods is that they actually return an instance of one of the following classes instead of the <code>Packet</code> class: <code>Iq</code>, <code>Presence</code> or <code>Message</code>.</p>
</div>
<div class="paragraph">
<p>There is also a number of utility methods helping with creating a copy of the Packet instance preserving as much pre-parsed data as possible:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Packet copyElementOnly();
Packet errorResult(...);
Packet okResult(...);
Packet swapFromTo();
Packet swapStanzaFromTo();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, I tried to keep the JavaDoc comments as complete as possible, have a look. In case of doubts please contact me and will add missing information to the documentation.</p>
</div>
<div class="paragraph">
<p>The main point is to reuse <code>JID</code> or <code>BareJID</code> instances in your code as much as possible. You never know, your code may run in highly loaded systems with throughput of 100k XMPP packets per second.</p>
</div>
<div class="paragraph">
<p>Another change. This one a bit risky as it is very difficult to find all places where this could be used. There are several utility classes and methods which accept source and destination address of a stanza and produce something.  There was a great confusion with them, as in some of them the first was the source address and in others the destination address. I have re-factored all the code to keep the parameter order the same in all places. Right now the policy is: <strong>source address first</strong>.  Therefore in all places where there was a method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Packet method(<span class="predefined-type">String</span> to, <span class="predefined-type">String</span> from);</code></pre>
</div>
</div>
<div class="paragraph">
<p>it has been changed to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Packet method(JID from, JID to);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As far as I know most of these method were used only by myself so I do not expect much trouble for other developers.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_compilation"><a class="anchor" href="#_server_compilation"></a>7. Server Compilation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>List of documents describing how to work with sources and how to compile them.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tigase XMPP Server 5.2.0 and Later - Compilation and Generating Distribution Packages</p>
</li>
<li>
<p>Tigase Packages Dependency Change - Server Compilation Version 4.x or Later</p>
</li>
<li>
<p>Server Compilation - Version 2.x and 3.x</p>
</li>
<li>
<p>Using Maven</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_xmpp_server_5_2_0_and_later_compilation_and_generating_distribution_packages"><a class="anchor" href="#_tigase_xmpp_server_5_2_0_and_later_compilation_and_generating_distribution_packages"></a>8. Tigase XMPP Server 5.2.0 and later - Compilation and Generating Distribution Packages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2013-08-08 12:42</p>
</div>
<div class="paragraph">
<p>Starting with version 5.2.0 Tigase Server we switch for generating distribution packages from Ant to Maven. This will allow better depencency management as well as build repeatability.</p>
</div>
<div class="paragraph">
<p>Guides:</p>
</div>
<div class="paragraph">
<p>A Very Short Maven Guide
Maven 2.x Support</p>
</div>
<div class="sect2">
<h3 id="_distribution_packages"><a class="anchor" href="#_distribution_packages"></a>8.1. Distribution Packages</h3>
<div class="paragraph">
<p>Starting from version 5.2.0 there will be two separate archives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>minimal version (-dist) containing only tigase-server, tigase-xmltools and tigase-utils</p>
</li>
<li>
<p>max version (-dist-max) containing all additional tigase components (MUC, PubSub, HTTP API, OSGi support, etc.) as well as dependencies required by those components.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>They will be available as both zip and tarball.</p>
</div>
</div>
<div class="sect2">
<h3 id="_building_server_and_generating_packages"><a class="anchor" href="#_building_server_and_generating_packages"></a>8.2. Building Server and Generating Packages</h3>
<div class="paragraph">
<p>After cloning tigase-server repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">git clone https://repository.tigase.org/git/tigase-server.git
cd tigase-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>You compile server with maven using project distribution profile (dist):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn -Pdist -f modules/master/pom.xml clean install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>compile server</p>
</li>
<li>
<p>generate javadoc</p>
</li>
<li>
<p>grab all latest versions of all declared depencencies and put them in jars/ directory</p>
</li>
<li>
<p>create both types of distribution packages (-dist and -dist-max) and place them in pack/ directory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to create instalator packages you have to execute two shell scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./scripts/installer-prepare.sh
./scripts/installer-generate.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, in order for them to succeed you have to build server first using maven as described earlier. You should also have git, python2, docutils and LaTeX distribution installed (please see src/main/izpack/README.txt for details).</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_server"><a class="anchor" href="#_running_server"></a>8.3. Running Server</h3>
<div class="paragraph">
<p>Afterwards you can run the server with the regular shell script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please bear in mind, that you should provide correct setup in etc/init.properties configuration files for the server to work correctly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scv4ol"><a class="anchor" href="#scv4ol"></a>9. Tigase Packages Dependency Change - Server Compilation Version 4.x or Later</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>The dependency for <a href="http://www.tigase.org/project/utils">Tigase Utils Package</a> has changed. This is important for everybody who builds the Tigase server manually from sources using <a href="http://ant.apache.org/">Ant</a> tool. The <a href="http://maven.apache.org/">Maven</a> handles all the dependencies automatically and scripts have been updated.</p>
</div>
<div class="paragraph">
<p>Please keep reading for more details how to compile the server from sources in current SVN repositories.</p>
</div>
<div class="paragraph">
<p>If you have an old <strong>Tigase MUC</strong> or <strong>Tigase Extras</strong> package lying in the <em>server/libs/</em> directory please remove it now. You have to update it too and copy it over to the <em>server/jars/</em> directory after you completed steps below.</p>
</div>
<div class="paragraph">
<p>For all those who build the server from sources manually using <a href="http://ant.apache.org/">Ant</a> here is a short guide:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Checkout all the sources first:</p>
<div class="ulist">
<ul>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-xmltools/repository">https://projects.tigase.org/projects/tigase-xmltools/repository</a></p>
</li>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-utils/repository">https://projects.tigase.org/projects/tigase-utils/repository</a></p>
</li>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-server/repository">https://projects.tigase.org/projects/tigase-server/repository</a></p>
</li>
</ul>
</div>
</li>
<li>
<p>Build the Tigase XMLTools and copy the jar file over to the <strong>utils</strong> and
<strong>server</strong> libs/ directory</p>
<div class="ulist">
<ul>
<li>
<p><code>cd xmltools</code></p>
</li>
<li>
<p><code>ant clean jar-dist</code></p>
</li>
<li>
<p><code>cp jars/tigase-xmltools.jar ../utils/libs</code></p>
</li>
<li>
<p><code>cp jars/tigase-xmltools.jar ../server/libs</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Build the Tigase Utils and copy the jar file to the <strong>server</strong> <em>libs/</em> directory</p>
<div class="ulist">
<ul>
<li>
<p><code>cd ../utils</code></p>
</li>
<li>
<p><code>ant clean jar-dist</code></p>
</li>
<li>
<p><code>cp jars/tigase-utils.jar ../server/libs</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Build the Tigase Server binary</p>
<div class="ulist">
<ul>
<li>
<p><code>cd ../server</code></p>
</li>
<li>
<p><code>ant clean jar-dist</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>This is a very short guide but I hope it helps. If you have any problems, please let me know.</p>
</div>
<div class="paragraph">
<p>Addendum: starting with version 5.2.0 all libraries and jar files for the server are in jars/ directory; however with that version we strongly encourage to switch to maven build system as we are phasing out Ant - please follow guide Tigase XMPP Server 5.2.0 and Later - Compilation and Generating Distribution Packages</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="scv23"><a class="anchor" href="#scv23"></a>10. Server Compilation - version 2.x and 3.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p><em>Tigase XMPP Server version <strong>4.x</strong> or later need slightly different procedure to compile.</em></p>
</div>
<div class="paragraph">
<p>Although the server doesn&#8217;t need any third-party libraries apart from Java 6.0 (1.6beta2) compliant JVM to run, <a href="http://ant.apache.org/">Apache Ant</a> tool and <a href="http://ant-contrib.sourceforge.net/">Ant-Contrib</a> are used to build binaries of <strong>Tigase</strong> applications and libraries. Another tools which is needed is a <a href="http://subversion.tigris.org/">Subversion</a> which is required to download the most recent sources from <strong>Tigase</strong> repository.</p>
</div>
<div class="paragraph">
<p>To make it a list, again:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://java.sun.com/javase/6/webnotes/install/index.html">JDK-1.6</a> - Java SDK to compile and run <strong>Tigase</strong> applications.</p>
</li>
<li>
<p><a href="http://ant.apache.org/">Apache Ant</a> - the build tool</p>
</li>
<li>
<p><a href="http://ant-contrib.sourceforge.net/">Ant-Contrib</a> - <strong>Apache Ant</strong> extensions used by build script (ant-contrib on gentoo, and ant-optional on Ubuntu)</p>
</li>
<li>
<p><a href="http://subversion.tigris.org/">Subversion</a> - version control system used by <strong>Tigase</strong>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Install all above in standard way, appropriate for your operating system. It is enough if they are available in system PATH variable so you can execute them from command line.</p>
</div>
<div class="paragraph">
<p><strong>Tigase Server</strong> has been divided into a few smaller subprojects some time ago. In order to have it all working together we need to do compile them one by one. Here is step by step instruction how to do it. Assuming you already run command line shell and changed to directory where you want to keep all <strong>Tigase</strong> files do as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Get <strong>tigase-utils</strong> sources and compile them:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">svn co https://svn.tigase.org/reps/tigase-utils/trunk/ utils
cd utils
ant clean jar
cd ..</code></pre>
</div>
</div>
</li>
<li>
<p>Get <strong>tigase-xmltools</strong> sources and compile them:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">svn co https://svn.tigase.org/reps/tigase-xmltools/trunk/ xmltools
cd xmltools
ant clean jar
cd ..</code></pre>
</div>
</div>
</li>
<li>
<p>Get <strong>tigase-server</strong> sources and compile them:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">svn co https://svn.tigase.org/reps/tigase-server/trunk/ server
cp xmltools/jars/tigase-xmltools.jar server/libs/
cp utils/jars/tigase-utils.jar server/libs/
cd server
ant clean jar</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now you have <strong>Tigase Server</strong> compiled and ready to run. To check and make sure it is indeed compiled and can be executed you can try to start the server. Assuming you are in the directory where you executed the last compilation command for server sources run following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">java -cp libs/tigase-utils.jar:libs/tigase-xmltools.jar:jars/tigase-server.jar tigase.server.XMPPServer</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it all worked correctly you should see output similar to presented below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">2006-10-04 17:00:38  ConfigRepository.init()        WARNING:  Can not open existing configuration file
2006-10-04 17:00:38  XMLDB.setupNewDB()                  INFO:     Create empty DB.
2006-10-04 17:00:38  MessageRouter.addRegistrator()      INFO:     Adding registrator: Configurator
2006-10-04 17:00:38  MessageRouter.addComponent()        INFO:     Adding component: Configurator
2006-10-04 17:00:38  Configurator.setupLogManager()      WARNING:  DONE
2006-10-04 17:00:38  Configurator.setupLogManager()      WARNING:  DONE
2006-10-04 17:00:39  XMLRepository.()              WARNING:  Can not open existing user repository file</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can proceed to configuration document to learn how to tweak server settings or you can just start hacking server code and do experiments.</p>
</div>
<div class="paragraph">
<p>include::text/Development_Guide_11_-_Using_Maven.asciidoc</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="maven2support"><a class="anchor" href="#maven2support"></a>11. Maven 2.x Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>Addendum: for a more recent guide please follow Tigase XMPP Server 5.2.0 and Later - Compilation and Generating Distribution Packages.</p>
</div>
<div class="paragraph">
<p>Thanks to <a href="http://www.tigase.org/user/2">bmalkow</a> you can now build Tigase server from sources using <a href="http://maven.apache.org/">Maven 2.x</a> tool.  This should greatly simplify first steps with Tigase code and it was requested by many of those trying to get the server running from sources.  Maven repository with Tigase packages is located at address: <a href="http://maven.tigase.org/">maven.tigase.org</a>.  Now all you need to compile sources and generate packages needed to run the server is just a few simple steps below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Download and install Maven 2.x</p>
</li>
<li>
<p>Checkout Tigase server sources from <a href="http://www.tigase.org/content/=">Subversion</a> repository:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">svn co https://svn.tigase.org/reps/tigase-server/trunk/ tigase-server</code></pre>
</div>
</div>
</li>
<li>
<p>Now go to directory with server code:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd tigase-server</code></pre>
</div>
</div>
</li>
<li>
<p>And run maven command to generate server package:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mvn assembly:assembly</code></pre>
</div>
</div>
</li>
<li>
<p>After maven finished his work there should be new subdirectory created: target. Go to this directory now:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd target/</code></pre>
</div>
</div>
</li>
<li>
<p>and list content of this directory.  On Linux, Unix system:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ls -l</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MS Windows system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">dir</code></pre>
</div>
</div>
</li>
<li>
<p>You should see at least 2 files like these:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">tigase-server-2.4.0-SNAPSHOT-prodenv.tar.gz
tigase-server-2.4.0-SNAPSHOT-prodenv.zip</code></pre>
</div>
</div>
</li>
<li>
<p>Unpack one of these files whichever you like:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">tar -xzvf tigase-server-2.4.0-SNAPSHOT-prodenv.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">unzip tigase-server-2.4.0-SNAPSHOT-prodenv.zip</code></pre>
</div>
</div>
</li>
<li>
<p>New directory will be created in our case it will be: <code>tigase-server-2.4.0-SNAPSHOT/</code>. Now go to this directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">cd tigase-server-2.4.0-SNAPSHOT/</code></pre>
</div>
</div>
</li>
<li>
<p>Now almost everything is ready to run the server. Almost because sometimes on Unix like (including Linux) operating systems you have to change script execution bit before you can run it:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">chmod u+x bin/*</code></pre>
</div>
</div>
</li>
<li>
<p>Now you can run Tigase server:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./bin/tigase.sh run etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can get a few warnings about missing configuration file (which will be automatically created) and user repository file (which will be automatically created when you register first user).</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For your convenience there are a few other startup files in <code>etc/</code> directory. You can look and modify them according to your needs.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mavenguide"><a class="anchor" href="#mavenguide"></a>12. A Very Short Maven Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t use <a href="http://maven.apache.org/">Maven</a> at all or use it once a year you may find the document a useful maven commands reminder:</p>
</div>
<div class="sect2">
<h3 id="_snapshot_compilation_and_snapshot_package_generation"><a class="anchor" href="#_snapshot_compilation_and_snapshot_package_generation"></a>12.1. Snapshot Compilation and Snapshot Package Generation</h3>
<div class="ulist">
<ul>
<li>
<p><code>mvn compile</code> - compilation of the snapshot package</p>
</li>
<li>
<p><code>mvn package</code> - create snapshot jar file</p>
</li>
<li>
<p><code>mvn install</code> - install in local repository shanpshot jar file</p>
</li>
<li>
<p><code>mvn deploy</code> - deploy to the remote repository snapshot jar file</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_release_compilation_generation"><a class="anchor" href="#_release_compilation_generation"></a>12.2. Release Compilation, Generation</h3>
<div class="ulist">
<ul>
<li>
<p><code>mvn release:prepare</code> prepare the project for a new version release</p>
</li>
<li>
<p><code>mvn release:perform</code> execute new version release generation</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_generating_tar_gz_tar_bz2_file_with_sources_only"><a class="anchor" href="#_generating_tar_gz_tar_bz2_file_with_sources_only"></a>12.3. Generating tar.gz, tar.bz2 File With Sources Only</h3>
<div class="ulist">
<ul>
<li>
<p><code>mvn -DdescriptorId=src assembly:assembly</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generating_tigase_installer"><a class="anchor" href="#_generating_tigase_installer"></a>13. Generating Tigase Installer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>To generate installer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Install chosen version of <a href="http://izpack.org/">IzPack</a> including source code.</p>
</li>
<li>
<p>In order to compile custom Tigase panels you need to first compile <a href="http://izpack.org/">IzPack</a> classes. You can use the included <code>build.xml</code> which is in the src directory of <a href="http://izpack.org/">IzPack</a> install. Just enter this dir and type:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ant all</code></pre>
</div>
</div>
</li>
<li>
<p>Depending on the IzPack version classes will be compiled directly into the <code>src/lib</code> directory or <code>_build</code> directory of <a href="http://izpack.org/">IzPack</a>. You may need to tweak the <code>build.xml</code> file which is in the same dir as the <code>readme</code> and point to the directory where <a href="http://izpack.org/">IzPack</a> compiled classess reside.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;!-- fragment --&gt;
&lt;classpath&gt;
  &lt;pathelement location=<span class="string"><span class="delimiter">&quot;</span><span class="content">java</span><span class="delimiter">&quot;</span></span>/&gt;

  &lt;!-- tweak below fragment --&gt;
  &lt;pathelement location=<span class="string"><span class="delimiter">&quot;</span><span class="content">${installer.path}/_build</span><span class="delimiter">&quot;</span></span>/&gt;

  &lt;pathelement location=<span class="string"><span class="delimiter">&quot;</span><span class="content">${installer.path}/bin/panels/TargetPanel.jar</span><span class="delimiter">&quot;</span></span>/&gt;
&lt;/classpath&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Make sure that the bin/panels directory of <a href="http://izpack.org/">IzPack</a> is writable by <code>generate-installer.sh</code> script. Compiled custom panels will be placed here before running installer compiler.</p>
</li>
<li>
<p>Modify the <code>script/generate-installer.sh</code>. Change the <code>IZPACK_DIR</code> variable to point to the <a href="http://izpack.org/">IzPack</a> instalation directory e.g.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">IZPACK_DIR=&quot;/usr/local/IzPack421&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>To start the installation process run the <code>scripts/generate-installer.sh</code> file you will find in the main server source code directory. You should start it from the server root dir.</p>
</li>
<li>
<p>Generated files (jar and exe) will be placed in the packages dir of Tigase codebase.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_plugin_development"><a class="anchor" href="#_plugin_development"></a>14. Plugin Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>This is a set of documents explaining details what is plugin, how it is designed and how it works inside the Tigase server. The last part of the documentation explains step by step creating the code for a new plugin.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>SASL Custom Mechanisms and Configuration</p>
</li>
<li>
<p>How Packets are Processed by the SM and Plugins</p>
</li>
<li>
<p>Writing Plugin Code</p>
</li>
<li>
<p>Plugin Configuration</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="saslcmac"><a class="anchor" href="#saslcmac"></a>15. SASL Custom Mechanisms and Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bartosz Malkowski &lt;<a href="mailto:bmalkowski@tigase.pl">bmalkowski@tigase.pl</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2013-01-23 03:54</p>
</div>
<div class="paragraph">
<p><strong>This API is available from Tigase XMPP Server version 5.2.0 or our current master branch.</strong></p>
</div>
<div class="paragraph">
<p><em>Note that API is under active development. This description may be updated at any time.</em></p>
</div>
<div class="sect2">
<h3 id="_basic_sasl_configuration"><a class="anchor" href="#_basic_sasl_configuration"></a>15.1. Basic SASL Configuration</h3>
<div class="paragraph">
<p>SASL implementation in the Tigase XMPP Server is compatible with Java API.The same exact interfaces are used.</p>
</div>
<div class="paragraph">
<p>The SASL implementation consists of following parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>mechanism</p>
</li>
<li>
<p>CallbackHandler</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Properties list for SASL plugin <em>(sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl):</em></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 90%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Property</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">factory</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A factory class for SASL mechanisms. Detailed description at <a href="#mechconf">Mechanisms configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callbackhandler</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A default callback handler class. Detailed description at <a href="#cbconf">CallbackHandler configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callbackhandler-${MECHANISM}</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A callback handler class for a particular mechanism. Detailed description at <a href="#cbconf">CallbackHandler configuration</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">mechanism-selector</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A class for filtering SASL mechanisms available in a stream. Detailed description at <a href="#selmech">Selecting mechanisms</a></p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="mechconf"><a class="anchor" href="#mechconf"></a>15.1.1. Mechanisms Configuration</h4>
<div class="paragraph">
<p>To add a new mechanism, a new factory for the mechanism has to be registered. It can be done with a new line in the <code>init.properties</code> file like this one:</p>
</div>
<div class="paragraph">
<p><code>sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/factory=com.example.OwnFactory</code></p>
</div>
<div class="paragraph">
<p>The class must implement <code>'SaslServerFactory'</code> interface. All mechanisms returned by <code>'getMechanismNames()'</code> method will be registered automatically.</p>
</div>
<div class="paragraph">
<p>The factory which is available and registered by default is <code>'tigase.auth.TigaseSaslServerFactory'</code> which provides <code>PLAIN</code> and <code>ANONYMOUS</code> mechanisms.</p>
</div>
</div>
<div class="sect3">
<h4 id="cbconf"><a class="anchor" href="#cbconf"></a>15.1.2. CallbackHandler Configuration</h4>
<div class="paragraph">
<p>The <code>CallbackHandler</code> is a helper class used for loading/retrieving authentication data from data repository and providing them to a mechanism.</p>
</div>
<div class="paragraph">
<p>To register a new callback handler a new line in the <code>init.properties</code> file like this one has to be added:</p>
</div>
<div class="paragraph">
<p><code>sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler=com.example.DefaultCallbackHandler</code></p>
</div>
<div class="paragraph">
<p>It is also possible to register different callback handlers for different mechanisms:</p>
</div>
<div class="paragraph">
<p><code>sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler-PLAIN=com.example.PlainCallbackHandler</code></p>
</div>
<div class="paragraph">
<p><code>sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/callbackhandler-OAUTH=com.example.OAuthCallbackHandler</code></p>
</div>
<div class="paragraph">
<p>During authentication process, the Tigase server always checks for a handler specific to selected mechanisms, and if there is no specific handler a default one is used.</p>
</div>
</div>
<div class="sect3">
<h4 id="selmech"><a class="anchor" href="#selmech"></a>15.1.3. Selecting Mechanisms Available in the Stream</h4>
<div class="paragraph">
<p>Interface <code>'tigase.auth.MechanismSelector'</code> is used for selecting mechanisms available in a stream. Method <code>'filterMechanisms()'</code> should return a collection with mechanisms available based on:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>all registered SASL factories</p>
</li>
<li>
<p>XMPP session data (from <code>'XMPPResourceConnection'</code> class)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The default selector returns mechanisms from the default Tigase&#8217;s factory <code>('TigaseSaslServerFactory')</code> only.</p>
</div>
<div class="paragraph">
<p>It is possible to use a custom selector by specifying it&#8217;s class int the <code>init.properties</code> file:</p>
</div>
<div class="paragraph">
<p><code>sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/mechanism-selector=com.example.OwnSelector</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_logging_authentication"><a class="anchor" href="#_logging_authentication"></a>15.2. Logging/Authentication</h3>
<div class="paragraph">
<p>After the XMPP stream is opened by a client, the server checks which SASL mechanisms are available for the XMPP session. Depending on whether the stream is encrypted or not, depending on the domain, the server can present different available authentication mechanisms. MechanismSelector is responsible for choosing mechanisms. List of allowed mechanisms is stored in the XMPP session object.</p>
</div>
<div class="paragraph">
<p>When the client/user begins authentication procedure it uses one particular mechanism. It must use one of the mechanisms provided by the server as available for this session. The server checks whether mechanisms used by the client is on the list of allowed mechanisms. It the check is successful, the server creates <code>'SaslServer'</code> class instance and proceeds with exchanging authentication information. Authentication data is different depending on the mechanism used.</p>
</div>
<div class="paragraph">
<p>When the SASL authentication is completed without any error, the Tigase server should have authorized user name or authorized BareJID. In the first case, the server automatically builds user&#8217;s JID based on the domain used in the stream opening element in '<code>to</code>' attribute.</p>
</div>
<div class="paragraph">
<p>If, after a successful authentication, method call: <code>'getNegotiatedProperty("IS_ANONYMOUS")\'</code> returns <code>'Boolean.TRUE'</code> then the user session is marked as anonymous. For valid and registered users this can be used for cases when we do not want to load any user data such as roster, vcard, privacy lists and so on. This is a performance and resource usage implication and can be useful for use cases such as support chat. The authorization is performed based on the client database but we do not need to load any XMPP specific data for the user&#8217;s session.</p>
</div>
<div class="paragraph">
<p>More details about implementation can be found at custom mechanisms development.</p>
</div>
<div class="sect3">
<h4 id="_built_in_mechanisms"><a class="anchor" href="#_built_in_mechanisms"></a>15.2.1. Built-in Mechanisms</h4>
<div class="paragraph">
<p><strong>PLAIN</strong></p>
</div>
<div class="paragraph">
<p><em>TODO!</em></p>
</div>
<div class="paragraph">
<p><strong>ANONYMOUS</strong></p>
</div>
<div class="paragraph">
<p><em>TODO!</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cmd"><a class="anchor" href="#cmd"></a>15.3. Custom Mechanisms Development</h3>
<div class="sect3">
<h4 id="__strong_mechanism_strong"><a class="anchor" href="#__strong_mechanism_strong"></a>15.3.1. <strong>Mechanism</strong></h4>
<div class="paragraph">
<p><code>'getAuthorizationID()\'</code> method from <code>'SaslServer'</code> class <strong>should</strong> return bare JID authorized user. In case that the method returns only user name such as <strong>romeo</strong> for example, the server automatically appends domain name to generate a valid BareJID: <em>romeo@example.com</em>. In case the method returns a full, valid BareJID, the server does not change anything.</p>
</div>
<div class="paragraph">
<p><code>'handleLogin()\'</code> method from <code>'SessionManagerHandler'</code> will be called with user&#8217;s Bare JID provided by <code>getAuthorizationID()</code> (or created later using stream domain name).</p>
</div>
</div>
<div class="sect3">
<h4 id="__strong_callbackhandler_strong"><a class="anchor" href="#__strong_callbackhandler_strong"></a>15.3.2. <strong>CallbackHandler</strong></h4>
<div class="paragraph">
<p>For each session authorization, the server creates a new and separate, empty handler. Factory which creates handler instance allows to inject different objects to the handler, depending on interfaces implemented by the handler class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AuthRepositoryAware</code> - injects <code>AuthRepository;</code></p>
</li>
<li>
<p><code>DomainAware</code> - injects domain name within which the user attempts to authenticate</p>
</li>
<li>
<p><code>NonAuthUserRepositoryAware</code> - injects <code>NonAuthUserRepository</code>, although I have no idea what for&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_general_remarks"><a class="anchor" href="#_general_remarks"></a>15.3.3. General Remarks</h4>
<div class="paragraph">
<p><code>JabberIqAuth</code> used for non-SASL authentication mechanisms uses the same callback as the SASL mechanisms.</p>
</div>
<div class="paragraph">
<p>Methods <code>'auth'</code> in <code>'Repository'</code> interfaces will be deprecated. These interfaces will be treated as user details providers only. There will be new methods available which will allow for additional login operations on the database such as last successful login recording and so on&#8230;&#8203;</p>
</div>
</div>
<div class="sect3">
<h4 id="_known_problems"><a class="anchor" href="#_known_problems"></a>15.3.4. Known Problems</h4>
<div class="paragraph">
<p>Because <code>JabberIqAuth</code> is initialized separatelly, we strongly recommend to use more general prefix in <strong><code>init.properties</code></strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/${KEY}=${VALUE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>instead of</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/urn\:ietf\:params\:xml\:ns\:xmpp-sasl/${KEY}=${VALUE}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>JabberIqAuth</code> is disabled, then you don&#8217;t care about it.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="How_Packets_are_Processed_by_the_SM_and_Plugins"><a class="anchor" href="#How_Packets_are_Processed_by_the_SM_and_Plugins"></a>16. How Packets are Processed by the SM and Plugins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>For the Tigase server plugin development it is important to understand how it all works. There are different kind of plugins responsible for processing packets at different stages of the data flow. Please read the introduction below before proceeding to the actual coding part.</p>
</div>
<div class="sect2">
<h3 id="_introduction"><a class="anchor" href="#_introduction"></a>16.1. Introduction</h3>
<div class="paragraph">
<p>In the Tigase server <strong>plugins</strong> are pieces of code responsible for processing particular XMPP stanza. A separate plugin might be responsible for processing messages, a different one for processing presences, and there might a separate plugins responsible for iq roster, different for iq version and so on.</p>
</div>
<div class="paragraph">
<p>A plugin provides information about what exact XML element(s) name(s) with xmlns it is interested in. So you can create a plugin which is interested in all packets containing caps child.</p>
</div>
<div class="paragraph">
<p>There might be no plugin for a particular stanza element and then a default actions is used which is simple forwarding stanza to a destination address. There might be also more than one plugin for a specific XML element and then they all process the same stanza simultaneously in separate threads so there is no guarantee on the order in which the stanza is processed by a different plugins.</p>
</div>
<div class="paragraph">
<p>Each stanza goes through the Session Manager component which processes packets in a few steps. Have a look at the picture below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sm-consumer.png" alt="Consumer"></span></p>
</div>
<div class="paragraph">
<p>The picture shows that each stanza is processed by the session manager in 4 steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pre-processing - all loaded pre-processors receive the packet for processing. They work within session manager thread and they have no internal queue for processing. As they work within Session Manager thread it is important that they limit processing time to absolute minimum as they may affect the Session Manager performance The intention for the pre-processors is to allow them for packet blocking. If the pre-processing result is <em>true</em> then the packet is blocked and no further processing is performed.</p>
</li>
<li>
<p>Processing - this is the next step the packet gets through if it wasn&#8217;t blocked by any of the pre-processors. It gets inserted to all processors queues which requested interest in this particular XML element. Each processor works in a separate thread and has own internal fixed size processing queue.</p>
</li>
<li>
<p>If there is no processor for the stanza then the packet goes through all post-processors. The last post-processor in built into session manager post-processor which tries to apply a default action to a packet which hasn&#8217;t been processed in step 2. Normally the default action is just forwarding the packet to a destination. Most commonly it is applied to &lt;message/&gt; packets.</p>
</li>
<li>
<p>Finally, if any of above 3 steps produced output/result packets all of them go through all filters which may or may not block them.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Important thing to note is that we have two kinds or two places where packets may be blocked or filtered out. One place is before packet is processed by the plugin and another place is after processing where filtering is applied to all results generated by the processor plugins.</p>
</div>
<div class="paragraph">
<p>It is also important to note that session manager and processor plugins act as packet consumers. The packet is taken for processing and once processing is finished the packet is destroyed. Therefore to forward a packet to a destination one of the processor must create a copy of the packet, set all properties and attributes and return it as a processing result. Of course processor can generate any number of packets as a result. Result packets can be generated in any of above 4 steps of the processing. Have a look at the picture below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/user-sends-to-comp.png" alt="User Send to Comp"></span></p>
</div>
<div class="paragraph">
<p>If the packet P1 is send outside of the server, for example to a user on another server or to some component (MUC, PubSub, transport) then one of the processor must create a copy P2 of the packet and set all attributes and destination addresses correctly. Packet P1 has been consumed by the session manager during processing and a new packet has been generated by one of the plugins.</p>
</div>
<div class="paragraph">
<p>The same of course happens on the way back from the component to the user:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comp-sends-to-user.png" alt="Comp Sends to User"></span></p>
</div>
<div class="paragraph">
<p>The packet from the component is processed and one of the plugins must generate a copy of the packet to deliver it to the user. Of course packet forwarding is a default action which is applied when there is no plugin for the particular packet.</p>
</div>
<div class="paragraph">
<p>It is implemented this way because the input packet P1 can be processed by many plugins at the same time therefore the packet should be in fact immutable and must not change once it got to the session manager for processing.</p>
</div>
<div class="paragraph">
<p>The most obvious processing workflow is when a user sends request to the server and expects a response from the server:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/user-request-response.png" alt="User Request Response"></span></p>
</div>
<div class="paragraph">
<p>This design has one surprising consequence though. If you look at the picture below showing communication between 2 users you can see that the packet is copied twice before it is delivered to a final destination:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/user-sends-to-user.png" alt="User Sends to User"></span></p>
</div>
<div class="paragraph">
<p>The packet has to be processed twice by the session manager. The first time it is processed on behalf of the User A as an outgoing packet and the second time it is processed on behalf of the User B as an incoming packet.</p>
</div>
<div class="paragraph">
<p>This is to make sure the User A has permission to send a packet out and all processing is applied to the packet and also to make sure that User B has permission to receive the packet and all processing is applied. If, for example, the User B is offline there is offline message processor which should put the packet to a database.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="wpc"><a class="anchor" href="#wpc"></a>17. Writing Plugin Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>Previous guide describes a basic idea behind the XMPP stanza processing in the session manager. As it was already point out the processing takes place in 4 steps. A different kind of plugin is responsible for each step of processing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPreprocessorIfc.java">XMPPPreprocessorIfc</a> - is the interface for packets pre-processing plugins.</p>
</li>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPProcessor.java">XMPPProcessorIfc</a> - is the interface for packets processing plugins.</p>
</li>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPostprocessorIfc.java">XMPPPostprocessorIfc</a> - is the interface for packets post-processing plugins.</p>
</li>
<li>
<p><a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPacketFilterIfc.java">XMPPPacketFilterIfc</a> - is the interface for processing results filtering.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you look inside any of these interfaces you find only a single method. This is it. This is where all the packet processing takes place. All of them take a similar set of parameters and below is a description for all of them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Packet packet</strong> - packet is which being processed. This parameter may never be null. Even though this is not immutable object it mustn&#8217;t be altered. None of it&#8217;s fields or attributes can be changed during processing.</p>
</li>
<li>
<p><strong>XMPPResourceConnection session</strong> - user session which keeps all the user session data and also gives an access to the user&#8217;s repository data. It allows for storing information in a permanent storage or in memory only during the live of the online session. This parameter can be null if there is no online user session at the time of the packet processing.</p>
</li>
<li>
<p><strong>NonAuthUserRepository repo</strong> - this is a user data storage which is normally used when the user session (parameter above) is null. This is repository allows for a very restricted access only. It allows for storing some user private data (doesn&#8217;t allow overwriting existing data) like messages for offline users and it also allows for reading user public data like VCard.</p>
</li>
<li>
<p><strong>Queue&lt;Packet&gt; results</strong> - this a collection with packets which have been generated as input packet processing results. Regardless a response to a user request is sent or the packet is forwarded to it&#8217;s destination it is always required that a copy of the input packet is created and stored in the <strong>results</strong> queue.</p>
</li>
<li>
<p><strong>Map&lt;String, Object&gt; settings</strong> - this map keeps plugin specific settings loaded from the Tigase server configuration. In most cases it is unused, however if the plugin needs to access an external database that this is a way to pass database connection string to the plugin.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After a closer look in some of the interfaces you can see that they extend another interface: <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPImplIfc.java">XMPPImplIfc</a> which provides a basic meta information about the plugin implementation. Please refer to JavaDoc documentation for all details.</p>
</div>
<div class="paragraph">
<p>For purpose of this guide we are implementing a simple plugin handling all <strong>&lt;message/&gt;</strong> packets, that is forwarding packets to the destination address. Incoming packets are forwarded to the user connection and outgoing packets are forwarded to the external destination address. This <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/impl/Message.java">message plugin</a> is actually implemented already and it is available in our Git repository. The code has some comments inside already but this guide goes deeper into the implementation details.</p>
</div>
<div class="paragraph">
<p>First of all you have to chose what kind of plugin you want to implement. If this is going to be a packet processor you have to implement <strong>XMPPProcessorIfc</strong> interface, if this is going to be pre-processor then you have to implement <strong>XMPPPreprocessorIfc</strong> interface. Of course your implementation can implement more than one interface, even all. It depends on your use case and needs. There are also two abstract helper classes from which you should use one as a base for all you plugins <strong>XMPPProcessor</strong> or <strong>AnnotatedXMPPProcessor</strong> for annotation support.</p>
</div>
<div class="sect2">
<h3 id="_using_annotation_support"><a class="anchor" href="#_using_annotation_support"></a>17.1. Using annotation support</h3>
<div class="paragraph">
<p>The class declaration should look like this (assuming you implement just packet processor):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Message</span> <span class="directive">extends</span> AnnotatedXMPPProcessor
   <span class="directive">implements</span> XMPPProcessorIfc</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing to create is the plugin <strong>ID</strong>. This is a unique string which you put in the configuration file to tell the server to load and use the plugin. In most cases you can use XMLNS if the plugin wants packets with elements with a very specific name space. Of course there is no guarantee there is no other packet for this specific XML element too. As I want to process all messages and I don&#8217;t want to spend whole day on thinking about a cool ID let&#8217;s say our ID is: 'message'.</p>
</div>
<div class="paragraph">
<p>A plugin informs about it&#8217;s using static <strong>ID</strong> field and <strong>@Id</strong> annotation placed on class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>(ID)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Message</span> <span class="directive">extends</span> AnnotatedXMPPProcessor
   <span class="directive">implements</span> XMPPProcessorIfc {
  <span class="directive">protected</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ID = <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned before such a plugin receives only this kind of packets for processing which it is interested in. My plugin is interested only in packets with <strong>&lt;message/&gt;</strong> elements and only if they are in "<strong>jabber:client</strong>" namespace. To indicate all supported elements and namespaces we have to add 2 more annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>(ID)
<span class="annotation">@Handles</span>({
  <span class="annotation">@Handle</span>(path={ <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> },xmlns=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:client</span><span class="delimiter">&quot;</span></span>)
})
<span class="directive">public</span> <span class="type">class</span> <span class="class">Message</span> <span class="directive">extends</span> AnnotatedXMPPProcessor
   <span class="directive">implements</span> XMPPProcessorIfc {
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ID = <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_older_non_annotation_based_implementation"><a class="anchor" href="#_using_older_non_annotation_based_implementation"></a>17.2. Using older non-annotation based implementation</h3>
<div class="paragraph">
<p>The class declaration should look like this (assuming you implement just packet processor):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">Message</span> <span class="directive">extends</span> XMPPProcessor
   <span class="directive">implements</span> XMPPProcessorIfc</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first thing to create is the plugin <strong>ID</strong>. This is a unique string which you put in the configuration file to tell the server to load and use the plugin. In most cases you can use XMLNS if the plugin wants packets with elements with a very specific name space. Of course there is no guarantee there is no other packet for this specific XML element too. As I want to process all messages and I don&#8217;t want to spend whole day on thinking about a cool ID let&#8217;s say our ID is: 'message'.</p>
</div>
<div class="paragraph">
<p>A plugin informs about it&#8217;s ID using following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ID = <span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>;
<span class="directive">public</span> <span class="predefined-type">String</span> id() { <span class="keyword">return</span> ID; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>As I mentioned before such a plugin receives only this kind of packets for processing which it is interested in. My plugin is interested only in packets with <strong>&lt;message/&gt;</strong> elements and only if they are in "<strong>jabber:client</strong>" namespace. To indicate all supported elements and namespaces we have to add 2 more methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">String</span><span class="type">[]</span> supElements() {
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>};
}

<span class="directive">public</span> <span class="predefined-type">String</span><span class="type">[]</span> supNamespaces()        {
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">String</span><span class="type">[]</span> {<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:client</span><span class="delimiter">&quot;</span></span>};
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementation_of_processing_method"><a class="anchor" href="#_implementation_of_processing_method"></a>17.3. Implementation of processing method</h3>
<div class="paragraph">
<p>Now we have our plugin prepared for loading it to the Tigase server. The next step is the actual packet processing method. For the complete code, please refer to the plugin in the Git. I will only comment here on elements which might be confusing or add a few more lines of code which might be helpful in your case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
43
44
45
46
47
48
49
<strong>50</strong>
51
52
53
54
55
56
57
58
59
<strong>60</strong>
61
62
63
64
65
66
67
68
69
<strong>70</strong>
71
72
73
74
75
76
77
78
79
<strong>80</strong>
81
82
83
84
85
86
87
88
89
<strong>90</strong>
91
</pre></td>
  <td class="code"><pre><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> process(Packet packet, XMPPResourceConnection session,
        NonAuthUserRepository repo, <span class="predefined-type">Queue</span>&lt;Packet&gt; results, <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; settings)
        <span class="directive">throws</span> XMPPException {

        <span class="comment">// For performance reasons it is better to do the check</span>
        <span class="comment">// before calling logging method.</span>
        <span class="keyword">if</span> (log.isLoggable(<span class="predefined-type">Level</span>.FINEST)) {
                log.log(<span class="predefined-type">Level</span>.FINEST, <span class="string"><span class="delimiter">&quot;</span><span class="content">Processing packet: {0}</span><span class="delimiter">&quot;</span></span>, packet);
        }

        <span class="comment">// You may want to skip processing completely if the user is offline.</span>
        <span class="keyword">if</span> (session == <span class="predefined-constant">null</span>) {
                <span class="keyword">return</span>;
        }    <span class="comment">// end of if (session == null)</span>

        <span class="keyword">try</span> {

                <span class="comment">// Remember to cut the resource part off before comparing JIDs</span>
                BareJID id = (packet.getStanzaTo() != <span class="predefined-constant">null</span>) ? packet.getStanzaTo().getBareJID() : <span class="predefined-constant">null</span>;

                <span class="comment">// Checking if this is a packet TO the owner of the session</span>
                <span class="keyword">if</span> (session.isUserId(id)) {

                        <span class="comment">// Yes this is message to 'this' client</span>
                        Packet result = packet.copyElementOnly();

                        <span class="comment">// This is where and how we set the address of the component</span>
                        <span class="comment">// which should rceive the result packet for the final delivery</span>
                        <span class="comment">// to the end-user. In most cases this is a c2s or Bosh component</span>
                        <span class="comment">// which keep the user connection.</span>
                        result.setPacketTo(session.getConnectionId(packet.getStanzaTo()));

                        <span class="comment">// In most cases this might be skept, however if there is a</span>
                        <span class="comment">// problem during packet delivery an error might be sent back</span>
                        result.setPacketFrom(packet.getTo());

                        <span class="comment">// Don't forget to add the packet to the results queue or it</span>
                        <span class="comment">// will be lost.</span>
                        results.offer(result);

                        <span class="keyword">return</span>;
                }    <span class="comment">// end of else</span>

                <span class="comment">// Remember to cut the resource part off before comparing JIDs</span>
                id = (packet.getStanzaFrom() != <span class="predefined-constant">null</span>) ? packet.getStanzaFrom().getBareJID() : <span class="predefined-constant">null</span>;

                <span class="comment">// Checking if this is maybe packet FROM the client</span>
                <span class="keyword">if</span> (session.isUserId(id)) {

                        <span class="comment">// This is a packet FROM this client, the simplest action is</span>
                        <span class="comment">// to forward it to is't destination:</span>
                        <span class="comment">// Simple clone the XML element and....</span>
                        <span class="comment">// ... putting it to results queue is enough</span>
                        results.offer(packet.copyElementOnly());

                        <span class="keyword">return</span>;
                }

                <span class="comment">// Can we really reach this place here?</span>
                <span class="comment">// Yes, some packets don't even have from or to address.</span>
                <span class="comment">// The best example is IQ packet which is usually a request to</span>
                <span class="comment">// the server for some data. Such packets may not have any addresses</span>
                <span class="comment">// And they usually require more complex processing</span>
                <span class="comment">// This is how you check whether this is a packet FROM the user</span>
                <span class="comment">// who is owner of the session:</span>
                JID jid = packet.getFrom();

                <span class="comment">// This test is in most cases equal to checking getElemFrom()</span>
                <span class="keyword">if</span> (session.getConnectionId().equals(jid)) {

                        <span class="comment">// Do some packet specific processing here, but we are dealing</span>
                        <span class="comment">// with messages here which normally need just forwarding</span>
                        <span class="predefined-type">Element</span> el_result = packet.getElement().clone();

                        <span class="comment">// If we are here it means FROM address was missing from the</span>
                        <span class="comment">// packet, it is a place to set it here:</span>
                        el_result.setAttribute(<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span>, session.getJID().toString());

                        Packet result = Packet.packetInstance(el_result, session.getJID(),
                                packet.getStanzaTo());

                        <span class="comment">// ... putting it to results queue is enough</span>
                        results.offer(result);
                }
        } <span class="keyword">catch</span> (NotAuthorizedException e) {
                log.warning(<span class="string"><span class="delimiter">&quot;</span><span class="content">NotAuthorizedException for packet: </span><span class="delimiter">&quot;</span></span> + packet);
                results.offer(Authorization.NOT_AUTHORIZED.getResponseMessage(packet,
                                <span class="string"><span class="delimiter">&quot;</span><span class="content">You must authorize session first.</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>));
        }    <span class="comment">// end of try-catch</span>
}</pre></td>
</tr></table></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pluginconf"><a class="anchor" href="#pluginconf"></a>18. Plugin Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>Plugin configuration is not very straightforward at the moment but we are going to change it soon.</p>
</div>
<div class="paragraph">
<p>At the moment the best and the simplest way to tell the Tigase server to load or not to load the plugin is via <code>init.properties</code> file. Property <code>--sm-plugins</code> takes a comma separated list of plugin <strong>IDs</strong> to active at the runtime. Please refer to the documentation for complete description.</p>
</div>
<div class="paragraph">
<p>Obviously you have to know the list of standard plugin IDs to add your to the set. There are 2 ways to find out the list. One is the log file: logs/tigase-console.log. If you look inside you can find following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Loading plugin: jabber:iq:register ...
Loading plugin: jabber:iq:auth ...
Loading plugin: urn:ietf:params:xml:ns:xmpp-sasl ...
Loading plugin: urn:ietf:params:xml:ns:xmpp-bind ...
Loading plugin: urn:ietf:params:xml:ns:xmpp-session ...
Loading plugin: roster-presence ...
Loading plugin: jabber:iq:privacy ...
Loading plugin: jabber:iq:version ...
Loading plugin: http://jabber.org/protocol/stats ...
Loading plugin: starttls ...
Loading plugin: vcard-temp ...
Loading plugin: http://jabber.org/protocol/commands ...
Loading plugin: jabber:iq:private ...
Loading plugin: urn:xmpp:ping ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>and this is a list of plugins which are loaded in your installation.</p>
</div>
<div class="paragraph">
<p>Another way is to look inside the session manager source code which has the default list hardcoded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> PLUGINS_FULL_PROP_VAL =
  {<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:register</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:auth</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">urn:ietf:params:xml:ns:xmpp-sasl</span><span class="delimiter">&quot;</span></span>,
   <span class="string"><span class="delimiter">&quot;</span><span class="content">urn:ietf:params:xml:ns:xmpp-bind</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">urn:ietf:params:xml:ns:xmpp-session</span><span class="delimiter">&quot;</span></span>,
   <span class="string"><span class="delimiter">&quot;</span><span class="content">roster-presence</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:privacy</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:version</span><span class="delimiter">&quot;</span></span>,
   <span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/stats</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">starttls</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">msgoffline</span><span class="delimiter">&quot;</span></span>,
   <span class="string"><span class="delimiter">&quot;</span><span class="content">vcard-temp</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:private</span><span class="delimiter">&quot;</span></span>,
   <span class="string"><span class="delimiter">&quot;</span><span class="content">urn:xmpp:ping</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">basic-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">domain-filter</span><span class="delimiter">&quot;</span></span>};</code></pre>
</div>
</div>
<div class="paragraph">
<p>In any way you have to put the list and your plugin IDs as a value to the plugin list property. Let&#8217;s say our plugin ID is '<strong>message</strong>' as in our all examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"> --sm-plugins=jabber:iq:register,jabber:iq:auth,......,message</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming your plugin class is in the classpath it will be loaded and used at the runtime.</p>
</div>
<div class="paragraph">
<p>There is another part of the plugin configuration though. If you looked at the Writing Plugin Code guide you can remember <strong>Map settings</strong> processing parameter. This is a map of properties you can set in the configuration file and these setting will be passed to the plugin at the processing time.</p>
</div>
<div class="paragraph">
<p>Again <strong>init.properties</strong> is the place to put the stuff. This kind of properties start with a string: <strong>sess-man/plugins-conf/</strong>, then you add your <strong>plugin ID</strong> and at the end and follow it with key and value pair for your setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/pluginID/key1=val1
sess-man/plugins-conf/pluginID/key2=val2
sess-man/plugins-conf/pluginID/key3=val3</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is possible to provide settings for a few plugins withing one configuration string by specifying <strong>multiple pluginIDs</strong> separated with a comma,
i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/plugin1,plugin2,plugin3/key1=val1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will make key/pair setting available only to listed plugins, in above case plugin1, plugin2 and plugin3.</p>
</div>
<div class="paragraph">
<p>Last but not least - in case you have <strong>omitted plugin ID</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/key1=val1</code></pre>
</div>
</div>
<div class="paragraph">
<p>then the configured key-value pair will be a global/common plugin setting available to all loaded plugins.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="componentdevelpoment"><a class="anchor" href="#componentdevelpoment"></a>19. Component Development</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>A component in the Tigase is an entity with own JID address. It can receive packets, can process them and can also generate packets.</p>
</div>
<div class="paragraph">
<p>An example of the best known components is MUC or PubSub. In the Tigase server, however, almost everything is actually a component: Session Manager, s2s connections manager, Message Router, etc&#8230;&#8203;. Components are loaded based on the server configuration, new components can be loaded and activated at the server run-time. You can easily replace a component implementation and the only change to make is a class name in the configuration entry.</p>
</div>
<div class="paragraph">
<p>Creating components for the Tigase server is an essential part of the server development hence there is a lot of useful API and ready to use code available. This guide should help you to get familiar with the API and how to quickly and efficiently create own component implementations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Component implementation - Lesson 1 - Basics</p>
</li>
<li>
<p>Component implementation - Lesson 2 - Configuration</p>
</li>
<li>
<p>Component implementation - Lesson 3 - Multi-Threading</p>
</li>
<li>
<p>Component implementation - Lesson 4 - Service Discovery</p>
</li>
<li>
<p>Component implementation - Lesson 5 - Statistics</p>
</li>
<li>
<p>Component implementation - Lesson 6 - Scripting Support</p>
</li>
<li>
<p>Component implementation - Lesson 7 - Data Repository</p>
</li>
<li>
<p>Component implementation - Lesson 8 - Startup Time</p>
</li>
<li>
<p>Configuration API</p>
</li>
<li>
<p>Packet Filtering in Component</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil1"><a class="anchor" href="#cil1"></a>20. Component Implementation - Lesson 1 - Basics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Creating a Tigase component is actually very simple and with broad API available you can create a powerful component with just a few lines of code. You can find detailed API description elsewhere. This series presents hands on lessons with code examples, teaching how to get desired results in the simplest possible code using existing Tigase API.</p>
</div>
<div class="paragraph">
<p>Even though all Tigase components are just implementations of <strong>ServerComponent</strong> interface I will keep such a low level information to necessary minimum. Creating a new component based on just interfaces, while very possible, is not very effective. This guide intends to teach you how to make use of all what is already there, ready to use with a minimal coding effort.</p>
</div>
<div class="paragraph">
<p>This is just the first lesson of the series where I cover basics of the component implementation.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s get started and create the Tigase component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
</pre></td>
  <td class="code"><pre><span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log = <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    log.finest(<span class="string"><span class="delimiter">&quot;</span><span class="content">My packet: </span><span class="delimiter">&quot;</span></span> + packet.toString());
  }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>The only element mandatory when you extend <strong>AbstractMessageReceiver</strong> is the implementation of <strong>void processPacket(Packet packet)</strong> method. This is actually logical as the main task for your component is processing packets. Class name for our new component is <strong>TestComponent</strong> and we have also initialised a separated logger for this class. This is actually very useful as it allows us to easily find log entries created by our class.</p>
</div>
<div class="paragraph">
<p>With these a few lines of code you have a fully functional Tigase component which can be loaded to the Tigase server, can receive and process packets, shows as an element on service discovery list (for administrators only), responds to administrator ad-hoc commands, supports scripting, generates statistics, can be deployed as an external component and a few other things.</p>
</div>
<div class="paragraph">
<p>Before we go any further with the implementation let&#8217;s set the component in the Tigase server so it is loaded next time the server starts.
Assuming our <strong>init.properties</strong> file looks like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
</pre></td>
  <td class="code"><pre>config-type = --gen-config-def
--debug = server
--user-db = derby
--admins = admin<span class="annotation">@devel</span>.tigase.org
--user-db-uri = jdbc:derby:/Tigase/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-<span class="integer">1</span> = muc
--comp-<span class="type">class</span>-<span class="integer">1</span> = <span class="class">tigase</span>.muc.MUCComponent
--comp-name-<span class="integer">2</span> = pubsub
--comp-<span class="type">class</span>-<span class="integer">2</span> = <span class="class">tigase</span>.pubsub.PubSubComponent</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see that it already is configured to load two other components: <strong>MUC</strong> and <strong>PubSub</strong>. Let&#8217;s add third - our new component to the configuration file by appending two following lines in the properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
</pre></td>
  <td class="code"><pre>--comp-name-<span class="integer">3</span> = test
--comp-<span class="type">class</span>-<span class="integer">3</span> = <span class="class">TestComponent</span></pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have to remove the <strong>etc/tigase.xml</strong> file and restart the server.</p>
</div>
<div class="paragraph">
<p>There are a few ways to check whether our component has been loaded to the server. Probably the easiest is to connect to the server from administrator account and look at the service discovery list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service-disco-test-comp-admin-300.png" alt="service-disco-test-comp-admin-300"></span></p>
</div>
<div class="paragraph">
<p>If everything goes well you should see an entry on the list similar to highlighted on the screenshot. The component description is "<em>Undefined description</em>" which is a default description and we can change it later on, the component default JID is: <strong>test@devel.tigase.org</strong>, where <strong>devel.tigase.org</strong> is the server domain and test is the component name.</p>
</div>
<div class="paragraph">
<p>Another way to find out if the component has been loaded is by looking at log files. Actually getting yourself familiar with Tigase log files will be very useful thing if you plan on developing Tigase components. So let&#8217;s look at the log file <strong>logs/tigase.log.0</strong>, if the component has been loaded you should find following lines in the log:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">MessageRouter.setProperties() FINER: Loading and registering message receiver: test
MessageRouter.addRouter() INFO: Adding receiver: TestComponent
MessageRouter.addComponent() INFO: Adding component: TestComponent
MessageRouter.addComponent() FINER: Adding: test component to basic-conf registrator.
Configurator.componentAdded() CONFIG:  component: test</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your component did not load you should first check configuration files. Maybe you forgot to remove the <strong>tigase.xml</strong> file before restarting the server or alternatively the Tigase could not find your class at startup time. Make sure your class is in <strong>CLASSPATH</strong> or copy a JAR file with your class to Tigase <strong>libs/</strong> directory.</p>
</div>
<div class="paragraph">
<p>Assuming everything went well and your component is loaded by the Tigase sever and it shows on the service discovery list as on the screenshot above you can double click on it to get a window with a list of ad-hoc commands - administrator scripts. A window on the screenshot shows only two basic commands for adding and removing script which is a good start.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/commands-list-test-200.png" alt="commands-list-test-200"></span></p>
</div>
<div class="paragraph">
<p>Moreover, you can browse the server statistics in the service discovery window to find your new test component on the list. If you click on the component it shows you a window with component statistics, very basic packets counters.</p>
</div>
<div class="paragraph">
<p>iThu Jun 19 14:45:56 2014mage:images/service-disco-stats-200.png[]</p>
</div>
<div class="paragraph">
<p>As we can see with just a few lines of code our new component is quite mighty and can do a lot of things without much effort from the developer side.</p>
</div>
<div class="paragraph">
<p>Now, the time has come to the most important question. Can our new component do something useful, that is can it receive and process XMPP packets?</p>
</div>
<div class="paragraph">
<p>Let&#8217;s try it out. Using you favourite client send a message to JID: <strong>test@devel.tigase.org</strong> (assuming your server is configured for <strong>devel.tigase.org</strong> domain). You can either use kind of XML console in your client or just send a plain message to the component JID. According to our code in <strong>processPacket(&#8230;&#8203;)</strong> method it should log our message. For this test I have sent a message with subject: "<em>test message</em>" and body: "<em>this is a test</em>". The log file should contain following entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">TestComponent.processPacket() FINEST: My packet: to=null, from=null,
data=&lt;message from=&quot;admin@devel.tigase.org/devel&quot;
  to=&quot;test@devel.tigase.org&quot; id=&quot;abcaa&quot; xmlns=&quot;jabber:client&quot;&gt;
  &lt;subject&gt;test message&lt;/subject&gt;
  &lt;body&gt;this is a test&lt;/body&gt;
&lt;/message&gt;, XMLNS=jabber:client, priority=NORMAL</code></pre>
</div>
</div>
<div class="paragraph">
<p>If this is a case we can be sure that everything works as expected and all we now have to do is to fill the <strong>processPacket(&#8230;&#8203;)</strong> method with some useful code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil2"><a class="anchor" href="#cil2"></a>21. Component Implementation - Lesson 2 - Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>It might be hard to tell what is the first important thing to do with your new component implementation. Different developers may have a different view on this. It seems to me however that it is always a good idea to give to your component a way to configure it and provide some runtime settings.</p>
</div>
<div class="paragraph">
<p>This guide describes how to add configuration handling to your component.  There is detailed Configuration API description available so again I am not getting deep into all details just the necessary code.</p>
</div>
<div class="paragraph">
<p>To demonstrate how to maintain the component configuration let&#8217;s say we want to make configurable types of packets which are being logged by the component. There are three possible packet types: '<strong>message</strong>\', '<strong>presence</strong>' and '<strong>iq</strong>' and we want to be able to configure logging of any combination of them. Furthermore we also want to be able to configure the text which is prepended to the logged message and optionally switch the secure logging on. (Secure logging replaces all packet CData with text: '<em>CData size: NN</em>' to protect user privacy.)</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create following private variables in our component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> packetTypes = {<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">presence</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">iq</span><span class="delimiter">&quot;</span></span>};
<span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">My packet: </span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the component configuration is maintained in a form of (<em>key, value</em>) Map we have to invent keys for each of our configuration entry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PACKET_TYPES_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">packet-types</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two methods used to maintain the component configuration: <code>getDefaults(&#8230;&#8203;)</code> where the component provides some configuration defaults and <code>setProperties(&#8230;&#8203;)</code> which sets working configuration for the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
</pre></td>
  <td class="code"><pre><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
  <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
  defs.put(PACKET_TYPES_KEY, packetTypes);
  defs.put(PREPEND_TEXT_KEY, prependText);
  defs.put(SECURE_LOGGING_KEY, secureLogging);
  <span class="keyword">return</span> defs;
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
  <span class="local-variable">super</span>.setProperties(props);
  <span class="keyword">if</span> (props.get( PACKET_TYPES_KEY ) != <span class="predefined-constant">null</span> ) {
    packetTypes = (<span class="predefined-type">String</span><span class="type">[]</span>) props.get( PACKET_TYPES_KEY );
  }
  <span class="keyword">if</span> (props.get( PREPEND_TEXT_KEY ) != <span class="predefined-constant">null</span> ) {
    prependText = (<span class="predefined-type">String</span>) props.get( PREPEND_TEXT_KEY );
  }
  <span class="keyword">if</span> (props.get( SECURE_LOGGING_KEY ) != <span class="predefined-constant">null</span> ) {
    secureLogging = (<span class="predefined-type">Boolean</span>) props.get( SECURE_LOGGING_KEY );
  }
}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>You do not have to implement <code>getDefaults(&#8230;&#8203;)</code> method and provide default settings for your configuration but doing so gives you a few benefits.</p>
</div>
<div class="paragraph">
<p>The first, from the developer point of view, you don&#8217;t have to check in the <code>setProperties(&#8230;&#8203;)</code> whether the value is of a correct type or convert it from String to the correct type as it always be either the default or user provided. It will be of a correct type as the configuration framework takes care of the types comparing between the user provided settings and default values. So this just makes your <code>setProperties(&#8230;&#8203;)</code> code much simpler and clearer.</p>
</div>
<div class="paragraph">
<p>Please note that currently Tigase allows changing properties atomically hence you should check each time if given property was updated at the given call of <code>setProperties()</code>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/test-comp-config-list-smaller.png" alt="test-comp-config-list-smaller"></span></p>
</div>
<div class="paragraph">
<p>Secondly this also makes the administrator live easier. As you can see on the screenshot, configuration parameters provided with default values, can be changed via configuration ad-hoc commands. So the administrator can maintain your component at run-time from his XMPP client.</p>
</div>
<div class="paragraph">
<p>Regardless you implemented the <code>getDefaults(&#8230;&#8203;)</code> method or not you can always manually add parameters to the <code>init.properties</code> file.</p>
</div>
<div class="paragraph">
<p>The syntax in <code>init.properties</code> file is actually very simple and is described in details in the <em>Admin Guide</em>. As it shows on the screenshot the configuration parameter name consists of: <em><em>component name</em> + /  + <em>property key</em></em>. To set configuration for your component in <code>init.properties</code> file you have to append following lines to the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">test/log-prepend=&quot;My packet: &quot;
test/packet-types[s]=message,presence,iq
test/secure-logging[B]=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>In square brackets you provide the property type, have a look at the <em>Admin Guide</em> documentation for more details.</p>
</div>
<div class="paragraph">
<p>And this is the complete code of the new component with modified <code>processPacket(&#8230;&#8203;)</code> method taking advantage of configuration settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
8
9
<strong>10</strong>
11
12
13
14
15
16
17
18
19
<strong>20</strong>
21
22
23
24
25
26
27
28
29
<strong>30</strong>
31
32
33
34
35
36
37
38
39
<strong>40</strong>
41
42
43
44
45
46
47
48
49
<strong>50</strong>
51
52
53
54
55
56
</pre></td>
  <td class="code"><pre><span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log =
    <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PACKET_TYPES_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">packet-types</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> packetTypes = {<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">presence</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">iq</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">My packet: </span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    <span class="keyword">for</span> (<span class="predefined-type">String</span> pType : packetTypes) {
      <span class="keyword">if</span> (pType == packet.getElemName()) {
        log.finest(prependText + packet.toString(secureLogging));
      }
    }
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
    defs.put(PACKET_TYPES_KEY, packetTypes);
    defs.put(PREPEND_TEXT_KEY, prependText);
    defs.put(SECURE_LOGGING_KEY, secureLogging);
    <span class="keyword">return</span> defs;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
    <span class="local-variable">super</span>.setProperties(props);
    <span class="keyword">if</span> (props.get( PACKET_TYPES_KEY ) != <span class="predefined-constant">null</span> ) {
      packetTypes = (<span class="predefined-type">String</span><span class="type">[]</span>) props.get( PACKET_TYPES_KEY );
    }
    <span class="comment">// Make sure we can compare element names by reference</span>
    <span class="comment">// instead of String content</span>
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; packetTypes.length; i++) {
      packetTypes[i] = packetTypes[i].intern();
    }
    <span class="keyword">if</span> (props.get( PREPEND_TEXT_KEY ) != <span class="predefined-constant">null</span> ) {
      prependText = (<span class="predefined-type">String</span>) props.get( PREPEND_TEXT_KEY );
    }
    <span class="keyword">if</span> (props.get( SECURE_LOGGING_KEY ) != <span class="predefined-constant">null</span> ) {
      secureLogging = (<span class="predefined-type">Boolean</span>) props.get( SECURE_LOGGING_KEY );
    }
  }

}</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course we can do much more useful packet processing in <code>processPacket(&#8230;&#8203;)</code> method. This is just a code example. Please note comparing packet element name with our packet type by reference is intentional and allowed in this context. All <strong>Element</strong> names are processed with <code>String.intern()</code> function to preserve memory and improve performance of string comparison.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil3"><a class="anchor" href="#cil3"></a>22. Component Implementation - Lesson 3 - Multi-Threading</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Multi core and multi CPU machines are nowadays very common. Especially for the application like the XMPP server you most likely deploy your service on a server with a few cores or even a few CPUs. Your new component however processes all packets in a single thread.</p>
</div>
<div class="paragraph">
<p>This is especially important if the packet processing is CPU expensive like, for example, SPAM checking. In such a case you could experience single Core/CPU usage at 100% while other Cores/CPUs are idling. Ideally, you want your component to use all available CPUs.</p>
</div>
<div class="paragraph">
<p>The Tigase API offers a very simple way to execute component&#8217;s <code>processPacket(Packet packet)</code> method in multiple threads. Methods <code>int processingOutThreads()</code> and <code>int processingInThreads()</code> returns number of threads assigned to the component. By default it returns just <em>1</em> as not all component implementations are prepared to process packets concurrently. By overwriting the method you can return any value you think is appropriate for the implementation. Please note, there are two methods, one is for a number of threads for incoming packets to the component and another for outgoing packets from the component. It used to be a single method but different components have different needs and the best performance can be achieved when the outgoing queues have a separate threads pool from incoming queues. Also some components only receive packets while other only send, therefore assigning an equal number of threads for both could be a waste of resources.</p>
</div>
<div class="paragraph">
<p>If the packet processing is CPU bound only, you normally want to have as many threads as there are CPUs available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">int</span> processingInThreads() {
  <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
}
<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">int</span> processingOutThreads() {
  <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the processing is I/O bound (network or database) you probably want to have much more threads to process requests. It is hard to guess ideal number of threads, instead you should run a few tests to see what exact number is best for the component implementation.</p>
</div>
<div class="paragraph">
<p>Now you have many threads for processing your packets. There is one slight problem with this, however. In many cases packets order is essential. If our <code>processPacket(&#8230;&#8203;)</code> method is executed concurrently by a few threads it is quite possible that a message sent to user can takeover the message sent earlier. Especially if the first message was large and the second was small. We can prevent this by adjusting method responsible for packets distribution among threads.</p>
</div>
<div class="paragraph">
<p>The algorithm for packets distribution among threads is very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> thread_idx = hashCodeForPacket(packet) % threads_total;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So the key here is <code>hashCodeForPacket(&#8230;&#8203;)</code> method. By overwriting it we can make sure that all packets addressed to the same user will always be processed by the same thread:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">int</span> hashCodeForPacket(Packet packet) {
  <span class="keyword">if</span> (packet.getElemTo() != <span class="predefined-constant">null</span>) {
    <span class="keyword">return</span> packet.getElemTo().hashCode();
  }
  <span class="comment">// This should not happen, every packet must have a destination</span>
  <span class="comment">// address, but maybe our SPAM checker is used for checking</span>
  <span class="comment">// strange kind of packets too....</span>
  <span class="keyword">if</span> (packet.getElemFrom() != <span class="predefined-constant">null</span>) {
    <span class="keyword">return</span> packet.getElemFrom().hashCode();
  }
  <span class="comment">// If this really happens on your system you should look</span>
  <span class="comment">// carefully at packets arriving to your component and</span>
  <span class="comment">// find a better way to calculate hashCode</span>
  <span class="keyword">return</span> <span class="integer">1</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above two methods give a control over the number of threads assigned to the packets processing in your component and to the packets distribution among threads. This is not all the Tigase API has to offer in terms of multi-threading.</p>
</div>
<div class="paragraph">
<p>Sometimes you want to perform some periodic actions. You can of course create Timer instance and load it with TimerTasks but as there might be a need for this on every level of the Class hierarchy you could end-up with multiple Timer (threads in fact) objects doing similar job and using resources. There are a few methods which allow you to reuse common Timer object to perform all sorts of actions.</p>
</div>
<div class="paragraph">
<p>First, you have three methods allowing your to perform some periodic actions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everySecond();
<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute();
<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyHour();</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example implementation for periodic notifications sent to some address could look like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute() {
  <span class="local-variable">super</span>.everyMinute();
  <span class="keyword">if</span> ((++delayCounter) &gt;= notificationFrequency) {
    addOutPacket(Packet.getMessage(abuseAddress, getComponentId(),
      StanzaType.chat, <span class="string"><span class="delimiter">&quot;</span><span class="content">Detected spam messages: </span><span class="delimiter">&quot;</span></span> + spamCounter,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam counter</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, newPacketId(<span class="string"><span class="delimiter">&quot;</span><span class="content">spam-</span><span class="delimiter">&quot;</span></span>)));
    delayCounter = <span class="integer">0</span>;
    spamCounter = <span class="integer">0</span>;
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This method sends every '<strong>notificationFrequency</strong>' minutes a message to '<strong>abuseAddress</strong>' reporting how many spam messages have been detected during last period. Please note, you have to call <code>super.everyMinute()</code> to make sure other actions are executed as well and you have to also remember to keep processing in this method to minimum, especially if you overwrite <code>everySecond()</code> method.</p>
</div>
<div class="paragraph">
<p>There are also two methods which allow you to schedule tasks executed at certain time, they are very similar to the <code>java.util.Timer</code> API with the only difference is that Timer is reused among all levels of Class hierarchy. There is a separate <code>Timer</code> for each Class instance though, to avoid interferences between separate components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">addTimerTask(<span class="predefined-type">TimerTask</span> task, <span class="type">long</span> delay, <span class="predefined-type">TimeUnit</span> unit);
addTimerTask(<span class="predefined-type">TimerTask</span> task, <span class="type">long</span> delay);</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one more method which can be overwritten which is not directly related to multi-threading but might be very helpful for executing some actions at a very specific point of time. This is the point of time when the server has just been initialised, that is all components have been created and received their configuration for the first time. When this happens the Tigase calls <code>void initializationCompleted()</code> method for each server component. You can overwrite this method to execute some actions at the time when you are sure the the Tigase server has started and is fully functional.</p>
</div>
<div class="paragraph">
<p>And here is a code of an example component which uses all the API discussed in this article:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;
<span class="keyword">import</span> <span class="include">tigase.util.JIDUtils</span>;
<span class="keyword">import</span> <span class="include">tigase.xmpp.StanzaType</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log =
    <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">bad-words</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITELIST_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">white-list</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ABUSE_ADDRESS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse-address</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NOTIFICATION_FREQ_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">notification-freq</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> badWords = {<span class="string"><span class="delimiter">&quot;</span><span class="content">word1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word3</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> whiteList = {<span class="string"><span class="delimiter">&quot;</span><span class="content">admin@localhost</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam detected: </span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="predefined-type">String</span> abuseAddress = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse@locahost</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="type">int</span> notificationFrequency = <span class="integer">10</span>;
  <span class="directive">private</span> <span class="type">int</span> delayCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;
  <span class="directive">private</span> <span class="type">long</span> spamCounter = <span class="integer">0</span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    <span class="comment">// Is this packet a message?</span>
    <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> == packet.getElemName()) {
      <span class="predefined-type">String</span> from = JIDUtils.getNodeID(packet.getElemFrom());
      <span class="comment">// Is sender on the whitelist?</span>
      <span class="keyword">if</span> (<span class="predefined-type">Arrays</span>.binarySearch(whiteList, from) &lt; <span class="integer">0</span>) {
        <span class="comment">// The sender is not on whitelist so let's check the content</span>
        <span class="predefined-type">String</span> body = packet.getElemCData(<span class="string"><span class="delimiter">&quot;</span><span class="content">/message/body</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (body != <span class="predefined-constant">null</span> &amp;&amp; !body.isEmpty()) {
          body = body.toLowerCase();
          <span class="keyword">for</span> (<span class="predefined-type">String</span> word : badWords) {
            <span class="keyword">if</span> (body.contains(word)) {
              log.finest(prependText + packet.toString(secureLogging));
              ++spamCounter;
              <span class="keyword">return</span>;
            }
          }
        }
      }
    }
    <span class="comment">// Not a SPAM, return it for further processing</span>
    Packet result = packet.swapFromTo();
    addOutPacket(result);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> processingInThreads() {
    <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> processingOutThreads() {
    <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> hashCodeForPacket(Packet packet) {
    <span class="keyword">if</span> (packet.getElemTo() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemTo().hashCode();
    }
    <span class="comment">// This should not happen, every packet must have a destination</span>
    <span class="comment">// address, but maybe our SPAM checker is used for checking</span>
    <span class="comment">// strange kind of packets too....</span>
    <span class="keyword">if</span> (packet.getElemFrom() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemFrom().hashCode();
    }
    <span class="comment">// If this really happens on your system you should look carefully</span>
    <span class="comment">// at packets arriving to your component and decide a better way</span>
    <span class="comment">// to calculate hashCode</span>
    <span class="keyword">return</span> <span class="integer">1</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
    defs.put(BAD_WORDS_KEY, badWords);
    defs.put(WHITELIST_KEY, whiteList);
    defs.put(PREPEND_TEXT_KEY, prependText);
    defs.put(SECURE_LOGGING_KEY, secureLogging);
    defs.put(ABUSE_ADDRESS_KEY, abuseAddress);
    defs.put(NOTIFICATION_FREQ_KEY, notificationFrequency);
    <span class="keyword">return</span> defs;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
    <span class="local-variable">super</span>.setProperties(props);
    badWords = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(BAD_WORDS_KEY);
    whiteList = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(WHITELIST_KEY);
    <span class="predefined-type">Arrays</span>.sort(whiteList);
    prependText = (<span class="predefined-type">String</span>)props.get(PREPEND_TEXT_KEY);
    secureLogging = (<span class="predefined-type">Boolean</span>)props.get(SECURE_LOGGING_KEY);
    abuseAddress = (<span class="predefined-type">String</span>)props.get(ABUSE_ADDRESS_KEY);
    notificationFrequency = (<span class="predefined-type">Integer</span>)props.get(NOTIFICATION_FREQ_KEY);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute() {
    <span class="local-variable">super</span>.everyMinute();
    <span class="keyword">if</span> ((++delayCounter) &gt;= notificationFrequency) {
      addOutPacket(Packet.getMessage(abuseAddress, getComponentId(),
        StanzaType.chat, <span class="string"><span class="delimiter">&quot;</span><span class="content">Detected spam messages: </span><span class="delimiter">&quot;</span></span> + spamCounter,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam counter</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, newPacketId(<span class="string"><span class="delimiter">&quot;</span><span class="content">spam-</span><span class="delimiter">&quot;</span></span>)));
      delayCounter = <span class="integer">0</span>;
      spamCounter = <span class="integer">0</span>;
    }
  }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil4"><a class="anchor" href="#cil4"></a>23. Component Implementation - Lesson 4 - Service Discovery</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>You component still shows in the service discovery list as an element with "<em>Undefined description</em>". It doesn&#8217;t also provide any interesting features or sub-nodes.</p>
</div>
<div class="paragraph">
<p>In this article I will show how, in a simple way, change the basic component information presented on the service discovery list, how to add some service disco features. As a bit more advanced feature the guide will teach you about adding/removing service discovery nodes at run-time and about updating existing elements.</p>
</div>
<div class="paragraph">
<p>Component description and category type can be changed by overwriting two following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getDiscoDescription() {
  <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam filtering</span><span class="delimiter">&quot;</span></span>;
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getDiscoCategoryType() {
  <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note, there is no such category type like '<strong>spam</strong>' defined in the <a href="http://xmpp.org/registrar/disco-categories.html">Service Discovery Identities registry</a>. It has been used here as a demonstration only. Please refer to the document mentioned above for a list of categories and types and pick the one most suitable to you.</p>
</div>
<div class="paragraph">
<p>After you added two above methods and restarted the server with updated code have a look at the service discovery window. You should see something like on the screenshot.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/spam-filtering-disco-small.png" alt="spam-filtering-disco-small"></span></p>
</div>
<div class="paragraph">
<p>This was easy but just this particular change doesn&#8217;t affect anything apart from just a visual appearance. Let&#8217;s get then to more advanced and more useful changes.</p>
</div>
<div class="paragraph">
<p>One of the limitations of methods above is that you can not update or change component information at run-time with these methods. They are called only once during <code>setProperties(&#8230;&#8203;)</code> method call and the component service discovery information is created and prepared for later use. Sometimes, however it is very useful to be able to change the service discovery at run-time.</p>
</div>
<div class="paragraph">
<p>In our simple spam filtering component let&#8217;s show how many messages have been checked out as part of the service discovery description string. Every time we receive a message we can to call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>,
  getDiscoDescription() + <span class="string"><span class="delimiter">&quot;</span><span class="content">: [</span><span class="delimiter">&quot;</span></span> +
  (++messagesCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>A small performance note, in some cases calling '<code>updateServiceDiscoveryItem(&#8230;&#8203;)</code>' might be an expensive operation so probably a better idea would be to call the method not every time we receive a message but maybe every 100 times or so.</em></p>
</div>
<div class="paragraph">
<p>The first parameter is the component JID presented on the service discovery list. However, the Tigase server may work for many virtual hosts so the hostname part is added by the lower level functions and we only provide the component name here. The second parameter is the service discovery node which is usually <em><strong>null</strong></em> for top level disco elements. Third is the item description (which is actually called <em>name</em> in the disco specification). The last parameter specifies if the element is visible to administrators only.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/spam-filter-counter-small.png" alt="spam-filter-counter-small"></span></p>
</div>
<div class="paragraph">
<p>The complete method code is presented below and screenshot above shows how the element of the service discovery for our component can change if we apply our code and send a few messages to the component.</p>
</div>
<div class="paragraph">
<p>Using the method we can also add submodes to our component element. The XMPP service discovery really is not for showing application counters, but this use case is good enough to demonstrate the API available in the Tigase server so we continue with presenting our counters via service discovery. This time, instead of using <em>null</em> as a node we put some meaningful texts as in example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// This is called whenever a message arrives</span>
<span class="comment">// to the component</span>
updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">messages</span><span class="delimiter">&quot;</span></span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">Messages processed: [</span><span class="delimiter">&quot;</span></span> + (++messagesCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
<span class="comment">// This is called every time the component detects</span>
<span class="comment">// spam message</span>
updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam caught: [</span><span class="delimiter">&quot;</span></span> +
  (++totalSpamCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, have a look at the full method body below for a complete code example. Now if we send a few messages to the component and some of them are spam (contain words recognised as spam) we can browse the service discovery of the server. Your service discovery should show a list similar to the one presented on the screenshot on the left.</p>
</div>
<div class="paragraph">
<p>Of course, depending on the implementation, initially there might be no sub-nodes under our component element if we call the '<code>updateServiceDiscoveryItem(&#8230;&#8203;)</code>' method only when a message is processed. To make sure that sub-nodes of our component show from the very beginning you can call them in '<code>setProperties(&#8230;&#8203;)</code>' for the first time to populate the service discovery with initial sub-nodes.</p>
</div>
<div class="paragraph">
<p>Please note, the '<code>updateServiceDiscoveryItem(&#8230;&#8203;)</code>' method is used for adding a new item and updating existing one. There is a separate method though to remove the item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> removeServiceDiscoveryItem(<span class="predefined-type">String</span> jid,
  <span class="predefined-type">String</span> node, <span class="predefined-type">String</span> description)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Actually only two first parameters are important: the '<strong>jid</strong>' and the '<strong>node</strong>' which must correspond to the existing, previously created service discovery item.</p>
</div>
<div class="paragraph">
<p>There are two additional variants of the 'update' method which give you more control over the service discovery item created. Items can be of different categories and types and can also present a set of features.</p>
</div>
<div class="paragraph">
<p>The simpler is a variant which sets set of features for the updated service discovery item. There is a <a href="http://xmpp.org/registrar/disco-features.html">document</a> describing existing, registered features. We are creating an example which is going to be spam filter and there is no predefined feature for spam filtering but for purpose of this guide we can invent two feature identification strings and set it for our component. Let&#8217;s call '<code>update</code>' method with following parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>, getDiscoDescription(),
  <span class="predefined-constant">true</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-reporting</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The best place to call this method is the '<code>setProperties(&#8230;&#8203;)</code>' method so our component gets a proper service discovery settings at startup time. We have set two features for the component disco: 'tigase:x:spam-filter' and 'tigase:x:spam-reporting'. The method accepts variable set of arguments so we can pass to it as many features as we need or following Java spec we can just pass an array of <strong>Strings</strong>.</p>
</div>
<div class="paragraph">
<p>Update your code with call presented above, and restart the server. Have a look at the service discovery for the component now.</p>
</div>
<div class="paragraph">
<p>The last functionality might be not very useful for our case of the spam filtering component but it is for many other cases like MUC, PubSub which is setting proper category and type for the service discovery item. There is a document listing all currently registered service discovery identities (categories and types). Again there is entry for spam filtering. Let&#8217;s use the <em><em>automation</em></em> category and <em><em>spam-filter</em></em> type and set it for our component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>, getDiscoDescription(),
  <span class="string"><span class="delimiter">&quot;</span><span class="content">automation</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">spam-filtering</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>,
  <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-reporting</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course all these setting can be applied to any service discovery create or update, including sub-nodes. And here is a complete code of the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;
<span class="keyword">import</span> <span class="include">tigase.util.JIDUtils</span>;
<span class="keyword">import</span> <span class="include">tigase.xmpp.StanzaType</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log =
    <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">bad-words</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITELIST_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">white-list</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ABUSE_ADDRESS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse-address</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NOTIFICATION_FREQ_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">notification-freq</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> badWords = {<span class="string"><span class="delimiter">&quot;</span><span class="content">word1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word3</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> whiteList = {<span class="string"><span class="delimiter">&quot;</span><span class="content">admin@localhost</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam detected: </span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="predefined-type">String</span> abuseAddress = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse@locahost</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="type">int</span> notificationFrequency = <span class="integer">10</span>;
  <span class="directive">private</span> <span class="type">int</span> delayCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;
  <span class="directive">private</span> <span class="type">long</span> spamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> totalSpamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> messagesCounter = <span class="integer">0</span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    <span class="comment">// Is this packet a message?</span>
    <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> == packet.getElemName()) {
      updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">messages</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Messages processed: [</span><span class="delimiter">&quot;</span></span> + (++messagesCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
      <span class="predefined-type">String</span> from = JIDUtils.getNodeID(packet.getElemFrom());
      <span class="comment">// Is sender on the whitelist?</span>
      <span class="keyword">if</span> (<span class="predefined-type">Arrays</span>.binarySearch(whiteList, from) &lt; <span class="integer">0</span>) {
        <span class="comment">// The sender is not on whitelist so let's check the content</span>
        <span class="predefined-type">String</span> body = packet.getElemCData(<span class="string"><span class="delimiter">&quot;</span><span class="content">/message/body</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (body != <span class="predefined-constant">null</span> &amp;&amp; !body.isEmpty()) {
          body = body.toLowerCase();
          <span class="keyword">for</span> (<span class="predefined-type">String</span> word : badWords) {
            <span class="keyword">if</span> (body.contains(word)) {
              log.finest(prependText + packet.toString(secureLogging));
              ++spamCounter;
              updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam caught: [</span><span class="delimiter">&quot;</span></span> +
                (++totalSpamCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
              <span class="keyword">return</span>;
            }
          }
        }
      }
    }
    <span class="comment">// Not a SPAM, return it for further processing</span>
    Packet result = packet.swapElemFromTo();
    addOutPacket(result);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> processingThreads() {
    <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> hashCodeForPacket(Packet packet) {
    <span class="keyword">if</span> (packet.getElemTo() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemTo().hashCode();
    }
    <span class="comment">// This should not happen, every packet must have a destination</span>
    <span class="comment">// address, but maybe our SPAM checker is used for checking</span>
    <span class="comment">// strange kind of packets too....</span>
    <span class="keyword">if</span> (packet.getElemFrom() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemFrom().hashCode();
    }
    <span class="comment">// If this really happens on your system you should look carefully</span>
    <span class="comment">// at packets arriving to your component and decide a better way</span>
    <span class="comment">// to calculate hashCode</span>
    <span class="keyword">return</span> <span class="integer">1</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
    defs.put(BAD_WORDS_KEY, badWords);
    defs.put(WHITELIST_KEY, whiteList);
    defs.put(PREPEND_TEXT_KEY, prependText);
    defs.put(SECURE_LOGGING_KEY, secureLogging);
    defs.put(ABUSE_ADDRESS_KEY, abuseAddress);
    defs.put(NOTIFICATION_FREQ_KEY, notificationFrequency);
    <span class="keyword">return</span> defs;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
    <span class="local-variable">super</span>.setProperties(props);
    badWords = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(BAD_WORDS_KEY);
    whiteList = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(WHITELIST_KEY);
    <span class="predefined-type">Arrays</span>.sort(whiteList);
    prependText = (<span class="predefined-type">String</span>)props.get(PREPEND_TEXT_KEY);
    secureLogging = (<span class="predefined-type">Boolean</span>)props.get(SECURE_LOGGING_KEY);
    abuseAddress = (<span class="predefined-type">String</span>)props.get(ABUSE_ADDRESS_KEY);
    notificationFrequency = (<span class="predefined-type">Integer</span>)props.get(NOTIFICATION_FREQ_KEY);
    updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>, getDiscoDescription(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">automation</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">spam-filtering</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-reporting</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute() {
    <span class="local-variable">super</span>.everyMinute();
    <span class="keyword">if</span> ((++delayCounter) &gt;= notificationFrequency) {
      addOutPacket(Packet.getMessage(abuseAddress, getComponentId(),
        StanzaType.chat, <span class="string"><span class="delimiter">&quot;</span><span class="content">Detected spam messages: </span><span class="delimiter">&quot;</span></span> + spamCounter,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam counter</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, newPacketId(<span class="string"><span class="delimiter">&quot;</span><span class="content">spam-</span><span class="delimiter">&quot;</span></span>)));
      delayCounter = <span class="integer">0</span>;
      spamCounter = <span class="integer">0</span>;
    }
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoDescription() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam filtering</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoCategoryType() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>;
  }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil5"><a class="anchor" href="#cil5"></a>24. Component Implementation - Lesson 5 - Statistics</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>In most cases you want to gather some run-time statistics from your component to see how it works, detect possible performance issues or congestion problems. All the server statistics are exposed and are accessible via XMPP with ad-hoc commands, HTTP, JMX and some selected statistics are also available via SNMP. As a component developer you don&#8217;t have to do anything to expose your statistic via any of above protocols, you just have to provide your statistics and the admin will be able to access them any way he wants.</p>
</div>
<div class="paragraph">
<p>This lesson will teach you how to add your own statistics and how to make sure that the statistics generation doesn&#8217;t affect application performance.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/spam-statitics-small.png" alt="spam-statitics-small"></span></p>
</div>
<div class="paragraph">
<p>Your component from the very beginning generates some statistics by classes it inherits. Let&#8217;s add a few statistics to our spam filtering component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> getStatistics(StatisticsList list) {
  <span class="local-variable">super</span>.getStatistics(list);
  list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam messages found</span><span class="delimiter">&quot;</span></span>, totalSpamCounter, <span class="predefined-type">Level</span>.INFO);
  list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">All messages processed</span><span class="delimiter">&quot;</span></span>, messagesCounter, <span class="predefined-type">Level</span>.FINER);
  <span class="keyword">if</span> (list.checkLevel(<span class="predefined-type">Level</span>.FINEST)) {
    <span class="comment">// Some very expensive statistics generation code...</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think the code should be pretty much self-explanatory.</p>
</div>
<div class="paragraph">
<p>You have to call '<code>super.getStatistics(&#8230;&#8203;)</code>' to update stats of the parent class. StatisticsList is a collection which keeps all the statistics in a way which is easy to update them and search and retrieve. You actually don&#8217;t need to know all the implementation details but if you are interested please refer to the source code and JavaDoc documentation.</p>
</div>
<div class="paragraph">
<p>The first parameter of the '<code>add(&#8230;&#8203;)</code>' method is the component name. All the statistics are grouped by the component names to make it easier to look at particular component data. Next is a description of the element. The third parameter is the element value which can be any number or string.</p>
</div>
<div class="paragraph">
<p>The last parameter is probably the most interesting. The idea has been borrowed from the logging framework. Each statistic item has importance level.  Levels are exactly the same as for logging methods with '<strong>SEVERE</strong>' the most critical and '<strong>FINEST</strong>' the least important. This parameter has been added to improve performance and statistics retrieval. When the '<strong>StatisticsList</strong>' object is created it get&#8217;s assigned a level requested by the user. If '<code>add(&#8230;&#8203;)</code>' method is called with lower priority level then the element is not even added to the list. This saves network bandwidth, improves statistics retrieving speed and is also more clear to present to the end-user.</p>
</div>
<div class="paragraph">
<p>One thing which may be a bit confusing at first is that, if there is a numerical element added to statistics with '<strong>0</strong>' value then the Level is always forced to '<strong>FINEST</strong>'. The assumption is that the administrator is normally not interested <strong>zero-value</strong> statistics, therefore unless he intentionally request the lowest level statistics he won&#8217;t see elements with <strong>zeros</strong>.</p>
</div>
<div class="paragraph">
<p>The '<strong>if</strong>' statement requires some explanation too. Normally adding a new statistics element is not a very expensive operation so passing it with '<code>add(&#8230;&#8203;)</code>' method and appropriate level is enough. Sometimes, however preparing statistics data may be quite expensive, like reading/counting some records from database. Statistics can be collected quite frequently therefore it doesn&#8217;t make sense to collect the statistics at all if there not going to be used as the current level is higher then the item we pass anyway. In such a case it is recommended to test whether the element level will be accepted by the collection and if not skip the whole processing altogether.</p>
</div>
<div class="paragraph">
<p>As you can see, the API for generating and presenting component statistics is very simple and straightforward. Just one method to overwrite and a simple way to pass your own counters. Below is the whole code of the example component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Level</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;
<span class="keyword">import</span> <span class="include">tigase.stats.StatisticsList</span>;
<span class="keyword">import</span> <span class="include">tigase.util.JIDUtils</span>;
<span class="keyword">import</span> <span class="include">tigase.xmpp.StanzaType</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log =
  <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">bad-words</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITELIST_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">white-list</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ABUSE_ADDRESS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse-address</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NOTIFICATION_FREQ_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">notification-freq</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> badWords = {<span class="string"><span class="delimiter">&quot;</span><span class="content">word1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word3</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span><span class="type">[]</span> whiteList = {<span class="string"><span class="delimiter">&quot;</span><span class="content">admin@localhost</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam detected: </span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="predefined-type">String</span> abuseAddress = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse@locahost</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="type">int</span> notificationFrequency = <span class="integer">10</span>;
  <span class="directive">private</span> <span class="type">int</span> delayCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;
  <span class="directive">private</span> <span class="type">long</span> spamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> totalSpamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> messagesCounter = <span class="integer">0</span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    <span class="comment">// Is this packet a message?</span>
    <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> == packet.getElemName()) {
      updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">messages</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Messages processed: [</span><span class="delimiter">&quot;</span></span> + (++messagesCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
      <span class="predefined-type">String</span> from = JIDUtils.getNodeID(packet.getElemFrom());
      <span class="comment">// Is sender on the whitelist?</span>
      <span class="keyword">if</span> (<span class="predefined-type">Arrays</span>.binarySearch(whiteList, from) &lt; <span class="integer">0</span>) {
        <span class="comment">// The sender is not on whitelist so let's check the content</span>
        Stringbody = packet.getElemCData(<span class="string"><span class="delimiter">&quot;</span><span class="content">/message/body</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (body != <span class="predefined-constant">null</span> &amp;&amp; !body.isEmpty()) {
          body = body.toLowerCase();
          <span class="keyword">for</span> (<span class="predefined-type">String</span> word : badWords) {
            <span class="keyword">if</span> (body.contains(word)) {
              log.finest(prependText + packet.toString(secureLogging));
              ++spamCounter;
              updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam caught: [</span><span class="delimiter">&quot;</span></span> +
                (++totalSpamCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
              <span class="keyword">return</span>;
            }
          }
        }
      }
    }
    <span class="comment">// Not a SPAM, return it for further processing</span>
    Packet result = packet.swapElemFromTo();
    addOutPacket(result);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> processingThreads() {
    <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> hashCodeForPacket(Packet packet) {
    <span class="keyword">if</span> (packet.getElemTo() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemTo().hashCode();
    }
    <span class="comment">// This should not happen, every packet must have a destination</span>
    <span class="comment">// address, but maybe our SPAM checker is used for checking</span>
    <span class="comment">// strange kind of packets too....</span>
    <span class="keyword">if</span> (packet.getElemFrom() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemFrom().hashCode();
    }
    <span class="comment">// If this really happens on your system you should look carefully</span>
    <span class="comment">// at packets arriving to your component and decide a better way</span>
    <span class="comment">// to calculate hashCode</span>
    <span class="keyword">return</span> <span class="integer">1</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
    defs.put(BAD_WORDS_KEY, badWords);
    defs.put(WHITELIST_KEY, whiteList);
    defs.put(PREPEND_TEXT_KEY, prependText);
    defs.put(SECURE_LOGGING_KEY, secureLogging);
    defs.put(ABUSE_ADDRESS_KEY, abuseAddress);
    defs.put(NOTIFICATION_FREQ_KEY, notificationFrequency);
    <span class="keyword">return</span> defs;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
    <span class="local-variable">super</span>.setProperties(props);
    badWords = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(BAD_WORDS_KEY);
    whiteList = (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(WHITELIST_KEY);
    <span class="predefined-type">Arrays</span>.sort(whiteList);
    prependText = (<span class="predefined-type">String</span>)props.get(PREPEND_TEXT_KEY);
    secureLogging = (<span class="predefined-type">Boolean</span>)props.get(SECURE_LOGGING_KEY);
    abuseAddress = (<span class="predefined-type">String</span>)props.get(ABUSE_ADDRESS_KEY);
    notificationFrequency = (<span class="predefined-type">Integer</span>)props.get(NOTIFICATION_FREQ_KEY);
    updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>, getDiscoDescription(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">automation</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">spam-filtering</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-reporting</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute() {
    <span class="local-variable">super</span>.everyMinute();
    <span class="keyword">if</span> ((++delayCounter) &gt;= notificationFrequency) {
      addOutPacket(Packet.getMessage(abuseAddress, getComponentId(),
        StanzaType.chat, <span class="string"><span class="delimiter">&quot;</span><span class="content">Detected spam messages: </span><span class="delimiter">&quot;</span></span> + spamCounter,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam counter</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, newPacketId(<span class="string"><span class="delimiter">&quot;</span><span class="content">spam-</span><span class="delimiter">&quot;</span></span>)));
      delayCounter = <span class="integer">0</span>;
      spamCounter = <span class="integer">0</span>;
    }
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoDescription() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam filtering</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoCategoryType() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> getStatistics(StatisticsList list) {
    <span class="local-variable">super</span>.getStatistics(list);
    list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam messages found</span><span class="delimiter">&quot;</span></span>, totalSpamCounter, <span class="predefined-type">Level</span>.INFO);
    list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">All messages processed</span><span class="delimiter">&quot;</span></span>, messagesCounter, <span class="predefined-type">Level</span>.FINE);
    <span class="keyword">if</span> (list.checkLevel(<span class="predefined-type">Level</span>.FINEST)) {
      <span class="comment">// Some very expensive statistics generation code...</span>
    }
  }

}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil6"><a class="anchor" href="#cil6"></a>25. Component Implementation - Lesson 6 - Scripting Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Scripting support is a basic API built-in to the Tigase server and automatically available to any component at no extra cost. This framework, however, can only access existing component variables which are inherited by your code from parent classes. It can not access any data or any structures you added in your component. A little effort is needed to expose some of your data to the scripting API.</p>
</div>
<div class="paragraph">
<p>This guide shows how to extend existing scripting API with your component specific data structures.</p>
</div>
<div class="paragraph">
<p>Integrating your component implementation with the scripting API is as simple as the code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_VAR = <span class="string"><span class="delimiter">&quot;</span><span class="content">badWords</span><span class="delimiter">&quot;</span></span>;
<span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITE_LIST_VAR = <span class="string"><span class="delimiter">&quot;</span><span class="content">whiteList</span><span class="delimiter">&quot;</span></span>;

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> initBindings(Bindings binds) {
  <span class="local-variable">super</span>.initBindings(binds);
  binds.put(BAD_WORDS_VAR, badWords);
  binds.put(WHITE_LIST_VAR, whiteList);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way you expose two the component variables: '<code>badWords</code>' and '<code>whiteList</code>' to scripts under names the same names - two defined constants. You could use different names of course but it is always a good idea to keep things simple, hence we use the same variable names in the component and in the script.</p>
</div>
<div class="paragraph">
<p>This is it, actually, all done. Almost&#8230;&#8203; In our old implementation these two variables are Java arrays of '<strong>String</strong>\'s. Therefore we can only change their elements but we can not add or remove elements from these structures inside the script. This is not very practical and it puts some serious limits on the script&#8217;s code. To overcome this problem I have changed the test component code to keep bad words and whitelist in \'<strong>java.util.Set</strong>' collection. This gives us enough flexibility to manipulate data.</p>
</div>
<div class="paragraph">
<p>As our component is now ready to cooperate with the scripting API, I will demonstrate now how to add remove or change elements of these collections using a script and ad-hoc commands.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/test-comp-newscript.png" alt="test-comp-newscript"></span></p>
</div>
<div class="paragraph">
<p>First, browse the server service discovery and double click on the test component. If you use <a href="http://psi-im.org/">Psi</a> client this should bring to you a new window with ad-hoc commands list. Other clients may present available ad-hoc commands differently.</p>
</div>
<div class="paragraph">
<p>The screenshot below show how this may look like. You have to provide some description for the script and an ID string. We use Groovy in this guide but you can as well use any different scripting language.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/badwords-list-script.png" alt="badwords-list-script"></span></p>
</div>
<div class="paragraph">
<p>Please refer to the Tigase scripting documentation for all the details how to add support for more languages. From the Tigase API point of view it all looks the same. You have to select a proper language from the pull-down list on windows shown on the right. If your preferred language is not on the list, it means it is not installed properly and Tigase couldn&#8217;t detect it.</p>
</div>
<div class="paragraph">
<p>The script to pull a list of current bad words can be as simple as the following Groovy code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">def badw = (java.util.Set)badWords
def result = <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
<span class="keyword">for</span> (s in badw) { result += s + <span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span> }
<span class="keyword">return</span> result</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see from the code, you have to reference your component variables to a variables in your script to make sure a correct type is used. The rest is very simple and is a pure scripting language stuff.</p>
</div>
<div class="paragraph">
<p>Load the script on to the server and execute it. You should receive a new window with a list of all bad words currently used by the spam filter.</p>
</div>
<div class="paragraph">
<p>Below is another simple script which allows updating (adding/removing) bad words from the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">tigase.server.Command</span>
<span class="include">import</span> <span class="include">tigase.server.Packet</span>

<span class="include">def</span> <span class="include">WORDS_LIST_KEY</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">words-list</span><span class="delimiter">&quot;</span></span>
<span class="include">def</span> <span class="include">OPERATION_KEY</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">operation</span><span class="delimiter">&quot;</span></span>
<span class="include">def</span> <span class="include">REMOVE</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Remove</span><span class="delimiter">&quot;</span></span>
<span class="include">def</span> <span class="include">ADD</span> = <span class="string"><span class="delimiter">&quot;</span><span class="content">Add</span><span class="delimiter">&quot;</span></span>
<span class="include">def</span> <span class="include">OPERATIONS</span> = [<span class="include">ADD</span>, <span class="include">REMOVE</span>]

<span class="include">def</span> <span class="include">badw</span> = (<span class="include">java.util.Set</span>)<span class="include">badWords</span>
<span class="include">def</span> <span class="include">Packet</span> <span class="include">p</span> = (<span class="include">Packet</span>)<span class="include">packet</span>
<span class="include">def</span> <span class="include">words</span> = <span class="include">Command.getFieldValue</span>(<span class="include">p</span>, <span class="include">WORDS_LIST_KEY</span>)
<span class="include">def</span> <span class="include">operation</span> = <span class="include">Command.getFieldValue</span>(<span class="include">p</span>, <span class="include">OPERATION_KEY</span>)

<span class="include">if</span> (<span class="include">words</span> == <span class="include">null</span>) {
  <span class="comment">// No data to process, let's ask user to provide</span>
  <span class="comment">// a list of words</span>
  <span class="include">def</span> <span class="include">res</span> = (<span class="include">Packet</span>)<span class="include">p.commandResult</span>(<span class="include">Command.DataType.form</span>)
  <span class="include">Command.addFieldValue</span>(<span class="include">res</span>, <span class="include">WORDS_LIST_KEY</span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Bad words list</span><span class="delimiter">&quot;</span></span>)
  <span class="include">Command.addFieldValue</span>(<span class="include">res</span>, <span class="include">OPERATION_KEY</span>, <span class="include">ADD</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Operation</span><span class="delimiter">&quot;</span></span>,
    (<span class="include">String</span><span class="type">[]</span>)<span class="include">OPERATIONS</span>, (<span class="include">String</span><span class="type">[]</span>)<span class="include">OPERATIONS</span>)
  <span class="include">return</span> <span class="include">res</span>
}

<span class="include">def</span> <span class="include">words_list</span> = <span class="include">words.tokenize</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">,</span><span class="delimiter">&quot;</span></span>)

<span class="include">if</span> (<span class="include">operation</span> == <span class="include">ADD</span>) {
  <span class="include">words_list.each</span> { <span class="include">badw.add</span>(<span class="include">it.trim</span>()) }
  <span class="include">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Words have been added.</span><span class="delimiter">&quot;</span></span>
}

<span class="include">if</span> (<span class="include">operation</span> == <span class="include">REMOVE</span>) {
  <span class="include">words_list.each</span> { <span class="include">badw.remove</span>(<span class="include">it.trim</span>()) }
  <span class="include">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Words have been removed.</span><span class="delimiter">&quot;</span></span>
}

<span class="include">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Unknown operation: </span><span class="delimiter">&quot;</span></span> + <span class="include">operation</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These two scripts are just the beginning. The possibilities are endless and with the simple a few lines of code in your test component you can then extend your application at runtime with scripts doing various things, you can reload scripts, add and remove them extending and modifying functionality as you need. No need to restart the server, no need to recompile the code and you can use whatever scripting language you like.</p>
</div>
<div class="paragraph">
<p>Of course, scripts for whitelist modifications would look exactly the same and it doesn&#8217;t make sense to attach them here.</p>
</div>
<div class="paragraph">
<p>Here is a complete code of the test component with the new method described at the beginning and data structures changed from array of '<strong>String</strong>\'s to Java \'<strong>Set</strong>':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.Arrays</span>;
<span class="keyword">import</span> <span class="include">java.util.Collections</span>;
<span class="keyword">import</span> <span class="include">java.util.Map</span>;
<span class="keyword">import</span> <span class="include">java.util.Set</span>;
<span class="keyword">import</span> <span class="include">java.util.concurrent.CopyOnWriteArraySet</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Level</span>;
<span class="keyword">import</span> <span class="include">java.util.logging.Logger</span>;
<span class="keyword">import</span> <span class="include">javax.script.Bindings</span>;
<span class="keyword">import</span> <span class="include">tigase.server.AbstractMessageReceiver</span>;
<span class="keyword">import</span> <span class="include">tigase.server.Packet</span>;
<span class="keyword">import</span> <span class="include">tigase.stats.StatisticsList</span>;
<span class="keyword">import</span> <span class="include">tigase.util.JIDUtils</span>;
<span class="keyword">import</span> <span class="include">tigase.xmpp.StanzaType</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">TestComponent</span> <span class="directive">extends</span> AbstractMessageReceiver {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> log =
    <span class="predefined-type">Logger</span>.getLogger(TestComponent.class.getName());

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">bad-words</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITELIST_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">white-list</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> PREPEND_TEXT_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">log-prepend</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> SECURE_LOGGING_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">secure-logging</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> ABUSE_ADDRESS_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse-address</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NOTIFICATION_FREQ_KEY = <span class="string"><span class="delimiter">&quot;</span><span class="content">notification-freq</span><span class="delimiter">&quot;</span></span>;

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> BAD_WORDS_VAR = <span class="string"><span class="delimiter">&quot;</span><span class="content">badWords</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> WHITE_LIST_VAR = <span class="string"><span class="delimiter">&quot;</span><span class="content">whiteList</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> INITIAL_BAD_WORDS = {<span class="string"><span class="delimiter">&quot;</span><span class="content">word1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">word3</span><span class="delimiter">&quot;</span></span>};
  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span><span class="type">[]</span> INITIAL_WHITE_LIST = {<span class="string"><span class="delimiter">&quot;</span><span class="content">admin@localhost</span><span class="delimiter">&quot;</span></span>};

  <span class="comment">/**
   * This might be changed in one threads while it is iterated in
   * processPacket(...) in another thread. We expect that changes are very rare
   * and small, most of operations are just iterations.
   */</span>
  <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; badWords = <span class="keyword">new</span> <span class="predefined-type">CopyOnWriteArraySet</span>&lt;<span class="predefined-type">String</span>&gt;();
  <span class="comment">/**
   * This might be changed in one threads while it is iterated in
   * processPacket(...) in another thread. We expect that changes are very rare
   * and small, most of operations are just contains(...).
   */</span>
  <span class="directive">private</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; whiteList = <span class="keyword">new</span> ConcurrentSkipListSet&lt;<span class="predefined-type">String</span>&gt;();
  <span class="directive">private</span> <span class="predefined-type">String</span> prependText = <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam detected: </span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="predefined-type">String</span> abuseAddress = <span class="string"><span class="delimiter">&quot;</span><span class="content">abuse@locahost</span><span class="delimiter">&quot;</span></span>;
  <span class="directive">private</span> <span class="type">int</span> notificationFrequency = <span class="integer">10</span>;
  <span class="directive">private</span> <span class="type">int</span> delayCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">boolean</span> secureLogging = <span class="predefined-constant">false</span>;
  <span class="directive">private</span> <span class="type">long</span> spamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> totalSpamCounter = <span class="integer">0</span>;
  <span class="directive">private</span> <span class="type">long</span> messagesCounter = <span class="integer">0</span>;

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> processPacket(Packet packet) {
    <span class="comment">// Is this packet a message?</span>
    <span class="keyword">if</span> (<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span> == packet.getElemName()) {
      updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">messages</span><span class="delimiter">&quot;</span></span>,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Messages processed: [</span><span class="delimiter">&quot;</span></span> + (++messagesCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
      <span class="predefined-type">String</span> from = JIDUtils.getNodeID(packet.getElemFrom());
      <span class="comment">// Is sender on the whitelist?</span>
      <span class="keyword">if</span> (!whiteList.contains(from)) {
        <span class="comment">// The sender is not on whitelist so let's check the content</span>
        <span class="predefined-type">String</span> body = packet.getElemCData(<span class="string"><span class="delimiter">&quot;</span><span class="content">/message/body</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">if</span> (body != <span class="predefined-constant">null</span> &amp;&amp; !body.isEmpty()) {
          body = body.toLowerCase();
          <span class="keyword">for</span> (<span class="predefined-type">String</span> word : badWords) {
            <span class="keyword">if</span> (body.contains(word)) {
              log.finest(prependText + packet.toString(secureLogging));
              ++spamCounter;
              updateServiceDiscoveryItem(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam caught: [</span><span class="delimiter">&quot;</span></span> +
                (++totalSpamCounter) + <span class="string"><span class="delimiter">&quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>);
              <span class="keyword">return</span>;
            }
          }
        }
      }
    }
    <span class="comment">// Not a SPAM, return it for further processing</span>
    Packet result = packet.swapElemFromTo();
    addOutPacket(result);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> processingThreads() {
    <span class="keyword">return</span> <span class="predefined-type">Runtime</span>.getRuntime().availableProcessors();
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">int</span> hashCodeForPacket(Packet packet) {
    <span class="keyword">if</span> (packet.getElemTo() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemTo().hashCode();
    }
    <span class="comment">// This should not happen, every packet must have a destination</span>
    <span class="comment">// address, but maybe our SPAM checker is used for checking</span>
    <span class="comment">// strange kind of packets too....</span>
    <span class="keyword">if</span> (packet.getElemFrom() != <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> packet.getElemFrom().hashCode();
    }
    <span class="comment">// If this really happens on your system you should look carefully</span>
    <span class="comment">// at packets arriving to your component and decide a better way</span>
    <span class="comment">// to calculate hashCode</span>
    <span class="keyword">return</span> <span class="integer">1</span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
    <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; defs = <span class="local-variable">super</span>.getDefaults(params);
    <span class="predefined-type">Collections</span>.addAll(badWords, INITIAL_BAD_WORDS);
    <span class="predefined-type">Collections</span>.addAll(whiteList, INITIAL_WHITE_LIST);
    defs.put(BAD_WORDS_KEY, INITIAL_BAD_WORDS);
    defs.put(WHITELIST_KEY, INITIAL_WHITE_LIST);
    defs.put(PREPEND_TEXT_KEY, prependText);
    defs.put(SECURE_LOGGING_KEY, secureLogging);
    defs.put(ABUSE_ADDRESS_KEY, abuseAddress);
    defs.put(NOTIFICATION_FREQ_KEY, notificationFrequency);
    <span class="keyword">return</span> defs;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props) {
    <span class="local-variable">super</span>.setProperties(props);
    <span class="predefined-type">Collections</span>.addAll(badWords, (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(BAD_WORDS_KEY));
    <span class="predefined-type">Collections</span>.addAll(whiteList, (<span class="predefined-type">String</span><span class="type">[]</span>)props.get(WHITELIST_KEY));
    prependText = (<span class="predefined-type">String</span>)props.get(PREPEND_TEXT_KEY);
    secureLogging = (<span class="predefined-type">Boolean</span>)props.get(SECURE_LOGGING_KEY);
    abuseAddress = (<span class="predefined-type">String</span>)props.get(ABUSE_ADDRESS_KEY);
    notificationFrequency = (<span class="predefined-type">Integer</span>)props.get(NOTIFICATION_FREQ_KEY);
    updateServiceDiscoveryItem(getName(), <span class="predefined-constant">null</span>, getDiscoDescription(),
      <span class="string"><span class="delimiter">&quot;</span><span class="content">automation</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">spam-filtering</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">true</span>,
      <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-filter</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">tigase:x:spam-reporting</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="directive">synchronized</span> <span class="type">void</span> everyMinute() {
    <span class="local-variable">super</span>.everyMinute();
    <span class="keyword">if</span> ((++delayCounter) &gt;= notificationFrequency) {
      addOutPacket(Packet.getMessage(abuseAddress, getComponentId(),
        StanzaType.chat, <span class="string"><span class="delimiter">&quot;</span><span class="content">Detected spam messages: </span><span class="delimiter">&quot;</span></span> + spamCounter,
        <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam counter</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, newPacketId(<span class="string"><span class="delimiter">&quot;</span><span class="content">spam-</span><span class="delimiter">&quot;</span></span>)));
      delayCounter = <span class="integer">0</span>;
      spamCounter = <span class="integer">0</span>;
    }
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoDescription() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam filtering</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">String</span> getDiscoCategoryType() {
    <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">spam</span><span class="delimiter">&quot;</span></span>;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> getStatistics(StatisticsList list) {
    <span class="local-variable">super</span>.getStatistics(list);
    list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">Spam messages found</span><span class="delimiter">&quot;</span></span>, totalSpamCounter,
      <span class="predefined-type">Level</span>.INFO);
    list.add(getName(), <span class="string"><span class="delimiter">&quot;</span><span class="content">All messages processed</span><span class="delimiter">&quot;</span></span>, messagesCounter,
       <span class="predefined-type">Level</span>.FINE);
    <span class="keyword">if</span> (list.checkLevel(<span class="predefined-type">Level</span>.FINEST)) {
      <span class="comment">// Some very expensive statistics generation code...</span>
    }
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="type">void</span> initBindings(Bindings binds) {
    <span class="local-variable">super</span>.initBindings(binds);
    binds.put(BAD_WORDS_VAR, badWords);
    binds.put(WHITE_LIST_VAR, whiteList);
  }

}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="ConfigurationAPI"><a class="anchor" href="#ConfigurationAPI"></a>25.1. Configuration API</h3>
<div class="sect3">
<h4 id="_introduction_2"><a class="anchor" href="#_introduction_2"></a>25.1.1. Introduction</h4>
<div class="paragraph">
<p>The component configuration API is actually very simple, it consists of two methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params);
<span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; properties);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first method retrieves configuration defaults from the component while the second sets the new configuration for the component. It does look very simple and it is very simple, however there is something more to know about that to use it effectively.</p>
</div>
</div>
<div class="sect3">
<h4 id="_component_startup_sequence"><a class="anchor" href="#_component_startup_sequence"></a>25.1.2. Component Startup Sequence</h4>
<div class="paragraph">
<p>Before we go into all the details it might be very helpful to know the full component initialisation sequence, how the component is brought to life and when the configuration is set. Component loading and starting sequence looks like this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Component class is loaded and a new class instance is created using public constructor with no parameters.</p>
</li>
<li>
<p>Component setName(<code>compName</code>); method is called to set a name for the component. This method is (should) be called only once in the component live time.</p>
</li>
<li>
<p>Component <code>start();</code> method is called which starts all the component internal threads. This method, together with <code>stop();</code> can be called many times to put the component processing on hold or restart processing. The developer should normally not be concerned about these, unless he decided to overwrite these methods.</p>
</li>
<li>
<p>Component <code>getDefaults();</code> method is called to retrieve initial settings for the component. This method is normally called only once in the component life time.</p>
</li>
<li>
<p>User provided configuration is mixed with the component defaults. Settings which the user has provided overwrite existing defaults, leaving the rest unchanged.</p>
</li>
<li>
<p>Component <code>setProperties();</code> is called to set new configuration for the component. This method can be called many times at any point during the component life time.</p>
</li>
<li>
<p>Component <code>initializationCompleted();</code> method is called to notify the component that the global server initialisation has been finished. This method is called only once during the server startup time, after all components have been initialised and configured. This method is mainly used by network connection managers which wait with activating socket listeners until the server is fully functional.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The important thing about all the configuration stuff is that the component does not read/ask/request configuration. <strong>The configuration is pushed to the component by the configuration manager.</strong> The <code>setProperties()</code> method can be called at any time and any number of times while the server is running. This design allows for the server reconfiguration at run-time and developers should be aware of this and properly code the method to allow for the component reconfiguration at run-time.</p>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_api"><a class="anchor" href="#_configuration_api"></a>25.1.3. Configuration API</h4>
<div class="paragraph">
<p>Both API methods operate on Map&lt;String, Object&gt;, hence, essentially the component configuration is just a list of <code>(key, value)</code> pairs. The Object can any of following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>String</p>
</li>
<li>
<p>Integer</p>
</li>
<li>
<p>Long</p>
</li>
<li>
<p>Double</p>
</li>
<li>
<p>Boolean</p>
</li>
<li>
<p>Array of any of above</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is guaranteed that if the component returns a default configuration entry in any of above types, the <code>setProperties()</code> method sets the configuration entry in the same exact type. This is quite convenient as you can limit type conversions (numbers parsing for example) in your code.</p>
</div>
</div>
<div class="sect3">
<h4 id="_getdefaults"><a class="anchor" href="#_getdefaults"></a>25.1.4. getDefaults()</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params);</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>This method is normally called only once, just after the component instance has been created. It is used to get some initial settings from the component and create a default/initial configuration which can be modified by the user. It is recommended that the component returns all possible settings with it&#8217;s default values so they can be presented to the end-user for configuration or diagnostic purposes.  No component initialisation can take place here and the developer can not assume that this method is called only once. Every time this method is called it should return only defaults not the settings set with <code>setProperties()</code>.  The <code>Map&lt;String, Object&gt;</code> params provided as a parameter to this method can contain some <em>hints</em> or <em>pre-initial</em> parameters which can affect generating default configuration. This is because configuration for some components may be complex and can have many different presets or optimisations depending on the use case. These presets can be used to generate proper default configuration.  If the component implementation extends AbstractMessageReceiver then the implementation of the method should always look like this:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; getDefaults(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; params) {
  <span class="predefined-type">Map</span> defs = <span class="local-variable">super</span>.getDefaults(params);
  defs.put(CONF_ENTRY_KEY, conf_entry_val);
  <span class="keyword">return</span> defs;
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setproperties"><a class="anchor" href="#_setproperties"></a>25.1.5. setProperties()</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> setProperties(<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; properties);</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>This method is called to set configuration for the component. It can be called at any time and many times during the server run-time. The configuration will always contain all entries returned by <code>getDefaults</code> method but some of them might be overwritten by user provided settings.  If the component implementation extends <code>AbstractMessageReceiver</code> then the implementation of the method should always look like this:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> setProperties(<span class="predefined-type">Map</span> properties) {
  <span class="local-variable">super</span>.setProperties(properties);
  <span class="type">int</span> conf_entry_val = (<span class="predefined-type">Integer</span>) properties.get(CONF_ENTRY_KEY);
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_useful_presets"><a class="anchor" href="#_useful_presets"></a>25.1.6. Useful Presets</h4>
<div class="paragraph">
<p>Normally configuration presets depend on the component implementation and are different for each component. There are a few presets however which are often used commonly by different components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>test</code> if set it means that the server runs in a test mode, which may mean different things for different components. The component may use this parameter to turn testing mode on.</p>
</li>
<li>
<p><code>admins</code> if set it provides a list of administrator IDs. These user may have special access permissions for the component. They usually can execute administrator ad-hoc commands.</p>
</li>
<li>
<p><code>user-db-uri</code> if set it contains the main database connection string. The component may keep there own data.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_global_configuration_settings"><a class="anchor" href="#_global_configuration_settings"></a>25.1.7. Global Configuration Settings</h4>
<div class="paragraph">
<p>There are some global settings which are provided to all components and can be used by all of them. Usually they point so some shared resources which can be used by all components.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SHARED_USER_REPO_PROP_KEY</code> is a configuration key for the user repository instance. This instance can be shared among components and used to store component data in database as well as access to user data.</p>
<div class="paragraph">
<p>To access the use repository instance you can use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserRepository user_repo;
user_repo = (UserRepository) properties.get(RepositoryFactory.SHARED_USER_REPO_PROP_KEY);</code></pre>
</div>
</div>
</li>
<li>
<p>SHARED_USER_REPO_POOL_PROP_KEY is a configuration key for the user repository pool. In most cases the user repository is just an SQL database. To improve the access to the database a connection pool is created which is realised by creating many UserRepository instances connecting to the same database.</p>
<div class="paragraph">
<p>To access the use repository instance you can use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">UserRepository user_repo;
user_repo = (UserRepository) properties.get(RepositoryFactory.SHARED_USER_REPO_POOL_PROP_KEY);</code></pre>
</div>
</div>
</li>
<li>
<p>SHARED_AUTH_REPO_PROP_KEY is a configuration key for the authentication repository. Components normally do not need access to this repository unless they deal with user authentication and authentication data is kept separately from the rest of the user data.</p>
<div class="paragraph">
<p>To access the use repository instance you can use the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AuthRepository auth_repo;
auth_repo = (AuthRepository) properties.get(RepositoryFactory.SHARED_AUTH_REPO_PROP_KEY);</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="packetfiltering"><a class="anchor" href="#packetfiltering"></a>26. Packet Filtering in Component</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="sect2">
<h3 id="_the_packet_filter_api"><a class="anchor" href="#_the_packet_filter_api"></a>26.1. The Packet Filter API</h3>
<div class="paragraph">
<p>The Tigase server offers an API to filter packets traffic inside every component. You can separately filter incoming and outgoing packets.</p>
</div>
<div class="paragraph">
<p>By filtering we understand intercepting a packet and possibly making some changes to the packet or just blocking the packet completely. By blocking we understand stopping from any further processing and just dropping the packet.</p>
</div>
<div class="paragraph">
<p>The packet filtering is based on the <a href="https://svn.tigase.org/reps/tigase-server/trunk/src/main/java/tigase/server/">PacketFilterIfc</a> interface. Please have a look in the JavaDoc documentation to this interface for all the details. The main filtering method is <code>Packet filter(Packet packet);</code> which takes packets as an input, processes it, possibly alerting the packet content (may add or remove some payloads) and returns a <strong>Packet</strong> for further processing. If it returns <strong>null</strong> it means the packet is blocked and no further processing is permitted otherwise it returns a <strong>Packet</strong> object which is either the same object it received as a parameter or a modified copy of the original object.</p>
</div>
<div class="paragraph">
<p>Please note, although <strong>Packet</strong> object is not unmodifiable instance it is recommended to not make any changes on the existing object. The same <strong>Packet</strong> might be processed at the same time by other components or threads, therefore modification of the <strong>Packet</strong> may lead to unpredictable results.</p>
</div>
<div class="paragraph">
<p>Please refer to an example code in <a href="https://svn.tigase.org/reps/tigase-server/trunk/src/main/java/tigase/server/filters/">PacketCounter</a> which is a very simple filter counting different types of packets. This filter is by default loaded to all components which might be very helpful for assessing traffic shapes on newly deployed installation. You can get counters for all types of packets, where they are generated, where they flow, what component they put the most load on.</p>
</div>
<div class="paragraph">
<p>This is because packet filter can also generate and present own statistics which are accessible via normal statistics monitoring mechanisms. To take advantage of the statistics functionality the packet filter has to implement <code>void getStatistics(StatisticsList list);</code> method. Normally the method can be empty but you can generate and add to the list own statistics from the filter. Please refer to <a href="https://svn.tigase.org/reps/tigase-server/trunk/src/main/java/tigase/server/filters/">PacketCounter</a> for an example implementation code.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration"><a class="anchor" href="#_configuration"></a>26.2. Configuration</h3>
<div class="paragraph">
<p>Packet filters are configurable, that is a list of packet filters can be provided in the Tigase server configuration for each component separately and for each traffic direction. This gives you a great flexibility and control over the data flow inside the Tigase server.</p>
</div>
<div class="paragraph">
<p>You can, for example load specific packet filters to all connections managers to block specific traffic or specific packet source from sending messages to users on your server. You could also reduce the server overall load by removing certain payload from all packets. Possibilities are endless.</p>
</div>
<div class="paragraph">
<p>The default configuration is generated in such a way that each components loads a single packet filter - PacketCounter for each traffic direction:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">message-router/incoming-filters=tigase.server.filters.PacketCounter
message-router/outgoing-filters=tigase.server.filters.PacketCounter
sess-man/incoming-filters=tigase.server.filters.PacketCounter
sess-man/outgoing-filters=tigase.server.filters.PacketCounter
c2s/incoming-filters=tigase.server.filters.PacketCounter
c2s/outgoing-filters=tigase.server.filters.PacketCounter
s2s/incoming-filters=tigase.server.filters.PacketCounter
s2s/outgoing-filters=tigase.server.filters.PacketCounter
bosh/incoming-filters=tigase.server.filters.PacketCounter
bosh/outgoing-filters=tigase.server.filters.PacketCounter
muc/incoming-filters=tigase.server.filters.PacketCounter
muc/outgoing-filters=tigase.server.filters.PacketCounter</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s say you have a packet filter implemented in class: <strong>com.company.SpamBlocker</strong>. You want to disable PacketCounter on most of the components leaving it only in the message router component and you want to install SpamBlocker in all connection managers.</p>
</div>
<div class="paragraph">
<p>Please note, in case of the connection managers <em>incoming</em> and <em>outgoing</em> traffic is probably somehow opposite from what you would normally expect.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'<strong>incoming</strong>' is a traffic which is submitted to a component by message router and has to be further processed. For connection managers this further processing means sending it out to the network.</p>
</li>
<li>
<p>'<strong>outgoing</strong>' is a traffic which is <em>generated</em> by the component and goes out of the component. Such a packet is submitted to message router which then decides where to send it for further processing. For connection managers '<strong>outgoing</strong>' traffic is all the packets just received from the network.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>According to above explanation we have to apply the SpamBlocker filter to all <em>outgoing</em> traffic in all connection managers. At the second thought you may also decide that it might be actually useful to compare traffic shape between Bosh connections and standard XMPP c2s connections. So let&#8217;s leave packet counters for this components too.</p>
</div>
<div class="paragraph">
<p>Here is our new configuration applying SpamBlocker to connection managers and PacketCounter to a few other components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">message-router/incoming-filters=tigase.server.filters.PacketCounter
message-router/outgoing-filters=tigase.server.filters.PacketCounter
sess-man/incoming-filters=
sess-man/outgoing-filters=
c2s/incoming-filters=tigase.server.filters.PacketCounter
c2s/outgoing-filters=tigase.server.filters.PacketCounter,com.company.SpamBlocker
s2s/incoming-filters=
s2s/outgoing-filters=com.company.SpamBlocker
bosh/incoming-filters=tigase.server.filters.PacketCounter
bosh/outgoing-filters=tigase.server.filters.PacketCounter,com.company.SpamBlocker
muc/incoming-filters=
muc/outgoing-filters=</code></pre>
</div>
</div>
<div class="paragraph">
<p>The simplest way, right now to apply the new configuration is via init.properties file which is in details described in the <em>Admin Guide</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil8"><a class="anchor" href="#cil8"></a>27. Component Implementation - Lesson 8 - Startup Time</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2011-05-27 22:52</p>
</div>
<div class="paragraph">
<p>A startup hook in the Tigase is different from the shutdown hook.</p>
</div>
<div class="paragraph">
<p>This is because you cannot really tell when exactly is the startup time. Is it when the application started, is it when configuration is loaded, is it when all objects are initialized. And this might be even different for each component. Therefore, in fact, there is no startup hook in the Tigase in the same sense as the shutdown hook.</p>
</div>
<div class="paragraph">
<p>There are a few methods which are called at startup time in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Constructor</strong> - there is of course constructor which has no parameters.  However it does not guarantee that this instance of the component will be used at all. The object could be created just to call <code>getDefaults(&#8230;&#8203;)</code> and may be destroyed afterwards.</p>
</li>
<li>
<p><strong>void setName(String name)</strong> - the second call for the component is to set it&#8217;s unique name within the Tigase instance. It still does not mean too much from the component run-time point of view but some components initialise service discovery data at this point.</p>
</li>
<li>
<p><strong>void start()</strong> - this is a second which means the component can start it&#8217;s internal jobs or worker threads or whatever it needs for future activity. Component&#8217;s queues and threads are initialised at this point.</p>
</li>
<li>
<p><strong>Map&lt;String, Object&gt; getDefaults(Map params)</strong> - this is the next call made by configuration manager to collect all the default settings for the component. To help generate default settings, configuration manager passes general properties (starting with <em>--</em>) in the Map as parameter to the component. As a result it expects specific settings applicable to the component only (not starting with <em>--</em>).</p>
</li>
<li>
<p><strong>setProperties(Map&lt;String, Object&gt; props)</strong> - after collecting component&#8217;s defaults, the connection manager combines them with configuration options (not starting with <em>--</em>, but starting with the component name) loaded from configuration repository (init.properties file, database, possibly other files). Then the final configuration is passed to the component with <code>setProperties(&#8230;&#8203;)</code> method call. Database connections are usually initialised at this point.</p>
</li>
<li>
<p><strong>void initializationCompleted()</strong> - this method is called for all components after all components are loaded and configuration was set (via <code>setProperties(&#8230;&#8203;)</code> method call) for all components.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Therefore, <code>initializationCompleted()</code> hook is the best point if you want to be sure that the Tigase server is fully loaded, initialised and functional</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cil7"><a class="anchor" href="#cil7"></a>28. Component Implementation - Lesson 7 - Data Repository</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>There are cases when you want to store some data permanently by your component. You can of course use the component configuration to provide some database connection settings, implement your own database connector and store records you need. There is, however, a very simple and useful framework which allows you to read and store some data transparently in either database or disk file. The framework also supports ad-hoc commands interface straight away so you can manipulate your component data using a good XMPP client.</p>
</div>
<div class="paragraph">
<p>This guide will teach you how to create a simple data repository and use it in your component. The repository can be automatically exposed via ad-hoc commands and you can change your data from any XMPP client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="apiVirtualDomain"><a class="anchor" href="#apiVirtualDomain"></a>29. API Description for Virtual Domains Management in the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>The purpose of this guide is to introduce to the vhost management in the Tigase server. Please refer to the JavaDoc documentation for all details. All interfaces are well documented and you can use existing implementation as an example code base and reference point. The VHost management files are located in the SVN repository and you can browse them using the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts">project tracker</a>.</p>
</div>
<div class="paragraph">
<p>Virtual hosts management in the Tigase server can be adjusted in many ways through the flexible API. The core elements of the virtual domains management is interface <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManagerIfc.java">VHostManagerIfc</a> and its implementation <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManager.java">VHostManager</a> class. They are responsible for providing the virtual hosts information to the rest of the Tigase server components. In particular to the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/server/MessageRouter.java">MessageRouter</a> class which controls XMPP packets flow inside the server.</p>
</div>
<div class="paragraph">
<p>The class you most likely want to re-implement is <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostJDBCRepository.java">VHostJDBCRepository</a> used as a default virtual hosts storage and implementing interface <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostRepository.java">VHostRepository</a>. You might need to have your own implementation in order to store and access virtual hosts in other than Tigase own data storage. This is especially important if you are going to modify the virtual domains list through other than Tigase server system.</p>
</div>
<div class="paragraph">
<p>The very basic virtual hosts storage is provided by <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VhostConfigRepository.java">VhostConfigRepository</a> class. This is read only storage and provides the server a bootstrap vhosts data at the first startup time when the database with virtual hosts is empty or is not accessible. Therefore it is advised that all <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VhostConfigRepository.java">VHostRepository</a> implementation extend this class. The example code is provided in the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostJDBCRepository.java">VHostJDBCRepository</a> file.</p>
</div>
<div class="paragraph">
<p>All components which may need virtual hosts information or want to interact with virtual hosts management subsystem should implement <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostListener.java">VHostListener</a> interface. In some cases implementing this interface is also necessary to receive packets for processing.</p>
</div>
<div class="paragraph">
<p>Virtual host information is carried out in 2 forms inside the Tigase server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>As a <code>String</code> value with the domain name</p>
</li>
<li>
<p>As a <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostItem.java">VHostItem</a> which contains all the domain information, including the domain name, maximum number of users for this domain, whether the domain is enabled or disabled and so on. The JavaDoc documentation contains all the details about all available fields and usage.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here is a complete list of all interfaces and classes with a brief description for each of them:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManagerIfc.java">VHostManagerIfc</a> - is an interface used to access virtual hosts information in all other server components. There is one, default implementation of the interface: <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManager.java">VHostManager</a>.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostListener.java">VHostListener</a> - is an interface which allows components to interact with the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManager.java">VHostManager</a>. The interaction is in both ways. The VHostManager provides virtual hosts information to components and components provide some control data required to correctly route packets to components.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostRepository.java">VHostRepository</a> - is an interface used to store and load virtual domains list from the database or any other storage media. There are 2 implementations for this interface: <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VhostConfigRepository.java">VHostConfigRepository</a> which loads vhosts information for the configuration file and provides read-only storage and - <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostJDBCRepository.java">VHostJDBCRepository</a> class which extends <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VhostConfigRepository.java">VHostConfigRepository</a> and allows for both - reading and saving virtual domains list. <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostJDBCRepository.java">VHostJDBCRepository</a> is loaded as a default repository by the Tigase server.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostItem.java">VHostItem</a> - is a class which allows for keeping all the virtual domain properties. Sometimes the domain name is not sufficient for data processing. The domain may be temporarily disabled, may have a limited number of users and so on. Instances of this class keep all the information about the domain which might be needed by the server components.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManager.java">VHostManager</a> - the default implementation of the VHostManagerIfc interface. It provides components with the virtual hosts information and manages the virtual hosts list. Processes ad-hoc commands for reloading, updating and removing domains.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VhostConfigRepository.java">VHostConfirRepository</a> - a very basic implementation of the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostRepository.java">VHostRepository</a> for loading domains list from the configuration file.</p>
</li>
<li>
<p><a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostJDBCRepository.java">VHostJDBCRepository</a> - the default implementation of the <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostRepository.java">VHostRepository</a> loaded by the Tigase server. It allows to read and store virtual domains list in the database accessible through UserRepository.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_experimental"><a class="anchor" href="#_experimental"></a>30. Experimental</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>The guide contains description of non-standard or experimental functionality of the server. Some of them are based on never published extensions, some of them are just test implementation for new ideas or performance improvements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Dynamic Rosters</p>
</li>
<li>
<p>Mobile Optimizations</p>
</li>
<li>
<p>Bosh Session Cache</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="DynamicRosters"><a class="anchor" href="#DynamicRosters"></a>30.1. Dynamic Rosters</h3>
<div class="sect3">
<h4 id="_problem_description"><a class="anchor" href="#_problem_description"></a>30.1.1. Problem Description</h4>
<div class="paragraph">
<p>Normal roster contacts stored created as so called dynamic roster part are delivered to the end user transparently. The XMPP client doesn&#8217;t really know what contacts come from his own <strong>static</strong> roster created manually by the user and what contacts come from <strong>dynamic</strong> roster part that is contacts and groups generated dynamically by the server logic.</p>
</div>
<div class="paragraph">
<p>Some specialized clients need to store extra bits of information about roster contacts. For the normal user <strong>static</strong> roster this extra information can be stored as private data and is available only to the this single user. In some cases however clients need to store information about contacts from the dynamic roster part and this information must be available to all users accessing <strong>dynamic</strong> roster part.</p>
</div>
<div class="paragraph">
<p>The protocol defined here allows exchanging information, saving and retrieving extra data about the contacts.</p>
</div>
</div>
<div class="sect3">
<h4 id="_syntax_and_semantics"><a class="anchor" href="#_syntax_and_semantics"></a>30.1.2. Syntax and Semantics</h4>
<div class="paragraph">
<p>Extra contact data is accessed using IQ stanzas, specifically by means of a  child element qualified by the '<strong>jabber:iq:roster-dynamic</strong>' namespace. The  child element MAY contain one or more  children, each describing a unique contact item. Content of the  element is not specified and is implementation dependent. From the Tigase server point of view it can contain any valid XML data. Whole  element is passed to the DynamicRoster? implementation class as is and without any verification. Upon retrieving the contact extra data the DynamicRoster? implementation is supposed to provide a valid XML  element with all the required data for requested '<strong>jid</strong>'.</p>
</div>
<div class="paragraph">
<p>The '<strong>jid</strong>' attribute specifies the Jabber Identifier (JID) that uniquely identifies the roster item. Inclusion of the '<strong>jid</strong>' attribute is <strong>REQUIRED</strong>.</p>
</div>
<div class="paragraph">
<p>Following actions on the extra contact data are allowed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'<strong>set</strong>' - stores extra information about the contact</p>
</li>
<li>
<p>'<strong>get</strong>' - retrieves extra information about the contact</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_retrieving_contact_data"><a class="anchor" href="#_retrieving_contact_data"></a>30.1.3. Retrieving Contact Data</h4>
<div class="paragraph">
<p>Upon connecting to the server and becoming an active resource, a client can request the contact extra data. This request can be made either after or before requesting the user roster. The client&#8217;s request for the extra contact data is <strong>OPTIONAL</strong>.</p>
</div>
<div class="paragraph">
<p>Example: Client requests contact extra data from the server using '<strong>get</strong>' request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">get</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">rce_1</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">'</span><span class="content">jabber:iq:roster-dynamic</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">archimedes@eureka.com</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: Client receives contact extra data from the server, but there were either no extra information for the user or the user was not found in the dynamic roster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">result</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">rce_1</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">'</span><span class="content">jabber:iq:roster-dynamic</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">archimedes@eureka.com</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Example: Client receives contact extra data from the server, and there was some extra information found about the contact:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">result</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">rce_1</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">'</span><span class="content">jabber:iq:roster-dynamic</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">archimedes@eureka.com</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;phone&gt;</span>+12 3234 322342<span class="tag">&lt;/phone&gt;</span>
<span class="tag">&lt;note&gt;</span>This is short note about the contact<span class="tag">&lt;/note&gt;</span>
<span class="tag">&lt;fax&gt;</span>+98 2343 3453453<span class="tag">&lt;/fax&gt;</span>
<span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_updating_saving_extra_information_about_the_contact"><a class="anchor" href="#_updating_saving_extra_information_about_the_contact"></a>30.1.4. Updating/Saving Extra Information About the Contact</h4>
<div class="paragraph">
<p>At any time, a client <strong>MAY</strong> update contact extra information on the server.</p>
</div>
<div class="paragraph">
<p>Example: Client sends contact extra information using '<strong>set</strong>' request.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">set</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">a78b4q6ha463</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">'</span><span class="content">jabber:iq:roster-dynamic</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">archimedes@eureka.com</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;phone&gt;</span>+22 3344 556677<span class="tag">&lt;/phone&gt;</span>
<span class="tag">&lt;note&gt;</span>he is a smart guy, he knows whether the crown is made from pure gold or not.<span class="tag">&lt;/note&gt;</span>
<span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Client responds to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">result</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">a78b4q6ha463</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A client <strong>MAY</strong> update contact extra information for more than a single item in one request:</p>
</div>
<div class="paragraph">
<p>Example: Client sends contact extra information using '<strong>set</strong>' request with many <code>&lt;item/&gt;</code> elements.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">set</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">a78b4q6ha464</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">'</span><span class="content">jabber:iq:roster-dynamic</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">archimedes@eureka.com</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;phone&gt;</span>+22 3344 556677<span class="tag">&lt;/phone&gt;</span>
<span class="tag">&lt;note&gt;</span>he is a smart guy, he knows whether the crown is made from pure gold or not.<span class="tag">&lt;/note&gt;</span>
<span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">newton@eureka.com</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;phone&gt;</span>+22 3344 556688<span class="tag">&lt;/phone&gt;</span>
<span class="tag">&lt;note&gt;</span>He knows how heavy I am.<span class="tag">&lt;/note&gt;</span>
<span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;item</span> <span class="attribute-name">jid</span>=<span class="string"><span class="delimiter">'</span><span class="content">pascal@eureka.com</span><span class="delimiter">'</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;phone&gt;</span>+22 3344 556699<span class="tag">&lt;/phone&gt;</span>
<span class="tag">&lt;note&gt;</span>This guy helped me cure my sickness!<span class="tag">&lt;/note&gt;</span>
<span class="tag">&lt;/item&gt;</span>
<span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Client responds to the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">'</span><span class="content">result</span><span class="delimiter">'</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">'</span><span class="content">a78b4q6ha464</span><span class="delimiter">'</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>30.1.5. Configuration</h4>
<div class="paragraph">
<p>DynamicRoster implementation class should be configured in the <strong>init.properties</strong> file. As it&#8217;s an extension to the <strong>Presence</strong> and <strong>Roster</strong> plugins class should be configured either for both plugins:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/jabber\:iq\:roster/dynamic-roster-classes=&lt;class list&gt;
sess-man/plugins-conf/presence/dynamic-roster-classes=&lt;classes list&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>or globally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/dynamic-roster-classes=&lt;classes list&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>&lt;classes list&gt;</strong> is a comma separated list of classes.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mobileoptimizations"><a class="anchor" href="#mobileoptimizations"></a>31. Mobile Optimizations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andrzej Wojcik &lt;<a href="mailto:andrzejw@tigase.org">andrzejw@tigase.org</a>&gt;
v2.1, January 2015: Added info about MobileV3
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2012-05-22 17:57</p>
</div>
<div class="sect2">
<h3 id="_problem_description_2"><a class="anchor" href="#_problem_description_2"></a>31.1. Problem Description</h3>
<div class="paragraph">
<p>In default configuration stanzas are sent to client when processing is finished, but in mobile environment sending or receiving data drains battery due to use of radio.</p>
</div>
<div class="paragraph">
<p>To save energy data should be sent to client only if it is important or client is waiting for it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_solution"><a class="anchor" href="#_solution"></a>31.2. Solution</h3>
<div class="paragraph">
<p>When mobile client is entering inactive state it notifies server about it by sending following stanza:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xx</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;mobile</span>
  <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://tigase.org/protocol/mobile#v3</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">enable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After receiving stanza server starts queueing stanza which should be send to mobile client. Kind of queued stanzas depends on used plugin and in case of <strong>Mobile v3</strong> presence stanzas are queued as well as message stanzas which are Message Carbons. Any other stanza (such as iq or plain messenge) is sent immediately to the client and every stanza from queue is also sent at this time.</p>
</div>
<div class="paragraph">
<p>When mobile client is entering active state it notifies server by sending following stanza:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xx</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
<span class="tag">&lt;mobile</span>
  <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://tigase.org/protocol/mobile#v3</span><span class="delimiter">&quot;</span></span>
  <span class="attribute-name">enable</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After receiving stanza server sends all queued stanzas to the client.</p>
</div>
<div class="paragraph">
<p>Also all stanzas from queue will be sent if number of stanzas in queue will reach queue size limit. By default this limit is set to 50.</p>
</div>
</div>
<div class="sect2">
<h3 id="_queueing_algorithms"><a class="anchor" href="#_queueing_algorithms"></a>31.3. Queueing Algorithms</h3>
<div class="paragraph">
<p>There are three mobile optimization plugins for Tigase:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Mobile v1</strong> - all presence stanzas are kept in queue</p>
</li>
<li>
<p><strong>Mobile v2</strong> - only last presence from each source is kept in queue</p>
</li>
<li>
<p><strong>Mobile v3</strong> - only last presence from each source is kept in queue, also Message Carbons are queued</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you wish to activate you Mobile v1 plugin you need to send presented above with xmlns attribute value replaced with <em><a href="http://tigase.org/protocol/mobile#v1" class="bare">http://tigase.org/protocol/mobile#v1</a></em></p>
</div>
<div class="paragraph">
<p>If you wish to activate you Mobile v2 plugin you need to send presented above with xmlns attribute value replaced with <em><a href="http://tigase.org/protocol/mobile#v2" class="bare">http://tigase.org/protocol/mobile#v2</a></em></p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_3"><a class="anchor" href="#_configuration_3"></a>31.4. Configuration</h3>
<div class="paragraph">
<p>Mentioned plugins are not activated by default thus additional entries in the init.properties are required:</p>
</div>
<div class="paragraph">
<p>+--sm-plugins=+mobile_v1,+mobile_v2,+mobile_v3</p>
</div>
<div class="paragraph">
<p><strong>Only one of this plugins should be enabled</strong></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="boshsessioncache"><a class="anchor" href="#boshsessioncache"></a>32. Bosh Session Cache</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="sect2">
<h3 id="_problem_description_3"><a class="anchor" href="#_problem_description_3"></a>32.1. Problem Description</h3>
<div class="paragraph">
<p>Web clients have no way to store any data locally, on the client side. Therefore after a web page reload the web clients loses all the context it was running in before the page reload.</p>
</div>
<div class="paragraph">
<p>Some elements of the context can be retrieved from the server like the roster and all contacts presence information. Some other data however can not be restored easily like opened chat windows and the chat windows contents. Even if the roster restoring is possible, this operation is very expensive in terms of time and resources on the server side.</p>
</div>
<div class="paragraph">
<p>On of possible solutions is to allow web client to store some data in the Bosh component cache on the server side for the time while the Bosh session is active. After the page reload, if the client can somehow retrieve SID (stored in cookie or provided by the web application running the web client) it is possible to reload all the data stored in the Bosh cache to the client.</p>
</div>
<div class="paragraph">
<p>Bosh session context data are: roster, contacts presence information, opened chat windows, chat windows content and some other data not known at the moment. Ideally the web client should be able to store any data in the Bosh component cache it wants.</p>
</div>
</div>
<div class="sect2">
<h3 id="_bosh_session_cache_description"><a class="anchor" href="#_bosh_session_cache_description"></a>32.2. Bosh Session Cache Description</h3>
<div class="paragraph">
<p>The Bosh Session Cache is divided into 2 parts - automatic cache and dynamic cache.</p>
</div>
<div class="paragraph">
<p>The reason for splitting the cache into 2 parts is that some data can be collected automatically by the Bosh component and it would be very inefficient to require the client to store the data in the Bosh cache. The best example for such data is the Roster and contacts presence information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>automatic cache</strong> - is the cache part which is created automatically by the Bosh component without any interaction with the client. The client, however, can access the cache at any time. I would say this is a read-only cache but I don&#8217;t want to stop client from manipulating the cache if it needs. The client usually, only retrieves data from this part of the cache as all changes should be automatically updated by the Bosh component. The general idea for the automatic cache is that the data stored there are accessible in the standard XMPP form. So no extra code is needed for processing them.</p>
</li>
<li>
<p><strong>dynamic cache</strong> - is the cache part which is or can be modified at any time by the client. Client can store, retrieve, delete and modify data in this part of the cache.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_cache_protocol"><a class="anchor" href="#_cache_protocol"></a>32.3. Cache Protocol</h3>
<div class="paragraph">
<p>All the Bosh Session Cache actions are executed using additional <code>&lt;body/&gt;</code> element attributes: <code>cache</code> and <code>cache-id</code>. Attribute cache stores the action performed on the Bosh <code>cache</code> and the <code>cache-id</code> attribute refers to the <code>cache</code> element if the action attribute needs it. <code>cache-id</code> is optional. There is a default cache ID (empty one) associated with the elements for which the <code>cache-id</code> is not provided.</p>
</div>
<div class="paragraph">
<p>If the <code>&lt;body/&gt;</code> element contains the cache attribute it means that all data included in the <code>&lt;body/&gt;</code> refer to the cache action. It is not allowed, for example to send a message in the body and have the cache action set to <strong>get</strong>. The <code>&lt;body/&gt;</code> element with cache action <strong>get</strong>, <strong>get_al*l, *on</strong>, <strong>off</strong>, <strong>remove</strong> must be empty. The <code>&lt;body/&gt;</code> element with actions <strong>set</strong> or <strong>add</strong> must contain data to store in the cache.</p>
</div>
<div class="sect3">
<h4 id="_cache_actions"><a class="anchor" href="#_cache_actions"></a>32.3.1. Cache Actions</h4>
<div class="ulist">
<ul>
<li>
<p><strong>on</strong> or <strong>off</strong> - the client can switch the cache on or off at any time during the session. It is recommended, however that the client switches the cache <strong>on</strong> in the first body packet, otherwise some information from the automatic cache may be missing. The automatic cache is created from the stream of data passing the Bosh component. Therefore if the cache is switched on after the roster retrieval is completed then the roster information will be missing in the cache.</p>
<div class="paragraph">
<p>If the cache is set to <strong>off</strong> (the default value) all requests to the cache are ignored. This is to ensure backward compatibility with the original Bosh specification and to make sure that in default environment the Bosh component doesn&#8217;t consume any extra resources for cache processing and storing as the cache wouldn&#8217;t be used by the client anyway.</p>
</div>
</li>
<li>
<p><strong>get</strong> - retrieves the cache element pointing by the cache-id from the Bosh cache. Note there is no <strong>result</strong> cache action. The <code>&lt;body/&gt;</code> sent as a response from the server to the client may contain cache results for a given cache-id and it may also contain other data received by the Bosh component for the client. It may also happen that large cached data are split into a few parts and each part can be sent in a separate <code>&lt;body/&gt;</code> element. It may usually happen for the Roster data.</p>
</li>
<li>
<p><strong>get_all</strong> - retrieves all the elements kept in the Bosh cache. That action can can be performed after the page reload. The client doesn&#8217;t have to request every single cached item one by one. It can retrieve all cache items in one go. It doesn&#8217;t mean however the whole cache is sent to the client in a single <code>&lt;body/&gt;</code> element. The cache content will be divided into a smaller parts of a reasonable size and will be sent to the client in a separate <code>&lt;body/&gt;</code> elements. It may also happen that the <code>&lt;body/&gt;</code> element contain the cache elements as well as the new requests sent to the user like new messages or presence information.</p>
</li>
<li>
<p><strong>set</strong> - sends data to the Bosh Session cache for later retrieval. The client can store any data it wants in the cache. The Bosh components stores in the cache under the selected ID all the data inside the <code>&lt;body/&gt;</code> element. The only restriction is that the cached data must be a valid XML content. The data are returned to the client in exactly the same form as they were received from the server. The <strong>set</strong> action replaces any previously stored data under this ID.</p>
</li>
<li>
<p><strong>add</strong> - adds new element to the cache under the given ID. This action might be useful for storing data for the opened chat window. The client can add new elements for the chat window, like new messages, icons and so on&#8230;&#8203;</p>
</li>
<li>
<p><strong>remove</strong> - removes the cached element for the given cache ID.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_cache_id"><a class="anchor" href="#_cache_id"></a>32.3.2. Cache ID</h4>
<div class="paragraph">
<p>Cache ID can be any characters string. There might be some IDs reserved for a special cases, like for the Roster content. To avoid any future ID conflicts reserved ID values starts with: <strong>bosh</strong> - string.</p>
</div>
<div class="paragraph">
<p>There is a default cache ID - en empty string. Thus cache-id attribute can be omitted and then the requests refers to data stored under the default (empty) ID.</p>
</div>
</div>
<div class="sect3">
<h4 id="_reserver_cache_id_names"><a class="anchor" href="#_reserver_cache_id_names"></a>32.3.3. Reserver Cache ID Names</h4>
<div class="paragraph">
<p>Here is a list of reserved Cache IDs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bosh-roster</strong> - The user roster is cached in the Bosh component in exactly the same form as it was received from the core server.</p>
<div class="paragraph">
<p>The Bosh Cache might do or might not do optimizations on the roster like removing elements from the cached roster if the roster <strong>remove</strong> has been received or may just store all the roster requests and then send them all to the client.</p>
</div>
<div class="paragraph">
<p>There is a one mandatory optimization the Bosh Cache must perform. It must remember the last (and only the last) presence status for each roster item. Upon roster retrieving from the cache the Bosh component must send the roster item first and then the presence for the item. If the presence is missing it means off-line presence.</p>
</div>
<div class="paragraph">
<p>If the roster is small it can be sent to the client in a single packet but for a large roster it is recommended to split contact lists to batches of max 100 elements. The Bosh component may send all roster contacts first and then all presences or it can send a part of the roster, presences for sent items, next part of the roster, presences for next items and so on&#8230;&#8203;.</p>
</div>
</li>
<li>
<p><strong>bosh-resource-bind</strong> - The user resource bind is also cached to allow the client quickly retrieve information about the full JID for the established Bosh session.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_test_suite"><a class="anchor" href="#_tigase_test_suite"></a>33. Tigase Test Suite</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>Tigase Test Suite is an engine which allows you to run tests. Essentially it just executes <strong>TestCase</strong> implementations. The tests may depend on other tests which means they are executed in specific order. For example authentication test is executed after the stream open test which in turn is executed after network socket connection test.</p>
</div>
<div class="paragraph">
<p>The tests may have parameters. Each <strong>TestCase</strong> implementation may have it&#8217;s own set of specific parameters. There is a set of common parameters which may be applied to any <strong>TestCase</strong>. As an example of the common parameter you can take <strong>-loop = 10</strong> which specified that the <strong>TestCase</strong> must be execited 10 times. The test specific parameter might be <strong>-user-name = tester</strong> which may set the user name for authentication test.</p>
</div>
<div class="paragraph">
<p>The engine is very generic and allows you to write any kind of tests but for the Tigase projects the current TestCase implementations mimic an XMPP client and are designed to test XMPP servers.</p>
</div>
<div class="paragraph">
<p>The suite contains also kind of scripting language which allows you to combine test cases into a test scenarios. The test scenario may contain full set of functional tests for example, another test scenario may contain performance tests and so on.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_suite_scripting_language"><a class="anchor" href="#_test_suite_scripting_language"></a>34. Test Suite Scripting Language</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>The test suite contains also scripting language which allows you to combine test cases into a test scenarios. On the lowest level, however the language is designed to allow you to describe the test by setting test parameters, test comments, identification and so on.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the example test description.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><table class="CodeRay"><tr>
  <td class="line-numbers"><pre>1
2
3
4
5
6
7
</pre></td>
  <td class="code"><pre><span class="predefined-type">Short</span> name<span class="annotation">@test</span>-id-<span class="integer">1</span>;test-id-<span class="integer">2</span>: <span class="predefined-type">Short</span> description <span class="keyword">for</span> the test <span class="keyword">case</span>
{
 -loop = <span class="integer">10</span>
 -user-name = Frank
 <span class="error">#</span> This is a comment which is ignored
}
&gt;&gt; <span class="predefined-type">Long</span>, detailed description of the test <span class="keyword">case</span> &lt;&lt;</pre></td>
</tr></table></code></pre>
</div>
</div>
<div class="paragraph">
<p>Meaning of all elements:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Short name</strong> is any descriptive name you want. It doesn&#8217;t need to be unique, just something which tells you what this test is about.@ is a separator between the short name and the test ids.</p>
</li>
<li>
<p><strong>test-id-1;test-id-2</strong> is a semicolon separated of the test cases IDs. The tests cases are executed in the listed order. And listing them there means that the test-id-2 depends on test-id-1. Normally you don&#8217;t have to list all the dependencies because all mandatory dependencies are included automatically. Which means if you have an authentication test case the suite adds automatically network socket connection and stream opening. Sometimes however there are dependencies which are optional or multiple mandatory dependencies and you can select which one has to be executed. As a good example is authentications test case. There are many authentication tests: PLAIN-AUTH, SASL-DIGESTMD5, SASL-PLAIN, DIGEST-AUTH and they are all mandatory for most of other tests like roster, presence and so on. One of the authentication tests is a default dependency but if you put on the list different authentication it will be used instead of default one.</p>
</li>
<li>
<p><strong>:</strong> is a separator between test cases ids list and the short test description.</p>
</li>
<li>
<p>Short test description is placed between : - colon and opening <strong>{</strong> - curly bracket. This is usually quite brief, single line test description.</p>
</li>
<li>
<p><strong>{  }</strong> curly brackets contain all the test parameters, like how many times the test has to be executed or run the test in a separate thread, user name, host IP address for the network connection and many others.</p>
</li>
<li>
<p><strong>&gt;&gt;  &lt;&lt;</strong> inside the double greater than and double less than you put a very long, multiple line test description.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Between an open curly bracket { and close one } you can put all the test case parameters you wish. The format for it is:</p>
</div>
<div class="paragraph">
<p><strong>-parameter-name = value</strong></p>
</div>
<div class="paragraph">
<p>Parameter names always start with '<strong>-</strong>'. Note, some parameters don&#8217;t need any value. They can exist on their own without any value assigned:</p>
</div>
<div class="paragraph">
<p><strong>-debug-on-error</strong></p>
</div>
<div class="paragraph">
<p>It works like you set "<strong>yes</strong>" or "<strong>true</strong>" for this parameter but you don&#8217;t set anything.</p>
</div>
<div class="paragraph">
<p>The scripting language includes also support for variables which can be assigned any value and used multiple times later on. You assign a value to the variable the same way as you assign it to the parameter:</p>
</div>
<div class="paragraph">
<p><strong>$(variable-name) = value</strong></p>
</div>
<div class="paragraph">
<p>The variable name must be always enclosed with brackets <strong>()</strong> and start with '<strong>$</strong>'.</p>
</div>
<div class="paragraph">
<p>The value may be enclosed within double quotes <strong>""</strong> or double quotes may be omitted. If this is a simple string like a number or character string consisting only of digits, letters, underscore '<strong>_</strong>' and hyphen '<strong>-</strong>' then you can omit double quotes otherwise you must enclose the value.</p>
</div>
<div class="paragraph">
<p>The test case descriptions can be nested inside other test case descriptions. Nested test case descriptions inherit parameters and variables from outer test case description.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_writing_tests_for_plugins"><a class="anchor" href="#_writing_tests_for_plugins"></a>35. Writing Tests for Plugins</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>You can write tests in form of simple text file which is loaded during test suite runtime.</p>
</div>
<div class="paragraph">
<p>You simply specify what should be send to the server and what response should be expected from the server. No need to write Java code and recompile whole test suite for new tests. It means new test cases can be now written easily and quickly which hopefully means more detailed tests for the server.</p>
</div>
<div class="paragraph">
<p>How it works:</p>
</div>
<div class="paragraph">
<p>Let&#8217;s take <a href="http://www.xmpp.org/extensions/xep-0049.html">XEP-0049</a> Private XML Storage. Looking into the spec we can see the first example:</p>
</div>
<div class="paragraph">
<p>Example 1. Client Stores Private Data</p>
</div>
<div class="paragraph">
<p><strong>CLIENT:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;query</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:private</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;exodus</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exodus:prefs</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;defaultnick&gt;</span>Hamlet<span class="tag">&lt;/defaultnick&gt;</span>
    <span class="tag">&lt;/exodus&gt;</span>
  <span class="tag">&lt;/query&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>SERVER:</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This is enough for the first simple test. I have to create text file <code>JabberIqPrivate.test</code> looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">send: {

&lt;iq type=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span>&gt;
  &lt;query xmlns=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:iq:private</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;exodus xmlns=<span class="string"><span class="delimiter">&quot;</span><span class="content">exodus:prefs</span><span class="delimiter">&quot;</span></span>&gt;
      &lt;defaultnick&gt;Hamlet&lt;/defaultnick&gt;
    &lt;/exodus&gt;
  &lt;/query&gt;
&lt;/iq&gt;
}

expect: {
&lt;iq type=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span> id=<span class="string"><span class="delimiter">&quot;</span><span class="content">1001</span><span class="delimiter">&quot;</span></span>/&gt;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now I can execute the test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">testsuite $ ./scripts/all-tests-runner.sh --single JabberIqPrivate.test

Tigase server home directory: ../server
Version: 2.8.5-b422
Database:         xmldb
Server IP:        127.0.0.1
Extra parameters: JabberIqPrivate.test
Starting Tigase:
Tigase running pid=6751

Running: 2.8.5-b422-xmldb test, IP 127.0.0.1...
Script name: scripts/single-xmpp-test.xmpt
Common test:  Common test  ...        failure!
FAILURE,  (Received result doesnt match expected result.,
Expected one of: [&lt;iq id=&quot;1001&quot; type=&quot;result&quot;/&gt;],
received:
[&lt;iq id=&quot;1001&quot; type=&quot;error&quot;&gt;
  &lt;query xmlns=&quot;jabber:iq:private&quot;&gt;
    &lt;exodus xmlns=&quot;exodus:prefs&quot;&gt;
      &lt;defaultnick&gt;Hamlet&lt;/defaultnick&gt;
    &lt;/exodus&gt;
  &lt;/query&gt;
  &lt;error type=&quot;cancel&quot;&gt;
    &lt;feature-not-implemented xmlns=&quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;/&gt;
    &lt;text xml:lang=&quot;en&quot; xmlns=&quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;&gt;
      Feature not supported yet.&lt;/text&gt;
  &lt;/error&gt;
&lt;/iq&gt;]),

Total: 100ms
Test time: 00:00:02
Shutting down Tigase: 6751</code></pre>
</div>
</div>
<div class="paragraph">
<p>If I just started working on this XEP and there is no code on the server side the result is perfectly expected although maybe this is not what we want. After a while of working on the server code I can execute the test once again:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">testsuite $ ./scripts/all-tests-runner.sh --single JabberIqPrivate.test

Tigase server home directory: ../server

Version: 2.8.5-b422

Database:         xmldb

Server IP:        127.0.0.1

Extra parameters: JabberIqPrivate.test

Starting Tigase:

Tigase running pid=6984

Running: 2.8.5-b422-xmldb test, IP 127.0.0.1...

Script name: scripts/single-xmpp-test.xmpt

Common test:  Common test  ... success,  Total: 40ms

Test time: 00:00:01

Shutting down Tigase: 6984</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is it. The result we want. In simple and efficient way. We can repeat it as many times we want which is especially important in longer term. Every time we change the server code we can re-run tests to make sure we get correct responses from the server.</p>
</div>
<div class="paragraph">
<p>You can have a look in current, with more complete test cases, file for <a href="http://testsuite.tigase.org/trac/browser/trunk/tests/data/JabberIqPrivate.cot">JabberIqPrivate</a>.</p>
</div>
<div class="paragraph">
<p>Now my server tests are no longer outdated. Of course not all cases are so simple. Some XEPs require calculations to be done before stanza is sent or to compare received results. A good example for this case is user authentication like SASL and even NON-SASL. But still, there are many cases which can be covered by simple tests: roster management, privacy lists management, vCard, private data storage and so on&#8230;&#8203;.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_case_parameters_description"><a class="anchor" href="#_test_case_parameters_description"></a>36. Test Case Parameters Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net/" class="bare">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p>
</div>
<div class="paragraph">
<p>There is long list of parameters which can be applied to any test case. Here is the description of all possible parameters which can be used to build test scenarios.</p>
</div>
<div class="sect2">
<h3 id="_test_report_configuration"><a class="anchor" href="#_test_report_configuration"></a>36.1. Test Report Configuration</h3>
<div class="paragraph">
<p>There are test report parameters which must be set in the main script file in order to generate HTML report from the test. These parameters have no effect is they are set inside the test case description.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>-version = 2.0.0</strong> sets the test script version. This is used to easily detect incompatibility issues when the test suite loads a script created for more recent version of the suite and may not work properly for this version.</p>
</li>
<li>
<p><strong>-output-format = (html | html-content)</strong> sets the output format for the test report. There is actually only one format possible right now - HTML. The only difference between these 2 options is that the <strong>html</strong> format creates full HTML page with HTML header and body. The <strong>html-content</strong> format on the other hand creates only what is inside <code>&lt;body/&gt;</code> element. And is used to embed test result inside other HTML content.</p>
</li>
<li>
<p><strong>-output-file = "report-file.html"</strong> sets the file name for the test report.</p>
</li>
<li>
<p><strong>-output-history = (yes | no)</strong> sets logging of the all protocol data sent between test suite and the XMPP server. Normally for functional tests it is recommended to set it to <strong>yes</strong> but for all other tests like performance or load tests it should be set to <strong>no</strong>.</p>
</li>
<li>
<p><strong>-history-format = separate-file</strong> sets protocol data logging to a separate file. Currently this is the only possible option.</p>
</li>
<li>
<p><strong>-output-cols = (5 | 7)</strong> Only valid values are:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">5: &quot;Test name&quot;, &quot;Result&quot;, &quot;Test time&quot;, &quot;Description&quot; [, &quot;History&quot; ]
7: &quot;Test name&quot;, &quot;Result&quot;, &quot;Total time&quot;, &quot;OK&quot;, &quot;Average&quot;, &quot;Description&quot; [, &quot;History&quot; ]</code></pre>
</div>
</div>
</li>
<li>
<p><strong>-title = "The title of the report page"</strong> This parameter sets the test report title which is placed in the HTML page in the <code>&lt;title/&gt;</code> element as well as in the first page header.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_basic_test_parameters"><a class="anchor" href="#_basic_test_parameters"></a>36.2. Basic Test Parameters</h3>
<div class="paragraph">
<p>These parameters can be set on per-test case basis but usually they are set in the main script file to apply them to all test cases.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>-base-ns = "jabber:client"</strong> sets the XML name space used for the XML stream in the XMPP connection. Some test cases can be used to test client to server protocol as well as server to server protocol and possibly different protocols added in the future.</p>
</li>
<li>
<p><strong>-debug</strong> switches debugging mode on. All the communication between the test suite and the server is printed out to the text console and all other debugging information including java exceptions is displayed as well. It is especially useful when some test fails and you want to find out why exactly.</p>
</li>
<li>
<p><strong>-debug-on-error</strong> switches on debugging mode on error detection. Normally debug output generates lots of message which makes the output very hard to read. Especially in the performance tests not only you can read fast scrolling lines of the protocol data but also it slows the test down. This option however turns debugging off if everything is working well and then generates debug output if any test error us detected.</p>
</li>
<li>
<p><strong>-def-auth = (auth-plain | auth-digest | auth-sasl)</strong> sets the default authentication method for the user connection.</p>
</li>
<li>
<p><strong>-def-stream = (stream-client | stream-server | stream-component | stream-bosh)</strong> sets the connection stream to be tested and the name space for the connection.</p>
</li>
<li>
<p><strong>-host = "host.name"</strong> the vhost name the tested server runs for. It may be the real DNS name or just configured for testing purposes hostname. It must match however the server configuration.</p>
</li>
<li>
<p><strong>-keys-file = "certs/keystore"</strong> sets the location of the keys store file. No need to touch it.</p>
</li>
<li>
<p><strong>-keys-file-password = keystore</strong> sets the password for the keystore file. Normally you don&#8217;t have to touch it.</p>
</li>
<li>
<p><strong>-serverip = "127.0.0.1"</strong> defines the XMPP server IP address. You may omit this parameter and then the IP address will be determined automatically based on the server DNS address. However if the DNS address can not be correctly resolved or if you run tests on the localhost you can use this parameter to enforce the IP address.</p>
</li>
<li>
<p><strong>-socket-wait = 10000</strong> sets the network socket timeout in milliseconds that is maximum time the test suite will wait for the response from the server. You may want to increase the timeout for some specific tests which require lots of computation or database activity on the server. Normally 10 seconds is enough for most cases.</p>
</li>
<li>
<p><strong>-stop-on-fail = true</strong> causes the script to terminate all actions on the first failed test case. It helps diagnosing the server state at the failure point.</p>
</li>
<li>
<p><strong>-trust-file = "certs/client_truststore"</strong> sets the file name for the client trust store file. No need to change it.</p>
</li>
<li>
<p><strong>-trust-file-password = truststore</strong> sets the password for the trust store file. Normally you don&#8217;t have to touch it.</p>
</li>
<li>
<p><strong>-user-name = tester</strong> sets the user name used for the XMPP connections between the test suite and the XMPP server. It is usually set globally the same for all tests and for some tests like receiving the server configuration you may want to use a different account (with admin permissions). Then you can set a different user for this specific test case.</p>
</li>
<li>
<p><strong>-user-pass = tester-password</strong> sets the password for the user used for the XMPP connection between the test suite and the XMPP server.</p>
</li>
<li>
<p><strong>-user-resr = resource</strong> sets the user JID resource part for the XMPP connection between the test suite and the XMPP server.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_test_case_parameters"><a class="anchor" href="#_test_case_parameters"></a>36.3. Test Case Parameters</h3>
<div class="paragraph">
<p>Test parameters which are normally set on per-test case basis and apply only to the test they are set for and all inherited tests. Some of the parameters though are applied only to inherited test cases. Please look in the description below to find more details.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>-active-connection</strong> is a similar parameter to <strong>-on-one-socket</strong> option. If set the suite doesn&#8217;t close the network socket and if the test is run in loop each loop run re-uses the network connection. Unlike in the -on-one-socket mode the whole test is executed on each run including XMPP stream initialization and user authentication. This option is currently not recommended in a normal use. It is useful only to debug the server behavior in very special use cases.</p>
</li>
<li>
<p><strong>-background</strong> executes the test in a separate thread in background and immediately returns control to the test suite program without waiting for the test to complete. Default behavior is to execute all tests sequentially and run next test when previous one has been completed. This parameter however allows to run tests concurrently. This a bit similar option to the <strong>-daemon</strong> parameter. The daemon test/task however is ignored completely and results from the daemon are not collected where the background test is a normal test which is run concurrently with another one or possibly many other tests.</p>
</li>
<li>
<p><strong>-daemon</strong> creates a task running in background in a separate thread. Such a test runs infinitely as a daemon, it is not recorded in the test report and it&#8217;s result is not calculated. The purpose of such test/task is to work as a helper for other test cases. A good example of such daemon test is message responder - the test which runs under a different user name and waits for messages and responding to the sender.</p>
</li>
<li>
<p><strong>-delay = 1000</strong> set the waiting time in milliseconds after the test case is completed. You may use it if you want to introduce short delay between each test cases run in the loop or if you start the helper daemon thread and you have to add the delay to make sure it is ready to work before next real test starts sending requests to the daemon.</p>
</li>
<li>
<p><strong>-expect-type = error</strong> sets the type for a packet expected as a response. Some test cases like message sender expects sometimes response with the same type it has sent the packet ('<strong>chat</strong>') but in some other cases when it sends a message to a user who has privacy lists set to block messages the response should be with an error. This way we can use the same test cases for testing different responses scenarios.</p>
</li>
<li>
<p><strong>-loop = 10</strong> sets the number of times the test (and all inherited tests) are repeated. You can use a <strong>$(loop)</strong> pseudo-variable to obtain and use the current loop run number. This is useful if you want to run every loop run for a different user name like registering 10 different user accounts. To do this you stick the $(loop) variable to the user name string: <strong>-user-name = "nick_name_$(loop)"</strong>.</p>
</li>
<li>
<p><strong>-loop-delay = 10</strong> sets a delay in milliseconds between each individual loop run for the tests which is run multiple times. This is similar parameter to the <strong>-delay</strong> one but the <strong>-delay</strong> option introduces a delay after the whole test (or all loop runs) has been completed. The loop delay options adds waiting time between each run of the looped test.</p>
</li>
<li>
<p><strong>-loop-start = 5</strong> sets the loop starting value. It doesn&#8217;t affect number of loop runs in a any way. It only affects the value of the <strong>$(loop)</strong> variable. Let&#8217;s say you want to run a load test for the server with 100k concurrent users and you want to run the test from 3 different machines. To make sure each machine uses distinct user accounts you have to set a different <strong>-loop-start</strong> parameter on each to prevent from overlapping.</p>
</li>
<li>
<p><strong>-messages = 10</strong> sets the number of messages to send to the server. This is another way of looping the test. Instead of repeating the whole test with opening network connection, XMPP stream, authentication and so on it causes only to send the message this many times. This parameters is accepted by some test cases only which send messages. For the messages listeners - test cases which is supposed to respond to the messages the number set here specifies how many times the the response must be sent before the test successfully terminates it&#8217;s work.</p>
</li>
<li>
<p><strong>-multi-thread</strong> option causes to run the test case and all inherited in all levels test cases in separate threads. Normally the test case where you put the parameter doesn&#8217;t have a test ID (what you put between <em>@</em> and <em>:</em> characters so it doesn&#8217;t run a test on it&#8217;s own. Instead it contains a series of test cases inside which are then run in a separate thread each. This is a key parameter to run tests for many concurrent users. (Not a load tests though.) For example you can see whether the server behaves correctly when 5 simultaneous modifies their roster. The execution time all inherited tests run in a separate threads is added together and also results from each individual test is calculated and added to the total main test results.</p>
</li>
<li>
<p><strong>-no-record</strong> is used for kind of configuration tests (tasks) which are used to prepare the XMPP server or database for later tests. As an example can be creation of the test user account which is later on used for the roster tests. Usually you don&#8217;t want to include such tests in the test report and using this parameter you essentially exclude the test from the report. The test and the result however shows in the command line output so you can still track what is really going on.</p>
</li>
<li>
<p><strong>-on-one-socket</strong> is a modifier for a looped test case. Normally when we switch looping on using '<strong>-loop</strong>' parameter the suite resets the state, closes the network socket and runs the test from the very beginning including opening network socket, XMPP stream, authentication and so on. This parameter however changes this behavior. The network socket is not closed when the test run is completed (successfully) and next run executes only the last part of the test omitting the XMPP stream initialization, authentication and all others but last. This is useful when you want to send many messages to the server (although this effect may be accomplished using '<strong>-messages</strong>' parameter as well) or registering many user accounts on the server, unregistering user accounts and any other which might make sense repeating many times.</p>
</li>
<li>
<p><strong>-port = 5223</strong> this parameter is similar to the IP address setting and can be also set globally for all tests. Normally however you set it for a selected tests only to check SSL connection. For all other tests default port number is used. Therefore this parameters has been included in this section instead of "Basic test parameters".</p>
</li>
<li>
<p><strong>-repeat-script = 100</strong> and <strong>-repeat-wait = 10</strong> are 2 parameters are specific to the common test cases. (The test cases which reads the test input/output data from the pseudo-xml text file. The first parameter is another variation of test looping. It sets how many times the test has to be repeated. It works very much like the <strong>-on-one-socket</strong> parameter. The only difference is that the common test can preserve some internal states between runs and therefore it has more control over the data. The second parameter sers the timeout in milliseconds to wait/delay between each individual test run and it is a very similar parameter to the <strong>-delay</strong> one but it sets a timeout inside the common test instead.</p>
</li>
<li>
<p><strong>-source-file = "dir/path/to/file.cot"</strong> is a parameter to set the "common test" script file. The common test is a test cases which depends on the authentication test case and can read data to send and responses to expect from the text file. The "cot" file is a pseudo-xml file with stanzas to send and stanzas to expect. The the test cases compares the received packets with those in the text file and reports the test result. This is usually a more convenient way to write a new test cases than coding them in Java.</p>
</li>
<li>
<p><strong>-time-out-ok</strong> is set for a test case when we expect socket timeout as a correct result from the test case. Normally the timeout means that the test failed and there was no response from the server at all or the response was incorrect. For some tests however (like sending a message to the user who is blocking messages through privacy lists) the timeout is the desired correct test result.</p>
</li>
<li>
<p><strong>-to-jid = "<a href="mailto:user_name@host.name">user_name@host.name</a>"</strong> sets the destination address for packets sending packets somewhere. As an example is the test case sending &lt;message                     /&gt; packet. You can set the destination address for the packet. Mind, normally every test expects some response for the data sent so make sure the destination end-point will send back the data expected by the test case.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-05-14 20:55:07 CEST
</div>
</div>
</body>
</html>