<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;16.&nbsp;How Packets are Processed by the SM and Plugins</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="index.html" title="Tigase Development Guide"><link rel="prev" href="cmd.html" title="Custom Mechanisms Development"><link rel="next" href="wpc.html" title="Chapter&nbsp;17.&nbsp;Writing Plugin Code"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;16.&nbsp;How Packets are Processed by the SM and Plugins</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="cmd.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="wpc.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="How_Packets_are_Processed_by_the_SM_and_Plugins"></a>Chapter&nbsp;16.&nbsp;How Packets are Processed by the SM and Plugins</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="How_Packets_are_Processed_by_the_SM_and_Plugins.html#_introduction">Introduction</a></span></dt></dl></div><p>Artur Hefczyc &lt;<a class="link" href="mailto:artur.hefczyc@tigase.net" target="_top">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:website: <a class="link" href="http://tigase.net/" target="_top">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p><p>For the Tigase server plugin development it is important to understand how it all works. There are different kind of plugins responsible for processing packets at different stages of the data flow. Please read the introduction below before proceeding to the actual coding part.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_introduction"></a>Introduction</h2></div></div></div><p>In the Tigase server <span class="strong"><strong>plugins</strong></span> are pieces of code responsible for processing particular XMPP stanza. A separate plugin might be responsible for processing messages, a different one for processing presences, and there might a separate plugins responsible for iq roster, different for iq version and so on.</p><p>A plugin provides information about what exact XML element(s) name(s) with xmlns it is interested in. So you can create a plugin which is interested in all packets containing caps child.</p><p>There might be no plugin for a particular stanza element and then a default actions is used which is simple forwarding stanza to a destination address. There might be also more than one plugin for a specific XML element and then they all process the same stanza simultaneously in separate threads so there is no guarantee on the order in which the stanza is processed by a different plugins.</p><p>Each stanza goes through the Session Manager component which processes packets in a few steps. Have a look at the picture below:</p><p><span class="inlinemediaobject"><img src="./images/sm-consumer.png" alt="Consumer"></span></p><p>The picture shows that each stanza is processed by the session manager in 4 steps:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">Pre-processing - all loaded pre-processors receive the packet for processing. They work within session manager thread and they have no internal queue for processing. As they work within Session Manager thread it is important that they limit processing time to absolute minimum as they may affect the Session Manager performance The intention for the pre-processors is to allow them for packet blocking. If the pre-processing result is <span class="emphasis"><em>true</em></span> then the packet is blocked and no further processing is performed.</li><li class="listitem">Processing - this is the next step the packet gets through if it wasn&#8217;t blocked by any of the pre-processors. It gets inserted to all processors queues which requested interest in this particular XML element. Each processor works in a separate thread and has own internal fixed size processing queue.</li><li class="listitem">If there is no processor for the stanza then the packet goes through all post-processors. The last post-processor in built into session manager post-processor which tries to apply a default action to a packet which hasn&#8217;t been processed in step 2. Normally the default action is just forwarding the packet to a destination. Most commonly it is applied to &lt;message/&gt; packets.</li><li class="listitem">Finally, if any of above 3 steps produced output/result packets all of them go through all filters which may or may not block them.</li></ol></div><p>Important thing to note is that we have two kinds or two places where packets may be blocked or filtered out. One place is before packet is processed by the plugin and another place is after processing where filtering is applied to all results generated by the processor plugins.</p><p>It is also important to note that session manager and processor plugins act as packet consumers. The packet is taken for processing and once processing is finished the packet is destroyed. Therefore to forward a packet to a destination one of the processor must create a copy of the packet, set all properties and attributes and return it as a processing result. Of course processor can generate any number of packets as a result. Result packets can be generated in any of above 4 steps of the processing. Have a look at the picture below:</p><p><span class="inlinemediaobject"><img src="./images/user-sends-to-comp.png" alt="User Send to Comp"></span></p><p>If the packet P1 is send outside of the server, for example to a user on another server or to some component (MUC, PubSub, transport) then one of the processor must create a copy P2 of the packet and set all attributes and destination addresses correctly. Packet P1 has been consumed by the session manager during processing and a new packet has been generated by one of the plugins.</p><p>The same of course happens on the way back from the component to the user:</p><p><span class="inlinemediaobject"><img src="./images/comp-sends-to-user.png" alt="Comp Sends to User"></span></p><p>The packet from the component is processed and one of the plugins must generate a copy of the packet to deliver it to the user. Of course packet forwarding is a default action which is applied when there is no plugin for the particular packet.</p><p>It is implemented this way because the input packet P1 can be processed by many plugins at the same time therefore the packet should be in fact immutable and must not change once it got to the session manager for processing.</p><p>The most obvious processing workflow is when a user sends request to the server and expects a response from the server:</p><p><span class="inlinemediaobject"><img src="./images/user-request-response.png" alt="User Request Response"></span></p><p>This design has one surprising consequence though. If you look at the picture below showing communication between 2 users you can see that the packet is copied twice before it is delivered to a final destination:</p><p><span class="inlinemediaobject"><img src="./images/user-sends-to-user.png" alt="User Sends to User"></span></p><p>The packet has to be processed twice by the session manager. The first time it is processed on behalf of the User A as an outgoing packet and the second time it is processed on behalf of the User B as an incoming packet.</p><p>This is to make sure the User A has permission to send a packet out and all processing is applied to the packet and also to make sure that User B has permission to receive the packet and all processing is applied. If, for example, the User B is offline there is offline message processor which should put the packet to a database.</p></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="cmd.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="wpc.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Custom Mechanisms Development&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;17.&nbsp;Writing Plugin Code</td></tr></table></div></body></html>