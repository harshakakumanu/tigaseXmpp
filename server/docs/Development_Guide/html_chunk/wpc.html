<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;17.&nbsp;Writing Plugin Code</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="index.html" title="Tigase Development Guide"><link rel="prev" href="How_Packets_are_Processed_by_the_SM_and_Plugins.html" title="Chapter&nbsp;16.&nbsp;How Packets are Processed by the SM and Plugins"><link rel="next" href="_using_older_non_annotation_based_implementation.html" title="Using older non-annotation based implementation"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;17.&nbsp;Writing Plugin Code</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="How_Packets_are_Processed_by_the_SM_and_Plugins.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="_using_older_non_annotation_based_implementation.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="wpc"></a>Chapter&nbsp;17.&nbsp;Writing Plugin Code</h1></div></div></div><div class="toc"><p><b>Table of Contents</b></p><dl class="toc"><dt><span class="section"><a href="wpc.html#_using_annotation_support">Using annotation support</a></span></dt><dt><span class="section"><a href="_using_older_non_annotation_based_implementation.html">Using older non-annotation based implementation</a></span></dt><dt><span class="section"><a href="_implementation_of_processing_method.html">Implementation of processing method</a></span></dt></dl></div><p>Artur Hefczyc &lt;<a class="link" href="mailto:artur.hefczyc@tigase.net" target="_top">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a class="link" href="http://tigase.net/" target="_top">http://tigase.net/</a>
:Date: 2010-04-06 21:22</p><p>Previous guide describes a basic idea behind the XMPP stanza processing in the session manager. As it was already point out the processing takes place in 4 steps. A different kind of plugin is responsible for each step of processing:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPreprocessorIfc.java" target="_top">XMPPPreprocessorIfc</a> - is the interface for packets pre-processing plugins.</li><li class="listitem"><a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPProcessor.java" target="_top">XMPPProcessorIfc</a> - is the interface for packets processing plugins.</li><li class="listitem"><a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPostprocessorIfc.java" target="_top">XMPPPostprocessorIfc</a> - is the interface for packets post-processing plugins.</li><li class="listitem"><a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPPacketFilterIfc.java" target="_top">XMPPPacketFilterIfc</a> - is the interface for processing results filtering.</li></ol></div><p>If you look inside any of these interfaces you find only a single method. This is it. This is where all the packet processing takes place. All of them take a similar set of parameters and below is a description for all of them:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><span class="strong"><strong>Packet packet</strong></span> - packet is which being processed. This parameter may never be null. Even though this is not immutable object it mustn&#8217;t be altered. None of it&#8217;s fields or attributes can be changed during processing.</li><li class="listitem"><span class="strong"><strong>XMPPResourceConnection session</strong></span> - user session which keeps all the user session data and also gives an access to the user&#8217;s repository data. It allows for storing information in a permanent storage or in memory only during the live of the online session. This parameter can be null if there is no online user session at the time of the packet processing.</li><li class="listitem"><span class="strong"><strong>NonAuthUserRepository repo</strong></span> - this is a user data storage which is normally used when the user session (parameter above) is null. This is repository allows for a very restricted access only. It allows for storing some user private data (doesn&#8217;t allow overwriting existing data) like messages for offline users and it also allows for reading user public data like VCard.</li><li class="listitem"><span class="strong"><strong>Queue&lt;Packet&gt; results</strong></span> - this a collection with packets which have been generated as input packet processing results. Regardless a response to a user request is sent or the packet is forwarded to it&#8217;s destination it is always required that a copy of the input packet is created and stored in the <span class="strong"><strong>results</strong></span> queue.</li><li class="listitem"><span class="strong"><strong>Map&lt;String, Object&gt; settings</strong></span> - this map keeps plugin specific settings loaded from the Tigase server configuration. In most cases it is unused, however if the plugin needs to access an external database that this is a way to pass database connection string to the plugin.</li></ul></div><p>After a closer look in some of the interfaces you can see that they extend another interface: <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/XMPPImplIfc.java" target="_top">XMPPImplIfc</a> which provides a basic meta information about the plugin implementation. Please refer to JavaDoc documentation for all details.</p><p>For purpose of this guide we are implementing a simple plugin handling all <span class="strong"><strong>&lt;message/&gt;</strong></span> packets, that is forwarding packets to the destination address. Incoming packets are forwarded to the user connection and outgoing packets are forwarded to the external destination address. This <a class="link" href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/impl/Message.java" target="_top">message plugin</a> is actually implemented already and it is available in our Git repository. The code has some comments inside already but this guide goes deeper into the implementation details.</p><p>First of all you have to chose what kind of plugin you want to implement. If this is going to be a packet processor you have to implement <span class="strong"><strong>XMPPProcessorIfc</strong></span> interface, if this is going to be pre-processor then you have to implement <span class="strong"><strong>XMPPPreprocessorIfc</strong></span> interface. Of course your implementation can implement more than one interface, even all. It depends on your use case and needs. There are also two abstract helper classes from which you should use one as a base for all you plugins <span class="strong"><strong>XMPPProcessor</strong></span> or <span class="strong"><strong>AnnotatedXMPPProcessor</strong></span> for annotation support.</p><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="_using_annotation_support"></a>Using annotation support</h2></div></div></div><p>The class declaration should look like this (assuming you implement just packet processor):</p><pre class="programlisting">public class Message extends AnnotatedXMPPProcessor
   implements XMPPProcessorIfc</pre><p>The first thing to create is the plugin <span class="strong"><strong>ID</strong></span>. This is a unique string which you put in the configuration file to tell the server to load and use the plugin. In most cases you can use XMLNS if the plugin wants packets with elements with a very specific name space. Of course there is no guarantee there is no other packet for this specific XML element too. As I want to process all messages and I don&#8217;t want to spend whole day on thinking about a cool ID let&#8217;s say our ID is: 'message'.</p><p>A plugin informs about it&#8217;s using static <span class="strong"><strong>ID</strong></span> field and <span class="strong"><strong>@Id</strong></span> annotation placed on class:</p><pre class="programlisting">@Id(ID)
public class Message extends AnnotatedXMPPProcessor
   implements XMPPProcessorIfc {
  protected static final String ID = "message";
}</pre><p>As I mentioned before such a plugin receives only this kind of packets for processing which it is interested in. My plugin is interested only in packets with <span class="strong"><strong>&lt;message/&gt;</strong></span> elements and only if they are in "<span class="strong"><strong>jabber:client</strong></span>" namespace. To indicate all supported elements and namespaces we have to add 2 more annotations:</p><pre class="programlisting">@Id(ID)
@Handles({
  @Handle(path={ "message" },xmlns="jabber:client")
})
public class Message extends AnnotatedXMPPProcessor
   implements XMPPProcessorIfc {
  private static final String ID = "message";
}</pre></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="How_Packets_are_Processed_by_the_SM_and_Plugins.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="_using_older_non_annotation_based_implementation.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;16.&nbsp;How Packets are Processed by the SM and Plugins&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Using older non-annotation based implementation</td></tr></table></div></body></html>