<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;20.&nbsp;Component Implementation - Lesson 1 - Basics</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Development Guide"><link rel="up" href="index.html" title="Tigase Development Guide"><link rel="prev" href="componentdevelpoment.html" title="Chapter&nbsp;19.&nbsp;Component Development"><link rel="next" href="cil2.html" title="Chapter&nbsp;21.&nbsp;Component Implementation - Lesson 2 - Configuration"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;20.&nbsp;Component Implementation - Lesson 1 - Basics</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="componentdevelpoment.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="cil2.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="cil1"></a>Chapter&nbsp;20.&nbsp;Component Implementation - Lesson 1 - Basics</h1></div></div></div><p>Artur Hefczyc &lt;<a class="link" href="mailto:artur.hefczyc@tigase.net" target="_top">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a class="link" href="http://tigase.net/" target="_top">http://tigase.net/</a>
:Date: 2010-01-06 20:22</p><p>Creating a Tigase component is actually very simple and with broad API available you can create a powerful component with just a few lines of code. You can find detailed API description elsewhere. This series presents hands on lessons with code examples, teaching how to get desired results in the simplest possible code using existing Tigase API.</p><p>Even though all Tigase components are just implementations of <span class="strong"><strong>ServerComponent</strong></span> interface I will keep such a low level information to necessary minimum. Creating a new component based on just interfaces, while very possible, is not very effective. This guide intends to teach you how to make use of all what is already there, ready to use with a minimal coding effort.</p><p>This is just the first lesson of the series where I cover basics of the component implementation.</p><p>Let&#8217;s get started and create the Tigase component:</p><pre class="programlisting">import java.util.logging.Logger;
import tigase.server.AbstractMessageReceiver;
import tigase.server.Packet;

public class TestComponent extends AbstractMessageReceiver {

  private static final Logger log = Logger.getLogger(TestComponent.class.getName());

  @Override
  public void processPacket(Packet packet) {
    log.finest("My packet: " + packet.toString());
  }

}</pre><p>The only element mandatory when you extend <span class="strong"><strong>AbstractMessageReceiver</strong></span> is the implementation of <span class="strong"><strong>void processPacket(Packet packet)</strong></span> method. This is actually logical as the main task for your component is processing packets. Class name for our new component is <span class="strong"><strong>TestComponent</strong></span> and we have also initialised a separated logger for this class. This is actually very useful as it allows us to easily find log entries created by our class.</p><p>With these a few lines of code you have a fully functional Tigase component which can be loaded to the Tigase server, can receive and process packets, shows as an element on service discovery list (for administrators only), responds to administrator ad-hoc commands, supports scripting, generates statistics, can be deployed as an external component and a few other things.</p><p>Before we go any further with the implementation let&#8217;s set the component in the Tigase server so it is loaded next time the server starts.
Assuming our <span class="strong"><strong>init.properties</strong></span> file looks like this one:</p><pre class="programlisting">config-type = --gen-config-def
--debug = server
--user-db = derby
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:derby:/Tigase/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--comp-name-2 = pubsub
--comp-class-2 = tigase.pubsub.PubSubComponent</pre><p>We can see that it already is configured to load two other components: <span class="strong"><strong>MUC</strong></span> and <span class="strong"><strong>PubSub</strong></span>. Let&#8217;s add third - our new component to the configuration file by appending two following lines in the properties file:</p><pre class="programlisting">--comp-name-3 = test
--comp-class-3 = TestComponent</pre><p>Now we have to remove the <span class="strong"><strong>etc/tigase.xml</strong></span> file and restart the server.</p><p>There are a few ways to check whether our component has been loaded to the server. Probably the easiest is to connect to the server from administrator account and look at the service discovery list.</p><p><span class="inlinemediaobject"><img src="./images/service-disco-test-comp-admin-300.png" alt="service-disco-test-comp-admin-300"></span></p><p>If everything goes well you should see an entry on the list similar to highlighted on the screenshot. The component description is "<span class="emphasis"><em>Undefined description</em></span>" which is a default description and we can change it later on, the component default JID is: <span class="strong"><strong>test@devel.tigase.org</strong></span>, where <span class="strong"><strong>devel.tigase.org</strong></span> is the server domain and test is the component name.</p><p>Another way to find out if the component has been loaded is by looking at log files. Actually getting yourself familiar with Tigase log files will be very useful thing if you plan on developing Tigase components. So let&#8217;s look at the log file <span class="strong"><strong>logs/tigase.log.0</strong></span>, if the component has been loaded you should find following lines in the log:</p><pre class="programlisting">MessageRouter.setProperties() FINER: Loading and registering message receiver: test
MessageRouter.addRouter() INFO: Adding receiver: TestComponent
MessageRouter.addComponent() INFO: Adding component: TestComponent
MessageRouter.addComponent() FINER: Adding: test component to basic-conf registrator.
Configurator.componentAdded() CONFIG:  component: test</pre><p>If your component did not load you should first check configuration files. Maybe you forgot to remove the <span class="strong"><strong>tigase.xml</strong></span> file before restarting the server or alternatively the Tigase could not find your class at startup time. Make sure your class is in <span class="strong"><strong>CLASSPATH</strong></span> or copy a JAR file with your class to Tigase <span class="strong"><strong>libs/</strong></span> directory.</p><p>Assuming everything went well and your component is loaded by the Tigase sever and it shows on the service discovery list as on the screenshot above you can double click on it to get a window with a list of ad-hoc commands - administrator scripts. A window on the screenshot shows only two basic commands for adding and removing script which is a good start.</p><p><span class="inlinemediaobject"><img src="./images/commands-list-test-200.png" alt="commands-list-test-200"></span></p><p>Moreover, you can browse the server statistics in the service discovery window to find your new test component on the list. If you click on the component it shows you a window with component statistics, very basic packets counters.</p><p>iThu Jun 19 14:45:56 2014mage:images/service-disco-stats-200.png[]</p><p>As we can see with just a few lines of code our new component is quite mighty and can do a lot of things without much effort from the developer side.</p><p>Now, the time has come to the most important question. Can our new component do something useful, that is can it receive and process XMPP packets?</p><p>Let&#8217;s try it out. Using you favourite client send a message to JID: <span class="strong"><strong>test@devel.tigase.org</strong></span> (assuming your server is configured for <span class="strong"><strong>devel.tigase.org</strong></span> domain). You can either use kind of XML console in your client or just send a plain message to the component JID. According to our code in <span class="strong"><strong>processPacket(&#8230;&#8203;)</strong></span> method it should log our message. For this test I have sent a message with subject: "<span class="emphasis"><em>test message</em></span>" and body: "<span class="emphasis"><em>this is a test</em></span>". The log file should contain following entry:</p><pre class="programlisting">TestComponent.processPacket() FINEST: My packet: to=null, from=null,
data=&lt;message from="admin@devel.tigase.org/devel"
  to="test@devel.tigase.org" id="abcaa" xmlns="jabber:client"&gt;
  &lt;subject&gt;test message&lt;/subject&gt;
  &lt;body&gt;this is a test&lt;/body&gt;
&lt;/message&gt;, XMLNS=jabber:client, priority=NORMAL</pre><p>If this is a case we can be sure that everything works as expected and all we now have to do is to fill the <span class="strong"><strong>processPacket(&#8230;&#8203;)</strong></span> method with some useful code.</p></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="componentdevelpoment.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="cil2.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;19.&nbsp;Component Development&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;21.&nbsp;Component Implementation - Lesson 2 - Configuration</td></tr></table></div></body></html>