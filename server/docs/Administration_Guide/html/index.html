<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0">
<meta name="author" content="Tigase Team">
<title>Tigase Administration Guide</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic|Noto+Serif:400,400italic,700,700italic|Droid+Sans+Mono:400">
<link rel="stylesheet" href="./asciidoctor.css">
<link rel="stylesheet" href="./coderay-asciidoctor.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Tigase Administration Guide</h1>
<div class="details">
<span id="author" class="author">Tigase Team</span><br>
<span id="email" class="email"><a href="mailto:team@tigase.net">team@tigase.net</a></span><br>
<span id="revdate">v7.0.0</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_scripting_support_in_tigase">1. Scripting support in Tigase</a></li>
<li><a href="#_scripting_introduction_hello_world">2. Scripting Introduction - Hello World!</a>
<ul class="sectlevel2">
<li><a href="#_loading_script_at_run_time">2.1. Loading Script at Run Time</a></li>
<li><a href="#_executing_script">2.2. Executing Script</a></li>
<li><a href="#_interaction_in_scripts">2.3. Interaction in Scripts</a></li>
<li><a href="#_automatic_scripts_loading_at_startup_time">2.4. Automatic Scripts Loading at Startup Time</a></li>
</ul>
</li>
<li><a href="#_tigase_scripting_version_4_4_x_update_for_administrators">3. Tigase Scripting Version 4.4.x Update for Administrators</a></li>
<li><a href="#_tigase_and_python">4. Tigase and Python</a>
<ul class="sectlevel2">
<li><a href="#_installation">4.1. Installation</a></li>
<li><a href="#_writing_python_scripts">4.2. Writing Python Scripts</a></li>
</ul>
</li>
<li><a href="#_about_tigase_jabber_xmpp_server">5. About Tigase Jabber/XMPP Server</a>
<ul class="sectlevel2">
<li><a href="#_security">5.1. Security</a></li>
<li><a href="#_flexibility">5.2. Flexibility</a></li>
<li><a href="#_easy">5.3. Easy</a></li>
</ul>
</li>
<li><a href="#_quick_start">6. Quick Start</a></li>
<li><a href="#_installation_using_gui_installer">7. Installation Using GUI Installer</a>
<ul class="sectlevel2">
<li><a href="#_prerequisites">7.1. Prerequisites</a></li>
<li><a href="#_download_the_installer">7.2. Download the Installer</a></li>
<li><a href="#_run_the_jar_file">7.3. Run the jar File</a></li>
<li><a href="#_starting_the_installation">7.4. Starting the Installation</a></li>
</ul>
</li>
<li><a href="#_installing_using_console_installer">8. Installing Using Console Installer</a>
<ul class="sectlevel2">
<li><a href="#_installation_using_the_text_mode_installer">8.1. Installation Using the text-mode Installer</a></li>
<li><a href="#_download_the_installer_2">8.2. Download the Installer</a></li>
<li><a href="#_run_the_jar_file_2">8.3. Run the jar File</a></li>
<li><a href="#_installation_steps">8.4. Installation Steps</a></li>
</ul>
</li>
<li><a href="#_manual_installation_in_console_mode">9. Manual Installation in Console Mode</a>
<ul class="sectlevel2">
<li><a href="#_get_the_binary_package">9.1. Get the Binary Package</a></li>
<li><a href="#_unpack_the_package">9.2. Unpack the Package</a></li>
<li><a href="#_prepare_configuration">9.3. Prepare Configuration</a></li>
<li><a href="#_prepare_database">9.4. Prepare Database</a></li>
<li><a href="#_start_the_server">9.5. Start the Server</a></li>
<li><a href="#_check_if_it_is_working">9.6. Check if it is Working</a></li>
</ul>
</li>
<li><a href="#_tigase_server_binary_updates">10. Tigase Server Binary Updates</a></li>
<li><a href="#_installation_using_web_installer">11. Installation Using Web Installer</a>
<ul class="sectlevel2">
<li><a href="#_download_and_extract">11.1. Download and Extract</a></li>
<li><a href="#_start_the_server_2">11.2. Start the Server</a></li>
<li><a href="#_verify_tigase_is_running">11.3. Verify Tigase is Running</a></li>
<li><a href="#_connect_to_the_web_installer">11.4. Connect to the Web Installer</a></li>
<li><a href="#_step_through_the_installation_process">11.5. Step Through the Installation Process</a></li>
</ul>
</li>
<li><a href="#_tigase_server_and_multiple_databases">12. Tigase Server and Multiple Databases</a></li>
<li><a href="#_basic_system_checks">13. Basic System Checks</a></li>
<li><a href="#_linux_settings_for_high_load_systems">14. Linux Settings for High Load Systems</a>
<ul class="sectlevel2">
<li><a href="#_fs_file_max">14.1. fs.file-max</a></li>
<li><a href="#_net_ipv4_ip_local_port_range">14.2. net.ipv4.ip_local_port_range</a></li>
<li><a href="#_tcp_keepalive">14.3. TCP_keepalive</a></li>
<li><a href="#__etc_sysctl_conf">14.4. /etc/sysctl.conf</a></li>
<li><a href="#_nofile">14.5. nofile</a></li>
<li><a href="#_su_and_init_script">14.6. su and init script</a></li>
</ul>
</li>
<li><a href="#_generic_documents_applying_to_all_tigase_server_versions">15. Generic Documents - Applying to All Tigase Server Versions</a></li>
<li><a href="#_configuration">16. Configuration</a></li>
<li><a href="#_tigase_xmpp_server_configuration_properties">17. Tigase XMPP Server Configuration Properties</a></li>
<li><a href="#_init_properties">18. init.properties</a></li>
<li><a href="#_xml_configuration_file_description">19. XML Configuration File Description</a></li>
<li><a href="#_old_way_editing_configuration_file_manually">20. Old Way - Editing Configuration File Manually</a>
<ul class="sectlevel2">
<li><a href="#_admin_accounts">20.1. Admin Accounts</a></li>
<li><a href="#_hostnames">20.2. Hostnames</a></li>
<li><a href="#_logs">20.3. Logs</a></li>
</ul>
</li>
<li><a href="#_startup_file_for_tigase_sh_tigase_conf">21. Startup File for tigase.sh - tigase.conf</a></li>
<li><a href="#_server_certificates">22. Server Certificates</a>
<ul class="sectlevel2">
<li><a href="#_documents_describing_how_to_obtain_and_manage_server_certificates">22.1. Documents Describing How To Obtain and Manage Server Certificates</a></li>
</ul>
</li>
<li><a href="#_creating_and_loading_the_server_certificate_in_pem_files">23. Creating and Loading the Server Certificate in pem Files</a>
<ul class="sectlevel2">
<li><a href="#_server_certificate">23.1. Server Certificate</a></li>
<li><a href="#_installing_loading_certificate_to_the_tigase_server">23.2. Installing/Loading Certificate To the Tigase Server</a></li>
<li><a href="#_tigase_server_configuration">23.3. Tigase Server Configuration</a></li>
</ul>
</li>
<li><a href="#_installing_startcom_certificate_in_your_linux_system">24. Installing StartCom Certificate in Your Linux System</a>
<ul class="sectlevel2">
<li><a href="#_gentoo_linux">24.1. Gentoo Linux</a></li>
</ul>
</li>
<li><a href="#_server_certificate_using_keytool_and_keystore">25. Server Certificate Using Keytool and Keystore</a>
<ul class="sectlevel2">
<li><a href="#_self_signed_certificate_2">25.1. Self Signed Certificate</a></li>
<li><a href="#_cerificate_from_ca">25.2. Cerificate from CA</a></li>
</ul>
</li>
<li><a href="#_tigase_and_pymsn_t_transport">26. Tigase and PyMSN-t Transport</a>
<ul class="sectlevel2">
<li><a href="#_pymsn_t_etc_jabber_pymsn_t_xml_file">26.1. PyMSN-t - /etc/jabber/pymsn-t.xml file</a></li>
<li><a href="#_pymsn_t_run_command">26.2. PyMSN-t - run command</a></li>
<li><a href="#_pymsn_t_expected_output">26.3. PyMSN-t - expected output</a></li>
<li><a href="#_tigase_etc_tigase_conf_file">26.4. Tigase - etc/tigase.conf file</a></li>
<li><a href="#_tigase_run_command">26.5. Tigase - run command</a></li>
<li><a href="#_tigase_expected_output">26.6. Tigase - expected output</a></li>
</ul>
</li>
<li><a href="#_two_or_more_sessionmanagers">27. Two or More SessionManagers</a></li>
<li><a href="#_database_preparation">28. Database Preparation</a></li>
<li><a href="#_prepare_the_mysql_database_for_the_tigase_server">29. Prepare the MySQL Database for the Tigase Server</a>
<ul class="sectlevel2">
<li><a href="#_basic_setup">29.1. Basic Setup</a></li>
<li><a href="#_configuring_from_the_linux_shell_command_line">29.2. Configuring From the Linux Shell Command Line</a></li>
<li><a href="#_configuring_mysql_for_utf_8_support">29.3. Configuring MySQL for UTF-8 Support</a></li>
<li><a href="#_other_mysql_setting_worth_considering">29.4. Other MySQL Setting Worth Considering</a></li>
</ul>
</li>
<li><a href="#_hashed_user_passwords_in_database">30. Hashed User Passwords in Database</a>
<ul class="sectlevel2">
<li><a href="#_shortcut">30.1. Shortcut</a></li>
<li><a href="#_full_route">30.2. Full Route</a></li>
</ul>
</li>
<li><a href="#_prepare_the_derby_database_for_the_tigase_server">31. Prepare the Derby Database for the Tigase Server</a>
<ul class="sectlevel2">
<li><a href="#_basic_setup_2">31.1. Basic Setup</a></li>
</ul>
</li>
<li><a href="#_prepare_the_ms_sql_server_database_for_the_tigase_server">32. Prepare the MS SQL Server Database for the Tigase Server</a>
<ul class="sectlevel2">
<li><a href="#_basic_setup_3">32.1. Basic Setup</a></li>
<li><a href="#_preparing_sql_server_instance">32.2. Preparing SQL Server Instance</a></li>
<li><a href="#_configuring_using_sql_server_management_studio">32.3. Configuring using SQL Server Management Studio</a></li>
<li><a href="#_import_schema">32.4. Import Schema</a></li>
<li><a href="#_configuring_from_command_line_tool">32.5. Configuring from command line tool</a></li>
<li><a href="#_tigase_configuration_init_properties">32.6. Tigase configuration - init.properties</a></li>
<li><a href="#_jdbc_jtds_vs_ms_jdbc_driver">32.7. JDBC: jTDS vs MS JDBC driver</a></li>
</ul>
</li>
<li><a href="#_prepare_the_postgresql_database_for_the_tigase_server">33. Prepare the PostgreSQL Database for the Tigase Server</a>
<ul class="sectlevel2">
<li><a href="#_basic_setup_4">33.1. Basic Setup</a></li>
</ul>
</li>
<li><a href="#_tigase_database_minor_but_useful_schema_change_in_version_5_1_0">34. Tigase Database Minor but Useful Schema Change in Version 5.1.0</a></li>
<li><a href="#_tigase_load_balancing">35. Tigase Load Balancing</a>
<ul class="sectlevel2">
<li><a href="#_available_implementations">35.1. Available Implementations</a></li>
<li><a href="#_configuration_options">35.2. Configuration Options</a></li>
</ul>
</li>
<li><a href="#_stanzasender">36. StanzaSender</a>
<ul class="sectlevel2">
<li><a href="#_how_it_works">36.1. How it Works</a></li>
<li><a href="#_configuration_2">36.2. Configuration</a></li>
</ul>
</li>
<li><a href="#_debuging_tigase">37. Debuging Tigase</a>
<ul class="sectlevel2">
<li><a href="#_the_easy_way_init_properties_file">37.1. The easy way - init.properties file</a></li>
<li><a href="#_the_more_difficult_but_more_powerful_tigase_xml_file_only_applicable_to_versions_before_5_0_0">37.2. The more difficult but more powerful - tigase.xml file (only applicable to versions before 5.0.0)</a></li>
</ul>
</li>
<li><a href="#_importing_user_data">38. Importing User Data</a></li>
<li><a href="#_drupal_authentication_added">39. Drupal Authentication Added</a></li>
<li><a href="#_tigase_services">40. Tigase Services</a></li>
<li><a href="#_add_and_manage_domain">41. Add and Manage Domain</a>
<ul class="sectlevel2">
<li><a href="#_adding_a_new_domain">41.1. Adding a New Domain</a></li>
<li><a href="#_adding_a_new_user">41.2. Adding a New User</a></li>
<li><a href="#_what_else">41.3. What Else?</a></li>
</ul>
</li>
<li><a href="#_presence_forwarding">42. Presence Forwarding</a></li>
<li><a href="#_register_own_xmpp_domain">43. Register Own XMPP Domain</a></li>
<li><a href="#_server_monitoring">44. Server Monitoring</a>
<ul class="sectlevel2">
<li><a href="#setUpRemoteMonitoring">44.1. Setting Up Remote Monitoring in the Server</a></li>
<li><a href="#RetrievingStatisticsFromTheServer">44.2. Retrieving statistics from the server</a></li>
</ul>
</li>
<li><a href="#TipsAndTricks">45. Tips and Tricks</a>
<ul class="sectlevel2">
<li><a href="#_tigase_tip_checking_the_runtime_environment">45.1. Tigase Tip: Checking the Runtime Environment</a></li>
<li><a href="#_tigase_tip_checking_cluster_connections">45.2. Tigase Tip: Checking Cluster Connections</a></li>
</ul>
</li>
<li><a href="#_tigase_server_version_5_x">46. Tigase Server version 5.x</a></li>
<li><a href="#_tigase_5_1_database_schema_upgrade">47. Tigase 5.1 Database Schema Upgrade</a></li>
<li><a href="#_derby_database_schema_upgrade_for_tigase_5_1">48. Derby Database Schema Upgrade for Tigase 5.1</a></li>
<li><a href="#_mysql_database_schema_upgrade_for_tigase_5_1">49. MySQL Database Schema Upgrade for Tigase 5.1</a></li>
<li><a href="#_postgresql_database_schema_upgrade_for_tigase_5_1">50. PostgreSQL Database Schema Upgrade for Tigase 5.1</a></li>
<li><a href="#_server_configuration_5_x">51. Server Configuration 5.x</a></li>
<li><a href="#_configuration_changes_in_the_tigase_server_5_x">52. Configuration Changes in the Tigase Server 5.x</a>
<ul class="sectlevel2">
<li><a href="#_reverting_to_the_old_behaviour">52.1. Reverting To the Old Behaviour</a></li>
<li><a href="#_default_behaviour">52.2. Default Behaviour</a></li>
<li><a href="#_storing_configuration_in_sql_database">52.3. Storing Configuration in SQL Database</a></li>
<li><a href="#_going_further">52.4. Going Further</a></li>
<li><a href="#_message_router_implementation_is_configurable_too">52.5. Message Router Implementation is Configurable Too</a></li>
</ul>
</li>
<li><a href="#_advanced_message_processing_amp_xep_0079">53. Advanced Message Processing - AMP XEP-0079</a></li>
<li><a href="#_configuration_sasl_external">54. Configuration SASL EXTERNAL</a></li>
<li><a href="#_server_to_server_protocol_settings">55. Server to Server Protocol Settings</a>
<ul class="sectlevel2">
<li><a href="#_number_of_concurrent_connections">55.1. Number of Concurrent Connections</a></li>
<li><a href="#_connection_throughput">55.2. Connection Throughput</a></li>
<li><a href="#_maximum_packet_waiting_time_and_connection_inactivity_time">55.3. Maximum Packet Waiting Time and Connection Inactivity Time</a></li>
<li><a href="#_custom_plugin_selecting_s2s_connection">55.4. Custom Plugin Selecting s2s Connection</a></li>
</ul>
</li>
<li><a href="#_tigase_server_version_4_x">56. Tigase Server Version 4.x</a></li>
<li><a href="#_mysql_database_schema_upgrade_for_tigase_4_0">57. MySQL Database Schema Upgrade for Tigase 4.0</a></li>
<li><a href="#_virtual_components_for_the_cluster_mode">58. Virtual Components for the Cluster Mode</a></li>
<li><a href="#_external_component_configuration">59. External Component Configuration</a></li>
<li><a href="#_basic_configuration_options_external_component">60. Basic Configuration Options (External Component)</a>
<ul class="sectlevel2">
<li><a href="#_simple_case">60.1. Simple Case</a></li>
<li><a href="#_more_external_components_domains">60.2. More External Components/Domains</a></li>
<li><a href="#_more_tcp_ip_ports">60.3. More TCP/IP Ports</a></li>
<li><a href="#_outgoing_connections">60.4. Outgoing Connections</a></li>
<li><a href="#_specifying_protocol">60.5. Specifying Protocol</a></li>
<li><a href="#_load_balancer_plugin">60.6. Load Balancer Plugin</a></li>
</ul>
</li>
<li><a href="#_tigase_as_external_component">61. Tigase as External Component</a>
<ul class="sectlevel2">
<li><a href="#_a_simple_case_muc_as_an_external_component">61.1. A Simple Case - MUC as an External Component</a></li>
<li><a href="#_more_components">61.2. More Components</a></li>
</ul>
</li>
<li><a href="#_load_balancing_external_components_in_cluster_mode">62. Load Balancing External Components in Cluster Mode</a>
<ul class="sectlevel2">
<li><a href="#_load_balancing_external_component">62.1. Load Balancing External Component</a></li>
<li><a href="#_external_component_and_cluster">62.2. External Component and Cluster</a></li>
</ul>
</li>
<li><a href="#_packet_filtering">63. Packet Filtering</a>
<ul class="sectlevel2">
<li><a href="#_domain_based_packet_filtering">63.1. Domain Based Packet Filtering</a></li>
</ul>
</li>
<li><a href="#_virtual_hosts_in_the_tigase_server">64. Virtual Hosts in the Tigase Server</a></li>
<li><a href="#_specification_for_ad_hoc_commands_used_to_manage_virtual_domains">65. Specification for ad-hoc Commands Used to Manage Virtual Domains</a>
<ul class="sectlevel2">
<li><a href="#_reloading_the_domains_list_from_the_database">65.1. Reloading the Domains List from the Database</a></li>
<li><a href="#_adding_a_new_domain_or_updating_existing_one">65.2. Adding a New Domain or Updating Existing One</a></li>
<li><a href="#_removing_a_virtual_domain_from_the_server">65.3. Removing a Virtual Domain From the Server</a></li>
</ul>
</li>
<li><a href="#_configuration_4">66. Configuration</a></li>
<li><a href="#_configuring_the_tigase_server_to_load_a_component">67. Configuring the Tigase Server to Load a Component</a></li>
<li><a href="#_custom_authentication_connectors">68. Custom Authentication Connectors</a></li>
<li><a href="#_tigase_custom_auth_connector">69. Tigase Custom Auth Connector</a></li>
<li><a href="#_ldap_authentication_connector">70. LDAP Authentication Connector</a></li>
<li><a href="#_tigase_auth_connector">71. Tigase Auth Connector</a></li>
<li><a href="#_tigase_server_version_3_x">72. Tigase Server Version 3.x</a></li>
<li><a href="#_connecting_the_tigase_server_to_mysql_database">73. Connecting the Tigase Server to MySQL Database</a></li>
<li><a href="#_integrating_tigase_server_with_drupal">74. Integrating Tigase Server with Drupal</a>
<ul class="sectlevel2">
<li><a href="#_connecting_to_drupal_database">74.1. Connecting to Drupal Database</a></li>
</ul>
</li>
<li><a href="#_integrating_tigase_server_with_libresource">75. Integrating Tigase Server With LibreSource</a>
<ul class="sectlevel2">
<li><a href="#_short_introduction">75.1. Short Introduction.</a></li>
<li><a href="#_how_to_set_tigase_up">75.2. How to set Tigase up.</a></li>
<li><a href="#_migration_from_old_tigase_installation_to_libresource">75.3. Migration From old Tigase Installation to LibreSource</a></li>
</ul>
</li>
<li><a href="#_windows_installation">76. Windows Installation</a>
<ul class="sectlevel2">
<li><a href="#_mysql_database_installation">76.1. MySQL Database Installation</a></li>
</ul>
</li>
<li><a href="#_configuration_5">77. Configuration</a></li>
<li><a href="#_configuration_wizards">78. Configuration Wizards</a></li>
<li><a href="#_tigase_server_version_2_x">79. Tigase Server version 2.x</a></li>
<li><a href="#_installation_3">80. Installation</a></li>
<li><a href="#_mysql_database_use">81. MySQL Database Use</a>
<ul class="sectlevel2">
<li><a href="#_mysql_database_preparation">81.1. MySQL Database Preparation</a></li>
<li><a href="#_server_configuration">81.2. Server Configuration</a></li>
<li><a href="#_user_data_import">81.3. User Data Import</a></li>
</ul>
</li>
<li><a href="#_postgresql_database_use">82. PostgreSQL Database Use</a>
<ul class="sectlevel2">
<li><a href="#_postgresql_database_preparation">82.1. PostgreSQL Database Preparation</a></li>
<li><a href="#_server_configuration_2">82.2. Server Configuration</a></li>
</ul>
</li>
<li><a href="#_configuration_6">83. Configuration</a></li>
<li><a href="#_short_configuration_guide">84. Short Configuration Guide</a>
<ul class="sectlevel2">
<li><a href="#_admin_accounts_2">84.1. Admin Accounts</a></li>
<li><a href="#_hostnames_2">84.2. Hostnames</a></li>
</ul>
</li>
<li><a href="#_command_line_admin_tools">85. Command Line Admin Tools</a></li>
<li><a href="#_configuration_management_tool">86. Configuration Management Tool</a></li>
<li><a href="#_best_practices_for_connecting_from_web_browser_to_tigase_xmpp_server">87. Best Practices for Connecting From Web Browser to Tigase XMPP Server</a>
<ul class="sectlevel2">
<li><a href="#_bosh">87.1. BOSH</a></li>
<li><a href="#_websocket">87.2. WebSocket</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_scripting_support_in_tigase"><a class="anchor" href="#_scripting_support_in_tigase"></a>1. Scripting support in Tigase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>The Tigase server supports scripting languages from the version 4.3.1. These pages describe this feature in details how to create new scripts, upload them to the server and execute them. The guide also contains API description with code examples.</p>
</div>
<div class="paragraph">
<p>There is one thing I have to highlight before you start digging into the scripting stuff. The Tigase server is known for it very low memory consumption. It successfully runs with less then 10MB of RAM memory. However, if you added scripting support for any non-standard (default) language to the Tigase server it significantly increases memory requirements for the installation. You cannot expect the Tigase server to run on 10MB RAM system if you enabled Python, Scala or any other non-standard language.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_scripting_introduction_hello_world"><a class="anchor" href="#_scripting_introduction_hello_world"></a>2. Scripting Introduction - Hello World!</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:18</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/tiger3-small.png" alt="tiger3-small"></span></p>
</div>
<div class="paragraph">
<p>This document is the first in series describing scripting support in the Tigase server. It shows how to load, install, update and call a script. It contains also an introduction to the scripting API with the first "Hello world!" like example.</p>
</div>
<div class="paragraph">
<p>Since the Tigase version 4.3.1 the server supports scripting for administrator commands.</p>
</div>
<div class="paragraph">
<p>In theory many different languages can be used to write scripts and the only requirement is that the support <a href="http://www.jcp.org/en/jsr/detail?id=223">JSR-223</a> for the language. More details can be found on the <a href="https://scripting.dev.java.net/">Java scripting project site</a>.</p>
</div>
<div class="paragraph">
<p>In practice some languages are better supported than others. At the moment the most recommended is <a href="http://groovy.codehaus.org/">Groovy</a>, although following languages are also confirmed to be working: <a href="http://www.scala-lang.org/">Scala</a>, <a href="http://www.python.org/">Python</a> and <a href="http://www.ruby-lang.org/en/">Ruby</a>. The <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main">Tigase SVN</a> contains a few examples for these languages.</p>
</div>
<div class="paragraph">
<p>Please note, the default Tigase installation contains only libraries for Groovy. Adding support for a different language is as simple as copying a few JAR files to the Tigase <strong>libs/</strong> directory.</p>
</div>
<div class="paragraph">
<p>All the examples presented in this guide are also available as ready to use scripts in the Tigase SVN repository in directory: <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/groovy/tigase/admin">src/main/groovy/tigase/admin</a>.</p>
</div>
<div class="paragraph">
<p>The scripting utilises only standard XMPP extensions and is by no means specific to any particular solution. I use and prefer Psi client. The whole guide and all the screenshots are created using Psi client. You can, however, use any other client which supports these extensions as well. As the whole thing is based on the service discovery and ad-hoc commands you need an XMPP client with a good support for both features.</p>
</div>
<div class="paragraph">
<p>To follow the guide and run all the examples you need installed Tigase server in version at least 4.3.1 and you have to connect to the server as administrator.</p>
</div>
<div class="sect2">
<h3 id="_loading_script_at_run_time"><a class="anchor" href="#_loading_script_at_run_time"></a>2.1. Loading Script at Run Time</h3>
<div class="paragraph">
<p>All the scripting stuff is as usually based on the service discovery and ad-hoc commands in the Tigase server.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service-disco.png" alt="service-disco"></span></p>
</div>
<div class="paragraph">
<p>The first thing to do, therefore, is to browse service discovery on the running server. The result you receive depends on your installation and installed components.</p>
</div>
<div class="paragraph">
<p>The most interesting for us right now are all items with "<strong><a href="http://jabber.org/protocol/admin" class="bare">http://jabber.org/protocol/admin</a></strong>" in their node part. You may have a few scripts loaded already but there are two commands used for scripting management. Their names are descriptive anouth I hope: "<strong>New command script</strong>" and "<strong>Remove command script</strong>".</p>
</div>
<div class="paragraph">
<p>The first is for adding a new script or updating existing and the second is for removing script from the server.</p>
</div>
<div class="paragraph">
<p>To add a new script you have just to execute "<strong>New command script</strong>". In Psi this is done by double clicking on the element in service discovery list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/hello1-new-script.png" alt="hello1-new-script"></span></p>
</div>
<div class="paragraph">
<p>The screenshot above shows a couple of options to set for the loaded script:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Description</strong> - is what shows as the script name in the service discovery window. There are no special restrictions on what to put there.</p>
</li>
<li>
<p><strong>Command id</strong> - is a unique ID of the script (admin command). This is what shows after the "http://jabber.org/protocol/admin" in node part. This needs to be unique or existing script is overwritten.</p>
</li>
<li>
<p><strong>Language</strong> - a drop down list of all supported scripting languages for your installation. The Tigase automatically detects all libraries for scripting languages and lists them here. So all you need is to select correct language for your script.</p>
</li>
<li>
<p><strong>Script text</strong> - is just your script content.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When your script is ready and all fields are correctly set, simply press "<strong>Finish</strong>" button and you should receive a message confirming that the script has been loaded successfully.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/loaded-ok-small.png" alt="loaded-ok-small"></span></p>
</div>
<div class="paragraph">
<p>In this guide we are creating a simple script of type "Hello world". The script is written in Groovy. What it does is displaying a window (ad-hoc command result) with a message: "<em>Hello admin, how are you?</em>".</p>
</div>
<div class="paragraph">
<p>It uses a basic scripting API which is described line by line below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It imports basic Tigase classes.</p>
</li>
<li>
<p>Set&#8217;s a local variable \'p' which points to a \'packet' variable with data received from the client.</p>
</li>
<li>
<p>Creates a \'res' variable which is response sent back to the client (administrator). The response to the client is of type \'result'. Other possible types will be introduced later.</p>
</li>
<li>
<p>We operate on ad-hoc commands here so the script uses Tigase utility class to set/retrieve command parameters. It sets the window title and a simple message displayed to the user (administrator).</p>
</li>
<li>
<p>The last line returns new packet as a script execution result.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The first, very simple version looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">tigase.server</span>.*
<span class="include">def</span> <span class="include">p</span> = (<span class="include">Packet</span>)<span class="include">packet</span>
<span class="include">def</span> <span class="include">res</span> = <span class="include">p.commandResult</span>(<span class="include">Command.DataType.result</span>)
<span class="include">Command.addTitle</span>(<span class="include">res</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World Script</span><span class="delimiter">&quot;</span></span>)
<span class="include">Command.addInstructions</span>(<span class="include">res</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello admin, how are you?</span><span class="delimiter">&quot;</span></span>)
<span class="include">return</span> <span class="include">res</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_executing_script"><a class="anchor" href="#_executing_script"></a>2.2. Executing Script</h3>
<div class="paragraph">
<p>Once the script is successfully loaded you have to reload/refresh the service discovery window which now should display one more element on the list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service-disco-with-new-hello.png" alt="service-disco-with-new-hello"></span></p>
</div>
<div class="paragraph">
<p>As you can see script name is set to what you have entered as "Description" in script loading window - "<em>Hello world script</em>". The command node is set to: "http://jabber.org/protocol/admin#hello" if "<strong>hello</strong>" is what is set as the script ID.</p>
</div>
<div class="paragraph">
<p>To execute the script you just have to double click on the script name (or click execute command if you use any other client).</p>
</div>
<div class="paragraph">
<p>As a result you should see a simple window similar to the screenshot below displaying our message.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/hello1-result-small.png" alt="hello1-result-small"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_interaction_in_scripts"><a class="anchor" href="#_interaction_in_scripts"></a>2.3. Interaction in Scripts</h3>
<div class="paragraph">
<p>Displaying just a message is very nice but in most cases not very useful. Normally you need to ask the user for some more data or parameters before you can perform any real processing.</p>
</div>
<div class="paragraph">
<p>Therefore in most cases the administrator script has to display a new window with input fields asking the user (admin) for some more data. In this document we present very simple examples, just an introduction so let&#8217;s ask about the administrator name before displaying greetings.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/hello2-asking-for-name-small.png" alt="hello2-asking-for-name-small"></span></p>
</div>
<div class="paragraph">
<p>To ask the user for some more information we have to extend example above with some more code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">tigase.server</span>.*

<span class="include">def</span> <span class="include">p</span> = (<span class="include">Packet</span>)<span class="include">packet</span>

<span class="include">def</span> <span class="include">name</span> = <span class="include">Command.getFieldValue</span>(<span class="include">packet</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>)

<span class="include">if</span> (<span class="include">name</span> == <span class="include">null</span>) {
  <span class="include">def</span> <span class="include">res</span> = <span class="include">p.commandResult</span>(<span class="include">Command.DataType.form</span>);
  Command.addTitle(res, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World Script</span><span class="delimiter">&quot;</span></span>)
  Command.addInstructions(res, <span class="string"><span class="delimiter">&quot;</span><span class="content">Please provide some details</span><span class="delimiter">&quot;</span></span>)
  Command.addFieldValue(res, <span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>, name ?: <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">text-single</span><span class="delimiter">&quot;</span></span>,
    <span class="string"><span class="delimiter">&quot;</span><span class="content">Your name</span><span class="delimiter">&quot;</span></span>)
  <span class="keyword">return</span> res
}

def res = p.commandResult(Command.DataType.result)
Command.addTitle(res, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello World Script</span><span class="delimiter">&quot;</span></span>)
Command.addInstructions(res, <span class="string"><span class="delimiter">&quot;</span><span class="content">Hello ${name}, how are you?</span><span class="delimiter">&quot;</span></span>)

<span class="keyword">return</span> res</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you compare both scripts you see that they are quite similar. Before displaying greeting, however, the script tries to retrieve data from the \'name' input field. If the name had been provided the greeting is displayed, otherwise the script asks for the user name.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/hello2-result-small.png" alt="hello2-result-small"></span></p>
</div>
<div class="paragraph">
<p>Please note, in this case the packet sent back to the user is of type form instead of result. The practical difference is that the type result displays only <strong>OK</strong> button which is pressed doesn&#8217;t send any data to the server. The form packet displays more buttons - <strong>Finish</strong> and <strong>Cancel</strong>. Whichever you press some data are sent back to the server.</p>
</div>
<div class="paragraph">
<p>The script demonstrates use of two new methods from the utility class "Command": getFieldValue and addFieldValue.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The first argument to all Command methods is the packet with ad-hoc command.</p>
</li>
<li>
<p>The second argument is usually the input field name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These two method parameters are actually enough to read the ad-hoc command data. Methods creating input fields in the ad-hoc command need a few arguments more:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Next arguments sets a default value displayed to the user. The way how it is set in the example above is specific to Groovy language and is quite useful what will be apparent in later examples.</p>
</li>
<li>
<p>After that we have to specify the field type. All field types are defined in the <a href="http://xmpp.org/extensions/xep-0004.html#protocol-fieldtypes">XEP-0004</a>.</p>
</li>
<li>
<p>The last argument specifies the field label which is displayed to the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/hello2-new-script.png" alt="hello2-new-script"></span></p>
</div>
<div class="paragraph">
<p>There are a few other different utility methods in the Command class to set different types of input fields and they will be described in details later on.</p>
</div>
<div class="paragraph">
<p>To reload the script simply call "New command script" again, enter the script text and make sure you entered exactly the same command ID to replace the old script with the new one.</p>
</div>
<div class="paragraph">
<p>Or, of course you can enter a new command id to create a new command and make it available on your server.</p>
</div>
<div class="paragraph">
<p>When the script is loaded on the server, try to execute it. You should get a new dialog window asking for your name as in the screenshot at the beginning of this section. When you entered your name and pressed "Finish" button you see another window and greetings message with your name.</p>
</div>
</div>
<div class="sect2">
<h3 id="_automatic_scripts_loading_at_startup_time"><a class="anchor" href="#_automatic_scripts_loading_at_startup_time"></a>2.4. Automatic Scripts Loading at Startup Time</h3>
<div class="paragraph">
<p>The last thing described in this guide is how to automatically load your scripts when the Tigase server starts. The ability to load scripts at run time, update them and remove is very useful, especially in emergency cases if something wrong is going on and you want to act without affecting the service.</p>
</div>
<div class="paragraph">
<p>If you, however have a few dozens scripts you don&#8217;t want to manually load them every time the server restarts.</p>
</div>
<div class="paragraph">
<p>The Tigase server automatically loads all scripts at the startup time which are located in the admin scripts directory. Unless you set it differently in the configuration it is: <strong>YourTigaseInstallationDir/scripts/admin/</strong>. All you have to do is to copy all your scripts to this directory and they will be loaded next time the server starts.</p>
</div>
<div class="paragraph">
<p>But hold on. What about the script parameters: language, description, command id? How are you supposed to set them?</p>
</div>
<div class="paragraph">
<p>Language is simple. It is detected automatically by the script file extension. So just make sure file extensions are correct and the language is sorted.</p>
</div>
<div class="paragraph">
<p>The script description and command id needs a little bit more work. You have to include in your script following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">AS:Description: The command description
AS:CommandId: command-id
AS:<span class="predefined-type">Component</span>: comp_name</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note, there must be at least a single space after the "AS:Description:" or "AS:CommandId:" string. Everything rest after that, until the end of the line, is treated as either the script description or command id. Put these in your script file and the loader will detect them and set correctly for your script.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_scripting_version_4_4_x_update_for_administrators"><a class="anchor" href="#_tigase_scripting_version_4_4_x_update_for_administrators"></a>3. Tigase Scripting Version 4.4.x Update for Administrators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:18</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/tiger-looking-left-small.png" alt="tiger-looking-left-small"></span></p>
</div>
<div class="paragraph">
<p>Scripting functionality is quite useful in the Tigase server for all sorts of administrator tasks. The possibility to load new scripts or replace old ones at the server runtime opens quite new area for the service maintenance.</p>
</div>
<div class="paragraph">
<p>In earlier versions of the Tigase server scripting capabilities was available only in the session manager component while it might be very useful in many other places - connection managers, MUC, PubSub, VHostManager and what even more important in completely new, custom components created for specific needs. It would be quite wasteful to reinvent the wheel every time and implementing scripting capabilities for each component separately.</p>
</div>
<div class="paragraph">
<p>Therefore the scripting capabilities has been implemented in the core of the Tigase server. It is now part of the API and is automatically available to all components without any additional coding. A detailed developer guide will be published separately.</p>
</div>
<div class="paragraph">
<p>This document describes changes from the user/administrator perspective because there are some usability changes related to the new implementation.</p>
</div>
<div class="paragraph">
<p>Please note. The description and screenshots are taken from the Psi client and most likely interface for ad-hoc commands and service discovery on other client looks different. I recommend to do some initial testing and experiments using Psi client and then switch to your preferred application for your day-to-day use.</p>
</div>
<div class="paragraph">
<p>As it always was in the Tigase you can access all the functions via XMPP service discovery on the server. However, as soon as you connect to the server you can see some changes there.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/new-service-disco-admin.png" alt="new-service-disco-admin"></span></p>
</div>
<div class="paragraph">
<p>There are no command on the list. They are hidden from the main service discovery list. You can see on the list only the server main components.</p>
</div>
<div class="paragraph">
<p>This had to be done for many reasons. One of them is, obviously, the cleaner access to the main server stuff. Another, probably more important, is to avoid a long list of commands for different components mixed together. Commands for different components can have the same name/description and they can even do similar things but they are executed on a different server component. To avoid any confusion and minimise opportunities for mistake the commands are now closely tight to their components. To access a list of commands for a particular component you have to double click on the component name on the list or click 'Execute command" icon on top of the window when your component is selected.</p>
</div>
<div class="paragraph">
<p>A new window should show up with drop-down list of available commands. All the commands are related to the selected component and are executed kind of "inside the component environment". You can of course add new command or delete existing one and of course execute any of the commands showing on the list.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/new-command-list.png" alt="new-command-list"></span></p>
</div>
<div class="paragraph">
<p>As a reminder, in the window title you can see the component ID and you should check it before running any command to make sure you accidentally don&#8217;t break your system.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/new-add-command.png" alt="new-add-command"></span></p>
</div>
<div class="paragraph">
<p>There has been also a small change made to the script adding window. As you can see on the screenshot there is one additional option added - "Save to disk". This means that once you submitted the script to the server it is written to the hard drive and will be automatically loaded at next startup time.</p>
</div>
<div class="paragraph">
<p>This option is enabled by default as this seems to be a logical choice that the administrator wants to save his new script for later reuse. This, however requires proper configuration of the server and give writing permission to the directory where all scripts are stored. Otherwise the server won&#8217;t be able to write script files on the hard drive.</p>
</div>
<div class="paragraph">
<p>As in previous version only users with administrator permissions can execute commands and access all the critical elements on the server. There has been, however, another change made, long time requested by users. In the new version all the administrator specific elements are hidden for the rest of users.</p>
</div>
<div class="paragraph">
<p>Server components don&#8217;t show up on the service discovery, the user can&#8217;t see administrator commands nor he can execute them. This hasn&#8217;t been implemented to improve the server security but to reduce confusion for general users who would otherwise see a lot of stuff which can&#8217;t be used by them anyway.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_and_python"><a class="anchor" href="#_tigase_and_python"></a>4. Tigase and Python</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Looking in the <a href="http://www.tigase.org/content/what-scripting-language-you-would-use-admin-commands-tigase">last poll</a> it is clear that the most people are mainly interested in Python support in the Tigase server. As I mentioned in <a href="http://www.tigase.org/content/scripting-introduction-hello-world">one of previous articles</a>, Tigase virtually supports any scripting language as long as there is <a href="http://www.jcp.org/en/jsr/detail?id=223">JSR-223</a> support for that language.</p>
</div>
<div class="paragraph">
<p>This article describes how to get Python working as a scripting language for ad-hoc commands in the Tigase server. The first part is installation, and the second shows a few code examples with explanation of the differences between Python usage and some other languages.</p>
</div>
<div class="paragraph">
<p><em>Please note, I am not a Python developer, and by no means this is Python development guide. In fact I know very little Python. All the code examples are used only to present the API available and there are certainly better ways to do it in the proper Python style. If you have any suggestions or have a better code examples I am happy to include them in the guide.</em></p>
</div>
<div class="sect2">
<h3 id="_installation"><a class="anchor" href="#_installation"></a>4.1. Installation</h3>
<div class="paragraph">
<p>In short, the installation is extremely simple. Just copy the file attached to this article to your Tigase installation, to the libs/ directory. Restart the server and&#8230;&#8203; here it is. You can write and execute Python scripts inside the Tigase server right away.</p>
</div>
<div class="paragraph">
<p>And here it is, the full description.</p>
</div>
<div class="paragraph">
<p>In theory the Tigase offers scripting support defined in <a href="http://www.jcp.org/en/jsr/detail?id=223">JSR-223</a>. You can use any language for which there is such support for JVM. This includes also stand-alone python implementations and the JSR-223 plugins acts just as a bridge. This, however, does not make much sense as you are not able to interact with JVM code (Tigase API). Therefore you need a language which is executed within JVM and can easily exchange data between the main application (Tigase server) and the script.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/lang-list-no-python-small.png" alt="lang-list-no-python-small"></span></p>
</div>
<div class="paragraph">
<p>The best way to go is to use Jython implementation. It works very well within JVM and what is very important it perfectly integrates with the Tigase server. I have tested the Tigase server with <strong>Jython-2.2.1</strong> and can confirm it works fine. I, however, recommend version <strong>Jython-2.5.1</strong> and all the examples are executed with this version installed. Please note, <em>Jython-2.5.0</em> does not work at all. Both supported versions can be downloaded from the <a href="http://wiki.python.org/jython/DownloadInstructions">Jython website</a>.</p>
</div>
<div class="paragraph">
<p><strong>Version 2.5.1</strong> is a bit simpler to install. When you download and run the Jython installer, you have to find jython.jar file in the directory where you installed Jython. Just copy the file to the Tigase&#8217;s <strong>libs/</strong> directory and all is ready to go. Please note, this is the same file as the one attached to this article for your convenience.</p>
</div>
<div class="paragraph">
<p><strong>Version 2.2.1</strong> needs a little bit more work. The first part is the same. It is not, however enough to copy the jython.jar file. One more file is necessary for the Jython to work with the Tigase server. You have to install JSR-223 engine separately. JSR-223 engines binary file can be downloaded from <a href="https://scripting.dev.java.net/">Java scripting project website</a>. The binary file has to be unpacked and jython-engine.jar file needs to be copied to the Tigase libs/ directory.</p>
</div>
<div class="paragraph">
<p>The best way to check if the Jython is installed correctly and support for Python is enabled is by trying to submit a new script to the Tigase server. Browser the server service discovery, select "<em>Session manager</em>" component and run "<em>Execute command</em>" function. A new window should show with a list of all available ad-hoc commands. Select "<em>New command script</em>" item and click "<em>Execute</em>". Ad-hoc command dialog windows should show up. One of the field is "<em>Language</em>" with pull down list of available scripting languages. If "<em>python</em>" is on the list it means everything is ok and support for Python is enabled.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/lang-list-with-python-small.png" alt="lang-list-with-python-small"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="_writing_python_scripts"><a class="anchor" href="#_writing_python_scripts"></a>4.2. Writing Python Scripts</h3>
<div class="paragraph">
<p>Python scripts work, generally in a similar way to Groovy or other languages scripts, except one significant difference. You cannot call "<em>return</em>" from the script itself. Hence you cannot simply pass script results by calling "<em>return</em>" statement directly from the script.</p>
</div>
<div class="paragraph">
<p>To overcome the  problem Tigase offers another way to pass script execution results. It checks the value of a special variables on the script completion: "result" and "packet". By assigning value to one of these variables the Python (or any other language) can pass execution results back to the Tigase server.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"result" allows to return simple text (or characters String) from the script.</p>
</li>
<li>
<p>"packet" allows to return Packet instance which is send back to the user.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The simplest possible Python script may look like this one:</p>
</div>
<div class="paragraph">
<p>result = "Hello world!"</p>
</div>
<div class="paragraph">
<p>For instructions how to load and execute the script, please refer to ////&lt;&lt;introductoryArticle,////introductory article for scripting in the Tigase server. There were some minor changes in later the Tigase 4.4.0 and later version, so please have a look at the ////&lt;&lt;newElements,////article describing new elements as well.</p>
</div>
<div class="paragraph">
<p>A bit more advanced script asks the user for providing required parameters for the actual script execution:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">from java.lang <span class="keyword">import</span> *
<span class="include">from</span> <span class="include">tigase.server</span> <span class="include">import</span> *

<span class="include">num1</span> = <span class="include">Command.getFieldValue</span>(<span class="include">packet</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">num1</span><span class="delimiter">&quot;</span></span>)
<span class="include">num2</span> = <span class="include">Command.getFieldValue</span>(<span class="include">packet</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">num2</span><span class="delimiter">&quot;</span></span>)

<span class="include">if</span> <span class="include">num1</span> <span class="include">is</span> <span class="include">None</span> <span class="include">or</span> <span class="include">num2</span> <span class="include">is</span> <span class="include">None</span>:
  <span class="include">res</span> = <span class="include">Iq.commandResultForm</span>(<span class="include">packet</span>)
  <span class="include">Command.addTextField</span>(<span class="include">res</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Note</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">This is a Python script!</span><span class="delimiter">&quot;</span></span>)
  <span class="include">Command.addFieldValue</span>(<span class="include">res</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">num1</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
  <span class="include">Command.addFieldValue</span>(<span class="include">res</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">num2</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>)
  <span class="include">packet</span> = <span class="include">res</span>
<span class="include">else</span>:
  <span class="include">result</span> = <span class="include">num1</span> + <span class="include">num2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Except this rather minor difference, the rest part of scripting in Python for the Tigase administrator commands is the same as for all other languages. As all languages can return execution results via these special variables, it could be argued there is no difference at all.</p>
</div>
<div class="paragraph">
<p>In next articles, I am going to present the Tigase server API available for scripting framework. My main language is Groovy as it offers the best integration with JVM and Tigase API, however I will try to include Python example code as well.</p>
</div>
<div class="paragraph">
<p>_I hope this article encourages you to try the scripting support in the Tigase server. If you have any suggestions or questions please do not hesitate to send me your comments. I have also created a new <a href="http://www.tigase.org/forums/tigase-scripts">tigase scripts</a> forum on the website. If you have an interesting script to share or want to discuss some aspects of this functionality do not hesitate to add your post.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="files/jython-2.5.1.jar">jython-2.5.1.jar</a> 6.44 MB</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_about_tigase_jabber_xmpp_server"><a class="anchor" href="#_about_tigase_jabber_xmpp_server"></a>5. About Tigase Jabber/XMPP Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 16:18</p>
</div>
<div class="paragraph">
<p><strong>Tigase Jabber/XMPP Server</strong> is <strong>Open Source and Free (GPLv3)</strong> Java based server. The goals behind the design and implementation of the server are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make the server robust and reliable.</p>
</li>
<li>
<p>Make the server secure communication platform.</p>
</li>
<li>
<p>Make flexible server which can be applied to different use cases.</p>
</li>
<li>
<p>Make extensible server which takes full advantage of XMPP protocol extensibility.</p>
</li>
<li>
<p>Make the server easy to setup and maintain.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Robust and reliable</strong>.</p>
</div>
<div class="paragraph">
<p>By robust and reliable server I mean the server which can handle many concurrent requests/connections and can run for a long time. By many concurrent requests/connections I mean as many as it is needed. The server is designed and implemented to handle milions of simultaneous connections.</p>
</div>
<div class="paragraph">
<p>It is not enough however to design and implement high load server and hope it will run well. The main focus in the project is put in tests. Tests are taken so seriously that dedicated testing framework has been implemented. All server functions are considered as implemented only when they pass testing cycle. The testing cycle consists of 3 fundamental tests:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Functional tests</strong> - checking whether the function works at all.</p>
</li>
<li>
<p><strong>Performance tests</strong> - checking whether the function performs well enough.</p>
</li>
<li>
<p><strong>Stability tests</strong> - checking whether the function behaves well in long term run. It must handle hundreds of requests a second in several hours server run.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_security"><a class="anchor" href="#_security"></a>5.1. Security</h3>
<div class="paragraph">
<p>There are a few elements of the security related to Jabber/XMPP server: secure data transmissions which is met by the implementation of <strong>SSL</strong> or <strong>TLS</strong> protocol, secure user authorization which is met by the implementation of <strong>DIGEST</strong> or <strong>SASL</strong> user authorization and secure deployment which is met by component architecture.</p>
</div>
<div class="paragraph">
<p><strong>Secure deployment</strong> is a software installation which doesn&#8217;t impact network security. Companies usually have their networks divided into 2 parts: <strong>DMZ</strong> which is partially open to outside world and <strong>Private network</strong> which is closed to outside world.</p>
</div>
<div class="paragraph">
<p>If the Jabber/XMPP server have to provide effective way of communication between company employees regardless they are in company office or outside (perhaps at customer site) it needs to accept connections from outside world. So the natural place for server deployment is a <strong>DMZ</strong> part. There is an issue however with such installation. Each company has normally established network users base and integrated authorization mechanisms. So it would be very good if Jabber server could use this mechanisms for users authorizations as well. Usually, however, authorization information is not available in <strong>DMZ</strong> and it shouldn&#8217;t be.</p>
</div>
<div class="paragraph">
<p><strong>Tigase server</strong> offers solution for such case. With it&#8217;s component structure it can be easily deployed on any number machines and from the user point of view it is seen as a one logical Jabber server. So in our case we can install Session Manager module in <strong>private</strong> network part and Client Connection Manager with Server Connection Manager in <strong>DMZ</strong>.</p>
</div>
<div class="paragraph">
<p>Session Manager connects to <strong>DMZ</strong> and receives all packets from users. Thus is can securely realize users authorization based on company authorization mechanisms.</p>
</div>
</div>
<div class="sect2">
<h3 id="_flexibility"><a class="anchor" href="#_flexibility"></a>5.2. Flexibility</h3>
<div class="paragraph">
<p>There are many different Jabber/XMPP server use cases. The most obvious are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Used as bussiness communication platform in small and medium companies server is not under heavy load. Instead for such deployments security is a key feature.</p>
</li>
<li>
<p>Fo huge community websites or internet portals server is on the other side usually under very heavy load and have to support tousands or millions of simultaneous connections and for such deployment we talk about different kind of security as the service is open to public anyway.</p>
</li>
<li>
<p>For very small community deployments or for small home networks the key factor is ease to deploy and maintain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Architecture based on components allows you to run selected modules on separate machines so the server can be easily applied to all scenarios.</p>
</div>
<div class="paragraph">
<p>For simple installation server generates config file which can be used almost stright away with very few modifications or sometimes even no config editing is required. For complex deployments though you can tweak configuration to your needs and setup Jabber server on as many physical machines as you need.
Extensibility</p>
</div>
<div class="paragraph">
<p>The world changes all the time so people needs change as well. Jabber/XMPP protocol has been designed to be extensible to make it easy adding new features and apply it to different needs. As a result Jabber is a very effective platform not only for sending messages to mates. It can also be extended for sending instant notifications about events, it can be useful platform for on-line customer service, voice communication and all other cases where sending information instantly to other people is needed.</p>
</div>
<div class="paragraph">
<p><strong>Tigase server</strong> has been designed to be extensible as well. Of course modular architecture makes it extensible as you can easily replace component which doesn&#8217;t fullfill your requirements with another one better fitting your needs. But this is not all. Another factor of extensibility is how easy is to replace component or add new extensions. The great focus has been put in server design API to make it easy for other software developers to create extensions and implement new features.</p>
</div>
</div>
<div class="sect2">
<h3 id="_easy"><a class="anchor" href="#_easy"></a>5.3. Easy</h3>
<div class="paragraph">
<p>Complex computer networks consisting of many servers with different services are hard to maintain. There is no other way than employing professional staff and looking after the network.</p>
</div>
<div class="paragraph">
<p>Not all networks are so complex however. Most small companies have just a few servers for their needs with services like e-mail, HTTP server with company website and that&#8217;s it. They might want to add Jabber server to the collection of their services and don&#8217;t want to dedicate much resources on setting it up and later maintenance. For such users default configuration is pretty much what they need. If operating system on the server is well configured then Tigase should pickup correct hostname.</p>
</div>
<div class="paragraph">
<p>Tigase server is designed and implemented to allow dynamic reconfiguration at runtime so there is no need for restarting server each time you want to change a configuration settings.</p>
</div>
<div class="paragraph">
<p>There are also interfaces and handlers available to make it easy to implement web user interface for server monitoring and configuring. Such user interface will included in one of future releases.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_quick_start"><a class="anchor" href="#_quick_start"></a>6. Quick Start</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>This is a set of documents allowing you to quickly start with our software. Every document provides an introduction to a single topic allowing you to start using/developing or just working on the subject.  Please have a look at the documents list below to find a topic you are looking for. If you don&#8217;t find a document for the topic you need please <a href="http://www.tigase.net/contact">let us know</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;guiInstaller,////Installation using GUI installer</p>
</li>
<li>
<p>////&lt;&lt;consoleInstaller,////Installing using console installer</p>
</li>
<li>
<p>////&lt;&lt;manualInstaller,////Manual installation in console mode</p>
</li>
<li>
<p>////&lt;&lt;TSBupdates,////Tigase server binary updates</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_using_gui_installer"><a class="anchor" href="#_installation_using_gui_installer"></a>7. Installation Using GUI Installer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mateusz Fiolka
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want to install Tigase using manual method, you can use the GUI installer. It not only copies server files to preferred place, but also assists with configuration of the most important parameters and database setup. Therefore it is the preferred way to install Tigase.</p>
</div>
<div class="sect2">
<h3 id="_prerequisites"><a class="anchor" href="#_prerequisites"></a>7.1. Prerequisites</h3>
<div class="paragraph">
<p>Before you can start the GUI installer you will need to have working Java environment. Although installer only requires <strong>JRE</strong> (Java Runtime Environment), server needs the <strong>JDK</strong> (Java Development Kit). Please do note that <strong>currently minimal JDK version Tigase is capable to run on is 1.6</strong>. If you don&#8217;t have JDK installed it is the right moment to do it. Visit the <a href="http://java.sun.com/javase/downloads/index.jsp">Java downloads site</a> From the list of available packages select newest JDK version (if you don&#8217;t have a specific need to use J2EE then choose a package without it). After configuring JDK you can download the Tigase GUI installer and start the server installation process.  It is also important to set the JAVA_HOME environment correctly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_download_the_installer"><a class="anchor" href="#_download_the_installer"></a>7.2. Download the Installer</h3>
<div class="paragraph">
<p>You can always find the newest Tigase packages in the <a href="https://projects.tigase.org/projects/tigase-server/files">download section</a>.  When you enter the page, you will be presented a list of files to choose from.  You may be sceptic at the beginning as there are lot of choices, but you don&#8217;t have to. All Tigase binary packages have conventional names, which help to differentiate them easily. They are of form <strong>tigase-server-x.y.z-bv.ext</strong> where 'x', 'y', 'z' and 'v' are version numbers and they change from a release to release. Ext is the file extension which in the case of our GUI installation program is <strong>.jar</strong>. We recommend you to download the latest version (highest version number) of the server as it contains latest functions and improvements</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_jar_file"><a class="anchor" href="#_run_the_jar_file"></a>7.3. Run the jar File</h3>
<div class="paragraph">
<p>On most systems installing JRE or JDK creates a default association which allows to run the <strong>.jar</strong> file by just clicking/ double clicking on it. However if nothing happens when you do it there is a way to do it manually. Perform the steps in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you are on <strong>Windows</strong> system you can use the command prompt to run the installer directly using the java command.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Click on the <strong>Start</strong> menu and choose the <strong>Run action</strong> (You can also use the <strong>Win+R</strong> shortcut).</p>
</li>
<li>
<p>You will be presented with a dialog box where you can enter a command. Type "<strong>cmd</strong>" (or "<strong>command</strong>" in the case of windows version older then 2000) and submit the window.
If you are on a <strong>Linux</strong> system, you can use a terminal. It should be easily discoverable as it is a standard tool on this platform. Find and run it.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Command prompt / terminal will appear. You will be able to check a whether your <strong>Java</strong> environment is working. To do it type the</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">java -version</code></pre>
</div>
</div>
<div class="paragraph">
<p>command and press Enter. If the message says that the command is not recognised then your <strong>Java</strong> installation may be corrupt or not configured properly. For correctly setting up <strong>JRE/JDK</strong> including setting the <strong>JAVA_HOME</strong> environmental variable please check documentation provided on the JDK download site. Also when the command succeeds please check if the printed version number fulfils Tigase requirements. When many versions of <strong>JDK/JRE</strong> are installed on one machine <strong>java</strong> command will need to be invoked with the full path it is placed on.</p>
</div>
</li>
<li>
<p>When you have no doubt that you can run the correct java launcher, you may start the installer i.e. for the file <strong>tigase-server-4.1.0-b1315.jar</strong> downloaded to the <strong>c:\download</strong> directory type the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">java -jar c:\download\tigase-server-4.1.0-b1315.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command should start the installer or print an error message explaining what is the cause of problem.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_starting_the_installation"><a class="anchor" href="#_starting_the_installation"></a>7.4. Starting the Installation</h3>
<div class="paragraph">
<p>Please note that this tutorial does cover only basic installation mode. Some screens have been omitted because they contain advanced options which are not shown in simple installation mode. Other such as progress of copying files and summary info are on the other hand self explanatory and will also not described.</p>
</div>
<div class="sect3">
<h4 id="_jdk_selection"><a class="anchor" href="#_jdk_selection"></a>7.4.1. JDK Selection</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall2.gif" alt="winInstall2"></span></p>
</div>
<div class="paragraph">
<p>This screen is only shown when JDK has not been selected automatically. When your JAVA_HOME path is properly set, it will be auto-detected saving you some configuration time. If you are reading this step and still don&#8217;t have JDK installed, then go back to the ////&lt;&lt;prequisites,////prerequisites section where you can find some info on how to prepare your system for Tigase installation. Sometimes your system will be configured in a way that prevents detection of JDK path. This often happens when you install JRE after installing JDK. You will have to find JDK directory yourself.  It is by default installed in the <strong>Program Files\Java</strong> directory of your system drive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installation_type_selection"><a class="anchor" href="#_installation_type_selection"></a>7.4.2. Installation Type Selection</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall3.gif" alt="winInstall3"></span></p>
</div>
<div class="paragraph">
<p>Recommended practice is to choose both installation and configuration of the server as manual configuration is more complicated, time consuming and error-prone.</p>
</div>
</div>
<div class="sect3">
<h4 id="_introduction_to_the_server"><a class="anchor" href="#_introduction_to_the_server"></a>7.4.3. Introduction To the Server</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall4.gif" alt="winInstall4"></span></p>
</div>
<div class="paragraph">
<p>This screen shows some information about Tigase which may help you understand what it is and how it can help to take advantage of the <strong>XMPP</strong> protocol. It is important that you read all information&#8217;s appearing on the installer screens, as they contain valuable hints and most recent information.</p>
</div>
</div>
<div class="sect3">
<h4 id="_choice_of_base_directory"><a class="anchor" href="#_choice_of_base_directory"></a>7.4.4. Choice of Base Directory</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall6.gif" alt="winInstall6"></span></p>
</div>
<div class="paragraph">
<p>This is the point where you choose where do you want you server to be installed. Recommended path should not contain spaces, as it may be reason of some strange path problems. In the case of installation on Windows it should be installed on a short path because there is a limit of path lengths. Also note that on Windows Vista there may be some problems with making the server work while installed in the Program Files directory, related to the working of UAC mechanism, so better don&#8217;t install it there.  If you don&#8217;t want are unsure about where to place the server, you can always leave the default selection.</p>
</div>
</div>
<div class="sect3">
<h4 id="_packages_selection"><a class="anchor" href="#_packages_selection"></a>7.4.5. Packages selection</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall7.gif" alt="winInstall7"></span></p>
</div>
<div class="paragraph">
<p>Next important step is package selection. Some choices are grey and you cannot change them as they are essential. All of the rest is optional. It consists of documentation, database drivers, sources of the server and some extras. When you select an item, you will be presented with a short description of it&#8217;s content.</p>
</div>
<div class="paragraph">
<p>We recommend you to install documentation. It contains valuable resources which may be very helpful in administration and general use of the server.</p>
</div>
<div class="paragraph">
<p>If you have a working database platform that you want to use for storing all important user information in, just select appropriate db drivers.  If you don&#8217;t have a database engine, you can use the included derby along with also included drivers.</p>
</div>
<div class="paragraph">
<p>If you are a developer and you want to be able to check how the server is working or you want to help with the development, you can install also the included source codes.</p>
</div>
</div>
<div class="sect3">
<h4 id="_basic_server_configuration"><a class="anchor" href="#_basic_server_configuration"></a>7.4.6. Basic Server Configuration</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall13.gif" alt="winInstall13"></span></p>
</div>
<div class="paragraph">
<p>On this screen you will find most important basic configuration options. As this guide covers only non-advanced set up - disable the advanced configuration checkbox.</p>
</div>
<div class="paragraph">
<p>You can select which components will be installed. For most installations default selection will most appropriate. You can expand the list to check if any of the other options will better suit your needs.</p>
</div>
<div class="paragraph">
<p>It is very important that you enter your domain name correctly here.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On <strong>Linux</strong> like system you can use the <strong>hostname</strong> command and extract the domain part from the output. If you use the <strong>-f</strong> parameter then you will get the fully qualified domain name.</p>
</li>
<li>
<p>On <strong>Windows</strong> use the standard <strong>System</strong> control panel applet. You will find your domain (computer name) in the <strong>Computer name</strong> tab.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On the other hand if you want to use Tigase virtual domain support and you have your <strong>DNS</strong> system configured properly, then you can put your virtual domains list here. Just separate them by comma characters. For example if your server is seen from the outside as <strong>veloci.tigase.org,</strong> <strong>mammoth.tigase.org</strong> and <strong>tigase.org</strong> then you can use Tigase instance as if it were three separate instances.  In reality it will be one server, however <strong>admin@veloci.tigase.org</strong> will be a different user then <strong>admin@tigase.org.</strong> This feature allows to use one server for separating user groups, for example different organizations.</p>
</div>
<div class="paragraph">
<p>When you will have your domain name just enter it in the domain text box. Next parameter will be the JID of server administrator. Standard practice is to give him name of <strong>admin</strong>, however you may choose any name you like. For example for domain <strong>tigase.org</strong> full admin name would be <strong>admin@tigase.org.</strong> Just stick your chosen name and domain together using the @ character as separator.</p>
</div>
<div class="paragraph">
<p>Starting from this version your XMPP admin will be automatically added to the database, so after installation you can just login into the server without registering admin manually.</p>
</div>
<div class="paragraph">
<p>You should also select a database which will be used for storing user info. Default is the <strong>Derby</strong> database, if you don&#8217;t need anything special just leave it as it is. Just select a new password as the default one may be easy to guess for a hacker.</p>
</div>
<div class="paragraph">
<p><strong>Important notice: Tigase installer doesn&#8217;t contain the actual databases, only drivers allowing db access. One exception is Derby database, which is included in JDK. It is automatically configured by installer, in case of other databases you will need to configure them by yourself.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_verification_of_database_connection_and_performing_db_tasks"><a class="anchor" href="#_verification_of_database_connection_and_performing_db_tasks"></a>7.4.7. Verification of Database Connection and Performing DB Tasks</h4>
<div class="paragraph">
<p><span class="image"><img src="./images/winInstall20.gif" alt="winInstall20"></span></p>
</div>
<div class="paragraph">
<p>When you switch to this screen an automatic test of database configuration will be started. It consists of few steps which will be executed in order. After testing connection and configuring schema, admin users will be added.</p>
</div>
<div class="paragraph">
<p>What to do if any of the tests will fail?</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you decided to use your own database, check if you entered correct password and whether your database is running.</p>
</li>
<li>
<p>If you use the embedded <strong>Derby</strong> database then probably your problem is more complicated. An error may indicate a bug in the installer. You may report it to one of Tigase developers.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you cannot go beyond this step after trying to resolve database problems you may try manual installation mode.</p>
</div>
</div>
<div class="sect3">
<h4 id="_finishing_installation"><a class="anchor" href="#_finishing_installation"></a>7.4.8. Finishing Installation</h4>
<div class="paragraph">
<p>When you perform all those steps altogether with choosing Start Menu location and other basic actions you will be informed that installation process is complete. You can now use your Tigase server. There are some post installation actions you may want to perform. They are briefly presented below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_server"><a class="anchor" href="#_running_the_server"></a>7.4.9. Running the Server</h4>
<div class="paragraph">
<p>Part of the installation process is selection of Tigase base directory. This is where you can find all important server files. Installer will create some configurable shortcuts in the <strong>Start Menu</strong>. You can navigate to the menu and use it to start the server.   To run the server manually:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On a <strong>Linux</strong> system you may start the server using the <strong>tigase.sh</strong> file found in the <strong>scripts</strong> sub-directory of Tigase server base directory. In the root server directory type the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Of course if you have a custom config file then change last command appropriately.</p>
</li>
<li>
<p>On a <strong>Windows</strong> platform you can use a <strong>bat</strong> file to run the server. There is a <strong>run.bat</strong> file in the Tigase root directory. Just double click it in <strong>Explorer</strong> or run it from command line to start the server. A window with server log output will pop-up.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/winRun.gif" alt="winRun"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_installation_as_a_service"><a class="anchor" href="#_installation_as_a_service"></a>7.4.10. Installation as a Service</h4>
<div class="paragraph">
<p>On <strong>Windows</strong> you can install Tigase as a service. To do it use the <strong>InstallTigaseService.bat</strong> batch file found also in server root directory.</p>
</div>
<div class="paragraph">
<p>In this mode service will be running in background and will be controllable from the <strong>Services</strong> management snapshot. To launch the tool right click on the <strong>Computer</strong> icon on the desktop. Choose the <strong>Manage</strong> action. It will run the <strong>Computer management</strong> graphical configuration program. On the left side choose the <strong>Services</strong> item.  You will be shown with a list of services. Here you can find Tigase service when it will be installed.</p>
</div>
<div class="paragraph">
<p>To uninstall Tigase service use the <strong>UninstallTigaseService.bat</strong> file from Tigase server root directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_check_if_the_server_is_running"><a class="anchor" href="#_how_to_check_if_the_server_is_running"></a>7.4.11. How to Check if the Server is Running</h4>
<div class="paragraph">
<p>Checking if the server is running is quite easy. Just try to connect  to it by using one of may available <strong>XMPP</strong> clients.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_using_console_installer"><a class="anchor" href="#_installing_using_console_installer"></a>8. Installing Using Console Installer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mateusz Fiolka
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="sect2">
<h3 id="_installation_using_the_text_mode_installer"><a class="anchor" href="#_installation_using_the_text_mode_installer"></a>8.1. Installation Using the text-mode Installer</h3>
<div class="paragraph">
<p>When you install Tigase server on a desktop machine or a server having a graphical user interface - you can use the ////&lt;&lt;guiInstaller,////GUI installer. However servers are often administered using <strong>SSH</strong> text-mode connection because of low connection requirements or user preferences. Because of a popular users demand Tigase development team has decided to implement a console installer for the server.</p>
</div>
<div class="paragraph">
<p><strong>Note! The console installer is available for the Tigase server from version 4.1.5 and later</strong>.</p>
</div>
<div class="sect3">
<h4 id="_requirements_and_important_notice"><a class="anchor" href="#_requirements_and_important_notice"></a>8.1.1. Requirements and Important Notice</h4>
<div class="paragraph">
<p>Before trying the installer please keep in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>This is first - alpha rate version of the text-mode installation - meant to install the server and do some basic configuration. We will be very happy to see bug reports and overall feedback about this feature. Please send your remarks to <a href="mailto:artur.hefczyc@tigase.net">Artur Hefczyc</a> or Mateusz Fiolka.</p>
</li>
<li>
<p>You will still need to perform some additional steps before running the installer. Main requirement is to download and install <strong>Java JDK</strong> of <strong>minimal 1.6 version</strong>. This guide is aimed at advanced users - thus downloading and configuring JDK is left to the reader. You can find more info at the <a href="http://java.sun.com/javase/downloads/index.jsp">Java downloads site</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_download_the_installer_2"><a class="anchor" href="#_download_the_installer_2"></a>8.2. Download the Installer</h3>
<div class="paragraph">
<p>You can always find the newest Tigase packages in the <a href="https://projects.tigase.org/projects/tigase-server/files/">download section</a>. When you enter the page, you will be presented a list of files to choose from.   All Tigase binary packages have conventional names, which help to differentiate them easily. They are of form <strong>tigase-server-x.y.z-bv.ext</strong> where 'x', 'y', 'z' and 'v' are version numbers and they change from a release to release. Ext is the file extension which in the case of our console installation program is <strong>.jar</strong>. We recommend you to download the latest version (highest version number) of the server as it contains latest functions and improvements.</p>
</div>
</div>
<div class="sect2">
<h3 id="_run_the_jar_file_2"><a class="anchor" href="#_run_the_jar_file_2"></a>8.3. Run the jar File</h3>
<div class="paragraph">
<p>In terminal (SSH or Windows cmd prompt if you use on) type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">java -jar nameOfTheDownloadedJarFile.jar -console</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_steps"><a class="anchor" href="#_installation_steps"></a>8.4. Installation Steps</h3>
<div class="paragraph">
<p>Now you are ready to to install the server.</p>
</div>
<div class="paragraph">
<p>Some tips for working with the console installer:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Please remember to write down your JDK location because you will need to type it during the installation process.</p>
</li>
<li>
<p>Installer consists of number of screens which relate to  different configuration aspects. Most of the panels end with a question whether you want to redisplay the panel or quit installer. When you make a mistake you will be probably asked later if you want re-enter the data
again.</p>
</li>
<li>
<p>To quit the installer use standard termination key specific to your platform. For example on a <strong>Linux</strong> system it is the Ctrl+C key combination. Keep in mind that if you quit the installer after it copied some files - it may leave them in the place and you might have to remove them manually.</p>
</li>
<li>
<p>In current version the installer is of beta quality and using advanced configuration is not recommended. It might work, however it is not much tested and will be improved later.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_initial_screen"><a class="anchor" href="#_initial_screen"></a>8.4.1. Initial Screen</h4>
<div class="paragraph">
<p>On this screen you will find server version info which will be useful if you would to suggest something to Tigase developers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Welcome to the installation of Tigase XMPP (Jabber) Server X.Y.Z!

The homepage is at: http://www.tigase.org/
press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jdk_selection_2"><a class="anchor" href="#_jdk_selection_2"></a>8.4.2. JDK Selection</h4>
<div class="paragraph">
<p>Your system may contain more then one JDK installation, thus you will have to make an explicit decision which one to use. Currently console mode installer doesn&#8217;t contain any auto-detection code nor validation. You will have to enter the path correctly or you may have problems with running the server. For example on <strong>Ubuntu Linux</strong> you can find the JDK in the /lib/jvm/java-6-sun directory. For the current Tigase server JDK of version at least <strong>1.6</strong> is required.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">The installed application needs a JDK. A java run-time
environment (JRE) will be not sufficient.

Enter path: /lib/jvm/java-6-sun</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_actions_selection"><a class="anchor" href="#_actions_selection"></a>8.4.3. Actions Selection</h4>
<div class="paragraph">
<p>Choose whether you want to configure the server in addition to install it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">*** Select what you want to do next:

On this panel you can specify whether you want to install
only or configure already installed server or to do both. If
you are just installing a server on your machine it is a
good idea to do both steps.



The wizards you want to execute
Installation of the Tigase Server
[on, off]
on
Configuration of the Tigase Server
[on, off]
on</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installer_info"><a class="anchor" href="#_installer_info"></a>8.4.4. Installer Info</h4>
<div class="paragraph">
<p>Introduction to the installer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Please note!

While the Tigase server is quite stable and well tested
application the installer itself is a new addition. Take
precautions especially if you upgrade the server from
earlier version. Backup old server files and the database.

If you notice any problems please report them to address:
Artur Hefczyc

press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_info"><a class="anchor" href="#_server_info"></a>8.4.5. Server Info</h4>
<div class="paragraph">
<p>If you don&#8217;t know what exactly is Tigase server, you can find some basic introduction on this screen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Tigase XMPP (Jabber) server ver 4.1.5-bDEV


About

Copyright (C) 2004 Tigase.org. &lt;http://www.tigase.org/&gt;

Tigase Jabber/XMPP Server is
Open Source and Free  (GPLv3)
Java based server. The goals behind the design and
implementation of the server are:


Make the server robust and reliable.
Make the server secure communication platform.
Make flexible server which can be applied to different use
cases.
Make extensible server which takes full advantage of XMPP
protocol extensibility.

--- Press ENTER to continue ---

Make the server easy to setup and maintain.


Installation, configuration and compilation

The most recent documentation on all these topics is always
available in the project website: www.tigase.org. Please
refer to the website for all the details and always up to
date guides.

You would probably want to start with Quick Start:
http://www.tigase.org/content/quick-start documentation.

The website also contains lots of other useful information
like load tests results, user discussions and on-line support
and help always available to you.

This is 4.1.5-bDEV release of the server. Please include the
exact version number in all correspondence regarding the
server.


press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_licence"><a class="anchor" href="#_server_licence"></a>8.4.6. Server Licence</h4>
<div class="paragraph">
<p>This is a licence that you have to agree to use Tigase server. Please read it carefully. Take note, that in this manual only part is shown in order to decrease guide length.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Please read the following license agreement carefully:



GNU General Public License - GNU Project - Free Software
Foundation (FSF)


GNU GENERAL PUBLIC LICENSE
Version 3, 29 June 2007

Copyright (C) 2007 Free Software Foundation, Inc.
 Everyone is permitted to copy and distribute verbatim copies
 of this license document, but changing it is not allowed.

Preamble

...
... Fragment cut out
...


You should also get your employer (if you work as a
programmer) or school, if any, to sign a &quot;copyright
disclaimer&quot; for the program, if necessary.  For more
information on this, and how to apply and follow the GNU
GPL, see --- Press ENTER to continue ---

&lt;http://www.gnu.org/licenses/&gt;.

The GNU General Public License does not permit incorporating
your program into proprietary programs.  If your program is
a subroutine library, you may consider it more useful to
permit linking proprietary applications with the library.
If this is what you want to do, use the GNU Lesser General
Public License instead of this License.  But first, please
read

&lt;http://www.gnu.org/philosophy/why-not-lgpl.html&gt;.

1. I accept the terms of this license agreement.
2. I do not accept the terms of this license agreement.
Choose number (1-2):
1
press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_server_location_selection"><a class="anchor" href="#_server_location_selection"></a>8.4.7. Server Location Selection</h4>
<div class="paragraph">
<p>Enter where do you want the server to be installed. If you have administrator rights you can place it in a standard location where all your applications reside. If you don&#8217;t have write  rights for this place, you can always install the server in your home directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Select target path
[/home/user/tigase] /home/user/tigase-server

press 1 to continue, 2 to quit, 3 to redisplay 1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_selection_of_packs_to_be_installed"><a class="anchor" href="#_selection_of_packs_to_be_installed"></a>8.4.8. Selection of Packs to be Installed</h4>
<div class="paragraph">
<p>Some packs are optional and you can disable/enable them. In the following screen they have an [x] option before them. To switch their state enter item number and ENTER. When done press d and ENTER.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Select the packs you want to install:

1 =&gt; Base, The base files
2 =&gt; Unix Files, Files needed to run the server on Unix like systems
3 =&gt; [x] Docs, The documentation
4 =&gt; [x] Extras, Extras libraries, MUC, PubSub...
5 =&gt; [x] Derby Database, Derby database and JDBC driver
6 =&gt; [x] MySQL Database, MySQL JDBC driver (MySQL has to be
installed separately)
7 =&gt; [x] PostgreSQL Database, PostgreSQL JDBC driver
(PostgreSQL has to be installed separately)
8 =&gt; [x] SQL Server Database, SQL Server JDBC driver (SQL
Server has to be installed separately)
9 =&gt; [ ] Sources, The server source files, tools and
libraries sources are not included
r =&gt; Redisplay menu
d =&gt; Done

Choose action: d
press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installation_2"><a class="anchor" href="#_installation_2"></a>8.4.9. Installation</h4>
<div class="paragraph">
<p>During extracting and copying server files to their target you will be presented with the process progress.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[ Starting to unpack ]
[ Processing package: Base (1/9) ]
[ Processing package: Unix Files (2/9) ]
[ Processing package: Windows Files (3/9) ]
[ Processing package: Docs (4/9) ]
[ Processing package: Extras (5/9) ]
[ Processing package: Derby Database (6/9) ]
[ Processing package: MySQL Database (7/9) ]
[ Processing package: PostgreSQL Database (8/9) ]
[ Processing package: SQL Server Database (9/9) ]
[ Unpacking finished ]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_basic_configuration"><a class="anchor" href="#_basic_configuration"></a>8.4.10. Basic Configuration</h4>
<div class="paragraph">
<p>This panels contains most important configuration options for the Tigase server. You can choose which components should be configured to be used when running server, add XMPP admin users and enter their password (many admins, comma separated, initially having the same password). Choose different password from the default one. Then select preferred database. If you don&#8217;t have a standalone DB which you would like to use, you can choose the included Derby DB.</p>
</div>
<div class="paragraph">
<p><strong>Important notice: Tigase installer doesn&#8217;t contain the actual databases, only drivers allowing db access. One exception is Derby database, which is included in JDK. It is automatically configured by installer, in case of other databases you will need to configure them by yourself.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">*** Basic Tigase server configuration
On this panel you can specify basic configuration settings
for the Tigase server.

Based on your selection here more configuration options
might be presented later on. After the configuration is
complete init.properties file will be created.

You can optionally restart the server at the end of the
process if you like.



0  [x] Default installation
1  [ ] Default plus extra components
2  [ ] Session Manager only
3  [ ] Network connectivity only
input selection:
0
Your XMPP (Jabber) domains [my-laptop]

Server administrators [admin@my-laptop]

Admin password [tigase]

0  [x] Derby (built-in database)
1  [ ] MySQL
2  [ ] PostgreSQL
3  [ ] SQLServer
4  [ ] Other...
input selection:
1</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_advanced_configuration"><a class="anchor" href="#_advanced_configuration"></a>8.4.11. Advanced Configuration</h4>
<div class="paragraph">
<p><strong>Please note: in this version advanced configuration is not supported. Although it may work it has not been tested and thus is not recommended. Please enter off to not use it.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Advanced configuration options
[on, off]
off
press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database_configuration"><a class="anchor" href="#_database_configuration"></a>8.4.12. Database Configuration</h4>
<div class="paragraph">
<p>Depending on which database you did select, you will be presented  with related options to configure its connectivity options. As you will see, the parameters have default values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">*** Database configuration:

You have selected MySQL database. This database needs
additional configuration parameters. Please enter all
required information.



MySQL super user account will be used only to create and
configure database for the Tigase server. It will not be
used by the Tigase server later on.

Super user account name: [root]

WARNING: password will be visible while entering
Super user password: mysecretpassword
WARNING: password will be visible while entering
Retype password: mysecretpassword



MySQL database details. It will be created automatically if
it does not exist.

Database account: [tigase]

Account password: [tigase12]

Database name: [tigasedb]

Database host or IP: [localhost]

Additional database parameters: []

press 1 to continue, 2 to quit, 3 to redisplay</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_database_checking_and_preparation"><a class="anchor" href="#_database_checking_and_preparation"></a>8.4.13. Database Checking and Preparation</h4>
<div class="paragraph">
<p>After entering all database information an automatic test of connection and database setup is performed. If everything is ok installer tries to convert database schema to required version and finally adds XMPP administrators to it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Performing DB tasks

Checking connection to the database
Connection OK
Checking if the database exists
Exists OK
Checking the database schema
New schema loaded OK
Checking whether the database needs conversion
Conversion not needed
Adding XMPP admin accounts
Added admins OK</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_installation_complete"><a class="anchor" href="#_installation_complete"></a>8.4.14. Installation Complete</h4>
<div class="paragraph">
<p>Now you can run the server and use it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Install was successful
application installed on /home/user/tigase-server
[ Console installation done ]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_sever"><a class="anchor" href="#_running_the_sever"></a>8.4.15. Running the Sever</h4>
<div class="paragraph">
<p>You can start the server using the tigase.sh file found in the scripts sub-directory of Tigase server base directory. In the root server directory type the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">./scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course if you have a custom config file then change last command appropriately.  On a Windows platform you can use a bat file to run the server. There is a run.bat file in the Tigase root directory. Just double click it in Explorer or run it from command line to start the server. A window with server log output will pop-up.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_check_if_the_server_is_running_2"><a class="anchor" href="#_how_to_check_if_the_server_is_running_2"></a>8.4.16. How to Check if the Server is Running</h4>
<div class="paragraph">
<p>Checking if the server is running is quite easy. Just try to connect to it by using one of may available XMPP clients.Application: Tigase Server</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_manual_installation_in_console_mode"><a class="anchor" href="#_manual_installation_in_console_mode"></a>9. Manual Installation in Console Mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Our preferred way to install the Tigase server is using GUI installer and configuration program which comes with one of the binary packages. Please pick up the latest version of the JAR file in our <a href="http://www.tigase.org/filebrowser/tigase-server">download section</a>.</p>
</div>
<div class="paragraph">
<p>In many cases however this is not always possible to use the GUI installer. In many cases you have just an ssh access or even a direct access in console mode only. We are going to provide a text-only installer in one of the next releases but for the time being you can use our binary packages to install the server manually. Please continue reading to learn how to install and setup the server in a few easy steps&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>If you have an old version of the Tigase server running and working and you intend to upgrade it please always backup the old version first.</p>
</div>
<div class="sect2">
<h3 id="_get_the_binary_package"><a class="anchor" href="#_get_the_binary_package"></a>9.1. Get the Binary Package</h3>
<div class="paragraph">
<p>Have a look at our <a href="http://www.tigase.org/filebrowser/tigase-server">download area</a>. Always pick the latest version of the package available. For manual installation either <strong>zip</strong> or <strong>tar.gz</strong> file is available. Pick one of files with filename looking like: <strong>tigase-server-x.y.z-bv.tar.gz</strong> or <strong>tigase-server-x.y.z-bv.zip</strong> where 'x', 'y', 'z' and 'v' are version numbers and they change from a release to release.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unpack_the_package"><a class="anchor" href="#_unpack_the_package"></a>9.2. Unpack the Package</h3>
<div class="paragraph">
<p>Unpack the file using command for the tar.gz file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ tar -xzvf tigase-server-x.y.z-bv.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>or for the zip file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ unzip tigase-server-x.y.z-bv.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>A new directory will be created: <strong>tigase-server-x.y.z-bv/</strong>.</p>
</div>
<div class="paragraph">
<p>Sometimes after unpacking package on unix system startup script doesn&#8217;t have execution permissions. To fix the problem you have to run following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ chmod u+x ./scripts/tigase.sh</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prepare_configuration"><a class="anchor" href="#_prepare_configuration"></a>9.3. Prepare Configuration</h3>
<div class="paragraph">
<p>If you look inside the new directory, it should like this output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ls -l
total 316K
-rw-r--r--  1 265K 2008-12-15 22:24 ChangeLog
-rw-r--r--  1  37K 2008-12-15 22:24 License.html
-rw-r--r--  1 1.1K 2008-12-15 22:24 README
drwxr-xr-x  6  204 2009-02-03 13:25 certs/
drwxr-xr-x 22  748 2009-02-03 13:25 database/
drwxr-xr-x  3  102 2008-12-15 22:24 docs/
drwxr-xr-x  4  136 2009-02-03 13:25 etc/
drwxr-xr-x  3  102 2009-02-03 13:25 jars/
drwxr-xr-x 12  408 2009-02-03 13:25 libs/
drwxr-xr-x  2   68 2008-12-15 22:24 logs/
-rw-r--r--  1 1.5K 2008-12-15 22:24 package.html
drwxr-xr-x  7  238 2009-02-03 13:25 scripts/</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the moment the most important is the etc/ directory with 2 files:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ls -l etc/
total 8.0K
-rw-r--r-- 1  97 2008-12-15 22:24 init.properties
-rw-r--r-- 1 333 2008-12-15 22:24 tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Small change in the tigase.conf file is needed. Find a line setting correct <strong>JAVA_HOME</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">JAVA_HOME=&quot;${JDKPath}&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and replace <strong>${JDKPath}</strong> with a path to Java installation on your system.</p>
</div>
<div class="paragraph">
<p>You need also to edit the init.properties file. It contains initial parameters normally set by the configuration program. As you do the installation manually you have to edit this file yourself. It contains already a few lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ cat etc/init.properties
config-type=--gen-config-def
--admins=admin@$HOST_NAME
--virt-hosts = $HOST_NAME
--debug=server</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have to replace <strong>$HOST_NAME</strong> with a domain name used for your XMPP (Jabber) installation. Let&#8217;s say this is \'<strong>jabber.your-great.net</strong>'. Your init.properties should look like this then:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ cat etc/init.properties
config-type=--gen-config-def
--admins=admin@jabber.your-great.net
--virt-hosts = jabber.your-great.net
--debug=server</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also use multiple virtual domains if you want. Please have a look at the detailed description for <strong>--virt-hosts</strong> property in the ////&lt;&lt;initPropertiesGuide,////init.properties guide and also more detailed information in the ////&lt;&lt;VHtigaseServerGuide,////Virtual Hosts in the Tigase Server guide.</p>
</div>
<div class="paragraph">
<p>Unfortunately this is not all. You also need to configure connection to the database. First you have to decide what database you want to use: <strong>Derby</strong>, <strong>MySQL</strong> or <strong>PostgreSQL</strong>. Then there are to more properties you have to add to the <strong>init.properties:</strong> <strong>--user-db</strong> and <strong>--user-db-uri.</strong> The first property specifies the database type you use and the second the database connection string. For simplicity let&#8217;s assume you want to use <strong>Derby</strong> database with files located in directory <strong>/var/lib/tigase/derby</strong>. 2 more lines need to be added to the <strong>init.properties</strong> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ cat etc/init.properties
config-type=--gen-config-def
--admins=admin@jabber.your-great.net
--virt-hosts = jabber.your-great.net
--debug=server
--user-db=derby
--user-db-uri=jdbc:derby:/var/lib/tigase/derby</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is enough basic configuration to have your Tigase server installation running.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prepare_database"><a class="anchor" href="#_prepare_database"></a>9.4. Prepare Database</h3>
<div class="paragraph">
<p>Normally the database is prepared for you during the installation process. Now you are on your own. As in section above we prepare your first installation to run with the <strong>Derby</strong> database. Creating and preparing the Derby database is actually quite easy if you use a helper script: <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/scripts/db-create-derby.sh">./scripts/db-create-derby.sh</a>. The file might not be in your <strong>scripts/</strong> directory if you have an earlier version of the package. Simply download it from the link provided if it is missing and put it in the <strong>scripts/</strong> directory and execute it with the database location as the parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ./scripts/db-create-derby.sh /var/lib/tigase/derby</code></pre>
</div>
</div>
<div class="paragraph">
<p>There will be lots of output but if there is no error at the end of the output it means your database has been created and it is ready to use and you are ready to&#8230;&#8203;.</p>
</div>
<div class="paragraph">
<p>There might be filesystem access restrictions for the directory: <strong>/var/lib/</strong> and you might want/need to select a different location.</p>
</div>
</div>
<div class="sect2">
<h3 id="_start_the_server"><a class="anchor" href="#_start_the_server"></a>9.5. Start the Server</h3>
<div class="paragraph">
<p>Starting the server is the easiest part. Simply execute following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ./scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>and you should get the output like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Starting Tigase:
nohup: redirecting stderr to stdout
Tigase running pid=18103</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_check_if_it_is_working"><a class="anchor" href="#_check_if_it_is_working"></a>9.6. Check if it is Working</h3>
<div class="paragraph">
<p>The server is started already but how do you know if it is really working and there were no problems. Have a look in the <strong>logs/</strong> directory. There should be a few files in there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ls -l logs/
total 40K
-rw-r--r-- 1 20K 2009-02-03 21:48 tigase-console.log
-rw-r--r-- 1 16K 2009-02-03 21:48 tigase.log.0
-rw-r--r-- 1   0 2009-02-03 21:48 tigase.log.0.lck
-rw-r--r-- 1   6 2009-02-03 21:48 tigase.pid</code></pre>
</div>
</div>
<div class="paragraph">
<p>2 first files are the most interesting for us: <strong>tigase-console.log</strong> and <strong>tigase.log.0</strong>. The first one contains very limited information and only the most important entries. Have a look inside and check if there are any <strong>WARNING</strong> or <strong>SEVERE</strong> entries. If not everything should be fine.</p>
</div>
<div class="paragraph">
<p>Now you can connect with a Jabber (XMPP) client of your choice. The first thing to do would be registering the first account - the admin account from your init.properties file: <a href="mailto:admin@jabber.your-great.net">admin@jabber.your-great.net</a>. Refer to your client documentation how to register a new account.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_binary_updates"><a class="anchor" href="#_tigase_server_binary_updates"></a>10. Tigase Server Binary Updates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Most projects try to make sure that the SVN trunk code always compiles correctly. In the Tigase server case this is not enough however. Lots of installations out there we know of run just straight from out SVN trunk line. This puts on us an extra responsibility. Therefore our general approach is to run all functional tests before each code commit to ensure it works correctly. Of course this does not guarantee it will work correctly and efficiently in all cases and on all systems.</p>
</div>
<div class="paragraph">
<p>Some people like to be on the bleeding edge and always use the source code repository trunk some others prefer to stick to stable public releases. There is however a lot of other who would like to be able to use something from the middle - have the most recent features and new bug fixes but at least in "<strong>Beta</strong>" or "<strong>Release-Candidate</strong>" state.</p>
</div>
<div class="paragraph">
<p>If you look at the <strong>Monitor</strong> on the right hand side of the Tigase website you can see that the currently running version is always higher then the version available for download. If you are interested to update your server to the more recent version without much hassle please continue to read.</p>
</div>
<div class="paragraph">
<p>Installing Tigase from the public binary packages is pretty straightforward especially if you use the installer. Using SVN trunk sources to compile them for your own installation is not simple thing, however people who decide to do so normally don&#8217;t need much help or instructions. This document describes how to update your system using so called <strong>Betas</strong> or <strong>RC</strong> versions we release from time to time.</p>
</div>
<div class="paragraph">
<p>For releasing our Betas or RC versions we use <a href="http://maven.apache.org/">Maven</a> tool. All our projects and packages are always available in the <a href="http://maven.tigase.org/tigase/">Tigase Maven repository</a>. You can find there both sources, documentation and binary packages ready to download and use.</p>
</div>
<div class="paragraph">
<p>If you look for example into the <a href="http://maven.tigase.org/tigase/tigase-server/">Tigase server directory</a> you can see a list of versions already published. The version with <strong>SNAPSHOT</strong> in name is something we are working on right now or we used to work in the past. The code used to generate the version is very close to what is in SVN repository.</p>
</div>
<div class="paragraph">
<p>Therefore if you want to use the most recent <strong>SVN</strong> code but don&#8217;t want to compile it yourself you can download the most recent <strong>SNAPSHOT</strong> and replace your current libraries with it. Please note there might be many snapshots for a single version number. Just pick the last one. The file name consists of the <strong>version number</strong>, the <strong>creation date</strong>, <strong>creation time</strong> and snapshot number: <strong>tigase-server-4.1.1-20090211.142252-8.jar</strong>.</p>
</div>
<div class="paragraph">
<p>Those who are interested in using more stable version should pick the most recent version <strong>without</strong> the SNAPSHOT in its name. There is always only one binary release for each final version. Looking in the version directory you can find 2 more binary files for each final version: one with documentation and another with source codes. Each final release is also <a href="https://svn.tigase.org/reps/tigase-server/tags/">tagged</a> in our SVN repository so you can checkout or browse the source code if you need. There is a nicer <a href="http://projects.tigase.org/server/trac/browser/tags">source code browser</a> available too.</p>
</div>
<div class="paragraph">
<p>A few things to remember when you do the update from our maven repository:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you update to the most recent version of the server you <strong>MUST</strong> also update all libraries to the most recent version and you <strong>MUST</strong> also update all other elements like MUC and PubSub. Only this way you can be sure all parts are compatible with each other and will work correctly.</p>
</li>
<li>
<p>Please make sure you REPLACE old libraries with new files. A common mistake is to copy new libraries to a directory and leave old files too. This leads to unpredictable problems. Note, tigase server library for example is stored in <strong>jars/tigase-server.jar</strong> file. From the repository however you would download: <strong>tigase-server-4.1.4.jar</strong> file. Make sure you don&#8217;t have both loaded at runtime.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The instruction may not be accurate or complete. If you run in to any problems or find something wrong with the instruction please let me know. I am always open for suggestions and comments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_using_web_installer"><a class="anchor" href="#_installation_using_web_installer"></a>11. Installation Using Web Installer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Eric Dziewa
v1.0, January 2015: New Web Installer!
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2015-01-15</p>
</div>
<div class="paragraph">
<p>When Tigase XMPP Server starts up, it looks for the default configuration file: <strong>etc/init.properties</strong>. If this file has not been modified you can run the web installer. Which will step you through the process of configuring Tigase.</p>
</div>
<div class="sect2">
<h3 id="_download_and_extract"><a class="anchor" href="#_download_and_extract"></a>11.1. Download and Extract</h3>
<div class="paragraph">
<p>First download Tigase XMPP Server and extract it. You can download the <a href="https://projects.tigase.org/projects/tigase-server/files">official binaries</a>, or the latest and greatest <a href="http://build.xmpp-test.net/nightlies/dists/">nightly builds</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ wget http://build.xmpp-test.net/nightlies/dists/2015-01-12/tigase-server-7.0.0-SNAPSHOT-b3752-dist-max.tar.gz
$ tar -xf tigase-server-7.0.0-SNAPSHOT-b3752-dist-max.tar.gz
$ cd tigase-server-7.0.0-SNAPSHOT-b3752</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please do not run as root.</p>
</div>
</div>
<div class="sect2">
<h3 id="_start_the_server_2"><a class="anchor" href="#_start_the_server_2"></a>11.2. Start the Server</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">scripts/tigase.sh start</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verify_tigase_is_running"><a class="anchor" href="#_verify_tigase_is_running"></a>11.3. Verify Tigase is Running</h3>
<div class="paragraph">
<p>You should see a list of listening ports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ lsof -i -P
COMMAND   PID   USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME
java    18387 tigase  141u  IPv6 22185825      0t0  TCP *:8080 (LISTEN)
java    18387 tigase  148u  IPv6 22185834      0t0  TCP *:5222 (LISTEN)
java    18387 tigase  149u  IPv6 22185835      0t0  TCP *:5223 (LISTEN)
java    18387 tigase  150u  IPv6 22185836      0t0  TCP *:5290 (LISTEN)
java    18387 tigase  151u  IPv6 22185837      0t0  TCP *:5280 (LISTEN)
java    18387 tigase  152u  IPv6 22185838      0t0  TCP *:5269 (LISTEN)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connect_to_the_web_installer"><a class="anchor" href="#_connect_to_the_web_installer"></a>11.4. Connect to the Web Installer</h3>
<div class="paragraph">
<p>Some points before you can connect:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If AuthRepository is not configured then access is allowed (initial installation).</p>
</li>
<li>
<p>If it is accessed on localhost then access is allowed.</p>
</li>
<li>
<p>If user is authenticated by jid and password as user from admins of Tigase XMPP Server then access is allowed.</p>
</li>
<li>
<p>In other case access is denied.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Point your browser to <strong><a href="http://localhost:8080/setup/" class="bare">http://localhost:8080/setup/</a></strong> unless you are working remotely. Then you can use the domain name, or IP address. I used <a href="http://tpub.xmpp-test.net:8080/setup/" class="bare">http://tpub.xmpp-test.net:8080/setup/</a> for this guide.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_through_the_installation_process"><a class="anchor" href="#_step_through_the_installation_process"></a>11.5. Step Through the Installation Process</h3>
<div class="paragraph">
<p>You will be greeted by the following "About software" page.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-01.png" alt="web-install-01"></span></p>
</div>
<div class="paragraph">
<p>Read it and then click "Next"</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-02.png" alt="web-install-02"></span></p>
</div>
<div class="paragraph">
<p>Here we have the licensing page. Please read though the agreement, type your name and click "Next".</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-03.png" alt="web-install-03"></span></p>
</div>
<div class="paragraph">
<p>The software reads your current <strong>etc/init.properties</strong> file and presents it. Here we have a bare bones new installation. Click "Next".</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-04.png" alt="web-install-04"></span></p>
</div>
<div class="paragraph">
<p>Here we have the domain, database type, and admin account configuration screen. I&#8217;ve chosen Derby. Possible options are MySQL, PostgresSQL, and SQLServer. Tick the advanced box if you think you want a non standard installation.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-05.png" alt="web-install-05"></span></p>
</div>
<div class="paragraph">
<p>The Advanced configuration page. Select what you need.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-06.png" alt="web-install-06"></span></p>
</div>
<div class="paragraph">
<p>Plugins which will be loaded by the server.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-07.png" alt="web-install-07"></span></p>
</div>
<div class="paragraph">
<p>This is where the database schema is installed.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-08.png" alt="web-install-08"></span></p>
</div>
<div class="paragraph">
<p>You should see a page like this after success.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-09.png" alt="web-install-09"></span></p>
</div>
<div class="paragraph">
<p>The installation is complete and this is what the new <strong>init.properties</strong> will look like. Click "Save" to write the file to disk.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/web-install-10.png" alt="web-install-10"></span></p>
</div>
<div class="paragraph">
<p>Setup has finished. Go back into the installation directory and restart.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ scripts/tigase.sh stop
$ scripts/tigase.sh start</code></pre>
</div>
</div>
<div class="paragraph">
<p>To further fine tune the server you should edit etc/tigase.conf. Ensure <strong>JAVA_HOME</strong> path is correct, and increase memory if needed using <strong>JAVA_OPTIONS</strong> -Xmx (max), and -Xms (initial). You will need to direct Tigase to read settings from this file on startup as follows.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>Everything should be running smooth at this point. Check the logfiles in logs/ if you experience any problems.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_and_multiple_databases"><a class="anchor" href="#_tigase_server_and_multiple_databases"></a>12. Tigase Server and Multiple Databases</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-10-02 04:23</p>
</div>
<div class="paragraph">
<p>Splitting user authentication data from all other XMPP information such as roster, vcards, etc&#8230;&#8203; was almost always possible in Tigase XMPP Server. Possible and quite simple thing to configure. Also it has been always possible and easy to assign a different database for each Tigase component (MUC, PubSub, AMP), for recording the server statistics. Almost every data type or component can store information in a different location, simple and easy to setup through the configuration file.</p>
</div>
<div class="paragraph">
<p>However it is much less known that it is also possible to have a different database for each virtual domain. This applies to both the user repository and authentication repository. This allows for very interesting configuration such as user database sharding where each shard keeps users for a specific domain, or physically split data based on virtual domain if each domain refers to a different customer or group of people.</p>
</div>
<div class="paragraph">
<p>How can we do that then?</p>
</div>
<div class="paragraph">
<p>This is very easy to do through the Tigase&#8217;s configuration file.</p>
</div>
<div class="paragraph">
<p>Typically the well known lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">--auth-db=tigase-custom
--auth-db-uri=jdbc:mysql://db1.tigase/dbname?user&amp;password
--user-db=mysql
--user-db-uri=jdbc:mysql://db2.tigase/dbname?user&amp;password</code></pre>
</div>
</div>
<div class="paragraph">
<p>Define just a default databases for both user repository and authentication repository. Default means it is used when there is no repository specified for a particular virtual domain. However, you can have a separate, both user and authentication repository for each virtual domain.</p>
</div>
<div class="paragraph">
<p>Here is, how it works:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># First, let's define our default database for all VHosts
--auth-db=tigase-custom
--auth-db-uri=jdbc:mysql://db1.tigase/dbname?user&amp;password
--user-db=mysql
--user-db-uri=jdbc:mysql://db2.tigase/dbname?user&amp;password

# Now, we have VHost: domain1.com
# User authentication data for this VHost is stored in Drupal database
--auth-db[domain1.com]=drupal
--auth-db-uri[domain1.com]=jdbc:mysql://db7.tigase/dbname?user&amp;password
# All other user data is stored in Tigase's standard database in MySQL
--user-db[domain1.com]=mysql
--user-db-uri[domain1.com]=jdbc:mysql://db4.tigase/dbname?user&amp;password

# Next VHost: domain2.com
# User authentication is in LDAP server
--auth-db[domain2.com]=tigase.db.ldap.LdapAuthProvider
# Pretty standard Tigase's definition for the database (repository)
#  connection string
--auth-db-uri[domain2.com]=ldap://ldap.domain2.com:389
# Now is something new, we have a custom authentication repository
# settings for a single domain.
# Please note how we define the VHost for which we set custom parameters
basic-conf/auth-repo-params/domain2.com/user-dn-pattern=cn=,ou=,dc=,dc=
# All other user data is stored in the same as default repository
--user-db[domain2.com]=mysql
--user-db-uri[domain2.com]=jdbc:mysql://db2.tigase/dbname?user&amp;password

# Next VHost: domain3.com
# Again user authentication is in LDAP server but pointing to
# a different LDAP server with different access credentials
--auth-db[domain3.com]=tigase.db.ldap.LdapAuthProvider
# Pretty standard Tigase's definition for the database
# (repository) connection string
--auth-db-uri[domain3.com]=ldap://ldap.domain3.com:389
# Now is something new, we have a custom authentication
# repository settings for a single domain
# Please note how we define the VHost for which we set custom parameters
basic-conf/auth-repo-params/domain3.com/user-dn-pattern=cn=,ou=,dc=,dc=
# All other user data is stored on the domain3 server in PostgreSQL database
--user-db[domain3.com]=pgsql
--user-db-uri[domain3.com]=jdbc:pgsql://db.domain3.com/dbname?user&amp;password

# For VHost: domain4.com all the data, both authentication and
# user XMPP data are stored on a separate
# MySQL server with custom stored procedures for both user
# login and user logout processing.
--auth-db[domain4.com]=tigase-custom
--auth-db-uri[domain4.com]=jdbc:mysql://db14.domain4.com/dbname?user&amp;password
basic-conf/auth-repo-params/domain4.com/user-login-query={ call UserLogin(?, ?) }
basic-conf/auth-repo-params/domain4.com/user-logout-query={ call UserLogout(?) }
basic-conf/auth-repo-params/domain4.com/sasl-mechs=PLAIN,DIGEST-MD5
--user-db[domain4.com]=mysql
--user-db-uri[domain4.com]=jdbc:mysql://db14.domain4.com/dbname?user&amp;password</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, it requires some writing but flexibility is very extensive and you can setup as many separate databases as you need or want. If one database (recognized by the database connection string) is shared among different VHosts, Tigase still uses a single connection pool, so it won&#8217;t create an excessive number of connections to the database.</p>
</div>
<div class="paragraph">
<p>I hope this helps with more complex setups and configuration cases.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_system_checks"><a class="anchor" href="#_basic_system_checks"></a>13. Basic System Checks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-03-06 20:18</p>
</div>
<div class="paragraph">
<p>A while ago, I have written an article about Linux settings for high load systems. This is a description for just very basic settings which are essential to successfully run XMPP service for hundred of thousands online users.</p>
</div>
<div class="paragraph">
<p>Of course, high load and high traffic systems require much more tuning and adjustments. If you use selinux you have to be careful as it can interfere with the service while it is under a high load. Also some firewall settings may case problems as the system may decide it is under a DOS attack and can start blocking incoming connections or throttle the traffic.</p>
</div>
<div class="paragraph">
<p>In any case, there are some basic checks to do every time you deploy XMPP service to make sure it will function properly. I am trying to keep the article mentioned above up to date and add all the settings and parameters I discover while working with different installations. <em>If you have some suggestions for different values or different parameters to add, please let me know.</em></p>
</div>
<div class="paragraph">
<p>The article, while helpful, seems to be not enough though.</p>
</div>
<div class="paragraph">
<p>If you want to run a service on a few cluster nodes (5 or even 10), then manually checking every machine and adjusting these settings is quite annoying and it is very easy to forget about something.</p>
</div>
<div class="paragraph">
<p>To overcome this problem I started to work on a shell script which would run all the basic checks and report problems found. Ideally it should be also able to adjust some parameters for you.</p>
</div>
<div class="paragraph">
<p>I have just committed to the Tigase server <a href="https://svn.tigase.org/reps/tigase-server/trunk/scripts/">trunk/scripts/</a> repository a script called machine-check.sh. It performs all the basic checks from the article and also tries to adjust them when necessary. Have a <a href="https://svn.tigase.org/anon-websvn/filedetails.php?repname=tigase-server&amp;path=%2Ftrunk%2Fscripts%2Fmachine-check.sh">look at the code</a> or <a href="https://svn.tigase.org/reps/tigase-server/trunk/scripts/machine-check.sh">check it out</a> and run for yourself.</p>
</div>
<div class="paragraph">
<p>Any comments or suggestions, as usually, very much appreciated.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_linux_settings_for_high_load_systems"><a class="anchor" href="#_linux_settings_for_high_load_systems"></a>14. Linux Settings for High Load Systems</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>There are a few basic settings you have to adjust for high load systems to make sure the server have enough resources to handle big number of network connections.</p>
</div>
<div class="paragraph">
<p>The main parameter is a maximum number of opened files allowed for the process to keep at the same time. Each network connection uses a file handler therefore if the limit is too low you can quickly run out of handlers and the server can not accept any more connections.</p>
</div>
<div class="paragraph">
<p>This limit is set on 2 levels - on the kernel level (<strong>fs.file-max</strong>) and on the system level (<strong>nofile</strong>).</p>
</div>
<div class="paragraph">
<p>Another kernel property which can be important in certain configurations (like transports installations or when you use proxy for Bosh connections) is: <strong>net.ipv4.ip_local_port_range</strong>. This parameter can be set the same way as the fs.file-max property.</p>
</div>
<div class="sect2">
<h3 id="_fs_file_max"><a class="anchor" href="#_fs_file_max"></a>14.1. fs.file-max</h3>
<div class="paragraph">
<p>The <strong>fs.file-max</strong> kernel property is set via sysctl command. You can see current settings executing command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># sysctl fs.file-max
fs.file-max = 358920</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you plan to run high load service with big number of server connections then this parameter should be at least as twice big as the number of network connections you expect to support. You can change this setting executing command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="error">#</span> sysctl -w fs.file-max=<span class="integer">360000</span>
fs.file-max = <span class="integer">360000</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_net_ipv4_ip_local_port_range"><a class="anchor" href="#_net_ipv4_ip_local_port_range"></a>14.2. net.ipv4.ip_local_port_range</h3>
<div class="paragraph">
<p>You can see current settings executing command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># sysctl net.ipv4.ip_local_port_range
net.ipv4.ip_local_port_range = 32768        61000</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can change this setting executing command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># sysctl -w net.ipv4.ip_local_port_range=&quot;1024 65000&quot;
net.ipv4.ip_local_port_range = 1024 65000</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tcp_keepalive"><a class="anchor" href="#_tcp_keepalive"></a>14.3. TCP_keepalive</h3>
<div class="paragraph">
<p>According to <a href="http://blog.kolargol.eu/2006/06/tcpkeepalive.html">blog.kolargol.eu</a> or <a href="http://www.gnugk.org/keepalive.html">www.gnugk.org/</a> some keepalive settings should be changed to improve reliability.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># sysctl -w net.ipv4.tcp_keepalive_time=&quot;60&quot;
net.ipv4.tcp_keepalive_time = 60
# sysctl -w net.ipv4.tcp_keepalive_probes=&quot;3&quot;
net.ipv4.tcp_keepalive_probes = 3
# sysctl -w net.ipv4.tcp_keepalive_intvl=&quot;90&quot;
net.ipv4.tcp_keepalive_intvl = 90</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="__etc_sysctl_conf"><a class="anchor" href="#__etc_sysctl_conf"></a>14.4. /etc/sysctl.conf</h3>
<div class="paragraph">
<p>Above commands let the system remember new settings until the next system restart. If you want to make the change permanent you have to edit file: /etc/sysctl.conf and add the property at the end of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">fs.file-max=360000
net.ipv4.ip_local_port_range=1024 65000net.ipv4.tcp_keepalive_time=60
net.ipv4.tcp_keepalive_probes=3
net.ipv4.tcp_keepalive_intvl=90</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will be automatically loaded next time you start the server. Command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># sysctl -p</code></pre>
</div>
</div>
<div class="paragraph">
<p>Causes the /etc/systcl.conf to be reloaded which is useful when you added more parameters to the file and don&#8217;t want to restart the server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_nofile"><a class="anchor" href="#_nofile"></a>14.5. nofile</h3>
<div class="paragraph">
<p>This is the property used by the system limits. For example running the command ulimit -a shows you all limits set for the current user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
file size               (blocks, -f) unlimited
pending signals                 (-i) 38912
max locked memory       (kbytes, -l) 32
max memory size         (kbytes, -m) unlimited
open files                      (-n) 40960
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 38912
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited</code></pre>
</div>
</div>
<div class="paragraph">
<p>To make it even more interesting and more complex there are 2 types of system limits: <strong>soft limit</strong> which can be temporarily exceeded by the user and <strong>hard limit</strong> which can not be exceeded. To see your <strong>hard limit</strong> execute command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># ulimit -a -H
core file size          (blocks, -c) unlimited
data seg size           (kbytes, -d) unlimited
file size               (blocks, -f) unlimited
pending signals                 (-i) 38912
max locked memory       (kbytes, -l) 32
max memory size         (kbytes, -m) unlimited
open files                      (-n) 40960
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
stack size              (kbytes, -s) unlimited
cpu time               (seconds, -t) unlimited
max user processes              (-u) 38912
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited</code></pre>
</div>
</div>
<div class="paragraph">
<p>The hard limits are usually bigger then the soft limits or sometimes the same.</p>
</div>
<div class="paragraph">
<p>For us the most important parameter is: <strong>open files</strong>. You can change the property in file: /etc/security/limits.conf. You have to append 2 following lines to the end of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">jabber               soft    nofile         350000
jabber               hard    nofile         350000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where the <strong>jabber</strong> is the user name of the account running you IM service. You can also set the limits for all users on the machine in a following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">*               soft    nofile         350000
*               hard    nofile         350000</code></pre>
</div>
</div>
<div class="paragraph">
<p>For those changes to make an effect you have to logout from the modified account and login again. New limits should be applied.</p>
</div>
</div>
<div class="sect2">
<h3 id="_su_and_init_script"><a class="anchor" href="#_su_and_init_script"></a>14.6. su and init script</h3>
<div class="paragraph">
<p>If one intends to use init scripts for startup purposes (or simply wants to be able to start the server utilizing su command it&#8217;s necessary to adjust PAM configuration by modifying /etc/pam.d/su file and uncomment following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">session    required   pam_limits.so</code></pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards that init scripts will respect configured limits.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_generic_documents_applying_to_all_tigase_server_versions"><a class="anchor" href="#_generic_documents_applying_to_all_tigase_server_versions"></a>15. Generic Documents - Applying to All Tigase Server Versions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>This section keeps set of documents which apply to all the Tigase server version and contain more generic or introductory information.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;genericConfiguration,////Configuration</p>
</li>
<li>
<p>////&lt;&lt;genericServerCertificates,////Server certificates</p>
</li>
<li>
<p>////&lt;&lt;genericPymsn-t,////Tigase and PyMSN-t transport</p>
</li>
<li>
<p>////&lt;&lt;genericTwoSessionManagers,////Two or more SessionManagers</p>
</li>
<li>
<p>////&lt;&lt;genericdatabasePreperation,////Database preparation</p>
</li>
<li>
<p>////&lt;&lt;genericLoadBalancing,////Tigase Load Balancing</p>
</li>
<li>
<p>////&lt;&lt;genericSchemaChange51,////Tigase database minor but useful schema change in version 5.1.0</p>
</li>
<li>
<p>////&lt;&lt;genericStanzaSender,////StanzaSender</p>
</li>
<li>
<p>////&lt;&lt;genericDebuggingTigase,////Debuging Tigase</p>
</li>
<li>
<p>////&lt;&lt;genericImportingData,////Importing user data</p>
</li>
<li>
<p>////&lt;&lt;genericDrupalAuthentication,////Drupal authentication added</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>16. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>The main and actually the only configuration for the Tigase server is kept in the XML file. Let&#8217;s call it <strong>tigase.xml</strong> for further discussion.</p>
</div>
<div class="paragraph">
<p>When the user tries to setup the client for the first time he comes across 2 other configuration files: <strong>tigase.conf</strong> and <strong>init.properties</strong> which might be confusing. Here is a brief explanation what all those files are about and in other sections you can learn all the details needed to configure the server.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>////&lt;&lt;tigaseXMLconfiguration,////tigase.xml is the only Tigase server configuration file. It stores all the runtime settings and if it is missing the server generates a new file with whole configuration with some default settings + settings read from the <strong>init.properties</strong> file. You may edit the file manually to adjust settings but this is not recommended as manual editing the XML is error prone. Another way of changing this file and changing the configuration is to use ad-hoc commands which allow you to modify configuration at run-time and cause updating the XML file too. Ad-hoc commands method is not polished yet thus it is also not recommended. The safest way to tweak server runtime parameters is to put them in the init.properties file.</p>
</li>
<li>
<p>////&lt;&lt;initPropertiesGuide,////init.properties file is a simple text file with server parameters in form: <strong>key</strong> = <strong>value</strong>. When the XML configuration file is missing the Tigase server reads <strong>init.properties</strong> file and uses parameters found there as defaults for generation of the XML file. Therefore if you change the <strong>init.properties</strong> file you normally have to stop the server, remove the XML file and start the server again. All the settings from the <strong>init.properties</strong> are read and applied to the XML configuration. The properties file is easy to read and very safe to modify. At the moment this is the recommended way change the server configuration.</p>
</li>
<li>
<p>////&lt;&lt;genericTigaseConf,////tigase.conf is the Tigase server startup configuration. It is actually not used by the server itself. It rather contains operating system settings and environment parameters to correctly run the <a href="http://java.sun.com/">Java Virtual Machine</a>. It is only useful on the unix-like systems with Bash shell. If you run the server on MS Windows systems <strong>tigase.bat</strong> and <strong>wrapper.conf</strong> files are used instead. The <strong>tigase.conf</strong> file is read and loaded by the <strong>scripts/tigase.sh</strong> shell script which also scans the operating system environment for Java VM and other tools needed.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_xmpp_server_configuration_properties"><a class="anchor" href="#_tigase_xmpp_server_configuration_properties"></a>17. Tigase XMPP Server Configuration Properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2013-02-09 03:54</p>
</div>
<div class="paragraph">
<p>init.properties is a little bit extended version of the Java properties file with (key, value) pairs.</p>
</div>
<div class="paragraph">
<p>Comment line has it&#8217;s first non-white space ASCII character either '#' or '!'.</p>
</div>
<div class="paragraph">
<p>The key starts with first non-white space ASCII character and ends on either first white space ASCII character or either of '=' or ':'. Therefore if your key contains any of '=', ':' or white space characters you have to escape them with backslash \'\': \: or \=.</p>
</div>
<div class="paragraph">
<p>All of examples below specify 'vhosts' as a key and 'test-a, test-b, test-c' as a value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">vhosts=test-a, test-b, test-c
vhosts : test-a, test-b, test-c
    vhosts     =     test-a, test-b, test-c</code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible types are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>[S]</strong> (or nothing) - Characters string: 'abcdef'</p>
</li>
<li>
<p><strong>[s]</strong> - String array: 'abcdef, ghaijk, lmnopq'</p>
</li>
<li>
<p><strong>[B]</strong> - Boolean: 'true' or 'false'</p>
</li>
<li>
<p><strong>[b]</strong> - Boolean array: 'true, true, false'</p>
</li>
<li>
<p><strong>[L]</strong> - Long number: 1234567890</p>
</li>
<li>
<p><strong>[l]</strong> - Long array: '12334, 45435, 45645'</p>
</li>
<li>
<p><strong>[I]</strong> - Integer number: 123456</p>
</li>
<li>
<p><strong>[i]</strong> - Integer array: '123, 456, 678'</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are a bunch of parameters which have broader meaning than just one property. Some of them affect many configuration settings or can generate whole sections in the XML file. Most of them starts with \'--' double hyphen. Please note, each property put in the init.properties file starting with \'--' becomes a JVM system property (without \'--' at the beginning). Here is a list of all those parameters with description:</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;admins,////--admins</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;auth-db,////--auth-db</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;auth-db-uri,////--auth-db-uri</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;auth-domain-repo-pool,////--auth-domain-repo-pool</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;auth-repo-pool,////--auth-repo-pool</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;auth-repo-pool-size,////--auth-repo-pool-size</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;bind-ext-hostnames,////--bind-ext-hostnames</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;bosh-close-connection,////--bosh-close-connection</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;bosh-extra-headers-file,////--bosh-extra-headers-file</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cl-conn-repo-class,////--cl-conn-repo-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;client-access-policy-file,////--client-access-policy-file</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cluster-connect-all,////--cluster-connect-all</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cluster-mode,////--cluster-mode</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cluster-nodes,////--cluster-nodes</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cm-ht-traffic-throttling,////--cm-ht-traffic-throttling</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cm-see-other-host,////--cm-see-other-host</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cm-traffic-throttling,////--cm-traffic-throttling</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cmpname-ports,////--cmpname-ports</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;comp-class,////--comp-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;comp-name,////--comp-name</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;cross-domain-policy-file,////--cross-domain-policy-file</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;data-repo-pool-size,////--data-repo-pool-size</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;debug,////--debug</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;debug-packages,////--debug-packages</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;domain-filter-policy,////--domain-filter-policy</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;elements-number-limit,////--elements-number-limit</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;ext-comp,////--ext-comp</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;extcomp-repo-class,////--extcomp-repo-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;external,////--external</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;hardened-mode,////--hardened-mode</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;max-queue-size,////--max-queue-size</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;monitoring,////--monitoring</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;net-buff-high-throughput,////--net-buff-high-throughput</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;net-buff-standard,////--net-buff-standard</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;new-connections-throttling,////--new-connections-throttling</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;nonpriority-queue,////--nonpriority-queue</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;queue-implementation,////--queue-implementation</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;roster-implementation,////--roster-implementation</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;s2s-ejabberd-bug-workaround-active,////--s2s-ejabberd-bug-workaround-active</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;s2s-secret,////--s2s-secret</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;s2s-skip-tls-hostnames,////--s2s-skip-tls-hostnames</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;script-dir,////--script-dir</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;sm-cluster-strategy-class,////--sm-cluster-strategy-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;sm-plugins,////--sm-plugins</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;sm-threads-pool,////--sm-threads-pool</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;ssl-certs-location,////--ssl-certs-location</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;ssl-container-class,////--ssl-container-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;ssl-def-cert-domain,////--ssl-def-cert-domain</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;stats-history,////--stats-history</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;stringprep-processor,////--stringprep-processor</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;test,////--test</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;tigase-config-repo-class,////--tigase-config-repo-class</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;tigase-config-repo-uri,////--tigase-config-repo-uri</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;tls-jdk-nss-bug-workaround-active,////--tls-jdk-nss-bug-workaround-active</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;trusted,////--trusted</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;user-db,////--user-db</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;user-db-uri,////--user-db-uri</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;user-domain-repo-pool,////--user-domain-repo-pool</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;user-repo-pool,////--user-repo-pool</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;user-repo-pool-size,////--user-repo-pool-size</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-anonymous-enabled,////--vhost-anonymous-enabled</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-max-users,////--vhost-max-users</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-message-forward-jid,////--vhost-message-forward-jid</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-presence-forward-jid,////--vhost-presence-forward-jid</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-register-enabled,////--vhost-register-enabled</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;vhost-tls-required,////--vhost-tls-required</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;virt-hosts,////--virt-hosts</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;watchdog_delay,////--watchdog_delay</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;watchdog_ping_type,////--watchdog_ping_type</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;watchdog_timeout,////--watchdog_timeout</p>
</div>
<div class="paragraph">
<p><strong>Property name:</strong> ////&lt;&lt;config-type,////config-type</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_init_properties"><a class="anchor" href="#_init_properties"></a>18. init.properties</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Document has been moved to a new location. Please have a look at the new page with the server properties description: Tigase XMPP Server ////&lt;&lt;initPropertiesGuide,////configuration properties.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_xml_configuration_file_description"><a class="anchor" href="#_xml_configuration_file_description"></a>19. XML Configuration File Description</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>If you look inside configuration file you can see that this is just normal XML file with a few top-level separate sections. These sections are called components.</p>
</div>
<div class="paragraph">
<p>This is it. Tigase server consists of components and without components there is no application at all. This is why the only configuration settings you can find there are only under some component level.</p>
</div>
<div class="paragraph">
<p>More precisely top level element in this XML file is called: &amp;lt;tigase-config/&amp;gt; and it doesn&#8217;t contain any top level configuration settings.</p>
</div>
<div class="paragraph">
<p>Under the top level element there are at least 2 or more &amp;lt;component/&amp;gt; elements. Each component can be distinguished from others by it&#8217;s 'name'. That is, 'name' attribute is mandatory and must be distinct within configuration file. It is just component ID. Each component can be named any way you like it doesn&#8217;t need to mean anything. It is just easier to manage configuration if you select sensible names.</p>
</div>
<div class="paragraph">
<p>&amp;lt;component/&amp;gt; elements keep configuration settings for server modules.</p>
</div>
<div class="paragraph">
<p>Example 1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;tigase-config&gt;
  &lt;component name=&quot;basic-conf&quot;&gt;
    .... settings
  &lt;/component&gt;
  &lt;component name=&quot;message-router&quot;&gt;
    .... settings
  &lt;/component&gt;
&lt;/tigase-config&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuration settings are kept in "simple" maps like structures (key, values, type) triplets.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>key</strong> is a configuration parameter identifier or a name of the parameter.</p>
</li>
<li>
<p><strong>values</strong> are just values of the parameter identified by the key. Usually this is just a single value but in some cases there can me more than just one value.</p>
</li>
<li>
<p><strong>type</strong> all configuration parameters have a type. In most cases this is just a String. Other possible types are: Boolean, Integer, Long and corresponding array types: String[], Boolean[], int[], long[].</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuration settings are stored in &amp;lt;map/&amp;gt; element which contains list of &amp;lt;entry/&amp;gt; elements. If there are multiple values for a parameter they are stored as a list of &amp;lt;item&amp;gt; elements.</p>
</div>
<div class="paragraph">
<p>Example 2:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;map&gt;
   &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host</span><span class="delimiter">&quot;</span></span>/&gt;
   &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">Boolean</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">demo-mode</span><span class="delimiter">&quot;</span></span>/&gt;
   &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">Integer</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">max-queue-size</span><span class="delimiter">&quot;</span></span>/&gt;
   &lt;entry type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String[]</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">hostnames</span><span class="delimiter">&quot;</span></span>&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">test-a</span><span class="delimiter">&quot;</span></span>/&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>/&gt;
   &lt;/entry&gt;
   &lt;entry type=<span class="string"><span class="delimiter">&quot;</span><span class="content">int[]</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">ports</span><span class="delimiter">&quot;</span></span>&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">5222</span><span class="delimiter">&quot;</span></span>/&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">5223</span><span class="delimiter">&quot;</span></span>/&gt;
   &lt;/entry&gt;
&lt;/map&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configuration settings can be organised hierarchically using &amp;lt;node&amp;gt; elements:</p>
</div>
<div class="paragraph">
<p>Example 3:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">&lt;component name=<span class="string"><span class="delimiter">&quot;</span><span class="content">c2s</span><span class="delimiter">&quot;</span></span>&gt;
  &lt;map&gt;
    &lt;entry type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String[]</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">hostnames</span><span class="delimiter">&quot;</span></span>&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">test-d</span><span class="delimiter">&quot;</span></span>/&gt;
      &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span>/&gt;
    &lt;/entry&gt;
  &lt;/map&gt;
  &lt;node name=<span class="string"><span class="delimiter">&quot;</span><span class="content">connections</span><span class="delimiter">&quot;</span></span>&gt;
    &lt;map&gt;
      &lt;entry type=<span class="string"><span class="delimiter">&quot;</span><span class="content">int[]</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">ports</span><span class="delimiter">&quot;</span></span>&gt;
         &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">5222</span><span class="delimiter">&quot;</span></span>/&gt;
         &lt;item value=<span class="string"><span class="delimiter">&quot;</span><span class="content">5223</span><span class="delimiter">&quot;</span></span>/&gt;
      &lt;/entry&gt;
    &lt;/map&gt;
    &lt;node name=<span class="string"><span class="delimiter">&quot;</span><span class="content">5222</span><span class="delimiter">&quot;</span></span>&gt;
      &lt;map&gt;
         &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host</span><span class="delimiter">&quot;</span></span>/&gt;
         &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">plain</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">socket</span><span class="delimiter">&quot;</span></span>/&gt;
         &lt;entry value=<span class="string"><span class="delimiter">&quot;</span><span class="content">accept</span><span class="delimiter">&quot;</span></span> type=<span class="string"><span class="delimiter">&quot;</span><span class="content">String</span><span class="delimiter">&quot;</span></span> key=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span>/&gt;
      &lt;/map&gt;
    &lt;/node&gt;
  &lt;/node&gt;
&lt;/component&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Detailed description for all possible settings is split to per-component chapter. Please look for particular component description for details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_old_way_editing_configuration_file_manually"><a class="anchor" href="#_old_way_editing_configuration_file_manually"></a>20. Old Way - Editing Configuration File Manually</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Options you most likely have to change at deployment time are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Admin</strong> <strong>accounts</strong> -  account names where all admin messages are sent.</p>
</li>
<li>
<p><strong>Hostnames</strong> -  real and virtual hostnames your server has to serve for.</p>
</li>
<li>
<p><strong>Logs</strong> -  setting related to log file location and how much information should be logged there.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Please let me know if you think more options should be described here.</p>
</div>
<div class="paragraph">
<p>At the moment the only way to change configuration is to manually edit XML config file. So be prepared for tough times. The good news it that more user friendly interfaces are scheduled for next release. And it will be also reconfigure server at runtime without need to restart service.</p>
</div>
<div class="sect2">
<h3 id="_admin_accounts"><a class="anchor" href="#_admin_accounts"></a>20.1. Admin Accounts</h3>
<div class="paragraph">
<p>This is the most likely thing to change after you install server and generate default configuration. Actually it is also the easiest option to customize.</p>
</div>
<div class="paragraph">
<p>Open tigase-config.xml in you favorite text editor and search for string: "<strong>admins</strong>". You should find section looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;admins&quot;&gt;
    &lt;item value=&quot;admin%40your.hostname.com&quot;/&gt;
    &lt;item value=&quot;admin%40localhost&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Characters "%40" stand for '@'. So assuming you have just 1 admin account on your installation which is: "<strong>frank@jabber.example.com</strong>" you need to replace above code with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;admins&quot;&gt;
    &lt;item value=&quot;frank%40jabber.example.com&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And yes, you can just remove second entry with admin account: "<strong>admin@localhost</strong>" unless you really want to keep it. Be aware though all system messages will be sent to <strong>ALL</strong> admin accounts.</p>
</div>
<div class="paragraph">
<p>Well, if the account does not exists the message is discarded and a warning is be printed in log file. Again, read it again, the previous sentence&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>It means that the admin account has to be also created in normal way on the Jabber server. Just register it using your Jabber client. The admin accounts setting works just as a forward instruction. So as a result all system and admin messages are forwarded to all admin accounts if they exist.</p>
</div>
<div class="paragraph">
<p>Obviously you can have admin accounts as many as you like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;admins&quot;&gt;
    &lt;item value=&quot;frank%40jabber.example.com&quot;/&gt;
    &lt;item value=&quot;lucy%40jabber.example.com&quot;/&gt;
    &lt;item value=&quot;mark%40jabber.example.com&quot;/&gt;
    &lt;item value=&quot;brenda%40jabber.example.com&quot;/&gt;
    &lt;item value=&quot;luck%40jabber.example.com&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hostnames"><a class="anchor" href="#_hostnames"></a>20.2. Hostnames</h3>
<div class="paragraph">
<p>This one might be a little bit more tricky than previous as <strong>hostnames</strong> setting has to be changed in a few places. Don&#8217;t ask why now as this is a "Short Configuration Guide", you remember. Here we focus on <strong>how</strong> not on <strong>why</strong>.</p>
</div>
<div class="paragraph">
<p>You have to search configuration file for string "<strong>hostnames</strong>". There are more than one such sections and you have to find <strong>ALL</strong> sections looking like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;hostnames&quot;&gt;
    &lt;item value=&quot;your.hostname.com&quot;/&gt;
    &lt;item value=&quot;localhost&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It may also look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;hostnames&quot;&gt;
    &lt;item value=&quot;localhost&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending how successful was mechanism for automatic hostname detection. It of course does not depends on your luck. It depends on network configuration on your server.</p>
</div>
<div class="paragraph">
<p>The first form is more useful as it includes also hostname recognized in network environment. If it is correct then you can just leave it as it is. If it is incorrect you have to change it. Please remember, if you want your server to be able to communicate with other <em>Jabber/XMPP</em> servers the hostname you put there must resolve in DNS to your Jabber server machine IP address. In other words. If you try to connect from the Internet to machine with this hostname the connection should reach your Jabber server.</p>
</div>
<div class="paragraph">
<p>And remember your Jabber server users' <em>JIDs (Jabber IDs)</em> can include only those hostnames which are included in the configuration. So for our case you can use only <em>JIDs:</em> "<em>user2@your.hostname.com</em>", "<em>user1@your.hostname.com</em>" and so on.</p>
</div>
<div class="paragraph">
<p>If you server have more Internet addresses (virtual domains) assigned to it your Jabber server can use them all. So your configuration may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;hostnames&quot;&gt;
    &lt;item value=&quot;your.hostname.com&quot;/&gt;
    &lt;item value=&quot;clien1.hostname.com&quot;/&gt;
    &lt;item value=&quot;another.hostname.com&quot;/&gt;
    &lt;item value=&quot;jabber.sample-domain.com&quot;/&gt;
    &lt;item value=&quot;jabber.some-project.org&quot;/&gt;
    &lt;item value=&quot;localhost&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In such case users' <em>JIDs</em> on your Jabber server may include any of defined above domains like: "<em>user1@your.hostname.com</em>", "<em>user1@clien1.hostname.com</em>", "<em>user1@jabber.sample-domain.com</em>". Each of these 3 sample JIDs refer to different user account.</p>
</div>
<div class="paragraph">
<p>Your server will accept connections only for domains defined in configuration file.</p>
</div>
<div class="paragraph">
<p>In majority cases it does not matter whether you leave "<strong>localhost</strong>" or remove it. It is sometimes better to leave it though. So if you are not sure if you can remove it in your environment just leave it as is.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logs"><a class="anchor" href="#_logs"></a>20.3. Logs</h3>
<div class="paragraph">
<p>Logging mechanism is very flexible in Tigase server. You can adjust separate logging level for each single component. You can also direct loggin to many different destinations like console, file, network socket and so on. Unfortunately it also mean it is a bit complex. The general idea however is quite simple so once you understand it it shouldn&#8217;t be difficult for you anymore. This guide however describes logging very briefly. Loot at full configuration documentation for detailed explanation.</p>
</div>
<div class="paragraph">
<p>In standard sever configuration you usually want to turn off all logging to console and all warning and more serious notices directed to log file. Let&#8217;s say logs will be written to /var/log/tigase-server.log which shouldn&#8217;t get bigger than 10MB and 5 old logs will be preserved. Here are instructions how to set options.</p>
</div>
<div class="paragraph">
<p>Open tigase-config.xml in you favorite text editor and search for string: "<strong>logging</strong>". You should find section looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;node name=&quot;logging&quot;&gt;
  &lt;map&gt;
    &lt;entry value=&quot;FINE&quot; type=&quot;String&quot; key=&quot;.level&quot;/&gt;
    &lt;entry value=&quot;java.util.logging.ConsoleHandler+java.util.logging.FileHandler&quot; type=&quot;String&quot; key=&quot;handlers&quot;/&gt;
    &lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.formatter&quot;/&gt;
    &lt;entry value=&quot;WARNING&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.level&quot;/&gt;
    &lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.append&quot;/&gt;
    &lt;entry value=&quot;5&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.count&quot;/&gt;
    &lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.formatter&quot;/&gt;
    &lt;entry value=&quot;ALL&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.level&quot;/&gt;
    &lt;entry value=&quot;100000&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.limit&quot;/&gt;
    &lt;entry value=&quot;logs%2Ftigase.log&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.pattern&quot;/&gt;
    &lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;tigase.useParentHandlers&quot;/&gt;
  &lt;/map&gt;
&lt;/node&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming we make this guide easy and strightforward let me show how this section should look like after modification. So you could just copy and paste it to your config file without going into details. After the configuration code I will briefly explain what each line means so you should be able to further adjust settings for your needs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;node name=&quot;logging&quot;&gt;
  &lt;map&gt;
    &lt;entry value=&quot;WARNING&quot; type=&quot;String&quot; key=&quot;.level&quot;/&gt;
    &lt;entry value=&quot;java.util.logging.ConsoleHandler+java.util.logging.FileHandler&quot; type=&quot;String&quot; key=&quot;handlers&quot;/&gt;
    &lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.formatter&quot;/&gt;
    &lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.formatter&quot;/&gt;
    &lt;entry value=&quot;OFF&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.level&quot;/&gt;
    &lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.append&quot;/&gt;
    &lt;entry value=&quot;5&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.count&quot;/&gt;
    &lt;entry value=&quot;ALL&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.level&quot;/&gt;
    &lt;entry value=&quot;10000000&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.limit&quot;/&gt;
    &lt;entry value=&quot;%2Fvar%2Flog%2Ftigase-server.log&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.pattern&quot;/&gt;
    &lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;tigase.useParentHandlers&quot;/&gt;
  &lt;/map&gt;
&lt;/node&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_each_line_explained"><a class="anchor" href="#_each_line_explained"></a>20.3.1. Each Line Explained:</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;WARNING&quot; type=&quot;String&quot; key=&quot;.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Effectively we set WARNING level for all possible logs for all possible components. So more detailed logging information will be discarded. All possible log levels are: OFF, SEVERE, WARNING, INFO, CONFIG, FINE, FINER, FINEST, ALL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;java.util.logging.ConsoleHandler+java.util.logging.FileHandler&quot; type=&quot;String&quot; key=&quot;handlers&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We set 2 handlers for logging information: console and file handler. As we are going to turn off logging to console we could remove all configuration settings for console handler as well. It would simplify configuration file. I don&#8217;t recommend it though. If there are any problems with your installation switching console logging on might be very helpful and if you remove these settings from config file it may be difficult to bring them back. Hm&#8230;&#8203; maybe not with such excellent documentation&#8230;&#8203;. ;-)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.formatter&quot;/&gt;
&lt;entry value=&quot;tigase.util.LogFormatter&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.formatter&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We set here log formatter for console and file handler. Standard Java handlers print each log message in 2 lines. Tigase formatter prints all logging info in 1 line which make it much easier to filter logs by log type, logging component or log level or whatever you wish. You can just use simple sed command and that&#8217;s it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;OFF&quot; type=&quot;String&quot; key=&quot;java.util.logging.ConsoleHandler.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we just switch console handler off. To switch it on back set any different level from the list above.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.append&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This settings is to controll whether we want to append logs into old log file or we want to create new log file (removing old content) each time server is restarted.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;5&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.count&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sets number of old log files to preserve to 5.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;ALL&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This line sets the logging level for file handler. Here we set that we want all possible logs to be written to the file. The global level setting however says that only WARNING logs will be generated. So if you want to have more detailed logs you need to adjust global logging level.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;10000000&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.limit&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Log file maximum size set to 10MB. After reaching this size the log file is closed and new file is created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;%2Fvar%2Flog%2Ftigase-server.log&quot; type=&quot;String&quot; key=&quot;java.util.logging.FileHandler.pattern&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Location of the log file and file name: /var/log/tigase-server.log. Please note <strong>%2F</strong> instead of \'<strong>/</strong>' character.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;true&quot; type=&quot;String&quot; key=&quot;tigase.useParentHandlers&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This setting requires going into more details so it is explained in comprehensive configuration guide.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_startup_file_for_tigase_sh_tigase_conf"><a class="anchor" href="#_startup_file_for_tigase_sh_tigase_conf"></a>21. Startup File for tigase.sh - tigase.conf</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Property file name for tigase.sh startup script is a second parameter for the startup script. It can be skipped if environmental variables are set in different place or in different way.</p>
</div>
<div class="paragraph">
<p>Config file for startup script simply sets number of environment variables with location of required components. Possible  variables to set in this file are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>JAVA_HOME</strong> - location of Java installation home directory. <strong>Must be set</strong>.</p>
</li>
<li>
<p><strong>TIGASE_HOME</strong> - location of Tigase installation home directory. <em>By default script try to find this location by searching directories from the location where the script has been run.</em></p>
</li>
<li>
<p><strong>TIGASE_CONSOLE_LOG</strong> - file to which all console messages will be redirected if server is run in background. By default it will be: <em>TIGASE_HOME/logs/tigase-console.log</em>. <strong><em>If this file/directory is not writable by Tigase process all console messages will be redirected to /dev/null</em></strong></p>
</li>
<li>
<p><strong>TIGASE_PID</strong> location of the file with server PID number. By default it will be <em>TIGASE_HOME/logs/tigase.pid</em>.</p>
</li>
<li>
<p><strong>TIGASE_CONFIG</strong> - location of the Tigase server config file. This is main config XML file. Not to be confused with startup script parameters file. <em>If not set script trys to find it in following locations in given order:</em> /etc/conf.d/tigase-server.xml, /etc/tigase-server.xml, /etc/tigase/tigase-server.xml or finally in TIGASE_HOME/etc/tigase-server.xml</p>
</li>
<li>
<p><strong>JAVA_OPTIONS</strong> - options for JVM like size of RAM allocated for the JVM, properties and so on.</p>
</li>
<li>
<p><strong>TIGASE_OPTIONS</strong> - additional options for Tigase server program. You can tweak here initial parameters for your environment.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Sample file to run <strong>Tigase</strong> with <strong>PostgreSQL</strong> database may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=org.postgresql.Driver&quot;
JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;
CLASSPATH=&quot;&quot;
TIGASE_CONFIG=&quot;tigase-pgsql.xml&quot;
TIGASE_OPTIONS=&quot; --property-file etc/init.properties &quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note encoding settings. I have received several requests about encoding problems. JVM by default uses encoding set in operating system environment. XMPP protocol, however uses UTF-8 for all data processing. So the above settings enforces UTF-8 encoding for all operations.</p>
</div>
<div class="paragraph">
<p>Another significant setting is \'<strong>CLASSPATH</strong>'. It is intentionally set to empty string. The <strong>tigase.sh</strong> startup script builds the <strong>CLASSPATH</strong> on it&#8217;s own from files found in <strong>jars/</strong> and <strong>libs/</strong> directories. I advice to set the <strong>CLASSPATH</strong> to the empty string because the Tigase server scans all available classes to find all components and plugins implementation. If the <strong>CLASSPATH</strong> contains lots of libraries which are not used anyway it cases long startup time and lots of memory consumption.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_certificates"><a class="anchor" href="#_server_certificates"></a>22. Server Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="sect2">
<h3 id="_documents_describing_how_to_obtain_and_manage_server_certificates"><a class="anchor" href="#_documents_describing_how_to_obtain_and_manage_server_certificates"></a>22.1. Documents Describing How To Obtain and Manage Server Certificates</h3>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;serverCertificatesPEM,////Creating and Loading the Server Certificate in pem Files</p>
</li>
<li>
<p>////&lt;&lt;startcomCertificate,////Installing StartCom Certificate in Your Linux System</p>
</li>
<li>
<p>////&lt;&lt;keytoolKeystore,////Server Certificate Using Keytool and Keystore</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_and_loading_the_server_certificate_in_pem_files"><a class="anchor" href="#_creating_and_loading_the_server_certificate_in_pem_files"></a>23. Creating and Loading the Server Certificate in pem Files</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="sect2">
<h3 id="_server_certificate"><a class="anchor" href="#_server_certificate"></a>23.1. Server Certificate</h3>
<div class="paragraph">
<p>Server certificate is needed when you use secure socket connections - SSL/TLS.</p>
</div>
<div class="paragraph">
<p>For secure socket connection proper certificate is needed. You can either generate your own, self-signed certificate or obtain certificate from trusted third party organization.</p>
</div>
<div class="paragraph">
<p>Here are steps how to obtain certificate from a trusted organization.</p>
</div>
<div class="sect3">
<h4 id="_certificate_request"><a class="anchor" href="#_certificate_request"></a>23.1.1. Certificate Request</h4>
<div class="paragraph">
<p>Before you can obtain/generate server certificate you need to have a private key and generate certificate request which contain essential information about you (the entity requesting certificate) and the domain for which you want the certificate.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generate the certificate request:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">openssl req -nodes -new -newkey rsa:2048 -keyout yourdomain.com.key -out yourdomain.com.csr</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be asked series of questions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Country Name (2 letter code) [AU]:AU
State or Province Name (full name) [Some-State]:Somestate
Locality Name (eg, city) []:Your city name
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Company name
Organizational Unit Name (eg, section) []:Department or any unit
Common Name (eg, YOUR name) []:*.yourdomain.com
Email Address []:your_email_address@somedomain.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:</code></pre>
</div>
</div>
</li>
<li>
<p>The command will generate 2 files for you:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>yourdomain.com.csr</p>
</li>
<li>
<p>yourdomain.com.key</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_certificate_from_other_providers"><a class="anchor" href="#_certificate_from_other_providers"></a>23.1.2. Certificate From Other Providers</h4>
<div class="paragraph">
<p>There is number of certificate providers offering certificates either for free or for money. You can use any of them, however you have to be aware that sometimes certificates might not be recognized by all other XMPP servers, especially if this is a new provider. Here is an example list of providers:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.cacert.org/">CAcert</a> - free certificates with an excellent Web GUI for managing generated certificates and identities.</p>
</li>
<li>
<p><a href="https://www.startssl.com/">StartCom</a> - both free and paid certificates, class 1, 2 and 3. Very good GUI for managing certificates and identities.</p>
</li>
<li>
<p><a href="https://www.verisign.com/">Verisign</a> - very expensive certificates comparing to above provides but the provider is recognized by everybody. If you have a certificate from Verisign you can be sure it is identified as a valid certificate.</p>
</li>
<li>
<p><a href="http://www.comodo.com/business-security/digital-certificates/ssl-certificates.php">Comodo Certificate Authority</a> offers different kind of commercial certificates</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To obtain certificate from such a third party authority you have to go to its Website and request the certificate using certificate request generated above. I can not provide any instructions for this as each of above providers have a different offer and a different user interface.</p>
</div>
</div>
<div class="sect3">
<h4 id="_self_signed_certificate"><a class="anchor" href="#_self_signed_certificate"></a>23.1.3. Self-Signed Certificate</h4>
<div class="paragraph">
<p>Another option, <strong>highly not recommended</strong> is to use self-signed certificate. Such a certificate won&#8217;t be recognized by any entity on the Internet but your own. So if any other Jabber server allows for connections only with valid certificate your installation won&#8217;t be able to connect. On the other hand self-signed certificate is a very good way for testing environment where you can create many artificial domains and you can test your service for supporting many virtual domains. You can generate as many certificates as you want and load them onto your server and play around.</p>
</div>
<div class="paragraph">
<p>Tigase, version 5.0.0 and newer automatically generates self-signed certificates for each Virtual Host configured. Alternatively such certificate can be created by hand - just execute following command using the same as above <strong>openssl</strong> tool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">openssl x509 -req -days 365 -in yourdomain.com.csr -signkey yourdomain.com.key -out yourdomain.com.crt</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can, of course put there any number of days you like.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installing_loading_certificate_to_the_tigase_server"><a class="anchor" href="#_installing_loading_certificate_to_the_tigase_server"></a>23.2. Installing/Loading Certificate To the Tigase Server</h3>
<div class="paragraph">
<p>From the version <strong>3.1.0-b802</strong> of Tigase server installing/loading certificates is very easy. The server can load all certificates directly from <strong>pem</strong> files. You just need to create a separate pem file for each of your virtual domains and put the file in a directory accessible by the server. Tigase server can automatically load all <strong>pem</strong> files found in given directory.</p>
</div>
<div class="sect3">
<h4 id="_pem_file"><a class="anchor" href="#_pem_file"></a>23.2.1. PEM File</h4>
<div class="paragraph">
<p><strong>PEM</strong> file is a file containing server certificate, certificate private key and certificate chain if it exists. For self-signed certificates there is no certificate chain so creating pem file is very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cat yourdomain.com.crt yourdomain.com.key &gt; yourdomain.com.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the certificate is issued by third-party authority you have also to attach certificate chain, that is certificate of the authority who has generated your certificate. You normally need to obtain certificates for your chain from the authority who has generated your certificate. For example, of you have a certificate from XMPP federation you need to download <a href="http://www.startssl.com/certs/ca.pem">StartCom root certificate</a> and <a href="http://www.startssl.com/certs/sub.class1.server.ca.pem">intermediate ICA certificate</a>. In such case pem file is created using following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">cat yourdomain.com.crt yourdomain.com.key sub.class1.xmpp.ca.crt ca.crt &gt; yourdomain.com.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result file should looks similar to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">-----BEGIN CERTIFICATE-----
MIIG/TCCBeWgAwIBAgIDAOwZMA0GCSqGSIb3DQEBBQUAMIGMMQswCQYDVQQGEwJJ
.
.
.
pSLqw/PmSLSmUNIr8yQnhy4=
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
WW91J3JlIGtpZGRpbmchISEKSSBkb24ndCBzaG93IHlvdSBvdXIgcHJpdmF0ZSBr
.
.
.
ZXkhISEhCkNyZWF0ZSB5b3VyIG93biA7KSA7KSA7KQo=
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE-----
MIIHyTCCBbGgAwIBAgIBATANBgkqhkiG9w0BAQUFADB9MQswCQYDVQQGEwJJTDEW
.
.
.
xV/stleh
-----END CERTIFICATE-----</code></pre>
</div>
</div>
<div class="paragraph">
<p>For Tigase server and many other servers (Apache 2.x) the order is following: your domain certificate, your private key, authority issuing your certificate, root certificate.</p>
</div>
<div class="paragraph">
<p><strong>Note! Tigase requires full certificate chain in PEM file (described above)! Different applications may require pem file with certificates and private key in different order. So the same file may not be necessarily used by other services like Web server or e-mail server. Currenty Tigase can automatically sort sertificates in PEM file while loading it.</strong></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_server_configuration"><a class="anchor" href="#_tigase_server_configuration"></a>23.3. Tigase Server Configuration</h3>
<div class="paragraph">
<p>Starting from version 5.1.0 and newer it&#8217;s not needed to use external libraries nor extra configuration in init.properties file. With this version Tigase uses, loaded by default thus no need to configure it, following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--ssl-container-class=tigase.io.SSLContextContainer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Older versions require different cofiguration. In order to be able to load server certificates directly from <strong>pem</strong> files you need to have <strong>tigase-extras</strong> package installed in your server <strong>libs/</strong> directory in version at least <strong>0.1.0</strong>. If you use Tigase server binary package other than <strong>mini</strong> this library is included by default. If you haven&#8217;t changed manually anything in your XML configuration file put following line in your initial.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--ssl-container-class=tigase.extras.io.PEMSSLContextContainer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Copy all your <strong>pem</strong> files with certificates into certs/ subdirectory in Tigase server installation, stop the server, remove XML configuration file and start the server. XML configuration will be automatically regenerated with the new SSLContainer used by all components and all certificates will be automatically loaded.</p>
</div>
<div class="paragraph">
<p>If you have changed your XML configuration file manually and you can not lost those changes you have now to manually change the existing SSLContainer class with the new one. Just replace all occurrences of the default SSLContainer - tigase.io.SSLContextContainer with the new - tigase.extras.io.PEMSSLContextContainer, copy all your <strong>pem</strong> files with certificates into certs/ subdirectory in Tigase server installation and restart the server.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing_startcom_certificate_in_your_linux_system"><a class="anchor" href="#_installing_startcom_certificate_in_your_linux_system"></a>24. Installing StartCom Certificate in Your Linux System</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>The third party authority for free XMPP server certificates is <a href="http://cert.startcom.org/">Startcom</a>. Startcom root certificate is not normally known to your system as a valid certificate and appear as a self-signed certificate.</p>
</div>
<div class="paragraph">
<p>To make it known to your system as valid your have to install it in your system.</p>
</div>
<div class="paragraph">
<p>In any case or any operating system, you have to download the certificate from the issuer <a href="http://cert.startcom.org/?lang=en&amp;app=110">web site</a>.</p>
</div>
<div class="sect2">
<h3 id="_gentoo_linux"><a class="anchor" href="#_gentoo_linux"></a>24.1. Gentoo Linux</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Copy downloaded ca.crt file to /etc/ssl/certs/starcom_ca.crt file.</p>
</li>
<li>
<p>Run command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">update-ca-certificates</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>All done. To test it run following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">openssl s_client -connect tigase.org:5223 -CApath /etc/ssl/certs</code></pre>
</div>
</div>
<div class="paragraph">
<p>Scroll the output up and look for something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">verify return:1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which means certificate verification was successful. If you find however:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">verify return:0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Look one line up for an error message which may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">verify error:num=19:self signed certificate in certificate chain</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which means the root certificate is still not recognized in your system.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_certificate_using_keytool_and_keystore"><a class="anchor" href="#_server_certificate_using_keytool_and_keystore"></a>25. Server Certificate Using Keytool and Keystore</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bartosz Malkowski &lt;<a href="mailto:bmalkowski@tigase.pl">bmalkowski@tigase.pl</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>To allow secure connections through SSL or TLS channel you need SSL certificate.</p>
</div>
<div class="paragraph">
<p>The main purpose of SSL certificate is to provide connecting entity with a proof of identity of your server. Significant role in proving identity of your server plays trusted third party - usually the issuer of the certificate.</p>
</div>
<div class="paragraph">
<p>Certificate issued by trusted third party usually cost you a money. You can also use self signed certificate which works as well but gives authentication warning on client software at the connecting time.</p>
</div>
<div class="paragraph">
<p>Tigase server binary package and sources repository contain so called "dummy" certificate which doesn&#8217;t refer to any real site name. This certificate is temporary. Should be used only for initial testing of your server. It should be replaced with real one as soon as possible. By real certificate I mean either self signed certificate or issued by trusted third party organization.</p>
</div>
<div class="paragraph">
<p>Here are instructions how to install real certificate for Tigase server.</p>
</div>
<div class="paragraph">
<p><em>Please note! You have to use <strong>keytool</strong> program included in JDK-1.6 or later version. The utility included in earlier versions can not import third party signed certificates correctly.</em></p>
</div>
<div class="sect2">
<h3 id="_self_signed_certificate_2"><a class="anchor" href="#_self_signed_certificate_2"></a>25.1. Self Signed Certificate</h3>
<div class="paragraph">
<p>If you don&#8217;t have third party signed certificate you should generate self-signed certificate.</p>
</div>
<div class="paragraph">
<p>Some clients don&#8217;t works correctly with DSA keys, so we need to use RSA algorithm. To generate private and public keypair you should use keytool:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -genkey -alias yourdomain -keystore rsa-keystore \
    -keyalg RSA -sigalg MD5withRSA</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where yourdomain is a domain part of <em>JIDs</em> on your <em>Jabber/XMPP</em> server. If you want to have TLS support for virtual domains you have to create certificate for each virtual domain. If you have just one domain or for some reason you have to use one certificate for all domains use default as an alias.</p>
</div>
<div class="paragraph">
<p>Now, enter the secret password to protect keystore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Enter keystore password: 123456</code></pre>
</div>
</div>
<div class="paragraph">
<p>The keytool asks several questions about certificate data. First question is very important! You must enter a hostname of your XMPP server!!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">What is your first and last name?
  [Unknown]: jabber.myserver.org
What is the name of your organizational unit?
  [Unknown]:
What is the name of your organization?
  [Unknown]:
What is the name of your City or Locality?
  [Unknown]:
What is the name of your State or Province?
  [Unknown]:
What is the two-letter country code for this unit?
  [Unknown]:
Is CN=jabber.myserver.org, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown correct?
  [no]: yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>In last step you can enter password for key. At the moment different password for keystore and key is not supported so you have to enter the same password here as for keystore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Enter key password for &lt;mykey&gt;
             (RETURN if same as keystore password):</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you have to copy file rsa-keystore to directory certs/ in your tigase server installation. The file could also be installed in different location but then corrections to config file are required. Refer to configuration documentation for details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_cerificate_from_ca"><a class="anchor" href="#_cerificate_from_ca"></a>25.2. Cerificate from CA</h3>
<div class="paragraph">
<p>If you don&#8217;t have third-party signed certificate yet but you want to have one you could obtain it from <a href="http://www.cacert.org/">cacert.org</a> for free.</p>
</div>
<div class="paragraph">
<p>First, you have to generate Certificate Request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -certreq -alias yourdomain -keystore rsa-keystore</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where yourdomain is a domain name for which this certificate is generated. If you  need support for multiple virtual domains you need to have certificate for each domain separately and assign proper alias to certificate. If you have just one domain or for some reason you have to use one certificate for all domains use default as an alias.</p>
</div>
<div class="paragraph">
<p>Keytool generates the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-----BEGIN NEW CERTIFICATE REQUEST-----
MIIBrzCCARgCAQAwbzEQMA4GA1UEBhMHVW5rbm93bjEQMA4GA1UECBMHVW5rbm93bjEQMA4GA1UE
BxMHVW5rbm93bjEQMA4GA1UEChMHVW5rbm93bjEQMA4GA1UECxMHVW5rbm93bjETMBEGA1UEAxMK
c2VydmVyLm9yZzCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAs73Y70725OcG0j4kpCfDX59e
qhz2gdGOO0LyMO7rm4m+ZCenq8E88M0RJ8/LV/7q0mtOAzbI8dtXZnmJ74xihCH8ZTFpVDMyFWgk
WCj2kz+IUD9vWt6i1UepSkr1a/jYmVMN3RSaoS+j+QLBsJ4rWeOHgIdbiF5tnMhoZMXU//0CAwEA
AaAAMA0GCSqGSIb3DQEBBAUAA4GBAHY5r9rftqiKESbbkCcfVhvnUqN4aMTC8/zXWwzBX8guC0kd
H46+p6eizwJg6p+h6rqShG2OqXCPrJzO3buHr1jEWRTlB8l5CM53L/xq61nYuaSf5R7Vv/RX2+aD
JyoBqYIoSUED0+Sjhej0SUPTOdpA/bfnqdfdtckday4vsLPC
-----END NEW CERTIFICATE REQUEST-----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now send the request to your CA. CA issues a signed certificate and send it to you. It may may look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-----BEGIN CERTIFICATE-----
MIICUDCCAbkCBEUqAK0wDQYJKoZIhvcNAQEEBQAwbzEQMA4GA1UEBhMHVW5rbm93bjEQMA4GA1UE
CBMHVW5rbm93bjEQMA4GA1UEBxMHVW5rbm93bjEQMA4GA1UEChMHVW5rbm93bjEQMA4GA1UECxMH
VW5rbm93bjETMBEGA1UEAxMKc2VydmVyLm9yZzAeFw0wNjEwMDkwNzU2MjlaFw0wNzAxMDcwNzU2
MjlaMG8xEDAOBgNVBAYTB1Vua25vd24xEDAOBgNVBAgTB1Vua25vd24xEDAOBgNVBAcTB1Vua25v
d24xEDAOBgNVBAoTB1Vua25vd24xEDAOBgNVBAsTB1Vua25vd24xEzARBgNVBAMTCnNlcnZlci5v
cmcwgZ8wDQYJKoZIhvcNAQEBBQADgY0AMIGJAoGBALO92O9O9uTnBtI+JKQnw1+fXqoc9oHRjjtC
8jDu65uJvmQnp6vBPPDNESfPy1f+6tJrTgM2yPHbV2Z5ie+MYoQh/GUxaVQzMhVoJFgo9pM/iFA/
b1reotVHqUpK9Wv42JlTDd0UmqEvo/kCwbCeK1njh4CHW4hebZzIaGTF1P/9AgMBAAEwDQYJKoZI
hvcNAQEEBQADgYEAQqRPdkbc/pdDcPIWOThn2XPp0gitPkXq89ZM1mb0Pib1OISj9ekjqhEZz0UA
cI6g1XttpY6hKi6Gg+mRbwiHNVebkDLamE2UIcVJ1wBtowYeOcV1CcLnlj91ScMKNhfD5ebQL+be
tWWrJX3ep+80kF/NdVkc7htGOhLebopp8SQ=
-----END CERTIFICATE-----</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should save the Certificate to disk file.</p>
</div>
<div class="paragraph">
<p>If you already have third-party sgined certificate you have to import it with <strong>keytool</strong> program to server certificate storage.</p>
</div>
<div class="paragraph">
<p><em>Note! You must have a root CA certificate!!! You can download the cert from CA (ie.: root.crt) and import:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -import -keystore rsa-keystore -file root.crt \
    -alias root</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last step is import Certificate to your keystore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -import -alias yourdomain -keystore rsa-keystore \
    -file your-certificate.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where yourdomain is a domain name for which this certificate has been generated. If you  need support for multiple virtual domains you have to import certificate for each domain separately and assign proper alias to certificate. If you have just one domain or for some reason you have to use one certificate for all domains use default as an alias.</p>
</div>
<div class="paragraph">
<p>It&#8217;s also good to import root CA certificate to this keystore. You must find it on CA website.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -import -keystore rsa-keystore -file rootCA.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>It may also happen that you have generated certreq using openssl for use in other services like WWW. In such case you may have your private key and certificate in separate files. Let&#8217;s say private key is in ssl.key file and certificate is in ssl.crt file. To put them together use following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">openssl pkcs12 -export -inkey ssl.key -in ssl.crt \
    -out mycert.pfx -name &quot;default&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now you can load certificate with private key to your keystore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">keytool -importkeystore -srckeystore mycert.pfx \
    -srcstoretype pkcs12 -destkeystore rsa-keystore \
    -srcalias default -destalias yourdomain \
    -destkeypass your_keystore_pass</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note!</strong> <em>Please note -destkeypass parametr. Your keys password must be the same as keystore password. Otherwise it won&#8217;t work.</em></p>
</div>
<div class="paragraph">
<p>Now you have to copy file rsa-keystore to directory certs/ in your tigase server installation. The file could also be installed in different location but then corrections to config file are required. Refer to configuration documentation for details.</p>
</div>
<div class="paragraph">
<p>The final note - don&#8217;t forget to modify tigase server configuration file and set proper password for your keystore.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_and_pymsn_t_transport"><a class="anchor" href="#_tigase_and_pymsn_t_transport"></a>26. Tigase and PyMSN-t Transport</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Any Jabber server and any transport connect with each other usually through external component protocol (<a href="http://www.xmpp.org/extensions/xep-0114.html">XEP-0114</a>). So all you need to do is to correctly prepare configuration for this protocol on both sides.</p>
</div>
<div class="paragraph">
<p><em>Continue reading to learn how to setup Tigase and PyMSN for working together&#8230;&#8203;</em></p>
</div>
<div class="paragraph">
<p>There are a few basic parameters to set for this protocol:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>PORT number</strong> - this is standard thing for any TCP/IP connection. Usually the port number should be above 1024 and for PyMSN-t transport it is usually <strong>5347</strong>.</p>
</li>
<li>
<p><strong>IP address</strong> - again, standard thing for any TCP/IP connection. If both applications - Jabber server and transport run on the same machine the IP address should be <strong>127.0.0.1</strong>.</p>
</li>
<li>
<p><strong>SECRET</strong> - this is kind of connection password. Transport connects to the Jabber server and authenticates itself using this password. So no other, unauthorised transport can connect to the Jabber server. For our guide let the password be just <strong>secret</strong>.</p>
</li>
<li>
<p><strong>Transport ID</strong> - is an ID in Jabber network. Let&#8217;s say we want to setup transport for <strong>MSN</strong> for the server <strong>tigase.org</strong>. Transport ID can be: msn.tigase.org. It could be also: <strong>anything.tigase.org</strong> but this name while still valid would be confusing for users and my suggestion is to avoid confusing names. <strong>Note!</strong> Transport ID should resolve to correct IP address. For your tests you can add the ID to /etc/hosts file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is side by side configuration for both applications: PyMSN-t and Tigase to make them work together. I have setup both services on my laptop which hostname is <strong>test-d</strong>. To make sure both <strong>test-d</strong> and <strong>msn.test-d</strong> resolve to correct IP address I am adding entry to /etc/hosts file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">## In your case the IP address should be probably different.
192.168.0.13    test-d            msn.test-d</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tigase server connects to MySQL database (or built-in XMLBD for simpler configuration variant).</p>
</div>
<div class="paragraph">
<p>I am not going to setup <strong>PyMSN-t</strong> to run in background as a system service. This is specific to the system you use and is covered in transport documentation and you operating system. Most of systems have own scripts to start services so I would recommend to use them. Here we just run it in foreground with full logging switched on to the console to make it easier track what happens.</p>
</div>
<div class="sect2">
<h3 id="_pymsn_t_etc_jabber_pymsn_t_xml_file"><a class="anchor" href="#_pymsn_t_etc_jabber_pymsn_t_xml_file"></a>26.1. PyMSN-t - /etc/jabber/pymsn-t.xml file</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;pymsnt&gt;
  &lt;!-- The JabberID of the transport --&gt;
  &lt;jid&gt;msn.test-d&lt;/jid&gt;
  &lt;!-- The public IP or DNS name of the machine
    the transport is running on --&gt;
  &lt;host&gt;test-d&lt;/host&gt;
  &lt;!-- The location of the PID file, relative
    to the PyMSNt directory --&gt;
  &lt;pid&gt;/var/run/jabber/pymsn-t.pid&lt;/pid&gt;
  &lt;!-- If set, the transport will background
    itself when run, we don't want to do this right
    now. --&gt;
  &lt;!-- &lt;background/&gt; --&gt;
  &lt;!-- The IP address of the main Jabber server
    to connect to --&gt;
  &lt;mainServer&gt;127.0.0.1&lt;/mainServer&gt;
  &lt;!-- The TCP port to connect to the Jabber
    server on (this is the default for Jabberd2) --&gt;
  &lt;port&gt;5347&lt;/port&gt;
  &lt;!-- The authentication token to use when
    connecting to the Jabber server --&gt;
  &lt;secret&gt;secret&lt;/secret&gt;
  &lt;lang&gt;en&lt;/lang&gt;
  &lt;website&gt;http://test-d/&lt;/website&gt;
  &lt;allowRegister/&gt;
  &lt;getAllAvatars/&gt;
  &lt;!-- Please give the port to listen for Jabber
    socks5 transfers on. Note the standard port number
    set here is &lt;strong&gt;8010&lt;/strong&gt;. This port
    however is in use on my machine so this is why
    I had to set it to different value.--&gt;
  &lt;ftJabberPort&gt;8014&lt;/ftJabberPort&gt;
  &lt;admins&gt;
    &lt;jid&gt;tus@test-d&lt;/jid&gt;
  &lt;/admins&gt;
  &lt;!-- The logging level
    0 -&gt; No logging
    1 -&gt; Log tracebacks
    2 -&gt; Log tracebacks, warnings and errors
    3 -&gt; Log everything --&gt;
  &lt;debugLevel&gt;3&lt;/debugLevel&gt;
  &lt;!-- The file to log to. Leave this disabled
    for stdout --&gt;
  &lt;!-- &lt;debugFile&gt;debug.log&lt;/debugFile&gt; --&gt;
&lt;/pymsnt&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pymsn_t_run_command"><a class="anchor" href="#_pymsn_t_run_command"></a>26.2. PyMSN-t - run command</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">python /usr/lib/python2.4/site-packages/pymsn-t/pymsn-t.py \
  -c /etc/jabber/pymsn-t.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note!</strong> the full path to PyMSN-t config file is important.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pymsn_t_expected_output"><a class="anchor" href="#_pymsn_t_expected_output"></a>26.3. PyMSN-t - expected output</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">A few last lines should look like:
[2007-05-07 13:00:39] Starting factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;
[2007-05-07 13:00:39] &lt;twisted.internet.tcp.Connector
  instance at 0xb7ceb24c&gt; will retry in 2 seconds
[2007-05-07 13:00:39] Stopping factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;
[2007-05-07 13:00:41] Starting factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;
[2007-05-07 13:00:41] &lt;twisted.internet.tcp.Connector
  instance at 0xb7ceb24c&gt; will retry in 5 seconds
[2007-05-07 13:00:41] Stopping factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;
[2007-05-07 13:00:46] Starting factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;
[2007-05-07 13:00:46] &lt;twisted.internet.tcp.Connector
  instance at 0xb7ceb24c&gt; will retry in 15 seconds
[2007-05-07 13:00:46] Stopping factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory
  instance at 0xb7ce80ac&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And PyMSN should continue to print such lines until it successfully connects to the Tigase server. When it happens following lines should be printed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[2007-05-07 13:29:04] Starting factory
  &lt;twisted.xish.xmlstream.XmlStreamFactory instance at 0xb7cf00ac&gt;
[2007-05-07 13:29:04] INFO ::  ::  :: componentConnected
  :: PyTransport :: {'xmlstream': &lt;twisted.xish.xmlstream.XmlStream
  instance at 0xb7d0feac&gt;, 'self': 'instance'}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_etc_tigase_conf_file"><a class="anchor" href="#_tigase_etc_tigase_conf_file"></a>26.4. Tigase - etc/tigase.conf file</h3>
<div class="paragraph">
<p>You may consider to remove 2 last lines from TIGASE_OPTIONS variable to not use MySQL for now. Tigase will then use internal XMLDB which doesn&#8217;t need any special setup. (Just remember to leave closing double quotes&#8230;&#8203;)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=com.mysql.jdbc.Driver&quot;
CLASSPATH=&quot;${CLASSPATH}:libs/jdbc-mysql.jar&quot;
JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;
TIGASE_CONFIG=&quot;etc/tigase-mysql.xml&quot;
## All TIGASE_OPTIONS settings must be in single line
## They are split to make them more readable
TIGASE_OPTIONS=&quot;--gen-config-all --admins \&quot;tus@test-d\&quot;
 --virt-hosts test-d,localhost --debug server
 --ext-comp \&quot;test-d,msn.test-d,5347,secret,plain,accept\&quot;
 --user-db mysql --user-db-uri
 \&quot;jdbc:mysql://localhost/tigase?user=tigase&amp;password=mypass\&quot; &quot;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_run_command"><a class="anchor" href="#_tigase_run_command"></a>26.5. Tigase - run command</h3>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_expected_output"><a class="anchor" href="#_tigase_expected_output"></a>26.6. Tigase - expected output</h3>
<div class="paragraph">
<p>To see the log output from Tigase server execute following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">tail -f logs/tigase-console.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>After transport connects to Tigase server you should see lines like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">2007-05-07 12:29:05
  ComponentConnectionManager.processHandshake() FINE:
  Connected to: msn.test-d
2007-05-07 12:29:05
  ComponentConnectionManager.updateServiceDiscovery()
  FINEST: Modifing service-discovery info:
  &lt;item name=&quot;XEP-0114 connected&quot;
  jid=&quot;msn.test-d&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note!</strong> There was a bug in <strong>jabber:iq:register</strong> plugin which caused problems with registering account in transport. Please use build 432 or later.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_two_or_more_sessionmanagers"><a class="anchor" href="#_two_or_more_sessionmanagers"></a>27. Two or More SessionManagers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>In the most cases you use just one SessionManager object for your Tigase server installation. A single SM can handle multiple virtual domains with separate SSL certificates for each domain.</p>
</div>
<div class="paragraph">
<p>Sometimes, however you need very different configuration for each domain. For example you wish to use a separate database for a selected domain or you need a different set of plugins for each domain. For one domain you might want to allow user registration via XMPP and for another you might want to disable this feature.  In such a case you need to load more than one session manager.</p>
</div>
<div class="paragraph">
<p>This is generally not a problem. You just need to add another component in the configuration and adjust default settings.</p>
</div>
<div class="paragraph">
<p>The question is now how Tigase server knows to which session manager it has to forward packets received from the network. Mind, there is only one component responsible for handling client connections. So it needs to know somehow which session manager is receiver for certain packet.  Of course you set domain names in session manager too. But that is not enough. Tigase server supports cluster mode configuration where session manager can be running on a separate machine. So packet routings rules are not so simple to look at the domain name only. Therefore client connection manager (<strong>c2s</strong>) must know where is located the session manager responsible for handling the packet received from the network.</p>
</div>
<div class="paragraph">
<p>To solve the problem <strong>routings</strong> concept has been introduced. You can define packet routings based on the domain name set during XMPP stream initialization.  Each time <strong>c2s</strong> component receives packet from the network it tries to resolve destination component for the packet based on the current routings table. If you look in you server XML configuration file and search for <strong>c2s</strong> configuration section you can find routings node. Default configuration for routings table is quite simple. Just a single regular expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">   &lt;node name=&quot;routings&quot;&gt;
    &lt;map&gt;
     &lt;entry key=&quot;.+&quot; type=&quot;String&quot; value=&quot;sess-man%40tigase.org&quot;/&gt;
     &lt;entry key=&quot;multi-mode&quot; type=&quot;Boolean&quot; value=&quot;true&quot;/&gt;
    &lt;/map&gt;
   &lt;/node&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see this routings table forwards all packets to a single destination - session manager located on the <strong>tigase.org</strong> server.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we have now two session managers each of them is responsible for a separate domain.sm1@tigase.org handles requests for <strong>tigase.org</strong> and sm2@tigase.net handles requests for domain <strong>tigase.net.</strong> So let&#8217;s modify our default configuration to properly spread the traffic between these two sessiona managers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">   &lt;node name=&quot;routings&quot;&gt;
    &lt;map&gt;
     &lt;entry key=&quot;tigase.org&quot; type=&quot;String&quot; value=&quot;sm1%40tigase.org&quot;/&gt;
     &lt;entry key=&quot;tigase.net&quot; type=&quot;String&quot; value=&quot;sm2%40tigase.net&quot;/&gt;
     &lt;entry key=&quot;multi-mode&quot; type=&quot;Boolean&quot; value=&quot;true&quot;/&gt;
    &lt;/map&gt;
   &lt;/node&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please remember that a key is a regular expression in Java style: <a href="http://java.sun.com/j2se/1.4.2/docs/api/java/util/regex/Pattern.html">Pattern.html</a>. You can match more than a single domain with the key, for example: <em>tigase.+</em> to match all domains starting with <strong>tigase</strong>. The expression, however won&#8217;t match domain: <strong>xmpp.tigase.org</strong>. To match this domain the expression would need to be: <em>.+tigase.+</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database_preparation"><a class="anchor" href="#_database_preparation"></a>28. Database Preparation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-07-15 06:42</p>
</div>
<div class="paragraph">
<p>Tigase uses generally the same DB schema and the same set of stored procedures and functions on every database. However, the schema creation scripts and code for stored procedures is different for each database. Therefore the manual process to prepare database is different for each of them.</p>
</div>
<div class="paragraph">
<p>Of course the simplest and easiest way to prepare database is to use Tigase installer which automates the whole process. Sometimes it is not possible however. Here we provide a set of guides, describing initialization and preparation process for each supported database.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;prepareMysql,////Prepare the MySQL Database for the Tigase Server</p>
</li>
<li>
<p>////&lt;&lt;hashedPasswords,////Hashed User Passwords in Database</p>
</li>
<li>
<p>////&lt;&lt;prepareDerby,////Prepare the Derby Database for the Tigase Server</p>
</li>
<li>
<p>////&lt;&lt;prepareMssql,////Prepare the MS SQL Server Database for the Tigase Server</p>
</li>
<li>
<p>////&lt;&lt;preparePostgresql,////Prepare the PostgreSQL Database for the Tigase Server</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prepare_the_mysql_database_for_the_tigase_server"><a class="anchor" href="#_prepare_the_mysql_database_for_the_tigase_server"></a>29. Prepare the MySQL Database for the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>This guide describes how to prepare the MySQL database for connecting the Tigase server to it.</p>
</div>
<div class="sect2">
<h3 id="_basic_setup"><a class="anchor" href="#_basic_setup"></a>29.1. Basic Setup</h3>
<div class="paragraph">
<p>The MySQL database can be prepared in many ways. Most of Linux distributions contain tools which allow you to go through all steps from the shell command line. To make sure, however it works on all platforms the same way I show first how to do it under MySQL command line client.</p>
</div>
<div class="sect3">
<h4 id="_configuring_from_mysql_command_line_tool"><a class="anchor" href="#_configuring_from_mysql_command_line_tool"></a>29.1.1. Configuring from MySQL command line tool</h4>
<div class="paragraph">
<p>Run the MySQL command line client in either Linux or MS Windows environment and enter following instructions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the database for the Tigase server:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">create</span> <span class="type">database</span> tigasedb;</code></pre>
</div>
</div>
</li>
<li>
<p>Add the tigase_user user and grant him access to the tigasedb database. Depending on how you plan to connect to the database (locally or over the network) use one of following commands or all if you are not sure:</p>
<div class="paragraph">
<p><strong>Grant access to tigase_user connecting from any network address.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> tigasedb.* <span class="keyword">TO</span> tigase_user<span class="error">@</span><span class="string"><span class="delimiter">'</span><span class="content">%</span><span class="delimiter">'</span></span>
            IDENTIFIED <span class="keyword">BY</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_passwd</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Grant access to tigase_user connecting from localhost.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> tigasedb.* <span class="keyword">TO</span> tigase_user<span class="error">@</span><span class="string"><span class="delimiter">'</span><span class="content">localhost</span><span class="delimiter">'</span></span>
            IDENTIFIED <span class="keyword">BY</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_passwd</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Grant access to tigase_user connecting from local machine only.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">GRANT</span> <span class="keyword">ALL</span> <span class="keyword">ON</span> tigasedb.* <span class="keyword">TO</span> tigase_user
            IDENTIFIED <span class="keyword">BY</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_passwd</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 4.x additional permissions must be granted for the database user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; <span class="class">GRANT</span> <span class="class">SELECT</span>, <span class="class">INSERT</span>, <span class="class">UPDATE</span> <span class="keyword">ON</span> mysql.proc <span class="keyword">TO</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_user</span><span class="delimiter">'</span></span><span class="error">@</span><span class="string"><span class="delimiter">'</span><span class="content">localhost</span><span class="delimiter">'</span></span>;
mysql&gt; <span class="class">GRANT</span> <span class="class">SELECT</span>, <span class="class">INSERT</span>, <span class="class">UPDATE</span> <span class="keyword">ON</span> mysql.proc <span class="keyword">TO</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_user</span><span class="delimiter">'</span></span><span class="error">@</span><span class="string"><span class="delimiter">'</span><span class="content">%</span><span class="delimiter">'</span></span>;
mysql&gt; <span class="class">GRANT</span> <span class="class">SELECT</span>, <span class="class">INSERT</span>, <span class="class">UPDATE</span> <span class="keyword">ON</span> mysql.proc <span class="keyword">TO</span> <span class="string"><span class="delimiter">'</span><span class="content">tigase_user</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now you can update user permission changes in the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; FLUSH PRIVILEGES;</code></pre>
</div>
</div>
</li>
<li>
<p>Load <a href="http://server.tigase.org/browser/trunk/database/mysql-schema.sql">database schema</a> to initialize the Tigase server database space.  First, switch to the database you have just created:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; use tigasedb;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming you run the mysql client in Linux from the Tigase installation directory. If you run the Tigase server all versions below 4.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; source <span class="type">database</span>/mysql-schema.sql;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 4.x you have to use proper schema version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; source <span class="type">database</span>/mysql-schema<span class="error">-</span><span class="error">4</span>.sql;</code></pre>
</div>
</div>
<div class="paragraph">
<p>On Windows you have probably to enter the full path:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt; source c:/Program Files/Tigase/<span class="type">database</span>/mysql-schema.sql;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The initialization schema file should be also available locally in database/ directory of your Tigase installation.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_from_the_linux_shell_command_line"><a class="anchor" href="#_configuring_from_the_linux_shell_command_line"></a>29.2. Configuring From the Linux Shell Command Line</h3>
<div class="paragraph">
<p>Follow steps below to prepare the MySQL database:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the database space for the Tigase server:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>mysqladmin -p create tigasedb</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the tigase_user user and grant him access to the tigasedb database. Depending on how you plan to connect to the database (locally or over the network) use one of following commands or all if you are not sure:
<strong>Grant access to tigase_user connecting from any network address.</strong></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>echo "GRANT ALL ON tigasedb.* TO tigase_user@'%' \
            IDENTIFIED BY 'tigase_passwd'; \
            FLUSH PRIVILEGES;" | mysql -u root -pdbpass mysql</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Grant access to tigase_user connecting from localhost.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">echo <span class="string"><span class="delimiter">&quot;</span><span class="content">GRANT ALL ON tigasedb.* TO tigase_user@'localhost' </span><span class="char">\
</span><span class="content">            IDENTIFIED BY 'tigase_passwd'; </span><span class="char">\
</span><span class="content">            FLUSH PRIVILEGES;</span><span class="delimiter">&quot;</span></span> | mysql -u root -pdbpass mysql</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Grant access to tigase_user connecting from local machine only.</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">echo <span class="string"><span class="delimiter">&quot;</span><span class="content">GRANT ALL ON tigasedb.* TO tigase_user </span><span class="char">\
</span><span class="content">            IDENTIFIED BY 'tigase_passwd'; </span><span class="char">\
</span><span class="content">            FLUSH PRIVILEGES;</span><span class="delimiter">&quot;</span></span> | mysql -u root -pdbpass mysql</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load <a href="http://server.tigase.org/browser/trunk/database/mysql-schema.sql">database schema</a> to initialize the Tigase server (version below 4.0) database space:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>mysql -u dbuser -p tigasedb &lt; mysql-schema.sql</pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 4.0 and later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql -u dbuser -p tigasedb &lt; mysql-schema<span class="error">-</span><span class="error">4</span>.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>The initialization schema file should be also available locally in database/ directory of your Tigase installation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_mysql_for_utf_8_support"><a class="anchor" href="#_configuring_mysql_for_utf_8_support"></a>29.3. Configuring MySQL for UTF-8 Support</h3>
<div class="paragraph">
<p>In the my.conf put following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">[mysql]
default-character-SET=utf8

[client]
default-character-SET=utf8

[mysqld]
init_connect='SET collation_connection = utf8_general_ci; SET NAMES utf8;'
character-set-server=utf8
default-character-SET=utf8
collation-server=utf8_general_ci
skip-character-set-client-handshake</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then connect to the database and from the command line shell check settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string"><span class="delimiter">'</span><span class="content">character_set_database</span><span class="delimiter">'</span></span>;
<span class="class">SHOW</span> VARIABLES <span class="keyword">LIKE</span> <span class="string"><span class="delimiter">'</span><span class="content">character_set_client</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If any of these shows something else then 'utf8' then you have to correct it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">ALTER</span> <span class="type">DATABASE</span> tigasedb <span class="directive">DEFAULT</span> CHARACTER <span class="class">SET</span> utf8;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now also test your database installation if it accepts UTF-8 data. Best way is just to create an account with UTF-8 characters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigAddUserPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">żółw@some.domain.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">żółw</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then check of the account has been created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> * <span class="keyword">FROM</span> tig_users <span class="keyword">WHERE</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">żółw@some.domain.com</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the last command gives you no results it means there is still something wrong with settings. You might also check you shell settings to make sure your command line shell supports UTF-8 characters and passes them correctly to MySQL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">export LANG=en_US.UTF-8
export LOCALE=UTF-8
export LESSCHARSET='utf-8'</code></pre>
</div>
</div>
<div class="paragraph">
<p>It seems to me that MySQL 5.0.x also needs an extra parameters in the connection string: '&amp;useUnicode=true&amp;characterEncoding=UTF-8' while MySQL 5.1.x seems to not need it but it doesn&#8217;t hurt to have it for both versions. You have to edit 'etc/init.properties' file and append this to the database connection string.</p>
</div>
<div class="paragraph">
<p>For MySQL 5.1.x, however, you need also updated code for all database stored procedures and functions used by the Tigase. They are updated for Tigase version 4.4.x and up, for the time being if you use older version of the Tigase server you can reload stored procedures using the file from SVN.</p>
</div>
</div>
<div class="sect2">
<h3 id="_other_mysql_setting_worth_considering"><a class="anchor" href="#_other_mysql_setting_worth_considering"></a>29.4. Other MySQL Setting Worth Considering</h3>
<div class="paragraph">
<p>There is a number of other options useful, especially for a performance reasons. Please note, you have to review them as some of them may impact data reliability and are useful for performance or load tests installations only.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># InnoDB seems to be a better choice
# so lets make it a default DB engine
default-storage-engine = innodb</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some the general MySQL settings which mainly affect performance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">key_buffer = 64M
max_allowed_packet = 32M
sort_buffer_size = 64M
net_buffer_length = 64K
read_buffer_size = 16M
read_rnd_buffer_size = 16M
thread_stack = 192K
thread_cache_size = 8
query_cache_limit = 10M
query_cache_size = 64M</code></pre>
</div>
</div>
<div class="paragraph">
<p>InnoDB specific settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Keep data in a separate file for each table
innodb_file_per_table = 1
# Allocate memory for data buffers
innodb_buffer_pool_size = 1000M
innodb_additional_mem_pool_size = 100M
# A location of the MySQL database
innodb_data_home_dir = /home/databases/mysql/
innodb_log_group_home_dir = /home/databases/mysql/
# The main thing here is the 'autoextend' property
# without it your data file may reach maximum size and
# no more records can be added to the table.
innodb_data_file_path = ibdata1:10M:autoextend
innodb_log_file_size = 10M
innodb_log_buffer_size = 32M
# Some other performance affecting settings
innodb_flush_log_at_trx_commit = 2
innodb_lock_wait_timeout = 50
innodb_thread_concurrency = 16</code></pre>
</div>
</div>
<div class="paragraph">
<p>I am certainly not a database expert nor MySQL expert and I do not pretend to be one. So any comments or suggestions you may have are very welcome and appreciated.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hashed_user_passwords_in_database"><a class="anchor" href="#_hashed_user_passwords_in_database"></a>30. Hashed User Passwords in Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-10-09 03:13</p>
</div>
<div class="paragraph">
<p>By default user passwords are stored in plain-text in the Tigase&#8217;s database. However, there is an easy way to have them encoded in either one of already supported ways or to even add a new encoding algorithm on your own.</p>
</div>
<div class="paragraph">
<p>The reason to store passwords in plain-text format in the database is to make it possible to avoid plain-text password authentication mechanism. At the moment you cannot have hashed passwords in the database and non-plain-text password authentication. On the other hand, the connection between the server and the client is almost always secured by SSL/TLS so maybe the plain-text password authentication method is less of a problem than storing plain-text passwords in the database.</p>
</div>
<div class="paragraph">
<p>Nevertheless, it is simple enough to adjust this in Tigase&#8217;s database and we will add an option in the Tigase installer to allow you to make the decision at installation time.</p>
</div>
<div class="sect2">
<h3 id="_shortcut"><a class="anchor" href="#_shortcut"></a>30.1. Shortcut</h3>
<div class="paragraph">
<p>Connect to your database from a command line and execute following statement for MySQL database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigPutDBProperty(<span class="string"><span class="delimiter">'</span><span class="content">password-encoding</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">encoding-mode</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where encoding mode is one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>MD5-PASSWORD</strong> the database stores MD5 hash code from the user&#8217;s password.</p>
</li>
<li>
<p><strong>MD5-USERID-PASSWORD</strong> the database stores MD5 hash code from concatenated user&#8217;s bare JID and password.</p>
</li>
<li>
<p><strong>MD5-USERNAME-PASSWORD</strong> the database stores MD5 hash code from concatenated user&#8217;s name (localpart) and password.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigPutDBProperty(<span class="string"><span class="delimiter">'</span><span class="content">password-encoding</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">MD5-PASSWORD</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_full_route"><a class="anchor" href="#_full_route"></a>30.2. Full Route</h3>
<div class="paragraph">
<p>The way passwords are stored in the DB is controlled by Tigase database schema property. Properties in the database schema can be set by a stored procedure called: TigPutDBProperty(key, value). Properties from the DB schema can be retrieved using another stored function called: TigGetDBProperty(key).</p>
</div>
<div class="paragraph">
<p>The simplest way to call them is via command-line interface to the database.</p>
</div>
<div class="paragraph">
<p>For the purpose of this guide let&#8217;s say we have MySQL database and a test account: <strong>test@example.com</strong> with password <strong>test77</strong>.</p>
</div>
<div class="paragraph">
<p>By default, most of DB actions for Tigase, are performed using stored procedures. This includes user authentication. So, the first thing to do is to make sure the stored procedures are working correctly.</p>
</div>
<div class="sect3">
<h4 id="_create_a_test_user_account"><a class="anchor" href="#_create_a_test_user_account"></a>30.2.1. Create a Test User Account</h4>
<div class="paragraph">
<p>To add a new user account we use a stored procedure: TigAddUserPlainPw(bareJid, password). As you can see there is this strange appendix to the procedure name: <strong>PlainPw</strong>. It means the procedure accepts plain password regardless how it is stored in the database. So it is safe and easy to use either for plain-text passwords or hashed in the DB. There are also versions of procedures without this appendix but they are sensitive on the data format and always have to pass password in the exact format it is stored in the database.</p>
</div>
<div class="paragraph">
<p>So, let&#8217;s add a new user account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigAddUserPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test77</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the result was 'Query OK', then it means the user account has been successfully created.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_user_authentication"><a class="anchor" href="#_test_user_authentication"></a>30.2.2. Test User Authentication</h4>
<div class="paragraph">
<p>We can now test user authentication:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigUserLoginPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test77</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If authentication was successful the result looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">+<span class="comment">--------------------+</span>
| user_id            |
+<span class="comment">--------------------+</span>
| <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span> |
+<span class="comment">--------------------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.01</span> sec)

Query OK, <span class="integer">0</span> rows affected (<span class="float">0.01</span> sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If authentication was unsuccessful the result looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">+<span class="comment">---------+</span>
| user_id |
+<span class="comment">---------+</span>
|    <span class="predefined-constant">NULL</span> |
+<span class="comment">---------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.01</span> sec)

Query OK, <span class="integer">0</span> rows affected (<span class="float">0.01</span> sec)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_password_encoding_check"><a class="anchor" href="#_password_encoding_check"></a>30.2.3. Password Encoding Check</h4>
<div class="paragraph">
<p>TigGetDBProperty is a function, not a procedure in MySQL database so we have to use select to call it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">select</span> TigGetDBProperty(<span class="string"><span class="delimiter">'</span><span class="content">password-encoding</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Most likely output is this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">+<span class="comment">---------------------------------------+</span>
| TigGetDBProperty(<span class="string"><span class="delimiter">'</span><span class="content">password-encoding</span><span class="delimiter">'</span></span>) |
+<span class="comment">---------------------------------------+</span>
| <span class="predefined-constant">NULL</span>                                  |
+<span class="comment">---------------------------------------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span>, <span class="integer">1</span> warning (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which means a default password encoding is used, that is plain-text, thus no encoding. And we can actually check this in the database directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">select</span> uid, user_id, user_pw <span class="keyword">from</span> tig_users <span class="keyword">where</span> user_id = <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And expected result with plain-text password format would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">+<span class="comment">-----+--------------------+---------+</span>
| uid | user_id            | user_pw |
+<span class="comment">-----+--------------------+---------+</span>
|  <span class="integer">41</span> | <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span> | test77  |
+<span class="comment">-----+--------------------+---------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_password_encoding_change"><a class="anchor" href="#_password_encoding_change"></a>30.2.4. Password Encoding Change</h4>
<div class="paragraph">
<p>Now let&#8217;s set password encoding to MD5 hash:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigPutDBProperty(<span class="string"><span class="delimiter">'</span><span class="content">password-encoding</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">MD5-PASSWORD</span><span class="delimiter">'</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>'Query OK', means the password encoding has been successfully changed. Of course we changed the property only. All the existing passwords in the database are still in plain-text format. Therefore we expect that attempt to authenticate the user would fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigUserLoginPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test777</span><span class="delimiter">'</span></span>);
+<span class="comment">---------+</span>
| user_id |
+<span class="comment">---------+</span>
|    <span class="predefined-constant">NULL</span> |
+<span class="comment">---------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.00</span> sec)

Query OK, <span class="integer">0</span> rows affected (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can fix this updating the user&#8217;s password in the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">call TigUpdatePasswordPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test777</span><span class="delimiter">'</span></span>);
Query OK, <span class="integer">1</span> <span class="type">row</span> affected (<span class="float">0.01</span> sec)

mysql&gt; call TigUserLoginPlainPw(<span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">test777</span><span class="delimiter">'</span></span>);
+<span class="comment">--------------------+</span>
| user_id            |
+<span class="comment">--------------------+</span>
| <span class="string"><span class="delimiter">'</span><span class="content">test@example.com</span><span class="delimiter">'</span></span> |
+<span class="comment">--------------------+</span>
<span class="integer">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="class">set</span> (<span class="float">0.00</span> sec)

Query OK, <span class="integer">0</span> rows affected (<span class="float">0.00</span> sec)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prepare_the_derby_database_for_the_tigase_server"><a class="anchor" href="#_prepare_the_derby_database_for_the_tigase_server"></a>31. Prepare the Derby Database for the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-06-21 13:28</p>
</div>
<div class="paragraph">
<p>This guide describes how to prepare the Derby database for connecting the Tigase server to it.</p>
</div>
<div class="sect2">
<h3 id="_basic_setup_2"><a class="anchor" href="#_basic_setup_2"></a>31.1. Basic Setup</h3>
<div class="paragraph">
<p>Preparation of the Derby database is quite simple, but the following assumptions are made</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DerbyDB - Derby database name</p>
</li>
<li>
<p>database/ directory contains all necessary schema files</p>
</li>
<li>
<p>jars/ and libs/ directories contains Tigase and Derby binaries</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_general_approach"><a class="anchor" href="#_general_approach"></a>31.1.1. General Approach</h4>
<div class="paragraph">
<p>From the main Tigase directory execute following commands (Linux and Windows accordingly)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -Dij.protocol=jdbc:derby: -Dij.database=&quot;DerbyDB;create=true&quot; -cp libs/derby.jar:libs/derbytools.jar:jars/tigase-server.jar org.apache.derby.tools.ij database/derby-schema-5.1.sql</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -Dij.protocol=jdbc:derby: -Dij.database=&quot;DerbyDB;create=true&quot; -cp libs\derby.jar;libs\derbytools.jar;jars\tigase-server.jar org.apache.derby.tools.ij &quot;database\derby-schema-5-1.sql&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will create Derby database named DerbyDB in the main Tigase directory and load Tigase schema for the version 5.1.</p>
</div>
<div class="paragraph">
<p>If there is a need to create schema for any other Tigase version then please use schema relevant to the version that you intend to use:</p>
</div>
<div class="paragraph">
<p>If you run the Tigase server all versions below 4.0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">derby-schema-3.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 4.x and later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">derby-schema-4.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 5.0 and later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">derby-schema-5.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 5.1 and later:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">derby-schema-5-1.sql</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prepare_the_ms_sql_server_database_for_the_tigase_server"><a class="anchor" href="#_prepare_the_ms_sql_server_database_for_the_tigase_server"></a>32. Prepare the MS SQL Server Database for the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2013-09-04 14:57</p>
</div>
<div class="paragraph">
<p>This guide describes how to prepare the MS SQL Server database for connecting the Tigase server to it.</p>
</div>
<div class="sect2">
<h3 id="_basic_setup_3"><a class="anchor" href="#_basic_setup_3"></a>32.1. Basic Setup</h3>
<div class="paragraph">
<p>It&#8217;s expected that a working installation of Microsoft SQL Server is present. Following guide will describe necessary configuration option required for using MS SQL Server with Tigase XMPP Server.</p>
</div>
</div>
<div class="sect2">
<h3 id="_preparing_sql_server_instance"><a class="anchor" href="#_preparing_sql_server_instance"></a>32.2. Preparing SQL Server Instance</h3>
<div class="paragraph">
<p>After installation of SQL Server an instance needs to be configure to handle incoming JDBC connections. For that purpose it&#8217;s required to open <em>SQL Server Configuration Manager</em>. In the left-hand side panel navigate to <em>SQL Server Configuration Manager</em>, then <em>SQL Server Network Configuration &#8594; Protocols for ${INSTANCE_NAME}</em>. After selecting instance in the right-hand side panel select TCP/IP and open <em>Properties</em>, in the Protocol tab in General section select Yes for Enabled property. In the IP Addresses tab select Yes for Active and Enabled properties of all IP Addresses that you want SQL Server to handle. Subsequently set TCP Port property (if missing) to the default value - 1433.A restart of the instance may be required afterwards.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_using_sql_server_management_studio"><a class="anchor" href="#_configuring_using_sql_server_management_studio"></a>32.3. Configuring using SQL Server Management Studio</h3>
<div class="paragraph">
<p>In order to prepare database one can use either Wizards or execute queries directly in the Query Editor. First of all you need to establish connection to the SQL Server instance thus from Object Explorer select Connect and in the Connect to Server dialog enter administrator credentials.</p>
</div>
<div class="sect3">
<h4 id="_using_wizards"><a class="anchor" href="#_using_wizards"></a>32.3.1. Using Wizards</h4>
<div class="ulist">
<ul>
<li>
<p>Create Login</p>
<div class="paragraph">
<p>In the left-hand side panel select Security &#8594; Logins and from context menu choose New Login, in the Wizard window enter desired Login name, select SQL Server authentication and enter desired password subsequently confirming action with OK</p>
</div>
</li>
<li>
<p>Create Database</p>
<div class="paragraph">
<p>From the Object Explorer select Databases node and from context menu select New Database; in the Wizard window enter desired Database name and enter previously created Login name into Owner field; subsequently confirming action with OK.</p>
</div>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_using_queries"><a class="anchor" href="#_using_queries"></a>32.3.2. Using Queries</h4>
<div class="paragraph">
<p>From the Object Explorer root node&#8217;s context menu select New Query. In the Query windows execute following statements adjusting details to your liking:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">USE [master]
GO

<span class="class">CREATE</span> <span class="type">DATABASE</span> [tigasedb];
GO

<span class="class">CREATE</span> LOGIN [tigase] WITH PASSWORD=<span class="string"><span class="modifier">N</span><span class="delimiter">'</span><span class="content">tigase12</span><span class="delimiter">'</span></span>, DEFAULT_DATABASE=[tigasedb]
GO

<span class="class">ALTER</span> AUTHORIZATION <span class="keyword">ON</span> <span class="type">DATABASE</span>::tigasedb <span class="keyword">TO</span> tigase;
GO</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_import_schema"><a class="anchor" href="#_import_schema"></a>32.4. Import Schema</h3>
<div class="paragraph">
<p>From the File menu Select Open &#8594; File (or use Ctrl+O) and then open following files:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sqlserver-schema-5-1-schema.sql</p>
</li>
<li>
<p>sqlserver-schema-5-1-sp.sql</p>
</li>
<li>
<p>sqlserver-schema-5-1-props.sql</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Subsequently select created database from the list of Available Databases (Ctrl+U) available on the toolbar and execute each of the opened files in the order listed above.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_from_command_line_tool"><a class="anchor" href="#_configuring_from_command_line_tool"></a>32.5. Configuring from command line tool</h3>
<div class="paragraph">
<p>Creation of the database and import of schema can be done from command line as well. In order to do that one needs to execute following commands (either from directory where Tigase XMPP Server is installed or paths to the schema need to be adjusted accordingly):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sqlcmd -S %servername% -U %root_user% -P %root_pass% -Q &quot;CREATE DATABASE [%database%]&quot;
sqlcmd -S %servername% -U %root_user% -P %root_pass% -Q &quot;CREATE LOGIN [%user%] WITH PASSWORD=N'%password%', DEFAULT_DATABASE=[%database%]&quot;
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -Q &quot;ALTER AUTHORIZATION ON DATABASE::%database% TO %user%;&quot;
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-5-1-schema.sql
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-5-1-sp.sql
sqlcmd -S %servername% -U %root_user% -P %root_pass% -d %database% -i database\sqlserver-schema-5-1-props.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above can be automatized with provided script %tigase-server%\scripts\db-create-sqlserver.cmd (note: it needs to be executed from main Tigase XMPP Server directory due to maintain correct paths):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ scripts\db-create-sqlserver.cmd %database_servername% %database_name% %tigase_username% %tigase_password% %root_username% %root_password%</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no parameters are provided then defaults are used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">%database_servername%=localhost
%database_name%=tigasedb
%tigase_username%=tigase
%tigase_password%=tigase12
%root_username%=root
%root_password%=root</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_configuration_init_properties"><a class="anchor" href="#_tigase_configuration_init_properties"></a>32.6. Tigase configuration - init.properties</h3>
<div class="paragraph">
<p>Configuration of the MS SQL Server follows general database convention. For MS SQL Support --user-db needs to be set to sqlserver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db=sqlserver</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the --user-db-uri needs to point to the configured database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db-uri=jdbc:[jtds:]sqlserver://db_hostname:port[;property=val]</code></pre>
</div>
</div>
<div class="paragraph">
<p>where any number of additional can (and should) consist of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>databaseName - name of the database</p>
</li>
<li>
<p>user - username configured to access database</p>
</li>
<li>
<p>password - password for the above username</p>
</li>
<li>
<p>schema - name of the database schema</p>
</li>
<li>
<p>lastUpdateCount - 'false' value causes all update counts to be returned, including those returned by server triggers</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">--user-db-uri=jdbc:sqlserver://hostname:1433;databaseName=tigasedb;user=tigase;password=tigase12;schema=dbo;lastUpdateCount=false</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jdbc_jtds_vs_ms_jdbc_driver"><a class="anchor" href="#_jdbc_jtds_vs_ms_jdbc_driver"></a>32.7. JDBC: jTDS vs MS JDBC driver</h3>
<div class="paragraph">
<p>Tigase XMPP Server supports two JDBC drivers intended to be used with Microsoft SQL Server - one created and provided by Microsoft itself and the alternative implementation - jTDS. Tigase is shipped with the latter in the distribution packages, wowever we do not recommend using jDTS with Tigase and urge users to use JDBC driver created by Microsoft. It can be downloaded from Microsoft website: <a href="http://www.microsoft.com/en-us/download/details.aspx?displaylang=en&amp;id=11774">JDBC Driver 4.0 for SQL Server</a> and unpack archive, then copy sqljdbc_4.0/enu/sqljdbc4.jar file to ${tigase-server}/jars directory.</p>
</div>
<div class="paragraph">
<p>Depending on the driver used --user-db-uri needs to be configured accordingly.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Microsoft driver:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db-uri=jdbc:sqlserver://...</code></pre>
</div>
</div>
</li>
<li>
<p>jDTS driver</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db-uri=jdbc:jdts:sqlserver://...</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prepare_the_postgresql_database_for_the_tigase_server"><a class="anchor" href="#_prepare_the_postgresql_database_for_the_tigase_server"></a>33. Prepare the PostgreSQL Database for the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andrzej Wojcik &lt;<a href="mailto:andrzejw@tigase.org">andrzejw@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-06-16 09:38</p>
</div>
<div class="paragraph">
<p>This guide describes how to prepare the PostgreSQL database for connecting the Tigase server to it.</p>
</div>
<div class="sect2">
<h3 id="_basic_setup_4"><a class="anchor" href="#_basic_setup_4"></a>33.1. Basic Setup</h3>
<div class="paragraph">
<p>The PostgreSQL database can be prepared in many ways. Below are presented two of them. Following assumptions apply to both methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>admin_db_user - database user with admin rights</p>
</li>
<li>
<p>tigase_user - database user for Tigase</p>
</li>
<li>
<p>tigasedb - database for Tigase</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_configuring_from_postgresql_command_line_tool"><a class="anchor" href="#_configuring_from_postgresql_command_line_tool"></a>33.1.1. Configuring from PostgreSQL Command Line Tool</h4>
<div class="paragraph">
<p>Run the PostgreSQL command line client and enter following instructions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the tigase_user:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql=<span class="comment"># create role tigase_user with login password 'tigase123';</span></code></pre>
</div>
</div>
</li>
<li>
<p>Create the database for the Tigase server with tigase_user as owner of database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql=<span class="comment"># create database tigasedb owner tigase_user;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Load database schema to initialize the Tigase server from the file that corresponds to the Tigase version you want to use. First you need to switch to tigasedb.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql=<span class="comment"># \connect tigasedb</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 5.0 and later you have to use proper schema version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql=<span class="comment"># \i database/postgresql-schema-5.sql</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>For the Tigase server version 5.1 and later you have to use proper schema version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql=<span class="comment"># \i database/postgresql-schema-5-1.sql</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuring_from_the_linux_shell_command_line_2"><a class="anchor" href="#_configuring_from_the_linux_shell_command_line_2"></a>33.1.2. Configuring From the Linux Shell Command Line</h4>
<div class="paragraph">
<p>Follow steps below to prepare the PostgreSQL database:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the tigase_user:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">createuser -U admin_db_user -W -D -R -S -P tigase_user</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will be asked for credentials for admin_db_user and password for new database user.</p>
</div>
</li>
<li>
<p>Create the database for the Tigase server with tigase_user as owner of database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">createdb -U admin_db_user -W -O tigase_user tigasedb</code></pre>
</div>
</div>
</li>
<li>
<p>Load database schema to initialize the Tigase server from the file that corresponds to the Tigase version you want to use. For the <strong>Tigase server version 5.0 and later</strong> you have to use proper schema version:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql -q -U tigase_user -W tigasedb -f <span class="type">database</span>/postgresql-schema<span class="error">-</span><span class="error">5</span>.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the <strong>Tigase server version 5.1 and later</strong> you have to use proper schema version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql -q -U tigase_user -W tigasedb -f <span class="type">database</span>/postgresql-schema<span class="integer">-5</span><span class="error">-</span><span class="error">1</span>.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above commands should be executed from the main Tigase directory. The initialization schema file should be also available locally in database/ directory of your Tigase installation.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_database_minor_but_useful_schema_change_in_version_5_1_0"><a class="anchor" href="#_tigase_database_minor_but_useful_schema_change_in_version_5_1_0"></a>34. Tigase Database Minor but Useful Schema Change in Version 5.1.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-06-05 02:38</p>
</div>
<div class="paragraph">
<p>We have recently made a simple but very useful change to the DB schema in Tigase. It does preserve backward compatibility and it is not required to change your existing schema, even if you upgrade your installation to the most recent 5.1.0 version.</p>
</div>
<div class="paragraph">
<p>However, the change is very useful to track new accounts creation, therefore this article shows how to make modifications to you schema manually.</p>
</div>
<div class="paragraph">
<p>The change is related to adding a new field: acc_create_time which stores exact time of user account creation. The time is recorded automatically by database when a new record in the user table is created. So there is no extra overhead or resource usage on the Tigase server.</p>
</div>
<div class="paragraph">
<p>While the new field was added I have also slightly modifies types of 2 other fields: last_login and last_logout.</p>
</div>
<div class="paragraph">
<p>Here is how it looks now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="comment">-- Time the account has been created</span>
acc_create_time <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> CURRENT_TIMESTAMP,
<span class="comment">-- Time of the last user login</span>
last_login <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> <span class="integer">0</span>,
<span class="comment">-- Time of the last user logout</span>
last_logout <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> <span class="integer">0</span>,</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can easily update your schema with above changes using a simple SQL query. Enter the MySQL shell and copy-paste following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">alter</span> <span class="type">table</span> tig_users
  modify last_login <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> <span class="integer">0</span>,
  modify last_logout <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> <span class="integer">0</span>,
  <span class="class">add</span> acc_create_time <span class="predefined-type">timestamp</span> <span class="directive">DEFAULT</span> CURRENT_TIMESTAMP;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note, after executing query above the column acc_create_time will have meaningless value. To put some meaning for existing records I just copy last_login value to acc_create_time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">update</span> tig_users <span class="class">set</span> acc_create_time = last_login;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_load_balancing"><a class="anchor" href="#_tigase_load_balancing"></a>35. Tigase Load Balancing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2013-06-10 15:49</p>
</div>
<div class="paragraph">
<p>Starting with version 5.2.0 Tigase introduces a load balancing functionality allowing users to be redirected to the most suitable cluster node. Functionality relies on a see-other-host XMPP stream error message. Basic principle behind the mechanism is that user will get redirect if the host returned by the implementaion differ from the host to which user currently tries to connect. It is required that the user JID to be known for the redirection to work correctly.</p>
</div>
<div class="sect2">
<h3 id="_available_implementations"><a class="anchor" href="#_available_implementations"></a>35.1. Available Implementations</h3>
<div class="paragraph">
<p>Tigase implementation is, as usual, extensible and allows for different, pluggable redirection strategies that implement <em>SeeOtherHostIfc</em> interface.</p>
</div>
<div class="paragraph">
<p>Currently there are three strategies available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>SeeOtherHost</em> - most basic implementation returning either single host configured in init.properties file or name of the current host;</p>
</li>
<li>
<p><em>SeeOtherHostHashed</em> (default) - default implementation for cluster environment of SeeOtherHostIfc returning redirect host based on the hash value of the user&#8217;s JID; list of the available nodes from which selection would be made is by default composed and reflects all connected nodes, alternatively hosts list can be configured in the init.properties;</p>
</li>
<li>
<p><em>SeeOtherHostDB</em> - extended implementation of SeeOtherHost using redirect information from database in the form of pairs user_id and node_id to which given user should be redirected.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_options"><a class="anchor" href="#_configuration_options"></a>35.2. Configuration Options</h3>
<div class="paragraph">
<p>Most basic configuration is related to the choice of actual redirection implementation:</p>
</div>
<div class="paragraph">
<p>--cm-see-other-host=</p>
</div>
<div class="paragraph">
<p>Possible values are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tigase.server.xmppclient.SeeOtherHost</p>
</li>
<li>
<p>tigase.server.xmppclient.SeeOtherHostHashed</p>
</li>
<li>
<p>tigase.server.xmppclient.SeeOtherHostDB</p>
</li>
<li>
<p>none - disables redirection</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All the remaining options are configured on per-connection-manager basis thus all options need to be prefixed with corresponding connection manager ID, i.e. c2s, bosh or ws; we will use c2s in the examples:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>c2s/cm-see-other-host/default-host=host1;host2;host3 - a semicolon separated list of hosts to be used for redirection;</p>
</li>
<li>
<p>c2s/cm-see-other-host/active=OPEN;LOGIN</p>
<div class="paragraph">
<p>a semicolon separated list of phases in which redirection should be active;</p>
</div>
<div class="ulist">
<ul>
<li>
<p>currently possible values are:</p>
</li>
<li>
<p><em>OPEN</em> which enables redirection during opening of the XMPP stream;</p>
</li>
<li>
<p><em>LOGIN</em> which enables redirection upon authenticating user session;</p>
</li>
<li>
<p>by default redirection is currently enabled only in the <em>OPEN</em> phase.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For SeeOtherHostDB implementation there are additional options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>c2s/cm-see-other-host/db-url - a JDBC connection URI which should be used to query redirect information; if not configured --user-db-uri will be used;</p>
</li>
<li>
<p>c2s/cm-see-other-host/get-host-query - a SQL query which should return redirection hostname;</p>
</li>
<li>
<p>c2s/cm-see-other-host/get-all-data-query - a SQL helper query which should return all redirection data from database;</p>
</li>
<li>
<p>c2s/cm-see-other-host/get-all-query-timeout - allows to set timeout for executed queries.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_stanzasender"><a class="anchor" href="#_stanzasender"></a>36. StanzaSender</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>This is a component which make it easier to integrate Jabber/XMPP server with other, third-party tools.</p>
</div>
<div class="paragraph">
<p>It simply allows you to send stanzas from your application without implementing any Jabber/XMPP specific code. The component regularly reads specified data source for XMPP packets to send. The data source can be an SQL database, directory on your filesystem or anything you might want.</p>
</div>
<div class="paragraph">
<p>If you have Web application for example which you want to send notifications of any event to selected users you can install <a href="http://server.tigase.org/browser/trunk/src/main/java/tigase/server/ssender/StanzaSender.java">StanzaSender</a> component on your Tigase server. It will help you to easily distribute your messages to end-users.</p>
</div>
<div class="sect2">
<h3 id="_how_it_works"><a class="anchor" href="#_how_it_works"></a>36.1. How it Works</h3>
<div class="paragraph">
<p>The module itself doesn&#8217;t do anything. It just schedules tasks and sends stanzas which come from&#8230;&#8203; it doesn&#8217;t know. To do actual work of retrieving stanzas from data source the component uses <strong>tasks</strong>.</p>
</div>
<div class="paragraph">
<p>In theory the task can retrieve XMPP packets for sending from any location or may just generate stanzas on its own.</p>
</div>
<div class="paragraph">
<p>In practise there are 2 <strong>tasks</strong> already implemented and ready to use. You can treat them as a sample code for implementation of your own tasks customised for your specific needs or you can just use these tasks as they are.</p>
</div>
<div class="paragraph">
<p>The tasks which are available are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>FileTask retrieving stanzas from directory in file system.</p>
</li>
<li>
<p>JDBCTask retrieving stanzas from SQL database.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_filetask"><a class="anchor" href="#_filetask"></a>36.1.1. FileTask</h4>
<div class="paragraph">
<p>FileTask implements tasks for cyclic retrieving stanzas from a directory and sending them to the StanzaHandler object.</p>
</div>
<div class="paragraph">
<p>It looks for any new stanza to send. Any single file can contain only single stanza to send and any entry in database table can also contain only single stanza to send. File on hard disk and record in database is deleted after it is read.</p>
</div>
<div class="paragraph">
<p>Any file in given directory is treated the same way - Tigase assumes it contains valid XML data with XMPP stanza to send. You can however set in configuration, using wildchars which files contain stanzas. All stanzas must contain complete data including correct "<em>from</em>" and "<em>to</em>" attributes.</p>
</div>
<div class="paragraph">
<p>By default it looks for *.stanza files in /var/spool/jabber/ folder but you can specify different directory name in initialization string. Sample initialization strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>/var/spool/jabber/*.stanza</p>
</li>
<li>
<p>/var/spool/jabber/*</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The last is equal to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>/var/spool/jabber/</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note the last forward slash '/' is required in such case if the last element of the path is a directory.</p>
</div>
<div class="paragraph">
<p><strong>Please note! Tigase must have writing permissions for this directory, otherwise it may not function properly.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_jdbctask"><a class="anchor" href="#_jdbctask"></a>36.1.2. JDBCTask</h4>
<div class="paragraph">
<p>JDBCTask implements tasks for cyclic retrieving stanzas from database and sending them to the StanzaHandler object.</p>
</div>
<div class="paragraph">
<p>Database table format:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>id</strong> - numerical unique record indetifier.</p>
</li>
<li>
<p><strong>stanza</strong> - text field containing valid XML data with XMPP stanza to send.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Any record in this table is treated the same way - Tigase assmes it contains valid XML data with XMPP stanza to send. No other data are allowed in this table. All stanzas must be complete including correct "<em>from</em>" and "<em>to</em>" attriutes.</p>
</div>
<div class="paragraph">
<p>By default it looks for stanzas in xmpp_stanza table but you can specify different table name in connection string. Sample connection string:</p>
</div>
<div class="paragraph">
<p>jdbc:mysql://localhost/tigasedb?user=tigase&amp;password=pass&amp;table=xmpp_stanza</p>
</div>
<div class="paragraph">
<p>Please note the last parameter which is specific to JDBCTask. You can specify the table name which stores stanzas for sending. If omitted default value is: xmpp_stanza.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_2"><a class="anchor" href="#_configuration_2"></a>36.2. Configuration</h3>
<div class="paragraph">
<p>It is Tigase component so the configuration is similar to configuration of all other components. The simplest way to get the settings for <strong>StanzaSender</strong> is by generating configuration with all possible components. To do this you have to run Tigase server with --gen-config-all parameter set.</p>
</div>
<div class="paragraph">
<p>By default this component name is <strong>ssend</strong> and here is a content of the configuration file for <strong>StanzaSender</strong>:</p>
</div>
<div class="paragraph">
<p>It is one of msg-receivers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry type=&quot;String[]&quot; key=&quot;id-names&quot;&gt;
  ...
  &lt;item value=&quot;ssend&quot;/&gt;
&lt;/entry&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To activate the component and specify class name for it following entries has been added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;true&quot; type=&quot;Boolean&quot; key=&quot;ssend.active&quot;/&gt;
&lt;entry value=&quot;tigase.server.ssender.StanzaSender&quot; type=&quot;String&quot; key=&quot;ssend.class&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the main settings section for the component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;component name=&quot;ssend&quot;&gt;
  &lt;map&gt;
   &lt;entry value=&quot;10&quot; type=&quot;Long&quot; key=&quot;default-interval&quot;/&gt;
   &lt;entry value=&quot;1000&quot; type=&quot;Integer&quot; key=&quot;max-queue-size&quot;/&gt;
   &lt;entry type=&quot;String[]&quot; key=&quot;stanza-listeners&quot;&gt;
    &lt;item value=&quot;jdbc&quot;/&gt;
    &lt;item value=&quot;file&quot;/&gt;
   &lt;/entry&gt;
  &lt;/map&gt;
  &lt;node name=&quot;file&quot;&gt;
   &lt;map&gt;
    &lt;entry value=&quot;true&quot; type=&quot;Boolean&quot; key=&quot;active&quot;/&gt;
    &lt;entry value=&quot;tigase.server.ssender.FileTask&quot; type=&quot;String&quot; key=&quot;class-name&quot;/&gt;
    &lt;entry value=&quot;/var/spool/jabber/*.stanza&quot; type=&quot;String&quot; key=&quot;init-string&quot;/&gt;
    &lt;entry value=&quot;10&quot; type=&quot;Long&quot; key=&quot;interval&quot;/&gt;
   &lt;/map&gt;
  &lt;/node&gt;
  &lt;node name=&quot;jdbc&quot;&gt;
   &lt;map&gt;
    &lt;entry value=&quot;true&quot; type=&quot;Boolean&quot; key=&quot;active&quot;/&gt;
    &lt;entry value=&quot;tigase.server.ssender.JDBCTask&quot; type=&quot;String&quot; key=&quot;class-name&quot;/&gt;
    &lt;entry value=&quot;jdbc:mysql://localhost/tigase?user=tigase&amp;
        password=mypass&amp;table=xmpp_stanza&quot;
      type=&quot;String&quot; key=&quot;init-string&quot;/&gt;
    &lt;entry value=&quot;10&quot; type=&quot;Long&quot; key=&quot;interval&quot;/&gt;
   &lt;/map&gt;
  &lt;/node&gt;
 &lt;/component&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think most of parameters should be pretty clear but some may need a little explanation. General StanzaSender parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>default-interval</strong> number which specifies in seconds how often should the task look in data source for new packets to send.</p>
</li>
<li>
<p><strong>max-queue-size</strong> is a number which specifies internal packets queue size. This is used to prevent the component from consume all the memory for data in case the component can not process them.</p>
</li>
<li>
<p><strong>stanza-listeners</strong> is a list of task names to load. Each task can read XMPP packets to send from different data source. You can load as many listeners (tasks) as you need. Each task must read stanzas from different data source.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each task has own, separate parameters list. For each task from the stanza-listeners list there is a separate section with parameters for each task:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>active</strong> boolean switch allowing you to turn on/off the task without removing configuration completely.</p>
</li>
<li>
<p><strong>class-name</strong> Java class name which implements the task. This class must extend tigase.server.ssender.SenderTask and it is loaded at runtime.</p>
</li>
<li>
<p><strong>init-string</strong> is kind of data source connection string. For database it is just database connection string, for file system this is just a directory name. It may be even different for different tasks. The 2 tasks already implemented have some specific features: FileTask allows you to use wild-chars in directory/ file name specification and JDBCTask allows you to specify additional parameter at the end of JDBC connection string - database table name. For specific examples look at above config sections.</p>
</li>
<li>
<p><strong>interval</strong> is a number which allows you to specify different interval in seconds for checking data source for each task.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_debuging_tigase"><a class="anchor" href="#_debuging_tigase"></a>37. Debuging Tigase</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>If something goes wrong and you can&#8217;t find out why it is not working as you expect you might want more detailed debugging options switched on.</p>
</div>
<div class="paragraph">
<p>Tigase is a Java application and it uses Java logging library this gives you flexibility to switch logging on for selected java package or even for a single Java class.</p>
</div>
<div class="paragraph">
<p>Logs files are stored in logs/ directory. tigase-console.log keeps all the data but only basic logs. tigase.log.N files keep all the detailed logging entries. So this is the place where you should look in case of problems.</p>
</div>
<div class="sect2">
<h3 id="_the_easy_way_init_properties_file"><a class="anchor" href="#_the_easy_way_init_properties_file"></a>37.1. The easy way - init.properties file</h3>
<div class="paragraph">
<p>The easiest way to change logging for the Tigase package is modifying in init.properies following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--debug=server</code></pre>
</div>
</div>
<div class="paragraph">
<p>The line above says: "<em>Switch on ALL debug messages for packet: tigase.server</em>". The tigase.server packet keeps all component&#8217;s classes. So it allows you to monitor what is going on in each component. What packets it receives and what it is sending out.</p>
</div>
<div class="paragraph">
<p>Usually people want to see what is going on the network level. That is what has been sent and what has been received by the server - the actual character data. The class which would print all received and sent character data is: tigase.xmpp.XMPPIOService. To enable all debugging info for this class you have to modify the debug line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--debug=xmpp.XMPPIOService</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note, you skip the tigase. part.</em></p>
</div>
<div class="paragraph">
<p>You can also have debugging switched on for many packages/classes at the same time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--debug=server,xmpp.XMPPIOService</code></pre>
</div>
</div>
<div class="paragraph">
<p>Other packages you might be interested in are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tiagse.io and tigase.net which can print out what is going on a very low level network level including TLS/SSL stuff.</p>
</li>
<li>
<p>tigase.xml would print the XML parser debugging data.</p>
</li>
<li>
<p>tigase.cluster would print all the clustering related stuff. So if you have clustered installation you might be interested in debug settings:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--debug=server,cluster</code></pre>
</div>
</div>
</li>
<li>
<p>tigase.xmpp.impl would print logs from all plugins loaded to the Tigase server.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and so on&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>This method, however has 2 main disadvantages:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You have to remove your XML config file and regenerate it which might be inconvenient. (only applicable to versions before 5.0.0)</p>
</li>
<li>
<p>You can&#8217;t set logging this way for classes and packages other than tigase. package. And this might be a problem if you include your own code in and load it into the server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To enable logging for your own packages from packages different than tigase. you have to use another option which has been made available for this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--debug-packages = your.com.package</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also specify more parameters for the Tigase logging mechanisms like the file size, number of file rotated and location where all Tigase logs are stored. You have to include following lines in the init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">basic-conf/logging/java.util.logging.FileHandler.limit=100000000
basic-conf/logging/java.util.logging.FileHandler.count=20
basic-conf/logging/java.util.logging.FileHandler.pattern=/var/log/tigase/tigase.log</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_more_difficult_but_more_powerful_tigase_xml_file_only_applicable_to_versions_before_5_0_0"><a class="anchor" href="#_the_more_difficult_but_more_powerful_tigase_xml_file_only_applicable_to_versions_before_5_0_0"></a>37.2. The more difficult but more powerful - tigase.xml file (only applicable to versions before 5.0.0)</h3>
<div class="paragraph">
<p>If you want to modify debugging settings without regenerating the whole XML config file you can modify it yourself manually and add debug entries. This must be done very carefully or you break the XML file and configuration won&#8217;t work.</p>
</div>
<div class="paragraph">
<p>Anyway. Open the XML config file with some good text editor (or XML editor) and find the line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;node name=&quot;logging&quot;&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Below is a long list of all logging settings. One of them is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;INFO&quot; type=&quot;String&quot; key=&quot;.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which says: INFO debug level for all the code. This level gives you very little debugging information. Therefore for example your init.properties line --debug=server adds one extra line in there:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;ALL&quot; type=&quot;String&quot; key=&quot;tigase.server.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I think now everything should be clear. You need to add a similar line changing only "key" attribute. If you need to switch logging on for a specific class - tigase.xmpp.XMPPIOService for example, add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;entry value=&quot;ALL&quot; type=&quot;String&quot; key=&quot;tigase.xmpp.XMPPIOService.level&quot;/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also put there your own package or class name. After you changed the config file you have to restart the server.</p>
</div>
<div class="paragraph">
<p><em>Note, don&#8217;t overdose the debugging or your logs are full of trash you can read.</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_importing_user_data"><a class="anchor" href="#_importing_user_data"></a>38. Importing User Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>You can easily copy data between Tigase compatible repositories that is repositories for which there is a database connector. It is not that easy however to import data from an external source. Therefore a simple data import functionality has been added to repository utilities package.</p>
</div>
<div class="paragraph">
<p>You can access repository utilities through command ./bin/repo.sh or ./scripts/repo.sh depending on whether you use binary package or source distribution.</p>
</div>
<div class="paragraph">
<p>-h parameter gives you a list of all possible parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/repo.sh -h

Parameters:
 -h          this help message
 -sc class   source repository class name
 -su uri     source repository init string
 -dc class   destination repository class name
 -du uri     destination repository init string
 -dt string  data content to set/remove in repository
 -u user     user ID, if given all operations are only for that ID
             if you want to add user to AuthRepository parameter must
             in form: &quot;user:password&quot;
 -st         perform simple test on repository
 -at         simple test for adding and removing user
 -cp         copy content from source to destination repository
 -pr         print content of the repository
 -n          data content string is a node string
 -kv         data content string is node/key=value string
 -add        add data content to repository
 -del        delete data content from repository
 ------------
 -roster     check the user roster
 -aeg [true|false]  Allow empty group list for the contact
 -import file  import user data from the file of following format:
         user_jid, password, roser_jid, roster_nick, subscription, group



Note! If you put UserAuthRepository implementation as a class name
      some operation are not allowed and will be silently skipped.
      Have a look at UserAuthRepository to see what operations are
      possible or what operation does make sense.
      Alternatively look for admin tools guide on web site.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The most critical parameters are source repository class name and initialization string. Therefore there are a few example, preset parameters which you can use an example and adjust for your system. If you look inside the repo.sh script you can find at the end of the script following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">XML_REP=&quot;-sc tigase.db.xml.XMLRepository -su ../testsuite/user-repository.xml_200k_backup&quot;
MYSQL_REP=&quot;-sc tigase.db.jdbc.JDBCRepository -su jdbc:mysql://localhost/tigase?user=root&amp;password=mypass&quot;
PGSQL_REP=&quot;-sc tigase.db.jdbc.JDBCRepository -su jdbc:postgresql://localhost/tigase?user=tigase&quot;

java $D -cp $CP tigase.util.RepositoryUtils $MYSQL_REP $*</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that the source repository has been set to MySQL database with tigase as the database name, root the database user and mypass the user password.</p>
</div>
<div class="paragraph">
<p>You can adjust these settings for your system.</p>
</div>
<div class="paragraph">
<p>Now to import data to your repository simply execute the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/repo.sh -import import-file.txt</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note, the import function is available from</em> <strong>b895</strong></p>
</div>
<div class="paragraph">
<p>The format of the import file is very simple. This is a flat file with comma separated values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">jid,password,roster_jid,roster_nick,subscriptio,group</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create such a file from MySQL database you have to execute command like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> a, b, c, d <span class="class">INTO</span> OUTFILE <span class="string"><span class="delimiter">'</span><span class="content">import-file.txt</span><span class="delimiter">'</span></span>
<span class="type">FIELDS</span> TERMINATED <span class="keyword">BY</span> <span class="string"><span class="delimiter">'</span><span class="content">,</span><span class="delimiter">'</span></span>
LINES TERMINATED <span class="keyword">BY</span> <span class="string"><span class="delimiter">'</span><span class="char">\n</span><span class="delimiter">'</span></span>
<span class="keyword">FROM</span> test_table;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_drupal_authentication_added"><a class="anchor" href="#_drupal_authentication_added"></a>39. Drupal Authentication Added</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Well it is authentication against <strong>Drupal</strong> database at the moment. So it is not full integration with <strong>Drupal</strong> yet.</p>
</div>
<div class="paragraph">
<p>As <strong>Drupal</strong> keeps encrypted passwords in database the only possible authorization protocols are those based on PLAIN passwords.</p>
</div>
<div class="paragraph">
<p>To protect your passwords <strong>Tigase</strong> server must be used with SSL or TLS encryption.</p>
</div>
<div class="paragraph">
<p>Implementation of <strong>Drupal</strong> database based authorization is located in tigase.db.jdbc.DrupalAuth class. Although this class is capable of adding new user to the repository I recommend to switch in-band registration off due to the caching problems in <strong>Drupal.</strong> Changes in database are not synchronized with <strong>Drupal</strong> yet. Function for adding new users is implemented only to ease user accounts migration from different repository type from earlier <strong>Tigase</strong> server installation.</p>
</div>
<div class="paragraph">
<p>The idea of that implementation was to allow all accounts administration tasks from <strong>Drupal</strong> like: account creation, all accounts settings, like e-mail, full name, password changes and so on.</p>
</div>
<div class="paragraph">
<p><strong>Tigase</strong> server uses following fields from <strong>Drupal</strong> database: name (user account name), pass (user account password), status (status of the account). Server picks up all changes instantly. If user status is not 1 then server won&#8217;t allow user to login trough Jabber/XMPP even if user provides valid password.</p>
</div>
<div class="paragraph">
<p>There is no <em>Roster</em> management in <strong>Drupal</strong> yet. So Roster management have to be done from Jabber/XMPP client.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_services"><a class="anchor" href="#_tigase_services"></a>40. Tigase Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-08-23 20:49</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;addManageDomain,////Add and Manage Domain</p>
</li>
<li>
<p>////&lt;&lt;presenceForwarding,////Presence Forwarding</p>
</li>
<li>
<p>////&lt;&lt;registerXMPP,////Register Own XMPP Domain</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_add_and_manage_domain"><a class="anchor" href="#_add_and_manage_domain"></a>41. Add and Manage Domain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-08-23 21:13</p>
</div>
<div class="paragraph">
<p>For everybody interested in using our service to host own XMPP domain I have good news. You do not have to ask administrator to add your domain or add users for your domain anymore. You can do it on your own.</p>
</div>
<div class="paragraph">
<p>Please note, this is very new stuff. Something may go wrong or may not be polished. Please report any problems, notices or suggestions.</p>
</div>
<div class="paragraph">
<p>This is the guide to walk you through new functions and describes how to add a new domain and new users within your domain.</p>
</div>
<div class="paragraph">
<p>You can do all the stuff from your XMPP client or you can use our WebApplication that allows you to connect to the service and execute admin commands. I recommend <a href="http://psi-im.org/">Psi</a> because of its excellent support for parts of the XMPP protocol which are used for domains and users management. You may use any other client as well, there is no limitation but I can only offer support and help if you use Psi client.</p>
</div>
<div class="paragraph">
<p>Secondly, you need an account on the server. This is because all the commands and features described here are available to local users only. Therefore, if you do not have a registered domain with us yet, please go ahead and register an account on the website either the <a href="http://jabber.me/">Jabber.Me</a> or <a href="http://www.tigase.im/">Tigase.IM</a>.</p>
</div>
<div class="sect2">
<h3 id="_adding_a_new_domain"><a class="anchor" href="#_adding_a_new_domain"></a>41.1. Adding a New Domain</h3>
<div class="paragraph">
<p>Once you register an account on one of the websites connect to the XMPP server using the account on the Psi client. I have an example, nice account: <a href="mailto:green@tigase.im">green@tigase.im</a> which is used for this guide.</p>
</div>
<div class="paragraph">
<p>When you are ready right click on the account name in Psi roster window to bring up context menu. Select <strong>Service Discovery</strong> element.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service_disco_menu.png" alt="service_disco_menu"></span></p>
</div>
<div class="paragraph">
<p>A new windows pops up as in the example on the right. Service discovery window is where all the stuff installed on XMPP service should show up. Most of elements on the list are well known transports, MUC and PubSub components. The new stuff on the list, which is interesting for us now, are 2 elements: <strong>VHost Manager</strong> and <strong>Session Manager</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service_disco_window_vhost.png" alt="service_disco_window_vhost"></span></p>
</div>
<div class="paragraph">
<p><strong>VHost Manager</strong> component in the Tigase is responsible for managing and controlling virtual hosts on the installation. It provides virtual hosts information to all other parts of the system and also allows you to add new hosts and remove/update existing virtual hosts.</p>
</div>
<div class="paragraph">
<p><strong>Session Manager</strong> component in the Tigase is responsible for managing users. In most cases online users but it can also perform some actions on user repository where all user data is stored.</p>
</div>
<div class="paragraph">
<p>Select <strong>VHost Manager</strong> and double click on it. A new windows shows up (might be hidden behind the service discovery window). The window contains another menu with a few items: <strong>Add&#8230;&#8203;, Remove&#8230;&#8203;</strong> and <strong>Update&#8230;&#8203;</strong> . These are for adding, removing and updating VHost information. For now, just select the first element <strong>Add&#8230;&#8203;.</strong></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/command_menu_add_vhost.png" alt="command_menu_add_vhost"></span></p>
</div>
<div class="paragraph">
<p>Press <strong>Execute</strong> and you get a new window where you can enter all of your VHost configuration details. I think all the fields are pretty much self explanatory. Leave blank field for <strong>Other parameters</strong> for now. <strong>Owner</strong> is you, that is Jabber ID which controls the domain and can change the domain configuration settings or can remove the domain from the service. <strong>Administrators</strong> field can be left blank or can contain comma separated list of Jabber IDs for people who can manage users within the domain. Of course the owner can always manage users for his domain too.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/add_vhost_window.png" alt="add_vhost_window"></span></p>
</div>
<div class="paragraph">
<p>When you are ready press <strong>Finish</strong> button. All done, hopefully. You can get either a window confirming everything went well or a window printing an error message if something went wrong. What can be wrong? There are some restrictions I decided to put on the service to prevent abuse. One of the restrictions is the maximum number of domains a user can register for himself which is <strong>25</strong> right now. Another restriction is that the domain which you add must have a valid DNS entry pointing to our service. The ////<a id="addXMPP"></a>//// add XMPP guide describes all the details about DNS settings. Please refer to these instructions if you need more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_new_user"><a class="anchor" href="#_adding_a_new_user"></a>41.2. Adding a New User</h3>
<div class="paragraph">
<p>Adding a new user process is quite similar, almost identical to adding a new domain. This time, however we have to select <strong>Session Manager</strong> in the service discovery window.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/service_disco_window_sm.png" alt="service_disco_window_sm"></span></p>
</div>
<div class="paragraph">
<p>Double click on the <strong>Session Manager</strong> and a window with SM&#8217;s commands list shows up. Right now, there is only one command available to domain administrators - <strong>Add user</strong>. I am going to make available more commands in the future and I am waiting for your suggestions.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/command_menu_add_user.png" alt="command_menu_add_user"></span></p>
</div>
<div class="paragraph">
<p>If you press <strong>Execute</strong> a window presented on the left shows up. Fill all fields accordingly and press <strong>Finish</strong>.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/add_user_window.png" alt="add_user_window"></span></p>
</div>
<div class="paragraph">
<p>If everything went well you have just added a new user and you should get a window confirming successful operation. If something was wrong a window with an error message should show up. What can be wrong? You may try to add a user which is already added, you may try to add a user for a domain to which you do not have permission or to non-existen domain. I hope nothing more.</p>
</div>
</div>
<div class="sect2">
<h3 id="_what_else"><a class="anchor" href="#_what_else"></a>41.3. What Else?</h3>
<div class="paragraph">
<p>Well, there are plans, very close plans, to add SSL certificates management for your domains. I want to also add more user administration commands but for this I am waiting for your suggestions. You are users, you tell me what you want.</p>
</div>
<div class="paragraph">
<p>One more thing.</p>
</div>
<div class="paragraph">
<p>There is quite a few domains already registered by an administrator for people who asked for it using website form. These people cannot control their domains right now. Everybody who is interested in taking control over his domain, please send me an e-mail with his domain details and account for which the ownership should be granted and I will update domain configuration. To make sure the correct person asks for this I require you to send the request as a response to the e-mail I sent you after the domain has been registered in our service.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_presence_forwarding"><a class="anchor" href="#_presence_forwarding"></a>42. Presence Forwarding</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-08-23 21:52</p>
</div>
<div class="paragraph">
<p>Have you ever thought of displaying your users presence status on the website? Or, maybe, you wanted to integrate XMPP service with your own system and share not only users' accounts but also presence status?</p>
</div>
<div class="paragraph">
<p>Now it is possible with Tigase. Well, not only possible but also very simple. You have a new option in the domain control form.</p>
</div>
<div class="paragraph">
<p>Actually there are 2 new options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Presence forward address</p>
</li>
<li>
<p>Message forward address - not fully implemented yet</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Presence forward address can be any XMPP address. Usually you want it to be your bot address which can collect your users' presence information. Once this option is set to a valid XMPP address the Tigase forwards user&#8217;s presence, every time the user changes his status. The presence is processed normally, of course, and distributed to all people from the contact list (roster), plus to this special address. It can be a component or a bot. If this is a bot connecting to a regular XMPP account, <strong>Make sure the presence forward address contains resource part and the bot is connecting with this resource.</strong> Otherwise the presence won&#8217;t be delivered to the bot.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/vhost-presence-forward.png" alt="vhost-presence-forward"></span></p>
</div>
<div class="paragraph">
<p>As the screenshot shows, there are new input lines with option for presence forwarding address and message forwarding address. As you can see this option can be specified separately for each domain, so you can have a different forward address for each domain.</p>
</div>
<div class="paragraph">
<p>If you have your own Tigase installation, the forwarding address can be also set globally and can be the same for all domains. However, for this website, we offer this feature to all our users who have own domains and this can be set on per-domain basis.</p>
</div>
<div class="paragraph">
<p>Now, the big question. How this can be used? I am attaching below an example code. With just a few lines of code you can connect a command line bot to the server as a client which would collect all presences from users. Code below is a simple Groovy script which receives presence packet and displays them on the console. However, it should be easy enough to store users' presence information in a database and then load it from a web application.</p>
</div>
<div class="paragraph">
<p>The bot/client uses our <a href="https://projects.tigase.org/projects/jaxmpp2">JaXMPP2</a> library which is available form our project management system.</p>
</div>
<div class="paragraph">
<p>You should be able to find a few more code examples on the wiki page.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">jaxmppexample</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.BareJID</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.SessionObject</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.exceptions.JaxmppException</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.observer.Listener</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.xmpp.modules.presence.PresenceModule</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.core.client.xmpp.modules.presence.PresenceModule.PresenceEvent</span>
<span class="namespace">import</span> <span class="namespace">tigase.jaxmpp.j2se.Jaxmpp</span>

<span class="namespace">final</span> <span class="namespace">Jaxmpp</span> <span class="namespace">jaxmpp</span> = <span class="namespace">new</span> <span class="namespace">Jaxmpp</span>()
<span class="namespace">jaxmpp.getProperties</span>().<span class="namespace">setUserProperty</span>( <span class="namespace">SessionObject.USER_BARE_JID</span>,
  <span class="namespace">BareJID.bareJIDInstance</span>( <span class="string"><span class="delimiter">&quot;</span><span class="content">test4@test.tigase.org</span><span class="delimiter">&quot;</span></span> ) )
<span class="namespace">jaxmpp.getProperties</span>().<span class="namespace">setUserProperty</span>(<span class="namespace">SessionObject.RESOURCE</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">presence-collector</span><span class="delimiter">&quot;</span></span>)
<span class="namespace">jaxmpp.getProperties</span>().<span class="namespace">setUserProperty</span>( <span class="namespace">SessionObject.PASSWORD</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">pass</span><span class="delimiter">&quot;</span></span> )
<span class="namespace">jaxmpp.getModulesManager</span>().<span class="namespace">getModule</span>( <span class="namespace">PresenceModule.class</span> ).<span class="namespace">addListener</span>(
  <span class="namespace">PresenceModule.ContactChangedPresence</span>,  <span class="namespace">new</span> <span class="namespace">Listener</span>() {
    <span class="namespace">public</span> <span class="namespace">void</span> <span class="namespace">handleEvent</span>( <span class="namespace">PresenceEvent</span> <span class="namespace">be</span> ) {
      <span class="namespace">def</span> <span class="namespace">msg</span> = (<span class="namespace">be.getStatus</span>() != <span class="namespace">null</span>) ? <span class="namespace">be.getStatus</span>() : <span class="string"><span class="delimiter">&quot;</span><span class="content">none</span><span class="delimiter">&quot;</span></span>
      <span class="namespace">println</span>( <span class="string"><span class="delimiter">&quot;</span><span class="content">Presence received:</span><span class="char">\t</span><span class="delimiter">&quot;</span></span> + <span class="namespace">be.getJid</span>() + <span class="string"><span class="delimiter">&quot;</span><span class="content"> is now </span><span class="delimiter">&quot;</span></span> + <span class="namespace">be.getShow</span>() +
        <span class="string"><span class="delimiter">&quot;</span><span class="content"> (</span><span class="delimiter">&quot;</span></span> + <span class="namespace">msg</span> + <span class="string"><span class="delimiter">&quot;</span><span class="content">)</span><span class="delimiter">&quot;</span></span> )
    }
  }
)
<span class="namespace">println</span>( <span class="string"><span class="delimiter">&quot;</span><span class="content">Loging in...</span><span class="delimiter">&quot;</span></span> )
<span class="namespace">jaxmpp.login</span>()
<span class="namespace">println</span>( <span class="string"><span class="delimiter">&quot;</span><span class="content">Waiting for the presence for 10 minutes</span><span class="delimiter">&quot;</span></span> )
<span class="namespace">Thread.sleep</span>( <span class="integer">10</span> * <span class="integer">60</span> * <span class="integer">1000</span> )
<span class="namespace">disconnect</span>()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_register_own_xmpp_domain"><a class="anchor" href="#_register_own_xmpp_domain"></a>43. Register Own XMPP Domain</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-08-23 21:05</p>
</div>
<div class="paragraph">
<p>You can have XMPP service running for your own domain. The only condition right now is that this must be a DNS registered domain and DNS must point to the following DNS address: <strong>tigase.me</strong>. Please note, do not confuse it with tigase.im domain name.</p>
</div>
<div class="paragraph">
<p>We recommend to use SRV records as this is required by XMPP specification but as some DNS services do not allow for SRV records yet we do not require SRV records either. If you want to register: <strong>your-domain.tld</strong> on our XMPP service make sure that either the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ host your-domain.tld
your-domain.tld has address 94.23.164.209</code></pre>
</div>
</div>
<div class="paragraph">
<p>displays <strong>94.23.164.209</strong> address or commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ host -t SRV _xmpp-server._tcp.your-domain.tld
_xmpp-server._tcp.your-domain.tld has SRV record 10 0 5269 tigase.me.
$ host -t SRV _xmpp-client._tcp.your-domain.tld
_xmpp-client._tcp.your-domain.tld has SRV record 10 0 5222 tigase.me.</code></pre>
</div>
</div>
<div class="paragraph">
<p>display <strong>tigase.me</strong> DNS name. We strongly recommend not to use the IP address directly however, as if the service grows too much, it will be much easier for us to migrate, expand it using the DNS name rather then IP address.</p>
</div>
<div class="paragraph">
<p>If you want to have MUC and PubSub available under your domain, you have to setup DNS for <strong>muc.your-domain.tld</strong> and <strong>pubsub.your-domain.tld</strong> domains too.</p>
</div>
<div class="paragraph">
<p>For MUC:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ host -t SRV _xmpp-server._tcp.muc.your-domain.tld
_xmpp-server._tcp.muc.your-domain.tld has SRV record 10 0 5269 tigase.me.
$ host -t SRV _xmpp-client._tcp.muc.your-domain.tld
_xmpp-client._tcp.muc.your-domain.tld has SRV record 10 0 5222 tigase.me.</code></pre>
</div>
</div>
<div class="paragraph">
<p>For PubSub :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ host -t SRV _xmpp-server._tcp.pubsub.your-domain.tld
_xmpp-server._tcp.pubsub.your-domain.tld has SRV record 10 0 5269 tigase.me.
$ host -t SRV _xmpp-client._tcp.pubsub.your-domain.tld
_xmpp-client._tcp.pubsub.your-domain.tld has SRV record 10 0 5222 tigase.me.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, how do you register your domain with our service?</p>
</div>
<div class="paragraph">
<p>There are a few ways. I recommend to look at this guide describing how to add and manage your domain on your own. If you cannot or don&#8217;t want to do it on your own, the way described in the guide please send us a message, either via XMPP to <a href="mailto:admin@tigase.im">admin@tigase.im</a> or the contact form requesting new domain. User registration is available via in-band registration protocol. You can also specify whether you want to allow anonymous authentication to be available for your domain and you can specify maximum number of users for your domain.</p>
</div>
<div class="paragraph">
<p>Any comments or suggestions are very welcomed.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_monitoring"><a class="anchor" href="#_server_monitoring"></a>44. Server Monitoring</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All the documentation and resources related to the Tigase server monitoring.</p>
</div>
<div class="sect2">
<h3 id="setUpRemoteMonitoring"><a class="anchor" href="#setUpRemoteMonitoring"></a>44.1. Setting Up Remote Monitoring in the Server</h3>
<div class="paragraph">
<p>The Tigase server can be remotely monitored over following protocols: <strong>JMX/RMI</strong>, <strong>SNMP</strong> and <strong>HTTP</strong>. Even though JMX offers the biggest control and visibility to the server states all of the monitoring services give the same basic set of the server statistics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Number of network connections for s2s, c2s and Bosh</p>
</li>
<li>
<p>Last second, last minute and last hour load for all main components: SM, MR, c2s, s2s, Bosh, MUC and PubSub</p>
</li>
<li>
<p>System statistics - memory usage (heap and non heap) and the server uptime in milliseconds and human readable text.</p>
</li>
<li>
<p>Users statistics - number of registered users and number of online user session.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JMX/RMI and SNMP servers offer basic security and can restrict access based and the HTTP server doesn&#8217;t offer any access restriction mechanisms. Therefore HTTP monitoring is recommended to work behind a firewall.</p>
</div>
<div class="paragraph">
<p>The monitoring itself causes very low overhead in terms of the resources and CPU consumption on top of the normal Tigase processing requirements so it can be left always on without worrying about performance degradation.</p>
</div>
<div class="paragraph">
<p><strong>Note.</strong> <em>This works with the Tigase server from version</em> <strong>4.2.0</strong> <em>or SVN revision</em> <strong>1418</strong>.</p>
</div>
<div class="sect3">
<h4 id="_what_you_need"><a class="anchor" href="#_what_you_need"></a>44.1.1. What You Need.</h4>
<div class="paragraph">
<p>If you use binary build for version 4.2.0 or later you can skip this section as all required libraries are included in the installation package: Extras pack. Please install the pack and you don&#8217;t have to worry about libraries any more.</p>
</div>
<div class="paragraph">
<p>If you run the server from sources or SVN continue reading:</p>
</div>
<div class="paragraph">
<p>The remote monitoring requires an external library therefore it is implemented in the tigase-extras package to comply with the basic rule - no third-party libraries are needed for the core Tigase server. But still what you need for the remote monitoring activation is just 2 jar files:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://www.tigase.org/project/extras">tigase-extras</a> the last <a href="http://maven.tigase.org/tigase/tigase-extras/0.3.0-SNAPSHOT/tigase-extras-0.3.0-20090110.223424-2.jar">0.3.0-SNAPSHOT</a> or later</p>
</li>
<li>
<p><strong>jdmkrt.jar</strong> file from <a href="https://opendmk.dev.java.net/">OpenDMK</a> project version 5.1 or later. A copy of this jar file in also available in our maven repository: <a href="http://maven.tigase.org/openDMK/jdmkrt/1.0-b02/jdmkrt-1.0-b02.jar">jdmkrt.jar</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Download both libraries and put them in the libs/ directory.</p>
</div>
</div>
<div class="sect3">
<h4 id="monitoring_activation"><a class="anchor" href="#monitoring_activation"></a>44.1.2. Activation</h4>
<div class="paragraph">
<p>You can either run the Tigase installer and use configuration wizard to activate the monitoring or edit etc/init.properties file and add following line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--monitoring=jmx:9050,http:9080,snmp:9060</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you see there is only a single line where you put list of monitoring servers you want to activate. Each server is responsible for activation of a different protocol and takes a single parameter - port number. There are following protocols supported right now:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>jmx</strong> - activating monitoring via JMX/RMI</p>
</li>
<li>
<p><strong>http</strong> - activating monitoring over HTTP protocol</p>
</li>
<li>
<p><strong>snmp</strong> - activating monitoring over SNMP protocol</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can have all protocols active at the same time or any combination of them or none.</p>
</div>
</div>
<div class="sect3">
<h4 id="_security_2"><a class="anchor" href="#_security_2"></a>44.1.3. Security</h4>
<div class="paragraph">
<p>Both JMX and SNMP offer security protection to limit access to monitoring data. The security configuration is a bit different for both.</p>
</div>
<div class="sect4">
<h5 id="monitoring_jmx"><a class="anchor" href="#monitoring_jmx"></a>JMX</h5>
<div class="paragraph">
<p>After the server installation or in the SVN repository you can find 2 files in the <strong>etc/</strong> directory: <strong>jmx.access</strong> and <strong>jmx.password</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>jmx.access</strong> is a user permission file. You can use it to specify whether the user can access the monitoring data for reading only 'readonly' or with read-write 'readwrite' access. There are example entries in the file already and the content may simply look like:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">monitor readonly
admin readwrite</code></pre>
</div>
</div>
</li>
<li>
<p><strong>jmx.password</strong> is a user password file. You can set user passwords here and the format again is very simple and the same as for jmx.access. There are example entries already provided for you convenience. Content of the file may look like the example below:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">admin admin_pass
monitor monitor_pass</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using above to files you can control who and how can access the JMX monitoring services.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_snmp"><a class="anchor" href="#_snmp"></a>44.1.4. SNMP</h4>
<div class="paragraph">
<p>Access to the SNMP monitoring is controlled using ACL (access control lists) which can be configured in the file  <strong>snmp.acl</strong> located in <strong>etc/</strong> directory. It contains lots of detailed instructions how to setup ACL and restrict access per user, host and what kind access is allowed. The simplest possible configuration may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">acl = {
  {
    communities = public, private
    access = read-only
    managers = public.host.com, private.host.com
  }
  {
    communities = admin
    access = read-write
    managers = localhost, admin.host.com
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might also need Tigase MIB definition: <a href="https://svn.tigase.org/reps/tigase-extras/trunk/src/main/resources/mib/TIGASE-MANAGEMENT-MIB.mib">TIGASE-MANAGEMENT-MIB.mib</a> for the server specific statistics. The MIB contains definition for all the server statistics exposed via SNMP.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="RetrievingStatisticsFromTheServer"><a class="anchor" href="#RetrievingStatisticsFromTheServer"></a>44.2. Retrieving statistics from the server</h3>
<div class="paragraph">
<p>By default we can retrieve server statistics using XMPP. After a successful setup of <a href="#setUpRemoteMonitoring">Setting Up Remote Monitoring in the Server</a> we can enable additional@@, configured methods (JMX, HTTP, etc).</p>
</div>
<div class="sect3">
<h4 id="_retrieving_statistics_using_xmpp"><a class="anchor" href="#_retrieving_statistics_using_xmpp"></a>44.2.1. Retrieving statistics using XMPP</h4>
<div class="paragraph">
<p>Accessing statistics over XMPP protocol requires any XMPP client capable of executing <a href="http://xmpp.org/extensions/xep-0050.html">XEP-0050: Ad-Hoc Commands</a>. It&#8217;s essential to remember, that only administrator (a user whose JID is configured as administrative) can access the statistics.</p>
</div>
<div class="sect4">
<h5 id="_psi_xmpp_client"><a class="anchor" href="#_psi_xmpp_client"></a>Psi XMPP Client</h5>
<div class="paragraph">
<p>For the purpose of this guide a <a href="http://psi-im.org/">Psi</a> client will be used. After successfully configuring and connecting to account with administrative privileges we need to access <em>Service Discovery</em>, either from application menu or from context menu of the particular account account:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_xmpp_1.png" alt="roster-discovery" width="233">
</div>
<div class="title">Figure 1: Access service discovery</div>
</div>
<div class="paragraph">
<p>In the <em>Service Discovery</em> window we need to find <em>Server Statistics</em> component:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_xmpp_2.png" alt="discovery-stats" width="558">
</div>
<div class="title">Figure 2: Access statistics component in service discovery</div>
</div>
<div class="paragraph">
<p>We can either access statistics for all components or select particular component after expanding the tree. To execute ad-hoc command simply double click on the particular node which will open window with statistics:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_xmpp_3.png" alt="server-stats" width="456">
</div>
<div class="title">Figure 3: Server statistics</div>
</div>
<div class="paragraph">
<p>In this window, in addition to see the statistics, we can adjust <em>Stats level</em> by selecting desired level from the list and confiming by presing <em>Finish</em>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_retrieving_statistics_using_jmx"><a class="anchor" href="#_retrieving_statistics_using_jmx"></a>44.2.2. Retrieving statistics using JMX</h4>
<div class="paragraph">
<p>In order to access statistics over JMX we need to enable support for it in Tigase - <a href="#monitoring_activation">Activation</a>. Afterwards we can use a number of tools, for example following:</p>
</div>
<div class="sect4">
<h5 id="_jconsole"><a class="anchor" href="#_jconsole"></a>JConsole</h5>
<div class="paragraph">
<p>After opening JConsole we either select local process or provide details of the remote process, including IP, port and credentials from <strong>etc/jmx.</strong>* files:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_jmx_jconsole_1.png" alt="jconsole" width="754">
</div>
</div>
<div class="paragraph">
<p>Afterwards we navigate to MBeans tab from where we can access <code>tigase.stats</code> MBean. It offers similar options to XMPP - either accessing statistics for all components or only for particular component as well as adjusting level for which we want to obtain statistics:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_jmx_jconsole_2.png" alt="jconsole" width="967">
</div>
</div>
</div>
<div class="sect4">
<h5 id="_statsdumper_groovy"><a class="anchor" href="#_statsdumper_groovy"></a>StatsDumper.groovy</h5>
<div class="paragraph">
<p>In order to collect statistics over period of time following groovy script can be used: <a href="files/StatsDumper.groovy">StatsDumper.groovy</a>. It&#8217;s a Simple JMX client that connects to Tigase and periodically save all statistics to files.</p>
</div>
<div class="paragraph">
<p>It takes following parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">$ groovy StatsDumper.groovy [hostname] [username] [password] [dir] [port] [delay(ms)] [interval(ms)] [loadhistory(bool)]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>hostname - address of the instance</p>
</li>
<li>
<p>username - JMX username</p>
</li>
<li>
<p>password - JMX username</p>
</li>
<li>
<p>dir - directory to which save the files with statistics</p>
</li>
<li>
<p>port - port on which to make the connection</p>
</li>
<li>
<p>delay(ms) - initial delay in milliseconds after which statistics should be saved</p>
</li>
<li>
<p>interval(ms) - interval between each retrieval/saving of statistics</p>
</li>
<li>
<p>loadhistory(bool) - indicates whether or not load statistics history from server (if such is enabled in Tigase)</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="TipsAndTricks"><a class="anchor" href="#TipsAndTricks"></a>45. Tips and Tricks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The section contains some short trick and tips helping in different kind of issues related to the server administration and maintenance.</p>
</div>
<div class="sect2">
<h3 id="_tigase_tip_checking_the_runtime_environment"><a class="anchor" href="#_tigase_tip_checking_the_runtime_environment"></a>45.1. Tigase Tip: Checking the Runtime Environment</h3>
<div class="paragraph">
<p>It has happened recently that we have tried very hard to fix a few annoying problems on one of the Tigase installations. Whatever we did, however the problems still existed after uploading a new version and the server restart. It worked fine in our development environment and it just didn&#8217;t on the target system.</p>
</div>
<div class="paragraph">
<p>It turned out that due to a specific environment settings on the target system an old version of the Tigase server was always started regardless updates we were uploading. When I finally started looking at the installation the first indication that something is wrong was lack of any log files in place where I expected them.</p>
</div>
<div class="paragraph">
<p>The best way to check all the environment settings used to start the Tigase server is to use&#8230;&#8203;.. <strong>check</strong> command line parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/tigase.sh check etc/tigase.conf
Checking arguments to Tigase
TIGASE_HOME = .
TIGASE_JAR = jars/tigase-server.jar
TIGASE_PARAMS = etc/tigase.conf
TIGASE_CONFIG = etc/tigase.xml
TIGASE_RUN = tigase.server.XMPPServer -c etc/tigase.xml --property-file etc/init.properties
TIGASE_PID = ./logs/tigase.pid
TIGASE_OPTIONS = --property-file etc/init.properties
JAVA_OPTIONS = -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 \
    -Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver \
    -server -Xms100M -Xmx200M -XX:PermSize=32m -XX:MaxPermSize=256m
JAVA = /System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin/java
JAVA_CMD =
CLASSPATH = ./jars/tigase-server.jar:./libs/jdbc-mysql.jar:./libs/jdbc-postgresql.jar:\
    ./libs/tigase-extras.jar:./libs/tigase-muc.jar:./libs/tigase-pubsub.jar:\
    ./libs/tigase-utils.jar:./libs/tigase-xmltools.jar
TIGASE_CMD = /System/Library/Frameworks/JavaVM.framework/Versions/1.6/Home/bin/java \
    -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8 \
    -Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver \
    -server -Xms100M -Xmx200M -XX:PermSize=32m -XX:MaxPermSize=256m \
    -cp ./jars/tigase-server.jar:./libs/jdbc-mysql.jar:./libs/jdbc-postgresql.jar:\
    ./libs/tigase-extras.jar:./libs/tigase-muc.jar:./libs/tigase-pubsub.jar:\
    ./libs/tigase-utils.jar:./libs/tigase-xmltools.jar tigase.server.XMPPServer \
    -c etc/tigase.xml --property-file etc/init.properties
TIGASE_CONSOLE_LOG = ./logs/tigase-console.log</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our case <strong>TIGASE_HOME</strong> was set to a fixed location pointing to an old version of the server files. The quick <strong>check</strong> command may be a real time saver.</p>
</div>
</div>
<div class="sect2">
<h3 id="_tigase_tip_checking_cluster_connections"><a class="anchor" href="#_tigase_tip_checking_cluster_connections"></a>45.2. Tigase Tip: Checking Cluster Connections</h3>
<div class="paragraph">
<p>After setting up clustering one may want to verify that cluster is operational. Right now it can be done in two fold manner - first by checking that there are actuall network connections established between cluster nodes, the next step is to check internal status of the server.</p>
</div>
<div class="sect3">
<h4 id="_established_connections"><a class="anchor" href="#_established_connections"></a>45.2.1. Established connections</h4>
<div class="paragraph">
<p>There are number of ways to check for opened connections, simplest one use command line. (Tigase uses port <em>5277</em> for cluster connections)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Linux</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>$ lsof -iTCP:5277 -sTCP:ESTABLISHED -P -n</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Windows</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>C:\WINNT&gt;netstat -anp tcp | find ":5277 "</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cluster_nodes_connected_using_xmpp"><a class="anchor" href="#_cluster_nodes_connected_using_xmpp"></a>45.2.2. Cluster nodes connected (using XMPP)</h4>
<div class="paragraph">
<p>Verifying clustering connectivity over XMPP protocol requires any XMPP client capable of <a href="http://xmpp.org/extensions/xep-0030.html">XEP-0030: Service Discovery</a>. It&#8217;s essential to remember, that only administrator (a user whose JID is configured as administrative) has access.</p>
</div>
<div class="sect4">
<h5 id="_psi_xmpp_client_2"><a class="anchor" href="#_psi_xmpp_client_2"></a>Psi XMPP Client</h5>
<div class="paragraph">
<p>For the purpose of this guide a <a href="http://psi-im.org/">Psi</a> client will be used. After successfully configuring and connecting to account with administrative privileges we need to access <em>Service Discovery</em>, either from application menu or from context menu of the particular account account:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_xmpp_1.png" alt="roster-discovery" width="233">
</div>
<div class="title">Figure 1: Access service discovery</div>
</div>
<div class="paragraph">
<p>In the <em>Service Discovery</em> window we need to find <em>Cluster Connection Manager</em> component. After expanding the tree node for the component a list of all cluster nodes will be presented with the current status (either <em>connected</em> or <em>disconnected</em>). Node column will contain actuall hostname of the cluster node:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/monitoring_clustering.png" alt="discovery-nodes" width="558">
</div>
<div class="title">Figure 2: List of cluster nodes</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_version_5_x"><a class="anchor" href="#_tigase_server_version_5_x"></a>46. Tigase Server version 5.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>This section contains documentation for the Tigase server version 5.x or above only. Some documents describe features specific to the new version and some other describe just extensions of older features with references to the complete guides.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;51schemaUpgeade,////Tigase 5.1 Database Schema Upgrade</p>
</li>
<li>
<p>////&lt;&lt;5xServerConfig,////Server Configuration 5.x</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_5_1_database_schema_upgrade"><a class="anchor" href="#_tigase_5_1_database_schema_upgrade"></a>47. Tigase 5.1 Database Schema Upgrade</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-07-16 11:10</p>
</div>
<div class="paragraph">
<p>Unfortunately we had to make a small change to the database schema for 5.1.0 version of the Tigase server.</p>
</div>
<div class="paragraph">
<p>It does not affect data or data structure, only the way some data is accessed in database. We added one more stored procedure which has to be installed in database if you upgrade your installation from a previous Tigase version.</p>
</div>
<div class="paragraph">
<p>Please follow detailed guide for the database applicable to your installation: ////&lt;&lt;derby,////Derby, ////&lt;&lt;mysql,////MySQL, ////&lt;&lt;postgresql,////PostgreSQL</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;derby,////Derby Database Schema Upgrade for Tigase 5.1</p>
</li>
<li>
<p>////&lt;&lt;mysql,////MySQL Database Schema Upgrade for Tigase 5.1</p>
</li>
<li>
<p>////&lt;&lt;postgresql,////PostgreSQL Database Schema Upgrade for Tigase 5.1</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_derby_database_schema_upgrade_for_tigase_5_1"><a class="anchor" href="#_derby_database_schema_upgrade_for_tigase_5_1"></a>48. Derby Database Schema Upgrade for Tigase 5.1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wojciech Kapcia &lt;<a href="mailto:wojciech.kapcia@tigase.org">wojciech.kapcia@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-06-20 19:12</p>
</div>
<div class="paragraph">
<p>Unfortunately we had to make a small change to the database schema for 5.1.0 version of the Tigase server.</p>
</div>
<div class="paragraph">
<p>The good news is that it does not affect data or data structure, only the way some data is accessed in database. We added one more stored procedure which has to be installed in database if you upgrade your installation from a previous Tigase version.</p>
</div>
<div class="paragraph">
<p>Therefore the schema upgrade is very simple and safe but make sure the current database schema is in version 4.0.</p>
</div>
<div class="paragraph">
<p>First things first - make a database backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">tar -czf derbyDB.tar.gz /path/to/derbyDB</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to restore database for any reason simply extract files from the backup archive:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">rm -rf /path/to/derbyDB
tar -xf derbyDB.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can run schema upgrade script</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -Dij.protocol=jdbc:derby: -Dij.database=&quot;/path/to/derbyDB&quot; \
                -Dderby.system.home=`pwd` \
                -cp libs/derby.jar:libs/derbytools.jar:jars/tigase-server.jar \
                org.apache.derby.tools.ij database/postgresql-schema-upgrade-to-5-1.sql</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mysql_database_schema_upgrade_for_tigase_5_1"><a class="anchor" href="#_mysql_database_schema_upgrade_for_tigase_5_1"></a>49. MySQL Database Schema Upgrade for Tigase 5.1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-04-21 03:58</p>
</div>
<div class="paragraph">
<p>Unfortunately we had to make a small change to the database schema for 5.1.0 version of the Tigase server.</p>
</div>
<div class="paragraph">
<p>The good news it does not affect data or data structure, only the way some data is accessed in database. We added one more stored procedure which has to be installed in database if you upgrade your installation from a previous Tigase version.</p>
</div>
<div class="paragraph">
<p>Therefore the schema upgrade is very simple and safe but make sure the current database schema is in version 4.0. If you happen to use ancient version of the Tigase before number 4.0 and you want to upgrade to 5.1 you have to run ////&lt;&lt;40schemaUpgrade,////4.0 upgrade script first.</p>
</div>
<div class="paragraph">
<p>Assumptions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>tigasedb</strong> is a database name</p>
</li>
<li>
<p><strong>tigase_user</strong> is a database user name</p>
</li>
<li>
<p><strong>mypass</strong> is database user password</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>First things first - make a database backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysqldump -u tigase_user -pmypass tigasedb &gt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to restore database for any reason execute following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">msyqladmin -u tigase_user -pmypass drop tigasedb
mysqladmin -u tigase_user -pmypass create tigasedb
mysql -u tigase_user -pmypass tigasedb &lt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note! You may be required to use root user and his password to execute mysqladmin commands.</em></p>
</div>
<div class="paragraph">
<p>Now we can run schema upgrade script</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysql -u tigase_user -pmypass tigasedb &lt; database/mysql-schema-upgrade-to-5-1.sql</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgresql_database_schema_upgrade_for_tigase_5_1"><a class="anchor" href="#_postgresql_database_schema_upgrade_for_tigase_5_1"></a>50. PostgreSQL Database Schema Upgrade for Tigase 5.1</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andrzej Wojcik &lt;<a href="mailto:andrzejw@tigase.org">andrzejw@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-06-16 11:03</p>
</div>
<div class="paragraph">
<p>Unfortunately we had to make a small change to the database schema for 5.1.0 version of the Tigase server.</p>
</div>
<div class="paragraph">
<p>The good news it does not affect data or data structure, only the way some data is accessed in database. We added one more stored procedure which has to be installed in database if you upgrade your installation from a previous Tigase version.</p>
</div>
<div class="paragraph">
<p>Therefore the schema upgrade is very simple and safe but make sure the current database schema is in version 4.0.</p>
</div>
<div class="paragraph">
<p>Assumptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>tigasedb</strong> is a database name</p>
</li>
<li>
<p><strong>tigase_user</strong> is a database user name</p>
</li>
<li>
<p><strong>admin_db_user</strong> is database admin user name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First things first - make a database backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">pg_dump -U tigase_user -W tigasedb &gt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to restore database for any reason execute following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">dropdb -U admin_db_user -W tigasedb
createdb -U admin_db_user -W -O tigase_user tigasedb
psql -U tigase_user -W tigasedb &lt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can run schema upgrade script</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">psql -q -U tigase_user -W tigasedb -f <span class="type">database</span>/postgresql-schema-upgrade-<span class="keyword">to</span><span class="integer">-5</span><span class="error">-</span><span class="error">1</span>.sql</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_configuration_5_x"><a class="anchor" href="#_server_configuration_5_x"></a>51. Server Configuration 5.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Collection of documents and guides for the Tigase server version 5.x and later.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;confChanges5x,////Configuration Changes in the Tigase Server 5.x</p>
</li>
<li>
<p>////&lt;&lt;amp0079,////Advanced Message Processing - AMP XEP-0079</p>
</li>
<li>
<p>////&lt;&lt;saslExternal,////Configuration SASL EXTERNAL</p>
</li>
<li>
<p>////&lt;&lt;s2sps,////Server to Server Protocol Settings</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_changes_in_the_tigase_server_5_x"><a class="anchor" href="#_configuration_changes_in_the_tigase_server_5_x"></a>52. Configuration Changes in the Tigase Server 5.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>The whole configuration framework for the Tigase server has been redesigned and rewritten. This was done to cleanup all the configuration code and logic and also extend the current functionality and allow for configuration storage in different kinds of repositories - memory, file, database, &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>The title says configuration changes but the version 5.x still follows our policy about backward compatibility so the changes should be rather called extensions.</p>
</div>
<div class="paragraph">
<p>There is however one change which can affect a few users. Those who use the server and worked with it&#8217;s configuration remember the mess and confusion related to duality in the server configuration - the init.properties file and tigase.xml file. This is now over.</p>
</div>
<div class="sect2">
<h3 id="_reverting_to_the_old_behaviour"><a class="anchor" href="#_reverting_to_the_old_behaviour"></a>52.1. Reverting To the Old Behaviour</h3>
<div class="paragraph">
<p>While using the tigase.xml file is still possible and the whole old behaviour can be preserved it is now disabled by default. By default the Tigase server reads only init.properties file with initial settings and stores all the complete configuration in memory only.</p>
</div>
<div class="paragraph">
<p>The init.properties works exactly as before and all old parameters are still working exactly as before. The only difference is the lack of the tigase.xml which is not created by default and is not read by default if it is present. The main advantage is that you don&#8217;t have to remove it each time you change something in the init.properties to pick up new settings.</p>
</div>
<div class="paragraph">
<p>I will first present how to revert to old behaviour as this might be critical to some existing systems which want to upgrade. This is actually very simple to accomplish. The Tigase server now, offers pluggable repository support. This means that you can easily extend current functionality with a different configuration storage by writing own class which reads and writes configuration parameters.</p>
</div>
<div class="paragraph">
<p>By default class tigase.conf.ConfigurationCache is loaded which stores configuration in memory only.</p>
</div>
<div class="paragraph">
<p>Please note, the init.properties file is always read if it exists at given location.</p>
</div>
<div class="paragraph">
<p>To revert to the old behaviour you just need to pass a parameter to the Tigase server with a class name which is responsible for keeping server parameters in the old XML file. You can do it in two ways:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add a parameter to init.properties file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--tigase-config-repo-class=tigase.conf.ConfigXMLRepository</code></pre>
</div>
</div>
</li>
<li>
<p>You can pass a system property to the JVM at the startup time:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-Dtigase-config-repo-class=tigase.conf.ConfigXMLRepository</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_default_behaviour"><a class="anchor" href="#_default_behaviour"></a>52.2. Default Behaviour</h3>
<div class="paragraph">
<p>By default the Tigase server loads tigase.conf.ConfigurationCache class which stores the whole configuration in memory. Please note that the ////&lt;&lt;initPropertiesGuide,////init.properties file with initial settings is always loaded if it is available at the given location and all settings in this file work exactly as before. For more details, please refer to the online documentation.</p>
</div>
<div class="paragraph">
<p>A couple of times I mention about 'initial configuration' and 'whole configuration'. What is this about, what is the difference?</p>
</div>
<div class="paragraph">
<p>The 'initial configuration' are startup settings provided by the user in the init.properties file. Most of the server elements, however use far more configuration parameters which are set to sensible default values if they are not provided by the user. The configuration framework in the Tigase server, however always keeps the complete configuration of all active elements. This is implemented in such a way to make it possible to present currently used settings to the end-users or administrators and allow them to change the server parameters at runtime.</p>
</div>
</div>
<div class="sect2">
<h3 id="_storing_configuration_in_sql_database"><a class="anchor" href="#_storing_configuration_in_sql_database"></a>52.3. Storing Configuration in SQL Database</h3>
<div class="paragraph">
<p>There is one more configuration storage implemented right now. It allows you to store the server settings in the SQL database. In most cases this is not quite useful, just opposite, very inconvenient.
There is however at least one case when you really want to keep the server configuration in the SQL database. This is the cluster mode. If you have a Tigase cluster system of 10 or more nodes it is much easier to keep configuration in a single central location and manage it from there, rather then go to every single machine, every time you want to change some settings.
You can even change any settings for all cluster nodes with a single database query.</p>
</div>
<div class="paragraph">
<p>You set the SQL storage the same way as you set it for XML file, there is, however one more parameter as you have to provide also database connection string for the server so it knows where to connect to for the settings:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Parameters in init.properties file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--tigase-config-repo-class=tigase.conf.ConfigSQLRepository
--tigase-config-repo-uri=connection-uri</code></pre>
</div>
</div>
</li>
<li>
<p>Alternatively you can provide system properties to the JVM:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-Dtigase-config-repo-class=tigase.conf.ConfigSQLRepository
-Dtigase-config-repo-uri=connection-uri</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Please note, the current implementation for the SQL storage automatically creates necessary table if it does not exists. So you don&#8217;t have to worry about the schema but you should make sure that the database user used by the Tigase has permissions to create a table.</p>
</div>
<div class="paragraph">
<p>Configuration is stored in table with following schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">create</span> <span class="type">table</span> tigase_configuration (
<span class="comment">-- The component name by which the configuration parameter</span>
<span class="comment">-- is used.</span>
  component_name <span class="predefined-type">varchar</span>(<span class="integer">127</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,

<span class="comment">-- The configuration property key name or identifier.</span>
  key_name <span class="predefined-type">varchar</span>(<span class="integer">127</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,

<span class="comment">-- The configuration property value</span>
  value <span class="predefined-type">varchar</span>(<span class="integer">8191</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span>,

<span class="comment">-- The cluster node by which the configuration property is read,</span>
<span class="comment">-- if empty it will be read by all cluster nodes.</span>
  cluster_node <span class="predefined-type">varchar</span>(<span class="integer">255</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">DEFAULT</span> <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,

<span class="comment">-- Additional, secondary identifier for the configuration property.</span>
<span class="comment">-- The configuration can be organised in a hierarchical way to allow</span>
<span class="comment">-- multiple occurrences of the same property name for a single</span>
<span class="comment">-- component, for example you can have the same property for</span>
<span class="comment">-- different tcp/ip ports set to a different value:</span>
<span class="comment">-- c2s/5222/port_type=plain</span>
<span class="comment">-- c2s/5223/port_type=ssl</span>
<span class="comment">-- the port number is a secondary identifier.</span>
  key_node <span class="predefined-type">varchar</span>(<span class="integer">127</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">DEFAULT</span> <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,

<span class="comment">--  Not currently used. In future it will be used to distinguish between</span>
<span class="comment">-- different kind of properties (initial settings, defaults, updated by</span>
<span class="comment">-- user, etc...)</span>
  flag <span class="predefined-type">varchar</span>(<span class="integer">32</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">DEFAULT</span> <span class="string"><span class="delimiter">'</span><span class="content">DEFAULT</span><span class="delimiter">'</span></span>,

<span class="comment">-- The system detects basic Java types and stores information about</span>
<span class="comment">-- the property type, when the property is read the original property</span>
<span class="comment">-- type is restored and provided to the component without need for</span>
<span class="comment">-- a parsing or conversion.</span>
  value_type <span class="predefined-type">varchar</span>(<span class="integer">8</span>) <span class="keyword">NOT</span> <span class="predefined-constant">NULL</span> <span class="directive">DEFAULT</span> <span class="string"><span class="delimiter">'</span><span class="content">S</span><span class="delimiter">'</span></span>,

<span class="comment">-- It is not currently used. In the future it will be used to reload</span>
<span class="comment">-- settings changed in last, defined period of time. Basicall, the</span>
<span class="comment">-- system can automatically check the configuration database to</span>
<span class="comment">-- see whether some properties have been updated, then reload</span>
<span class="comment">-- them and apply automatically.</span>
  last_update           <span class="predefined-type">timestamp</span>,

<span class="directive">primary</span> <span class="type">key</span>(cluster_node, component_name, key_node,
                  key_node, flag));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_going_further"><a class="anchor" href="#_going_further"></a>52.4. Going Further</h3>
<div class="paragraph">
<p>There is more. As the configuration mechanism in the Tigase server offers pluggable storage engines you can easily write your own engine by implementing the interface: tigase.conf.ConfigRepositoryIfc or by extending one of current implementations.</p>
</div>
<div class="paragraph">
<p>There is even more. You can go even further. The whole configuration framework is pluggable and you can replace it completely if it doesn&#8217;t suites you well enough. Your implementation has to extend tigase.conf.ConfiguratorAbstract class and can be set using JVM system property (as this is configuration framework you can&#8217;t do this via any configuration system):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">-Dtigase-configurator=tigase.conf.Configurator</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows the parameter set to the default configuration framework.</p>
</div>
</div>
<div class="sect2">
<h3 id="_message_router_implementation_is_configurable_too"><a class="anchor" href="#_message_router_implementation_is_configurable_too"></a>52.5. Message Router Implementation is Configurable Too</h3>
<div class="paragraph">
<p>The Message router component was the only component which was fixed to the Tigase instance. In theory it could always be replaced but in practise there was no way of doing it as that was the first element loaded at the server startup time.</p>
</div>
<div class="paragraph">
<p>Now the Tigase message router implementation can be easily replaced to and it can be made a configurable option if needed.</p>
</div>
<div class="paragraph">
<p>At the server startup time the code creates configurator and calls method: getMessageRouterClassName() which by default returns class: tigase.server.MessageRouter. You can extend the configurator and provide any different class name instead which implements required interfaces. You can even make it configurable. It is no longer a fixed thing for the server instance.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_advanced_message_processing_amp_xep_0079"><a class="anchor" href="#_advanced_message_processing_amp_xep_0079"></a>53. Advanced Message Processing - AMP XEP-0079</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-05-13 16:09</p>
</div>
<div class="paragraph">
<p>The Tigase server <strong>5.1.0</strong> or later offers support for <a href="http://xmpp.org/extensions/xep-0079.html">Advanced Message Processing</a>, called AMP or XEP-0079.</p>
</div>
<div class="paragraph">
<p>It is enabled by default but there are several configuration options that you may tweak.</p>
</div>
<div class="paragraph">
<p>Configuration is not very complex but as the AMP is implemented as a component in the Tigase server it does needs a few settings to get it right.</p>
</div>
<div class="paragraph">
<p>Here is a first, brief overview of the AMP configuration and later  detailed explanation of each parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--sm-plugins=amp,-message,-msgoffline
--amp-repo-uri=jdbc:mysql://localhost/tigasedb?user=db_usr&amp;password=db_pwd
--amp-security-level=STRICT
sess-man/plugins-conf/amp/amp-jid=amp@your-domain.tld</code></pre>
</div>
</div>
<div class="paragraph">
<p>First of all: plugins.</p>
</div>
<div class="paragraph">
<p>Even though the whole functionality is implemented inside the component you need a way to forward messages with AMP payload to that component. This is what the 'amp' plugin does. The 'amp' plugin intercepts all &lt;message/&gt; packets even without AMP payload, redirecting some of the to the AMP component and others processing in a standard way. Therefore you no longer need 'message' plugin or 'msgoffline' plugin. Their all functions are offered by the 'amp' plugin now. Hence you have to switch 'message' and 'msgoffline' plugins off (the 'amp' plugin is loaded by default):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--sm-plugins=amp,-message,-msgoffline</code></pre>
</div>
</div>
<div class="paragraph">
<p>The 'amp' plugin needs to know where to forward all the AMP packets. By default plugin uses hostname of the given machine as this is true to the most installations, however this is configured by the last line of the example configuration, which forwards all packets to the address '<a href="mailto:amp@your-domain.tld">amp@your-domain.tld</a>':</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sess-man/plugins-conf/amp/amp-jid=amp@your-domain.tld</code></pre>
</div>
</div>
<div class="paragraph">
<p>Secondly: component.</p>
</div>
<div class="paragraph">
<p>By default  Tigase loads the component with the standard name 'amp'</p>
</div>
<div class="paragraph">
<p>Optional parameters:</p>
</div>
<div class="paragraph">
<p>There is also one parameter shared between the component and the plugin. Connection to the database where offline messages are stored. The AMP component has a dedicated schema for storing offline messages designed for a high traffic and high load installations. It does not use UserRepository for storing messages.</p>
</div>
<div class="paragraph">
<p>By default the same physical database as for UserRepository is used but you can change it and store messages in a completely separate location to reduce performance degradation of rest of the system. You can set a database connection string using following property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--amp-repo-uri=jdbc:mysql://localhost/tigasedb?user=db_usr&amp;password=db_pwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <a href="http://xmpp.org/extensions/xep-0079.html">XEP-0079</a> specification has a <a href="http://xmpp.org/extensions/xep-0079.html#security">Section 9. - Security Considerations</a>. As it describes, in some cases the AMP protocol can be used to reveal user&#8217;s presence information by other users who are not authorised for presence updates. There are a few possible ways to prevent this.</p>
</div>
<div class="paragraph">
<p>The Tigase&#8217;s implementation offers 3 modes to handle AMP requests to prevent revealing user&#8217;s status to not authorised people:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--amp-security-level=STRICT</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this mode the server performs strict checking. The AMP specification is fully handled. This however involves roster loading for each offline user, hence it may impact the service performance. It may not be feasible or possible to run in this mode for services under a high load with lots of AMP messages.</p>
</div>
<div class="paragraph">
<p>In the XEP this mode is described in the following way:</p>
</div>
<div class="paragraph">
<p><em>Accept the relevant condition only if the sender is authorized to receive the receiver&#8217;s presence, as a result of which the server MUST reply with a &lt;not-acceptable/&gt; error condition if the sender is not so authorized; this is the RECOMMENDED behavior. This is also the default in Tigase.</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--amp-security-level=PERFORMANCE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dummy checking is performed, that is no checking actually. It just returns an error response every time there is a chance that the default action may reveal user status without looking into the user&#8217;s roster. This does not affect performance but it does impact the AMP compliance.</p>
</div>
<div class="paragraph">
<p>In the XEP this mode is described in the following way:</p>
</div>
<div class="paragraph">
<p><em>Accept the relevant condition only if the action is "drop", as a result of which the server MUST reply with a &lt;not-acceptable/&gt; error condition if the action is "alert", "error", or "notify"; this is slightly less restrictive but still unnecessarily restricts the functionality of the system, so is NOT RECOMMENDED.</em></p>
</div>
<div class="paragraph">
<p>It does not do any checking. It acts like all people are authorised to receive notifications, even if it may reveal user status to unauthorised people. It does not impact the server performance and it offers full AMP compliance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--amp-security-level=NONE</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_sasl_external"><a class="anchor" href="#_configuration_sasl_external"></a>54. Configuration SASL EXTERNAL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Bartosz Malkowski &lt;<a href="mailto:bmalkowski@tigase.pl">bmalkowski@tigase.pl</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2013-11-27 13:34</p>
</div>
<div class="paragraph">
<p>In order to enable SASL External add following line to the  init.properties file</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">c2s/clientCertCA=/path/to/cacert.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>File cacert.pem contains Certificate Authority certificate which is used to sign clients certificate.</p>
</div>
<div class="paragraph">
<p>Client certificate must include user&#8217;s Jabber ID as XmppAddr in subjectAltName:</p>
</div>
<div class="paragraph">
<p><em>As specified in RFC 3920 and updated in RFC 6120, during the stream negotiation process an XMPP client can present a certificate (a “client certificate”). If a JabberID is included in a client certificate, it is encapsulated as an id-on-xmppAddr Object Identifier (“xmppAddr”), i.e., a subjectAltName entry of type otherName with an ASN.1 Object Identifier of “id-on-xmppAddr” as specified in Section 13.7.1.4 of RFC 6120. [1]</em></p>
</div>
<div class="paragraph">
<p><a href="http://xmpp.org/extensions/xep-0178.html#c2s">XEP-0178</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_server_to_server_protocol_settings"><a class="anchor" href="#_server_to_server_protocol_settings"></a>55. Server to Server Protocol Settings</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-06-29 21:27</p>
</div>
<div class="paragraph">
<p>The Tigase server <strong>5.1.0</strong> or later offers new, rewritten from scratch implementation for s2s communication which allows you to tweak it&#8217;s configuration to get a better performance in your installation.</p>
</div>
<div class="paragraph">
<p>S2S (or server to server) protocol is enabled by default with setting which are optimal for the most common cases. There is however a set of configuration parameters you can adjust the server behaviour to get an optimal performance for your installation.</p>
</div>
<div class="paragraph">
<p>This documents describes following elements of the Tigase server configuration:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Number of concurrent connections to external servers</p>
</li>
<li>
<p>The connection throughput parameters</p>
</li>
<li>
<p>Maximum waiting time for packets addressed to external servers and the connection inactivity time</p>
</li>
<li>
<p>Custom plugins selecting connection to the remote server</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_number_of_concurrent_connections"><a class="anchor" href="#_number_of_concurrent_connections"></a>55.1. Number of Concurrent Connections</h3>
<div class="paragraph">
<p>Normally only one connection to the remote server is required to send XMPP stanza to that server. In some cases however, under a high load, you can get much better throughput and performance if you open multiple connections to the remote server.</p>
</div>
<div class="paragraph">
<p>This is especially true when the remote server works in a cluster mode. Ideally you want to open a connection to each of the cluster nodes on the remote server. This way you can spread the traffic evenly among cluster nodes and improve the performance for s2s connections.</p>
</div>
<div class="paragraph">
<p>The Tigase server offers 2 different parameters to tweak the number of concurrent, s2s connections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'max-out-total-conns' - the property specifies the maximum outgoing connections the Tigase server opens to any remote XMPP server. This is 'per domain' limit, which means that this limit applies to each of the remote domain the Tigase connects to. If it is set to '4' then Tigase opens maximum 4 connections to 'jabber.org' plus maximum 4 connections to 'muc.jabber.org' even if this is the same physical server behind the same IP address.</p>
<div class="paragraph">
<p>To adjust the limit you have to add following line to the init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">s2s/max-out-total-conns[I]=2</code></pre>
</div>
</div>
</li>
<li>
<p>'max-out-per-ip-conns' - the property specifies the maximum outgoing connections the Tigase server opens to any remote XMPP server to its single IP address. This is 'per domain' limit, which means that this limit applies to each of the remote domain the Tigase connects to. If it is set to '1', above limit is set to '4' and the remote server is visible behind 1 IP address then Tigase opens maximum 1 connection to 'jabber.org' plus maximum 1 connection to 'muc.jabber.org', etc&#8230;&#8203;.</p>
<div class="paragraph">
<p>To adjust the limit you have to add following line to the init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">s2s/max-out-per-ip-conns[I]=2</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_connection_throughput"><a class="anchor" href="#_connection_throughput"></a>55.2. Connection Throughput</h3>
<div class="paragraph">
<p>Of course everybody wants his server to run with maximum throughput. However this comes with cost, usually increased memory usage. This is especially important if you have huge number of s2s connections on your installations. High throughput means lots of memory for network buffers for every single s2s connection. You may soon run out of all available memory.</p>
</div>
<div class="paragraph">
<p>There is one configuration property which allows you to adjust the network buffers for s2s connections to lower your memory usage or increase data throughput for s2s communication.</p>
</div>
<div class="paragraph">
<p>More details about are available in the ////&lt;&lt;initPropertiesGuide,////init.properties guide under the link to --net-buff-high-throughput property description.</p>
</div>
</div>
<div class="sect2">
<h3 id="_maximum_packet_waiting_time_and_connection_inactivity_time"><a class="anchor" href="#_maximum_packet_waiting_time_and_connection_inactivity_time"></a>55.3. Maximum Packet Waiting Time and Connection Inactivity Time</h3>
<div class="paragraph">
<p>There are 2 timeouts you can set for the component controlling s2s communication.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'max-packet-waiting-time' - this sets the maximum time for the packets waiting for sending to some remote server. Sometimes, due to networking problems or DNS problems it might be impossible to send message to remote server right away. Establishing a new connection may take time or there might be communication problems between servers or perhaps the remote server is restarted. The Tigase will try a few times to connect to the remote server before giving up. This parameter specifies how long the packet is waiting for sending before it is returned to the sender with an error. The timeout is specified in seconds:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">s2s/max-packet-waiting-time[L]=420</code></pre>
</div>
</div>
</li>
<li>
<p>'max-inactivity-time' - this parameters specifies the maximum s2s connection inactivity time before it is closed. If the connection is not in use for a long time, perhaps it doesn&#8217;t make sense to keep it open and it resources up. The Tigase closes s2s connection after specified period of time and reconnects when it is necessary. The timeout is specified in seconds:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">s2s/max-inactivity-time[L]=900</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_custom_plugin_selecting_s2s_connection"><a class="anchor" href="#_custom_plugin_selecting_s2s_connection"></a>55.4. Custom Plugin Selecting s2s Connection</h3>
<div class="paragraph">
<p>Sometimes for a very large installations you may want to set larger number of s2s connections to remote servers. Especially if they work in cluster of several nodes. In such a case you can also have a control over XMPP packets distribution among s2s connections to a single remote server.</p>
</div>
<div class="paragraph">
<p>This piece of code is pluggable and you can write your own connection selector. It is enough to implement 'S2SConnectionSelector' interface and set your class name in the configuration using following parameter in init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">s2s/s2s-conn-selector=YourSelectorImplementation</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default selector picks connections randomly.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_version_4_x"><a class="anchor" href="#_tigase_server_version_4_x"></a>56. Tigase Server Version 4.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:22</p>
</div>
<div class="paragraph">
<p>Administration manuals and guides for the Tigase server version 4.x line.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;40schemaUpgrade,////MySQL Database Schema Upgrade for Tigase 4.0</p>
</li>
<li>
<p>////&lt;&lt;virtualComponents,////Virtual Components for the Cluster Mode</p>
</li>
<li>
<p>////&lt;&lt;externalComponentConfiguration,////External Component Configuration</p>
</li>
<li>
<p>////&lt;&lt;packetFiltering,////Packets filtering</p>
</li>
<li>
<p>////&lt;&lt;virtualHosts,////Virtual Hosts in the Tigase Server</p>
</li>
<li>
<p>////&lt;&lt;4xconfiguration,////Configuration</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mysql_database_schema_upgrade_for_tigase_4_0"><a class="anchor" href="#_mysql_database_schema_upgrade_for_tigase_4_0"></a>57. MySQL Database Schema Upgrade for Tigase 4.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-01-06 20:18</p>
</div>
<div class="paragraph">
<p>For number of reasons the database schema had to be changed for Tigase server version 4.0. The most important are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compliance with the XMPP RFC which says that each part of JID may have up to 1023 characters. We store in the database user JIDs without resource name thus the maximum possible size of the user id is 2047. There aren&#8217;t really JIDs that long yet but we experienced quite long JIDs in a few installations already so we decided to prepare Tigase to accept any JID allowed by RFC.</p>
</li>
<li>
<p>Performance and flexibility -  the Tigase server now accesses database using stored procedures. This allows for any database storage format and it doesn&#8217;t really matter for the Tigase server what is the database schema how data is organized inside. What it needs is just bunch of stored procedures to access the data. This allows for much more flexibility in storing user data as well as much easier integration with third-party systems and also organize data in more efficient way.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore when you run the Tigase server now it may (depending on what exact SVN revision you use) refuse to start if it detects that the database schema is not updated. If it happens just follow steps below to update the database schema and start the server again.  Updating of the database schema is very easy and almost fully automated process. Just follow the steps below and you should be able to run new version of the Tigase server in a few minutes or even seconds depending on your database size. It takes around 7 minutes to update database with 200k user accounts on an average machine.</p>
</div>
<div class="paragraph">
<p><strong>Note. Do not update the database schema before the Tigase server tells you to do so. And do a database backup before starting the schema update.</strong></p>
</div>
<div class="paragraph">
<p><em>Please note. I have done a few schema upgrades already in a different configurations and here are a few tips which might be useful if something goes wrong:</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>You really, really have to do the DB backup (database dump) before upgrading.</strong> <em>If you don&#8217;t you might not be able to revert database on your own. Contact me in case of problems.</em></p>
</li>
<li>
<p><em>In case of error:</em> <strong>ERROR 1419 (HY000) at line 31 in file: 'database/mysql-schema-4-sp.schema': You do not have the SUPER privilege and binary logging is enabled (you *might</strong> want to use the less safe log_bin_trust_function_creators variable)* <em>Restore the database following description found below and run the update again as MySQL super user.</em></p>
</li>
<li>
<p><em>The following error may manifest itself in many ways from the NullPointerException in the Tigase server log file to message like this:</em> <strong>User does not have access to metadata required to determine stored procedure parameter types. If rights can not be granted, configure connection with "noAccessToProcedureBodies=true" to have driver generate parameters that represent INOUT strings irregardless of actual parameter types.</strong> <em>The best solution to this is to grant proper permissions to this user. Enter the MySQL command line mode as MySQL super user:</em></p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="error">$</span> mysql -u root -proot_passwd mysql
mysql&gt; <span class="class">GRANT</span> <span class="class">SELECT</span>, <span class="class">INSERT</span>, <span class="class">UPDATE</span> <span class="keyword">ON</span> <span class="error">\</span><span class="string"><span class="delimiter">`</span><span class="content">mysql</span><span class="char">\`</span><span class="content">.</span><span class="char">\`</span><span class="content">proc</span><span class="char">\`</span><span class="content"> TO 'tigase_user'@'localhost';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON </span><span class="char">\`</span><span class="content">mysql</span><span class="char">\`</span><span class="content">.</span><span class="char">\`</span><span class="content">proc</span><span class="char">\`</span><span class="content"> TO 'tigase_user'@'%';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON </span><span class="char">\`</span><span class="content">mysql</span><span class="char">\`</span><span class="content">.</span><span class="char">\`</span><span class="content">proc</span><span class="char">\`</span></span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Assumptions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>tigasedb</strong> is a database name</p>
</li>
<li>
<p><strong>tigase_user</strong> is a database user name</p>
</li>
<li>
<p><strong>mypass</strong> is database user password</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>First things first - make a database backup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysqldump -u tigase_user -pmypass tigasedb &gt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you need to restore database for any reason execute following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">msyqladmin -u tigase_user -pmypass drop tigasedb
mysqladmin -u tigase_user -pmypass create tigasedb
mysql -u tigase_user -pmypass tigasedb &lt; tigasedb_dump.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note! You may be required to use</em> <strong>root</strong> <em>user and his password to execute mysqladmin commands.  Ok we have the database backup and we know how to restore it. Now we can run schema upgrade script:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysql -u tigase_user -pmypass tigasedb &lt; database/mysql-schema-upgrade-to-4.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>The script should generate output like this:</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Droping index for user_id column
Resizing user_id column to 2049 characters to comply with RFC
Creating a new index for user_id column for first 765 bytes of the field
Adding sha1_user_id column
Adding user_pw column
Adding last_login column
Adding last_logout column
Adding online_status column
Adding failed_logins column
Adding account_status column
Creating a new index for user_pw column
Creating a new index for last_login column
Creating a new index for last_logout column
Creating a new index for account_status column
Creating a new index for online_status column
Resizing node column to 255 characters
Changing pval column type to mediumtext
Loading stored procedures definitions
Setting passwords encoding in the database
Converting database to a new format
Creating a new index for sha1_user_id column
Setting schema version to 4.0
All done, database ready to use!</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_virtual_components_for_the_cluster_mode"><a class="anchor" href="#_virtual_components_for_the_cluster_mode"></a>58. Virtual Components for the Cluster Mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume you have a cluster installation and you want to include a component in  your installation which doesn&#8217;t support the cluster mode yet. If you put it on all nodes as a separate instances they will work out of sync and overall functionality might be useless. If you put on one node only it will work correctly but it will be visible to users connected to this one node only.</p>
</div>
<div class="paragraph">
<p>Ideally you would like to have a mechanism to install it on one node and put some redirections on other nodes to forward all packets for this component to a node where this component is working. Redirection on it&#8217;s own is not enough however because the component must be visible in service discovery list and must be visible somehow to users connected to all nodes.</p>
</div>
<div class="paragraph">
<p>This is where the virtual components are handy. They are visible to users as a local normal component, they seem to be a real local component but in fact they just forward all requests/packets to a cluster node where the real component is working.</p>
</div>
<div class="paragraph">
<p>Virtual component is a very lightweight ServerComponent implementation in the Tigase server. It can pretend to be any kind of component and can redirect all packets to a given address. They can mimic native Tigase components as well as third-party components connected over external component protocol (XEP-0114).</p>
</div>
<div class="paragraph">
<p>Configuration is very simple and straightforward. In fact it is very similar to configuration of any Tigase component. You set a real component name as a name of the component and a vritual component class name to load. Let&#8217;s say we want to deploy MUC component this way. The MUC component is visible as muc.domain.our in the installation. Thus the name of the component is: muc</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1=muc
--comp-class-1=tigase.cluster.VirtualComponent</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is pretty much all you need to load a virtual component. A few other options are needed to point to correct destination addresses for packets forwarding and to set correct service discovery parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">muc/redirect-to=muc@cluster-node-with-real-muc.domain.our
muc/disco-name=Multi User Chat
muc/disco-node=
muc/disco-type=text
muc/disco-category=conference
muc/disco-features=http://jabber.org/protocol/muc</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_external_component_configuration"><a class="anchor" href="#_external_component_configuration"></a>59. External Component Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06</p>
</div>
<div class="paragraph">
<p>In the Tigase server version 4.4.x a new implementation for connecting external components has been introduced.</p>
</div>
<div class="paragraph">
<p>It is much simpler to setup and follows the same configuration standards as all other components. It is also much more powerful as a single instance can control many TCP/IP ports and many external components on each port and even allows for multiple connections for the same component. It supports both XEP-0114 and XEP-0225 with protocol auto-detection mechanisms. Protocols are pluggable so in future more protocols can be supported or custom extensions to existing protocols can be added.</p>
</div>
<div class="paragraph">
<p>The implementation also supports scripting API and new domains with passwords can be added at run-time using ad-hoc commands. New scripts can be loaded to even further control all connected external components.</p>
</div>
<div class="paragraph">
<p>Even though it is much simpler to setup and to use it also offers a lot of new functionality and features. Pages in this guide describe in details all the administration aspects of setting up and managing external components.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;4xbasicConfiguration,////Basic Configuration Options (External Component)</p>
</li>
<li>
<p>////&lt;&lt;4xexternalComponent,////Tigase as External Component</p>
</li>
<li>
<p>////&lt;&lt;loadBalancingExternalComponent,////Load Balancing External Components in Cluster Mode</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_configuration_options_external_component"><a class="anchor" href="#_basic_configuration_options_external_component"></a>60. Basic Configuration Options (External Component)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>As for all Tigase components you can load it and configure it via ////&lt;&lt;initPropertiesGuide,////init.properties file described in details in ////&lt;&lt;4xconfiguration,////another guide. This document describes how to load the component and set the initial configuration to accept or initiate connections for an external component.</p>
</div>
<div class="paragraph">
<p>First thing to do is to specify the component class and the component name which must be unique within the Tigase installation. The most commonly name used is ext and the class is tigase.server.ext.ComponentProtocol.</p>
</div>
<div class="paragraph">
<p>Following 2 lines in the ////&lt;&lt;initPropertiesGuide,////init.properties will load the component during the server startup time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol</code></pre>
</div>
</div>
<div class="paragraph">
<p>While this would load the component there is no additional configuration provided to the component would be practically useless. It is possible to add necessary parameters (external domains, passwords) during run-time via ad-hoc commands but this is generally a good practise to provide some initial parameters in the configuration file too.</p>
</div>
<div class="paragraph">
<p>There are two additional properties used for setting initial configuration for external components connections: ////&lt;&lt;initProperties_external,////--external and ////&lt;&lt;initProperties_bind-ext-hostnames,////--bind-ext-hostnames.</p>
</div>
<div class="paragraph">
<p>These two properties are very well described on page under the given links, therefore I will focus on practical and working examples here.</p>
</div>
<div class="sect2">
<h3 id="_simple_case"><a class="anchor" href="#_simple_case"></a>60.1. Simple Case</h3>
<div class="paragraph">
<p>The most common scenario is to connect an external component which works for a specific, given domain to the main server. The component authenticates with a defined password and the external component connects to a TCP/IP port the server listens on.</p>
</div>
<div class="paragraph">
<p>For example lat&#8217;s say our server works for a virtual domain: devel.tigase.org. We want it to listen on port 5270 for incoming connections from an external component working for a domain: muc.devel.tigase.org. The authentication password for the domain is muc-secret.</p>
</div>
<div class="paragraph">
<p>For such a scenario we need 3 lines in the init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.devel.tigase.org:muc-secret:listen:5270</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_more_external_components_domains"><a class="anchor" href="#_more_external_components_domains"></a>60.2. More External Components/Domains</h3>
<div class="paragraph">
<p>Suppose you want to connect more than one external component. Let&#8217;s say you want to connect PubSub and MSN components to the Tigase server as well.</p>
</div>
<div class="paragraph">
<p>In such a case you don&#8217;t have to open another port on the server. All the components can connect to the same port. Of course each of the components connect for a different domain and probably should use a different password.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say then that we want the Tigase server accept two more domains with corresponding passwords: (pubsub.devel.tigase.org:pubsub_pass) and (msn.devel.tigase.org:msn_pass). Your counfiguration properties should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.devel.tigase.org:muc-secret:listen:5270, \
    pubsub.devel.tigase.org:pubsub_pass, \
    msn.devel.tigase.org:msn_pass</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Please note, the --external property with value should be written in a single line. Above example has split the line for readibility.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_more_tcp_ip_ports"><a class="anchor" href="#_more_tcp_ip_ports"></a>60.3. More TCP/IP Ports</h3>
<div class="paragraph">
<p>You can make the Tigase to listen on more than one TCP/IP port for incoming external component connections. Please be aware however that there is no way, currently to bind an external component to a particular port. If the Tigase listens on two or more ports it accepts any external component on any of the ports. Therefore there is no practical reason for opening more than one port.</p>
</div>
<div class="paragraph">
<p>However, if for some reason you need Tigase to listen on more ports then this is an example configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.devel.tigase.org:muc-secret:listen:5270, \
   pubsub.devel.tigase.org:pubsub_pass:listen:5271, \
   msn.devel.tigase.org:msn_pass:listen:5272</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Please note, the --external property with value should be written in a single line. Above example has split the line for readibility.</em></p>
</div>
<div class="paragraph">
<p>Above setting sets three TCP/IP ports to listen on: 5270, 5271 and 5272. It also specifies 3 different external domains with passwords which are accepted by the Tigase. Even though each port is specified with conjunction with a domain they are not bound together in any way. Any of specified domains can connect through any of specified ports.</p>
</div>
</div>
<div class="sect2">
<h3 id="_outgoing_connections"><a class="anchor" href="#_outgoing_connections"></a>60.4. Outgoing Connections</h3>
<div class="paragraph">
<p>The Tigase server can, not only, accept connections from external components, it can also open connections to external components.</p>
</div>
<div class="paragraph">
<p>To make the Tigase connect to external component you have to change 'listen' parameter to 'connect' and of course you have to tell where to connect - the address of the external component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = devel.tigase.org:muc-secret:connect:5270:muc.devel.tigase.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming the MUC component listens on the port '5270' at the DNS address: 'muc.devel.tigase.org' the Tigase will connect to the component.</p>
</div>
<div class="paragraph">
<p>You can of course set as many as you need external components to which you want the Tigase to connect to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = devel.tigase.org:mucsecret:connect:5270:muc.devel.tigase.org, \
  devel.tigase.org:pubsub_pass:connect:5271:pubsub.devel.tigase.org, \
  devel.tigase.org:msn_pass:connect:5272:msn.devel.tigase.org</code></pre>
</div>
</div>
<div class="paragraph">
<p>If external components run on a separate machines you can of course us the same port number for each of them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_specifying_protocol"><a class="anchor" href="#_specifying_protocol"></a>60.5. Specifying Protocol</h3>
<div class="paragraph">
<p>One of the last parameters you can set for the external component/domain is a protocol which should be used for the connection. At the moment the Tigase server supports two protocols defined in <a href="http://xmpp.org/extensions/xep-0114.html">XEP-0114</a> and <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a> and possibly in the future it may support more.</p>
</div>
<div class="paragraph">
<p>You don&#8217;t have to specify a protocol if you setup a connection in 'listen' mode as the server automatically detects a protocol which is used in incoming connections.</p>
</div>
<div class="paragraph">
<p>You can, however specify the protocol which is used for outgoing connections. You have to add one more parameter to the connection string. There are two possibilities:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>'accept' which is an identifier for protocol defined in <a href="http://xmpp.org/extensions/xep-0114.html">XEP-0114</a> (and is a default if you do not specify anything)</p>
</li>
<li>
<p>'client' which is identifier for protocol defined in <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a> and is based on the client-to-server protocol.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>An example configuration with protocol specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = devel.tigase.org:mucsecret:connect:5270:muc.devel.tigase.org:accept, \
  devel.tigase.org:pubsub_pass:connect:5270:pubsub.devel.tigase.org:client</code></pre>
</div>
</div>
<div class="paragraph">
<p>It defines two outgoing connections to external protocols, the first uses <a href="http://xmpp.org/extensions/xep-0114.html">XEP-0114</a> protocol and the second uses <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_load_balancer_plugin"><a class="anchor" href="#_load_balancer_plugin"></a>60.6. Load Balancer Plugin</h3>
<div class="paragraph">
<p>The last option you can set for external component connections is load balancer class.</p>
</div>
<div class="paragraph">
<p>The load balancer plugin is used if you have multiple connections for the same component (external domain name) and you want to spread load over all connections. Perhaps you have an installation with huge number of MUC rooms and you want to spread the load over all MUC instances.</p>
</div>
<div class="paragraph">
<p>An example configuration with load balancer plugin specified:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.devel.tigase.org:mucsecret:listen:5270:devel.tigase.org:accept:ReceiverBareJidLB, \
  pubsub.devel.tigase.org:pubsub_pass:listen:5270:devel.tigase.org:accept:SenderBareJidLB</code></pre>
</div>
</div>
<div class="paragraph">
<p>It defines two listeners for external component with different load balancer plugins. The first load-balance traffic by a packet destination BareJID, which makes sense for MUC component. This way each MUC instance handles a different set of rooms which allows for a good load distribution.</p>
</div>
<div class="paragraph">
<p>For PubSub component we use a different load balancer plugin which distributes load by the sender BareJID instead. This is because for PubSub destination BareJID is always the same so we cannot use it to distribute the load.</p>
</div>
<div class="paragraph">
<p>Either the <strong>ReceiverBareJidLB</strong> or <strong>SenderBareJidLB</strong> are class names from package: <strong>tigase.server.ext.lb</strong> however, you can use any class name as a plugin, you just have to provide a full class name and the class name must implement <strong>LoadBalancerIfc</strong> interface.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_as_external_component"><a class="anchor" href="#_tigase_as_external_component"></a>61. Tigase as External Component</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>There are cases when you want to deploy one or more Tigase components separately from the main server or perhaps you want to run some Tigase components connecting to a different XMPP server or perhaps you work on a component and you do not want to restart the main server every time you make a change.</p>
</div>
<div class="paragraph">
<p>There is a way to run the Tigase server in "external component mode". In fact you can run any of Tigase components as an external component and connect them to the main XMPP server either via <a href="http://xmpp.org/extensions/xep-0114.html">XEP-0114</a> or <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a> connection.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the examples&#8230;&#8203;</p>
</div>
<div class="sect2">
<h3 id="_a_simple_case_muc_as_an_external_component"><a class="anchor" href="#_a_simple_case_muc_as_an_external_component"></a>61.1. A Simple Case - MUC as an External Component</h3>
<div class="paragraph">
<p>A few assumptions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We want to run a MUC component for a domain: 'muc.devel.tigase.org' and password 'muc-pass'</p>
</li>
<li>
<p>The main server works at an address: devel.tigase.org and for the same virtual domain</p>
</li>
<li>
<p>We want to connect to the server using <a href="http://xmpp.org/extensions/xep-0114.html">XEP-0114</a> protocol and port '5270'.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is a special configuration type for this case which simplifies setting needed to run the Tigase as an external component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type=--gen-config-comp.</code></pre>
</div>
</div>
<div class="paragraph">
<p>This generates a configuration for the Tigase with only one component loaded by default - component used for external component connection. If you use this configuration type, your init.properties file may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-comp
--debug = server
--user-db = derby
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:derby:/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--external = muc.devel.tigase.org:muc-pass:connect:5270:devel.tigase.org:accept</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note, you do not need lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol</code></pre>
</div>
</div>
<div class="paragraph">
<p>as the</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--gen-config-comp</code></pre>
</div>
</div>
<div class="paragraph">
<p>automatically includes them.</p>
</div>
</div>
<div class="sect2">
<h3 id="_more_components"><a class="anchor" href="#_more_components"></a>61.2. More Components</h3>
<div class="paragraph">
<p>Suppose you want to run more components as external components within one Tigase instance. Let&#8217;s add another - PubSub component to the configuration above and see how to set it up.</p>
</div>
<div class="paragraph">
<p>The way which seems to be most straightforward is just to add another component and another connection to the main server for the component domain:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-comp
--debug = server
--user-db = derby
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:derby:/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--comp-name-2 = pubsub
--comp-class-2 = tigase.pubsub.PubSubComponent
--external = muc.devel.tigase.org:muc-pass:connect:5270:devel.tigase.org:accept, \
  pubsub.devel.tigase.org:pubsub-pass:connect:5270:devel.tigase.org:accept</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note however that we are opening two connections to the same server. This is kind of wasting resources and overcomplicating system. What if we want to run even more components? Opening a separate connection for each component seems to be an overkill.</p>
</div>
<div class="paragraph">
<p>In fact there is a way to reuse the connection for all component domains running as an external component. The property '--bind-ext-hostnames' contains a comma separated list of all hostnames (external domains) which should reuse the existing connection.</p>
</div>
<div class="paragraph">
<p>There is one catch however. Connection reusing (hostname binding is defined in <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a> only, hence you must use this protocol for the functionality.</p>
</div>
<div class="paragraph">
<p>Here is an example configuration with a single connection over <a href="http://xmpp.org/extensions/xep-0225.html">XEP-0225</a> protocol used by both external domains:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-comp
--debug = server
--user-db = derby
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:derby:/tigasedb
--virt-hosts = devel.tigase.org
--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--comp-name-2 = pubsub
--comp-class-2 = tigase.pubsub.PubSubComponent
--external = muc.devel.tigase.org:muc-pass:connect:5270:devel.tigase.org:client
--bind-ext-hostnames=pubsub.devel.tigase.org</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_load_balancing_external_components_in_cluster_mode"><a class="anchor" href="#_load_balancing_external_components_in_cluster_mode"></a>62. Load Balancing External Components in Cluster Mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2011-07-09 22:45</p>
</div>
<div class="paragraph">
<p>This document describes how to load balance any external components using Tigase XMPP Server and how to make Tigase&#8217;s components work as external components in a cluster mode.</p>
</div>
<div class="paragraph">
<p><em>Please note, all configuration options described here apply to Tigase XMPP Server version 5.1.0 or later.</em></p>
</div>
<div class="paragraph">
<p>These are actually 2 separate topics:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>One is to distribute load over many instances of a single component to handle larger traffic, or perhaps for high availability.</p>
</li>
<li>
<p>The second is to make Tigase&#8217;s component work as an external component and make it work in a cluster mode, even if the component itself does not support cluster mode.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Here are step by step instructions and configuration examples teaching how to achieve both goals</p>
</div>
<div class="sect2">
<h3 id="_load_balancing_external_component"><a class="anchor" href="#_load_balancing_external_component"></a>62.1. Load Balancing External Component</h3>
<div class="paragraph">
<p>The first, simple scenario is to connect multiple instances of an external component to a single Tigase XMPP Server to distribute load.</p>
</div>
<div class="paragraph">
<p>Why would you like to do that? There are at least 2 reasons, one would be to spread load over more instances/machines and the second is to improve reliability in case one component fails the other one can take over the work.</p>
</div>
<div class="paragraph">
<p>So here is a simple picture showing the use case.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/ExternalCompClustering002.png" alt="ExternalCompClustering002"></span></p>
</div>
<div class="paragraph">
<p>We have a single machine running Tigase XMPP Server and 2 instances of the MUC component connecting to the Tigase. First example configurations.</p>
</div>
<div class="paragraph">
<p>The server configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-def
--user-db = mysql
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:mysql://localhost/db?user=tigase&amp;password=tigase
--virt-hosts = devel.tigase.org

--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.devel.tigase.org:muc-secret:listen:\
       5270:devel.tigase.org:accept:ReceiverBareJidLB</code></pre>
</div>
</div>
<div class="paragraph">
<p>And configuration for both instances of the MUC component (identical for both of them):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-comp
--user-db = mysql
--admins = admin@devel.tigase.org
--user-db-uri = jdbc:mysql://localhost/db?user=tigase&amp;password=tigase
--virt-hosts = devel.tigase.org

--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--external = muc.devel.tigase.org:muc-secret:connect:\
       5270:devel.tigase.org:accept</code></pre>
</div>
</div>
<div class="paragraph">
<p>I guess everything is quite clear and simple to those who are familiar with Tigase&#8217;s configuration except one small element in the Tigase server configuration. At the end of the component connection we have <strong>ReceiverBareJidLB</strong>.</p>
</div>
<div class="paragraph">
<p>This is load balancing plugin class. Load balancing plugin decides how the traffic is distributed among different component connections that is different component instances. For the MUC component it does make sense to distribute the traffic based on the receiver bare JID because this is the MUC room address. This way we just distribute MUC rooms and traffic over different MUC component instances.</p>
</div>
<div class="paragraph">
<p>This distribution strategy does not always work for all possible components however. For transports for example this would not work at all. A better way to spread load for transports would be based on the source bare JID. And it is possible of course if you use plugin with class name: <strong>SenderBareJidLB</strong>.</p>
</div>
<div class="paragraph">
<p>This are two basic load distribution strategies available now. For some use cases none of them is good enough. If you have PubSub, then you probably want to distribute load based on the PubSub node. There is no plugin for that yet but it is easy enough to write one and put the class name in configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="_external_component_and_cluster"><a class="anchor" href="#_external_component_and_cluster"></a>62.2. External Component and Cluster</h3>
<div class="paragraph">
<p>If you want to use Tigase&#8217;s component in a cluster mode which does not have clustering implemented yet there is a way to make it kind of cluster-able. In the previous section we connected many MUC components to a single Tigase server. Now we want to connect a single MUC component to many Tigase servers (or many Tigase cluster nodes).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say we have Tigase XMPP Server working for domain: <strong>xmpp-test.org</strong> and the server is installed on three cluster nodes: <strong>red.xmpp-test.org,</strong> <strong>green.xmpp-test.org</strong> and <strong>blue.xmpp-test.org.</strong></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/ExternalCompClustering003_0.png" alt="ExternalCompClustering003_0"></span></p>
</div>
<div class="paragraph">
<p>We want to make it possible to connect the MUC component to all nodes, so here is configuration for the server (for each node is the same):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type=--gen-config-def
--admins=admin@xmpp-test.org
--virt-hosts = xmpp-test.org

--cluster-mode = true
--cluster-nodes=red.xmpp-test.org,green.xmpp-test.org,blue.xmpp-test.org

--auth-db=tigase-auth
--user-db=mysql
--user-db-uri=jdbc:mysql://localhost/db?user=tigase&amp;password=tigase

--comp-name-1 = ext
--comp-class-1 = tigase.server.ext.ComponentProtocol
--external = muc.xmpp-test.org:muc-secret:listen:5270:\
       xmpp-test.org:accept:ReceiverBareJidLB</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see there is nothing special here. The most interesting part comes on the MUC side.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type = --gen-config-comp
--user-db = mysql
--admins = admin@xmpp-test.orgg
--user-db-uri = jdbc:mysql://localhost/db?user=tigase&amp;password=tigase

--virt-hosts = xmpp-test.org

--comp-name-1 = muc
--comp-class-1 = tigase.muc.MUCComponent
--external = muc.xmpp-test.org:muc-secret:connect:5270:xmpp-test.org;blue.xmpp-test.org;green.xmpp-test.org,red.xmpp-test.org:accept</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see remote host name is not a simple domain but a character string with a few comma separated parts. The first part is our remote domain and the rest are addresses of the host to connect to. This can be a list of domain names or IP addresses.</p>
</div>
<div class="paragraph">
<p>Of course it is possible to connect multiple external component to all cluster nodes, this way the whole installation would be really working in the cluster and also load balanced.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_packet_filtering"><a class="anchor" href="#_packet_filtering"></a>63. Packet Filtering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tigase offers different ways to filter XMPP packets flying through the server. The most common case to use packet filtering is to restrict users from sending or receiving packets based on the sender or received address.</p>
</div>
<div class="paragraph">
<p>There are also possible different scenarios: time based filtering, content filtering, volume filtering and so on.</p>
</div>
<div class="paragraph">
<p>All pages in this section describe different filtering strategies.</p>
</div>
<div class="sect2">
<h3 id="_domain_based_packet_filtering"><a class="anchor" href="#_domain_based_packet_filtering"></a>63.1. Domain Based Packet Filtering</h3>
<div class="paragraph">
<p>Domain based packets filter is a simple filter allowing to restrict user communication based on the source/destination domain name. This is especially useful if we want to limit user communication within a single - own domain only or a list of domains.</p>
</div>
<div class="paragraph">
<p>A company might not wish and allow employers to chat during work hours with anybody in the world. A company may also have a few different domains used by different branches or departments. An administrator may restrict communication to a list of domains.</p>
</div>
<div class="sect3">
<h4 id="_introduction"><a class="anchor" href="#_introduction"></a>63.1.1. Introduction</h4>
<div class="paragraph">
<p>The restriction is on per-user basis. So the administrator can set a different filtering rules for each user. There is also a per-domain configuration and global-installation setting (applied from most general to most specific, i.e. from installation to user).</p>
</div>
<div class="paragraph">
<p>Regular user can not change the setting. So this is not like a privacy list where the user control the filter. Domain filter can not be changed or controlled by the user. System administrator can change the settings based on the company policy.</p>
</div>
<div class="paragraph">
<p>There are predefined rules for packet filtering:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>ALL</code> - user can send and receive packets from anybody.</p>
</li>
<li>
<p><code>LOCAL</code> - user can send and receive packets within the server installation only and all it&#8217;s virtual domains.</p>
</li>
<li>
<p><code>OWN</code> - user can send and receive packets within his own domains only</p>
</li>
<li>
<p><code>BLOCK</code> - user can&#8217;t communicate with anyone. This could be used as a means to temporarily disable account or domain.</p>
</li>
<li>
<p><code>LIST</code> - user can send and receive packets within listed domains only (i.e. <em>whitelist</em>).</p>
</li>
<li>
<p><code>BLACKLIST</code> - user can communicate with everybody (like <code>ALL</code>), except contacts on listed domains.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Whitelist (<code>LIST</code>) and blacklist (<code>BLACKLIST</code>) settings are mutually exclusive, i.e. at any given point of time only one of them can be used.</p>
</div>
<div class="paragraph">
<p>Those rules applicable to particular user are stored in the user repository and are loaded for each user session. If there are no rules stored for a particular user server tries to apply rules for a VHost of particular user, and if there is no VHost filtering policy server uses global server configuration. If there is no filtering policy altogether server applies defaults based on following criteria:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If this is <strong>Anonymous</strong> user then <strong>LOCAL</strong> rule is applied</p>
</li>
<li>
<p>For all <strong>other</strong> users <strong>ALL</strong> rule is applied.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_configuration_3"><a class="anchor" href="#_configuration_3"></a>63.1.2. Configuration</h4>
<div class="paragraph">
<p>Filtering is performed by domain filter plugin which must be loaded at startup time. It is loaded by default if plugins list is not set in the configuration file. However if you have a list of loaded plugins in the configuration file make sure <strong>domain-filter</strong> is on the list.</p>
</div>
<div class="paragraph">
<p>There is no other configuration required for the plugin to work.</p>
</div>
</div>
<div class="sect3">
<h4 id="_administration_rules_management"><a class="anchor" href="#_administration_rules_management"></a>63.1.3. Administration, Rules Management</h4>
<div class="paragraph">
<p>Although controlling domain filtering rules are possible for each user separately it is normally not practical for large installations. In most cases users are stored in the database and third-party system keeps all the user information.</p>
</div>
<div class="paragraph">
<p>To change the rule for a single user you can use loadable administration scripts feature and load <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/groovy/tigase/admin/UserDomainFilter.groovy">UserDomainFilter.groovy</a> script. It allows to modify rules for a given user JID.</p>
</div>
</div>
<div class="sect3">
<h4 id="_implementation"><a class="anchor" href="#_implementation"></a>63.1.4. Implementation</h4>
<div class="paragraph">
<p>If you have a third party system which keeps and manages all user information than you probably have your own UserRepository implementation which allows the Tigase server to access user data. Filtering rules are loaded from user repository using following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">repo.getData(user_id, <span class="predefined-constant">null</span>, DomainFilter.ALLOWED_DOMAINS_KEY, <span class="predefined-constant">null</span>)
repo.getData(user_id, <span class="predefined-constant">null</span>, DomainFilter.ALLOWED_DOMAINS_LIST_KEY, <span class="predefined-constant">null</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <strong>user_id</strong> is user Jabber ID without resource part. <strong>DomainFilter.ALLOWED_DOMAINS_KEY</strong> is a property key: "allowed-domains". The user repository MUST return one of following only:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>ALL</code> - if the user is allowed to communicate with anybody</p>
</li>
<li>
<p><code>LOCAL</code> - if the user is allowed to communicate with users on the same server installation.</p>
</li>
<li>
<p><code>OWN</code> - if the user is allowed to communicate with users within his own domain only.</p>
</li>
<li>
<p><code>LIST</code> - list of domains within which the user is allowed to communicate with other users. No wild-cards are supported. User&#8217;s own domain should be included too.</p>
</li>
<li>
<p><code>BLACKLIST</code> - list of domains within which the user is NOT allowed to communicate with other users. No wild-cards are supported. User&#8217;s own domain should NOT be included.</p>
</li>
<li>
<p><code>null</code> - a java null if there are no settings for the user.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In case of <code>LIST</code> and <code>BLACKLIST</code> filtering options, it&#8217;s essential to provide list of domains for the whitelisting/blacklisting. <strong>DomainFilter.ALLOWED_DOMAINS_LIST_KEY</strong> is a property key: "allowed-domains-list". The user repository MUST return semicolon separated list of domains: <code>domain1.com;domain2.com,domain3.org</code></p>
</div>
<div class="paragraph">
<p>The filtering is performed by <a href="https://projects.tigase.org/projects/tigase-server/repository/revisions/master/entry/src/main/java/tigase/xmpp/impl/DomainFilter.java"><code>tigase.xmpp.impl.DomainFilter</code></a> plugin. Please refer to source code for more implementation details.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_virtual_hosts_in_the_tigase_server"><a class="anchor" href="#_virtual_hosts_in_the_tigase_server"></a>64. Virtual Hosts in the Tigase Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>The Tigase server supports multiple virtual hosts for a single server installation. This is supported via <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostManagerIfc.java">VHostManager</a> - the new Tigase server component added recently to the implementation. Virtual hosts can be added or removed, enabled or disabled at the server runtime without restarting the service or disrupting normal operation.</p>
</div>
<div class="paragraph">
<p>This document describes how virtual hosts work in the Tigase server and how to take the most of this feature in your installation.</p>
</div>
<div class="paragraph">
<p>The simplest and default way to set virtual hosts is the server configuration. You can either edit manually the ////&lt;&lt;initPropertiesGuide,////init.properties file or use the graphical installer/configuration program to set the property. If you want to edit it manually search for '--virt-hosts' property for more detailed description.</p>
</div>
<div class="paragraph">
<p>Alternatively you can use the GUI installer as shown below to set a list of virtual hosts.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/tigase-basic-config-vhosts.png" alt="tigase-basic-config-vhosts"></span></p>
</div>
<div class="paragraph">
<p>This method however has many disadvantages. It requires the server restart after each change, the configuration file is not the best place to store long list of virtual domains and you can not actually set any additional parameters for the domain other than it does exist or not.</p>
</div>
<div class="paragraph">
<p>There is another way to store and control virtual domains in the Tigase server. They can be put in the database and managed using ad-hoc commands. List of domains can be modified outside the Tigase server through any third-party system or web application and the server reloads the list of when received <strong>VHOSTS_RELOAD</strong> ad-hoc command.</p>
</div>
<div class="paragraph">
<p>There are 2 more ad-hoc commands which allow you to add/update and remove virtual hosts via XMPP protocol:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>VHOSTS_UPDATE</strong> - for adding new virtual host or changing parameters of the existing domain</p>
</li>
<li>
<p><strong>VHOSTS_REMOVE</strong> - for removing existing virtual domain from the list of the server domains.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, both commands cause vhosts list update in the permanent repository. This is however <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/vhosts/VHostRepository.java">VHostRepository</a> implementation dependent feature and can be changed in your repository implementation.</p>
</div>
<div class="paragraph">
<p>Commands for virtual domains management can be executed using any XMPP client with a good support for service discovery and ad-hoc commands, for example <a href="http://psi-im.org/">Psi</a>. Commands are accepted only when they are sent by the service administrator.</p>
</div>
<div class="paragraph">
<p>Please refer to documents listed below for more detailed information on the following topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;managingVirtualDomainsMissing,////Managing Virtual Domains Using Psi Client.</p>
</li>
<li>
<p>////&lt;&lt;ad-hocCommands,////Specification for ad-hoc Commands Used to Manage Virtual Domains.</p>
</li>
<li>
<p>////&lt;&lt;apiVirtualDomain,////API Description for Virtual Domains Management in the Tigase Server.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification_for_ad_hoc_commands_used_to_manage_virtual_domains"><a class="anchor" href="#_specification_for_ad_hoc_commands_used_to_manage_virtual_domains"></a>65. Specification for ad-hoc Commands Used to Manage Virtual Domains</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>There are 3 ad-hoc commands for virtual domains management in the Tigase server:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>VHOSTS_RELOAD</strong> used to reload virtual domains list from the repository (database).</p>
</li>
<li>
<p><strong>VHOSTS_UPDATE</strong> used to add a new virtual domain or update information for existing one.</p>
</li>
<li>
<p><strong>VHOSTS_REMOVE</strong> used to remove an existing virtual host from the running server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Syntax of the commands follows specification described in the <a href="http://xmpp.org/extensions/xep-0050.html">XEP-0050</a>. Extra information required to complete the command is carried as data forms described in the <a href="http://xmpp.org/extensions/xep-0004.html">XEP-0004</a>.</p>
</div>
<div class="paragraph">
<p>All commands are accepted by the server only when send by the installation administrator. If the command is sent from any other account &amp;lt;not-authorized /&amp;gt; error is returned. To grant administrator rights to an account you have to set <strong>--admins</strong> property in the ////&lt;&lt;initPropertiesGuide,////configuration file.</p>
</div>
<div class="paragraph">
<p>Commands are sent to 'vhost-man' server component and the 'to' attribute of the stanza must contain a full JID of the VHostManager on the server. The full <strong>JID</strong> consists of the component name: 'vhost-man' and the local domain, that is domain which is already on the list of virtual domains and is active. Assuming 'existing.domain.com' one of domains already activated for the server installation the <strong>JID</strong> is: '<a href="mailto:vhost-man@existing.domain.com">vhost-man@existing.domain.com</a>'.</p>
</div>
<div class="sect2">
<h3 id="_reloading_the_domains_list_from_the_database"><a class="anchor" href="#_reloading_the_domains_list_from_the_database"></a>65.1. Reloading the Domains List from the Database</h3>
<div class="paragraph">
<p>In order to reload virtual domains from the permanent repository other than configuration file you have to send <strong>VHOSTS_RELOAD</strong> ad-hoc command to the VHostManager on the server.</p>
</div>
<div class="paragraph">
<p>The reload command request is of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aac8a</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_RELOAD</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The server sends a response upon successful completion of the command with current number of virtual domains server by the installation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">from</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cmd-sender-admin@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aac8a</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">status</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_RELOAD</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;x</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:x:data</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;field</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fixed</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Note</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>Current number of VHosts: 123<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/field&gt;</span>
    <span class="tag">&lt;/x&gt;</span>
  <span class="tag">&lt;/command&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If the command is sent from other than admin account the server returns an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">from</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cmd-sender-admin@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aac8a</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_RELOAD</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
  <span class="tag">&lt;error</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">code</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">401</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;not-authorized</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:ietf:params:xml:ns:xmpp-stanzas</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;text</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:ietf:params:xml:ns:xmpp-stanzas</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">xml:lang</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">en</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      You are not authorized for this action.
    <span class="tag">&lt;/text&gt;</span>
  <span class="tag">&lt;/error&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The response doesn&#8217;t have any special meaning other then informative for the end-user. The client may ignore response as it is sent after the command has been executed.</p>
</div>
</div>
<div class="sect2">
<h3 id="_adding_a_new_domain_or_updating_existing_one"><a class="anchor" href="#_adding_a_new_domain_or_updating_existing_one"></a>65.2. Adding a New Domain or Updating Existing One</h3>
<div class="paragraph">
<p>In order to add a new domain or update existing one you have to send an ad-hoc command <strong>VHOSTS_UPDATE</strong> with at least domain name in the command data form. You can also specify whether the domain is enabled or disabled but this is optional. Future releases may allow for setting additional parameters for the domain: maximum number of user accounts for this domain, anonymous login enabled/disabled for the domain, registration via XMPP enabled/disabled for this domain and some more parameters not specified yet.</p>
</div>
<div class="paragraph">
<p>The domain add/update command request is of the form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aacba</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_UPDATE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;x</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:x:data</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;field</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text-single</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>new-virt.domain.com<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/field&gt;</span>
      <span class="tag">&lt;field</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">list-single</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Enabled</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>true<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/field&gt;</span>
    <span class="tag">&lt;/x&gt;</span>
  <span class="tag">&lt;/command&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note! Character case in the command field variable names does matter.</p>
</div>
<div class="paragraph">
<p>Upon successful completion of the command the server sends a response back to the client with information of the existing number of virtual hosts on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">from</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">cmd-sender-admin@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aacba</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">status</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">completed</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_UPDATE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;x</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:x:data</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">result</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;field</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fixed</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Note</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>Current number of VHosts: 124<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/field&gt;</span>
    <span class="tag">&lt;/x&gt;</span>
  <span class="tag">&lt;/command&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_removing_a_virtual_domain_from_the_server"><a class="anchor" href="#_removing_a_virtual_domain_from_the_server"></a>65.3. Removing a Virtual Domain From the Server</h3>
<div class="paragraph">
<p>In order to remove a virtual domain you have to send <strong>VHOSTS_REMOVE</strong> command to the server with the domain name.</p>
</div>
<div class="paragraph">
<p>The domain remove command is sent by the client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;iq</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">set</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vhost-man@existing.domain.com</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">aacba</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;command</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://jabber.org/protocol/commands</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">node</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHOSTS_REMOVE</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;x</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jabber:x:data</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;field</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text-single</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">var</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">VHost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>virt-nn.domain.com<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/field&gt;</span>
    <span class="tag">&lt;/x&gt;</span>
  <span class="tag">&lt;/command&gt;</span>
<span class="tag">&lt;/iq&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Upon successful completion of the command the server sends a response back to the client with information of the existing number of virtual hosts on the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">&lt;iq from=&quot;vhost-man@existing.domain.com&quot;
    type=&quot;result&quot;
    to=&quot;cmd-sender-admin@existing.domain.com&quot;
    id=&quot;aacba&quot;&gt;
  &lt;command xmlns=&quot;http://jabber.org/protocol/commands&quot;
           status=&quot;completed&quot;
           node=&quot;VHOSTS_REMOVE&quot;&gt;
    &lt;x xmlns=&quot;jabber:x:data&quot; type=&quot;result&quot;&gt;
      &lt;field type=&quot;fixed&quot; var=&quot;Note&quot;&gt;
        &lt;value&gt;Current number of VHosts: 124&lt;/value&gt;
      &lt;/field&gt;
    &lt;/x&gt;
  &lt;/command&gt;
&lt;/iq&gt;</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_4"><a class="anchor" href="#_configuration_4"></a>66. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>This section contains some specific description for non-standard Tigase installations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;loadComponent,////Configuring the Tigase Server to Load a Component</p>
</li>
<li>
<p>////&lt;&lt;customAuthentication,////Custom Authentication Connectors</p>
</li>
<li>
<p>////&lt;&lt;custonAuthConnector,////Tigase Custom Auth Connector</p>
</li>
<li>
<p>////&lt;&lt;LDAPauth,////LDAP Authentication Connector</p>
</li>
<li>
<p>////&lt;&lt;tigaseAuthConnector,////Tigase Auth Connector</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_the_tigase_server_to_load_a_component"><a class="anchor" href="#_configuring_the_tigase_server_to_load_a_component"></a>67. Configuring the Tigase Server to Load a Component</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>A detailed description of all the configuration options is in the ////&lt;&lt;initPropertiesGuide,////init.properties guide where you can also find information described below and much more. Purpose of this document however is to give you a quite and brief information how to load a component into the Tigase server without need to dig through all the details.</p>
</div>
<div class="paragraph">
<p>I will show how to load 2 components into the Tigase server using configuration in the init.properties file: <a href="https://projects.tigase.org/projects/tigase-muc">MUC</a> and <a href="https://projects.tigase.org/projects/tigase-pubsub">PubSub</a>. Please remember, every time you change something in the <strong>init.properties</strong> file you have to remove the XML configuration file in order to force the server to regenerate the main configuration which is stored in XML file.</p>
</div>
<div class="paragraph">
<p>The first thing you need is the component implementation. Component implementation is a class or set of classes extending <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/server/AbstractMessageReceiver.java">tigase.server.AbstractMessageReceiver</a>. What you need to do is just putting the jar file in the libs/ directory in the Tigase server installation. Then the Tigase server will find all classes automatically at the startup time.</p>
</div>
<div class="paragraph">
<p>Next step is to tell the server what components to load, how to name them and optionally give some extra parameters. To do so please open the init.properties file you use in your installation. It might be init-mysql.properties or init-pgsql.properties or even your own properties file.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say you want to add just PubSub for now. All you need to do is adding just 2 lines to the properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-1=pubsub
--comp-class-1=tigase.pubsub.PubSubComponent</code></pre>
</div>
</div>
<div class="paragraph">
<p>They mean: the first component name is 'pubsub' and the main class for this component is: 'tigase.pubsub.PubSubClusterComponent'. It doesn&#8217;t really matter what the component name is the only requirement is that it must be unique among other components names. It does also help to give it a name which means something thus 'pubsub' is a good name for a 'PubSub' component but it would be a bad name for the 'MUC' component.</p>
</div>
<div class="paragraph">
<p>We can of course add more components even PubSub components to the same server. Each of them would need to have a different name then. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-2=pubsub-priv
--comp-class-2=tigase.pubsub.PubSubComponent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which is needed in really rare cases.</p>
</div>
<div class="paragraph">
<p>Normally, however we want to load few different components like PubSub, MUC, MSN Transport and so on&#8230;&#8203;. Therefore instead of the above second PubSub we can load the MUC component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--comp-name-2=muc
--comp-class-2=tigase.muc.MUCComponent</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again! Don&#8217;t forget to remove your XML config file before restarting the server.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_authentication_connectors"><a class="anchor" href="#_custom_authentication_connectors"></a>68. Custom Authentication Connectors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>Tigase server offers you quite a few authentication connectors which allow you to connect to almost any SQL database for user authentication data and share user accounts between the XMPP server and any different system. This feature makes it possible to integrate the Tigase server with other systems without any development effort and without any coding.</p>
</div>
<div class="paragraph">
<p>This article presents configuration options available to the administrator and describe how to set the Tigase server up to use user accounts data from a different database.</p>
</div>
<div class="paragraph">
<p>The first thing to know is that the Tigase server always opens 2 separate connections to the database. One connection is for user login data and another is for all other user data like the user roster, vCard, private data storage, privacy lists and so on&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>In this article we still assume that the Tigase server keeps user data in it&#8217;s own database and only login data are retrieved from the external database.</p>
</div>
<div class="paragraph">
<p>At the moment the Tigase server offers following authentication connectors:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'mysql', 'pgsql', 'derby' - standard authentication connector used to load user login data from the main user database used by the Tigase server. In fact the same physical implementation is used for all JDBC databases.</p>
</li>
<li>
<p>'drupal' - is the authentication connector used to integrate the Tigase server with <a href="http://drupal.org/">Drupal CMS</a>.</p>
</li>
<li>
<p>'libresource' - is the authentication connector used to integrate the Tigase server with <a href="http://dev.libresource.org/">Libresource Collaboration platform</a>.</p>
</li>
<li>
<p>'tigase-auth' - is the authentication connector which can be used with any database. It executes stored procedures to perform all actions. Therefore it is a very convenient way to integrate the server with an external database if you don&#8217;t want to expose the database structure. You just have to provide a set of stored procedures in the database. While implementing all stored procedures expected by the server might be a bit of work it allows you to hide the database structure and change the SP implementation at any time. You can add more actions on user login/logout without restarting or touching the server. And the configuration on the server side is very simple. For detailed description of this implementation please refer to ////&lt;&lt;tigaseAuthConnector,////Tigase Auth documentation.</p>
</li>
<li>
<p>'tigase-custom' - is the authentication connector which can be used with any database. Unlike the 'tigase-auth' connector it allows you to define SQL queries in the configuration file. The advantage of this implementation is that you don&#8217;t have to touch your database. You can use either simple plain SQL queries or stored procedures. The configuration is more difficult as you have to enter carefully all SQL queries in the config file and changing the query usually involves restarting the server. For more details about this implementation and all configuration parameters please refer to ////&lt;&lt;custonAuthConnector,////Tigase Custom Auth documentation.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As always the simplest way to configure the server is through the ////&lt;&lt;initPropertiesGuide,////init.properties file. In the article describing this file you can find long list with all available options and all details how to handle it. For the authentication connector setup however we only need 2 options:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'--auth-db = connector'</p>
</li>
<li>
<p>'--auth-db-uri = database connection url'</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you happen to keep the user data in the same database as user authentication data you can even skip the second parameter as Tigase automatically assumes settings from the '--user-db-uri' it '--auth-db-uri' is missing.</p>
</div>
<div class="paragraph">
<p>'--auth-db-uri' stored a standard JDBC connection URL and is exactly the same as for all other settings. For example if you store authentication data in the 'drupal' database on 'localhost' the URL might look like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db-uri = jdbc:mysql://localhost/drupal?user=user&amp;password=passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>'--auth-db' stored just a connector name or connector implementation class. For convenience the Tigase has predefined short names for the most common connectors but you can always use the class name if you know it. And you have to use a class name if you want to attach your own authentication connector. The following 2 settings are equal:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db = tigase-auth</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db = tigase.db.jdbc.TigaseAuth</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the same exact way you can setup connector for any different database type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db = drupal</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db = tigase-custom</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can normally skip configuring connectors for the default Tigase database format: 'mysql', 'pgsql' and 'derby' as they are applied automatically if the parameter is missing.</p>
</div>
<div class="paragraph">
<p>One more important thing to know is that you also have to modify '--user-db-uri' if you use a custom authentication connector. This is because if you retrieve user login data from the external database this external database is usually managed by external system. User accounts are added without notifying the Tigase server. Then, when the user logins and tries to retrieve the user roster the server can not find such a user in the roster database.</p>
</div>
<div class="paragraph">
<p>To keep user accounts in sync between authentication database and the main user database you have to add following option to the end of the database connection URL: 'autoCreateUser=true'.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db-uri=jdbc:mysql://localhost/tigasedb?user=nobody&amp;password=pass&amp;autoCreateUser=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you are interested in even further customize you authentication connector by writing your own queries or stored procedures please have a look at 2 following guides:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;tigaseAuthConnector,////Tigase Auth guide</p>
</li>
<li>
<p>////&lt;&lt;custonAuthConnector,////Tigase Custom Auth guide</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_custom_auth_connector"><a class="anchor" href="#_tigase_custom_auth_connector"></a>69. Tigase Custom Auth Connector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>The Tigase Custom Auth connector with shortcut name: <strong>tigase-custom</strong> is implemented in the class: <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/db/jdbc/TigaseCustomAuth.java">tigase.db.jdbc.TigaseCustomAuth</a>. It allows you to connect to any external database to perform user authentication and use a custom queries for all actions..</p>
</div>
<div class="paragraph">
<p>You can find more details how to setup a custom connector in ////&lt;&lt;customAuthentication,////Custom Authentication Connectors guide.</p>
</div>
<div class="paragraph">
<p>The basic configuration is very simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db = tigase-custom
--auth-db-uri = jdbc:mysql://localhost/drupal?user=user&amp;password=passwd</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s it.</p>
</div>
<div class="paragraph">
<p>The connector loads correctly and starts working using predefined, default list of queries. In most cases you also want to define your own queries in the configuration file. The shortest possible description is the following example of the content from ////&lt;&lt;initPropertiesGuide,////init.properties file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># This query is used to check connection to the database, whether it is still alive or not
basic-conf/auth-repo-params/conn-valid-query=select 1

# This is database initialization query, normally we do not use it, especially in
# clustered environment
basic-conf/auth-repo-params/init-db-query=update tig_users set online_status = 0

# Below query performs user authentication on the database level.
# The Tigase server does not need to know authentication algorithm or password
# encoding type, it simply passes user id (BareJID) and password in form
# which was received from the client, to the stored procedure. If the
# authentication was successful the procedure returns user bare JID or null otherwise.
# The Tigase checks whether the JID returned from the query matches
# JID passed as a parameter. If they match, the authentication is successful.
basic-conf/auth-repo-params/user-login-query={ call TigUserLoginPlainPw(?, ?) }

# Below query returns number of user accounts in the database, this is mainly used
# for the server metrics and monitoring components.
basic-conf/auth-repo-params/users-count-query={ call TigAllUsersCount() }

# Below query is used to add a new user account to the database
basic-conf/auth-repo-params/add-user-query={ call TigAddUserPlainPw(?, ?) }

# Below query is used to remove existing account with all user's data from the database
basic-conf/auth-repo-params/del-user-query={ call TigRemoveUser(?) }

# This query is used for the user authentication if &quot;user-login-query&quot; is not defined,
# that is if there is no database level user authentication algorithm available. In such
# a case the Tigase server loads user's password from the database and compares it
# with data received from the client.
basic-conf/auth-repo-params/get-password-query=select user_pw from tig_users where user_id = ?

# Below query is used for user password update in case user decides to change his password
basic-conf/auth-repo-params/update-password-query=update tig_users set user_pw = ? where user_id = ?

# Below query is called on user logout event. Usually we use a stored procedure which
# records user logout time and marks user as offline in the database
basic-conf/auth-repo-params/user-logout-query=update tig_users, set online_status = online_status - 1 where user_id = ?

# This is configuration setting to specify what non-sasl authentication mechanisms
# expose to the client
basic-conf/auth-repo-params/non-sasl-mechs=password,digest

# This is configuration setting to specify what sasl authentication mechanisms expose to the client
basic-conf/auth-repo-params/sasl-mechs=PLAIN,DIGEST-MD5</code></pre>
</div>
</div>
<div class="paragraph">
<p>Queries are defined in the configuration file and they can be either plain SQL queries or stored procedures. If the query starts with characters: '\{ call' then the server assumes this is a stored procedure call, otherwise it is executed as a plain SQL query. Each configuration value is stripped from white characters on both ends before processing.</p>
</div>
<div class="paragraph">
<p>Please don&#8217;t use semicolon ';' at the end of the query as many JDBC drivers get confused and the query may not work for unknown reason.</p>
</div>
<div class="paragraph">
<p>Some queries take arguments. Arguments are marked by question marks '?' in the query. Refer to the configuration parameters description for more details about what parameters are expected in each query.</p>
</div>
<div class="paragraph">
<p>The first example shows how to put a stored procedure as a query with 2 required parameters.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">add-user-query={ call TigAddUserPlainPw(?, ?) }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same query with plain SQL parameters instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">add-user-query=insert into users (user_id, password) values (?, ?)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The order of the query arguments is important and must be exactly as described in specification for each parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'conn-valid-query' - Query executing periodically to ensure active connection with the database.</p>
<div class="paragraph">
<p>Takes no arguments.</p>
</div>
<div class="paragraph">
<p>Example query: 'select 1'</p>
</div>
</li>
<li>
<p>'init-db-query' - Database initialization query which is run after the server is started.</p>
<div class="paragraph">
<p>Takes no arguments.</p>
</div>
<div class="paragraph">
<p>Example query: 'update tig_users set online_status = 0'</p>
</div>
</li>
<li>
<p>'add-user-query' - Query adding a new user to the database.</p>
<div class="paragraph">
<p>Takes 2 arguments: (user_id (JID), password)</p>
</div>
<div class="paragraph">
<p>Example query: 'insert into tig_users (user_id, user_pw) values (?, ?)'</p>
</div>
</li>
<li>
<p>'del-user-query' - Removes a user from the database.</p>
<div class="paragraph">
<p>Takes 1 argument: (user_id (JID))</p>
</div>
<div class="paragraph">
<p>Example query: 'delete from tig_users where user_id = ?'</p>
</div>
</li>
<li>
<p>'get-password-query' - Rertieves user password from the database for given user_id (JID).</p>
<div class="paragraph">
<p>Takes 1 argument: (user_id (JID))</p>
</div>
<div class="paragraph">
<p>Example query: 'select user_pw from tig_users where user_id = ?'</p>
</div>
</li>
<li>
<p>'update-password-query' - Updates (changes) password for a given user_id (JID).</p>
<div class="paragraph">
<p>Takes 2 arguments: (password, user_id (JID))</p>
</div>
<div class="paragraph">
<p>Example query: 'update tig_users set user_pw = ? where user_id = ?'</p>
</div>
</li>
<li>
<p>'user-login-query' - Performs user login. Normally used when there is a special SP used for this purpose. This is an alternative way to a method requiring retrieving user password. Therefore at least one of those queries must be defined: user-login-query or get-password-query.</p>
<div class="paragraph">
<p>If both queries are defined then user-login-query is used. Normally this method should be only used with plain text password authentication or sasl-plain.</p>
</div>
<div class="paragraph">
<p>The Tigase server expects a result set with user_id to be returned from the query if login is successful and empty results set if the login is unsuccessful.</p>
</div>
<div class="paragraph">
<p>Takes 2 arguments: (user_id (JID), password)</p>
</div>
<div class="paragraph">
<p>Example query: 'select user_id from tig_users where (user_id = ?) AND (user_pw = ?)'</p>
</div>
</li>
<li>
<p>'user-logout-query' - This query is called when user logs out or disconnects. It can record that event in the database.</p>
<div class="paragraph">
<p>Takes 1 argument: (user_id (JID))</p>
</div>
<div class="paragraph">
<p>Example query: 'update tig_users, set online_status = online_status - 1 where user_id = ?'</p>
</div>
</li>
<li>
<p>'non-sasl-mechs' - Comma separated list of NON-SASL authentication mechanisms. Possible mechanisms are: password and digest. digest mechanism can work only with get-password-query active and only when password are stored in plain text format in the database.</p>
</li>
<li>
<p>'sasl-mechs' - Comma separated list of SASL authentication mechanisms. Possible mechanisms are all mechanisms supported by Java implementation. The most common are: PLAIN, DIGEST-MD5, CRAM-MD5.</p>
<div class="paragraph">
<p>"Non-PLAIN" mechanisms will work only with the get-password-query active and only when passwords are stored in plain text format in the database.   Application: Tigase Server</p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ldap_authentication_connector"><a class="anchor" href="#_ldap_authentication_connector"></a>70. LDAP Authentication Connector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2012-03-30 21:56</p>
</div>
<div class="paragraph">
<p>From version 5.1.0, rev. (build) 2881 Tigase XMPP Server offers support for authenticating users against LDAP server in <strong>Bind</strong> <strong>Authentication</strong> mode.</p>
</div>
<div class="paragraph">
<p>Configuration for the LDAP support is really simple. You have to add a few lines to your init.properties file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># LDAP Authentication connector
--auth-db = tigase.db.ldap.LdapAuthProvider
# LDAP connection URI
--auth-db-uri=ldap://ldap.tigase.com:389
# LDAP access parameters
basic-conf/auth-repo-params/user-dn-pattern=cn=USER_ID,ou=people,dc=tigase,dc=org</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please note the <strong>USER_ID</strong> element, this is a special element of the configuration which is used to authenticate particular user. Tigase LDAP connector replaces it with appropriate data during authentication. You can control what Tigase should put into this part. In your configuration you must replace this string with one of the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>%1$s</strong> - use user name only for authentication (JabberID&#8217;s localpart)</p>
</li>
<li>
<p><strong>%2$s</strong> - use domain name only for authentication (JabberID&#8217;s domain part)</p>
</li>
<li>
<p><strong>%3$s</strong> - use the whole Jabber ID (JID) for authentication</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_auth_connector"><a class="anchor" href="#_tigase_auth_connector"></a>71. Tigase Auth Connector</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:18</p>
</div>
<div class="paragraph">
<p>The Tigase Auth connector with shortcut name: <strong>tigase-auth</strong> is implemented in the class: <a href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/db/jdbc/TigaseAuth.java">tigase.db.jdbc.TigaseAuth</a>. It allows you to connect to any external database to perform user authentication.
You can find more details how to setup a custom connector in ////&lt;&lt;customAuthentication,////Custom Authentication Connectors guide.</p>
</div>
<div class="paragraph">
<p>To make this connector working you have to prepare your database to offer set of stored procedures for the Tigase server to perform all the authentication actions. The best description is the example schema with all the stored procedures defined. Please refer to the Tigase <a href="http://projects.tigase.org/server/trac/browser/trunk/database/">SVN repository</a> for the schema definition files.</p>
</div>
<div class="paragraph">
<p>Files with the stored procedures implementations are located in <a href="http://projects.tigase.org/server/trac/browser/trunk/database/mysql-schema-4-sp.schema">mysql-schema-4-sp.schema</a> for MySQL database and in <a href="http://projects.tigase.org/server/trac/browser/trunk/database/postgresql-schema-4-sp.schema">postgresql-schema-4-sp.schema</a> file for PostgreSQL database. You can also refer to the tables definition files to see how database is organized in our implementation: <a href="http://projects.tigase.org/server/trac/browser/trunk/database/mysql-schema-4.sql">mysql-schema-4.sql</a> file for MySQL database and <a href="http://projects.tigase.org/server/trac/browser/trunk/database/postgresql-schema-4.sql">postgresql-schema-4.sql</a> file for PostgreSQL database.</p>
</div>
<div class="paragraph">
<p>The absolute minimum of stored procedures you have to implement is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>TigUserLoginPlainPw</strong> - to perform user authentication. The procedure is always called when the user tries to login to the XMPP server. This is the only procedure which must be implemented and actually must work.</p>
</li>
<li>
<p><strong>TigUserLogout</strong> - to perform user logout. The procedure is always called when the user logouts or disconnects from the server. This procedure must be implemented but it can be empty and can do nothing. It just needs to exist because Tigase expect it to exist and attempts to call it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>With these 2 above stored procedures you can only perform user login/logout on the external database. You can&#8217;t register a user account, change user password or remove the user. In many cases this is fine as all the user management is handled by the external system.</p>
</div>
<div class="paragraph">
<p>If you however want to allow for account management via XMPP you have to implement also following procedures:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>TigAddUserPlainPw</strong> - to add a new user account</p>
</li>
<li>
<p><strong>TigRemoveUser</strong> - to remove existing user account</p>
</li>
<li>
<p><strong>TigUpdatePasswordPlainPw</strong> - to change a user password for existing account</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_version_3_x"><a class="anchor" href="#_tigase_server_version_3_x"></a>72. Tigase Server Version 3.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Admin manuals and guides for the Tigase server version 3.x line.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;connectingTigaseToMysql,////Connecting the Tigase Server to MySQL Database</p>
</li>
<li>
<p>////&lt;&lt;integrateWithDrupal,////Integrating Tigase Server with Drupal</p>
</li>
<li>
<p>////&lt;&lt;integrateWithLibreSource,////Integrating Tigase Server with LibreSource</p>
</li>
<li>
<p>////&lt;&lt;windowsInstallation,////Windows Installation</p>
</li>
<li>
<p>////&lt;&lt;windowsInstallation,////Instalacja Pod Windows</p>
</li>
<li>
<p>////&lt;&lt;3xconfiguration,////Configuration</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_the_tigase_server_to_mysql_database"><a class="anchor" href="#_connecting_the_tigase_server_to_mysql_database"></a>73. Connecting the Tigase Server to MySQL Database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Please before continuing reading of this manual have a look at the ////&lt;&lt;prepareMysql,////initial MySQL database setup. It will help you with database preparation for connecting the Tigase server.</p>
</div>
<div class="paragraph">
<p>The easiest way to setup the Tigase server for connecting with MySQL database is to use so called ////&lt;&lt;3xconfiguration,////configuration wizards (configuration generators) which release you from manually editing the XML configuration file and allow you quickly regenerate the XML configuration file in case of problems.</p>
</div>
<div class="paragraph">
<p>The article above describes the older way for using configuration generators which is a bit more difficult and doesn&#8217;t work on Windows system. The guide below describes a new way to use them which is simpler and can be applied for Windows systems as well. It is using init.properties file where you can put all your initial configuration parameters.</p>
</div>
<div class="paragraph">
<p>This guide describes MySQL database connection parameters.</p>
</div>
<div class="paragraph">
<p>Well the guide is actually very short as there are example configuration files which can be used and customized for your environment.</p>
</div>
<div class="paragraph">
<p>Unfortunately these files are not included yet in the server version 3.x binary release and you have to download them from the SVN repository using following links:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://svn.tigase.org/reps/tigase-server/trunk/etc/tigase-mysql.conf">tigase-mysql.conf</a> - the Tigase server startup file. The only difference from the default one is that it points to the file described below to load initial parameters.</p>
</li>
<li>
<p><a href="https://svn.tigase.org/reps/tigase-server/trunk/etc/init-mysql.properties">init-mysql.properties</a> - the file contains a few initial parameters which can/should be adjusted to your environment. Here is a content of the file with each line described:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># Load standard set of the server components.
# Look at the http://www.tigase.org/configuration-wizards
# document for other possible values. Normally you don't
# need to change this line.
config-type=--gen-config-def
# List of administrator accounts, please replace them with
# administrator accounts in your installation
--admins=admin@tigase.org,admin@test-d
# The line says that the database used by the Tigase server is 'mysql'
# Look at the configuration wizards article for different options
# You can also put here a Java class name if you have a custom
# implementation for a database connector.
--user-db=mysql
# The line contains the database connection string. This is database
# specific string and for each kind of database it may look differently.
# Below string is for MySQL database. Please modify it for your system.
# MySQL connector requires connection string in the following format:
# jdbc:mysql://[hostname]/[database name]?user=[user name]&amp;password=[user password]
--user-db-uri=jdbc:mysql://localhost/tigasedb?user=tigase_user&amp;password=mypass
# Virtual domains for your server installation, comma separated list of vhosts
--virt-hosts=tigase.org,test-d,localhost
# Select what packages you want to have logging switched for
# The below setting is recommended for the initail setup and it is required
# when asking for help with setting the server up
--debug=server</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Download both files and put them to your etc/ directory.</p>
</div>
<div class="paragraph">
<p>Edit the init-mysql.properties for your environment.</p>
</div>
<div class="paragraph">
<p>Remove the XML configuration file.</p>
</div>
<div class="paragraph">
<p>Start the server using following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/tigase.sh start etc/tigase-mysql.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Ask more questions if you got stuck or need any help with this.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_tigase_server_with_drupal"><a class="anchor" href="#_integrating_tigase_server_with_drupal"></a>74. Integrating Tigase Server with Drupal</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Tigase supports integration with Drupal on many levels. At the moment all stuff described below work with Drupal version 4.x and 5.x. They may also work with Drupal 6.x but this version hasn&#8217;t been tested.</p>
</div>
<div class="paragraph">
<p>First of all it can authenticate users against Drupal database which means you have the same user account for both Drupal website and XMPP (Jabber) server. More over in such a configuration all account management is done via Drupal web interface like account creation, password change update user details and so on. Administrator can temporarily disable user account and this is respected by the Tigase server too.</p>
</div>
<div class="sect2">
<h3 id="_connecting_to_drupal_database"><a class="anchor" href="#_connecting_to_drupal_database"></a>74.1. Connecting to Drupal Database</h3>
<div class="paragraph">
<p>The best way to setup Tigase with Drupal database is via configuration wizards that is init.properties file where you can put initial setting for Tigase configuration.</p>
</div>
<div class="paragraph">
<p>If you look in etc/ directory of your Tigase installation you should find a few files there. The one we want to base our configuration on is: init-mysql.properties. In some older packages the file might be missing, then you can download it from the <a href="https://svn.tigase.org/reps/tigase-server/trunk/etc/init-mysql.properties">SVN repository</a>.</p>
</div>
<div class="paragraph">
<p>If you look inside the file and strip all the comments you would see following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type=--gen-config-def
--admins=admin@tigase.org,admin@tigase.net
--user-db=mysql
--user-db-uri=jdbc:mysql://localhost/tigasedb?user=tigase_user&amp;password=mypass
--virt-hosts=tigase.org,tigase.net
--debug=server</code></pre>
</div>
</div>
<div class="paragraph">
<p>All you need to connect to Drupal database are 2 following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--auth-db=drupal
--auth-db-uri=jdbc:mysql://localhost/drupal?user=drupalusr&amp;password=drupalpass</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s combine it in a single file called etc/init-drupal.properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">config-type=--gen-config-def
--admins=admin@tigase.org,admin@tigase.net
--auth-db=drupal
--auth-db-uri=jdbc:mysql://localhost/drupal?user=drupalusr&amp;password=drupalpass
--user-db=mysql
--user-db-uri=jdbc:mysql://localhost/tigasedb?user=tigase_user&amp;password=mypass
--virt-hosts=tigase.org,tigase.net
--debug=server</code></pre>
</div>
</div>
<div class="paragraph">
<p>In theory you can load Tigase database schema to Drupal database and then both db-uris would have the same database connection string. More details about setting up and connecting to MySQL database can be found in the ////&lt;&lt;prepareMysql,//// MySQL guide.</p>
</div>
<div class="paragraph">
<p>You need also to edit etc/tigase.conf file to point to your newly created properties file. The last line which looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">TIGASE_OPTIONS=&quot; --property-file etc/init.properties &quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>should be changed to following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">TIGASE_OPTIONS=&quot; --property-file etc/init-drupal.properties &quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you have Java-6 installed and JAVA_HOME is set to correct location. If JAVA_HOME is not set you can add following line to etc/tigase.conf file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">JAVA_HOME=&quot;/your/java-6-location&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The best way to check whether the variable is set correctly is with command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ ls -l $JAVA_HOME/bin/java</code></pre>
</div>
</div>
<div class="paragraph">
<p>should list you the file without error.</p>
</div>
<div class="paragraph">
<p>Check also if logs/ directory is created in your Tigase server location as sometimes unpacking application doesn&#8217;t create empty directories.</p>
</div>
<div class="paragraph">
<p>Now when you have the configuration file and databases ready to use you can start the Tigase server with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the Tigase server installed from sources the command would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/tigase.sh start etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are system startup scripts for Gentoo and Mandriva Linux on bin/ or scripts/ directory which can be used to automatically start the server when system starts.</p>
</div>
<div class="paragraph">
<p>Now you can register an account on your Drupal website and connect with Jabber client using the account details.</p>
</div>
<div class="paragraph">
<p><strong>Note!</strong> <em>You have to enable plain password authentication in your Jabber client to connect to the Tigase server with Drupal database</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integrating_tigase_server_with_libresource"><a class="anchor" href="#_integrating_tigase_server_with_libresource"></a>75. Integrating Tigase Server With LibreSource</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p><strong>This document is still not finished.</strong></p>
</div>
<div class="paragraph">
<p>Taken directly from <a href="http://www.libresource.org/">LibreSource</a> page:</p>
</div>
<div class="paragraph">
<p><em>LibreSource is a collaborative platform dedicated to both software development and community building. Based on Java/J2EE technology, LibreSource is a modular web server that users can customize online by combining resources and rights: wiki pages, forum, trackers, files, download areas, etc. All the tools are included and integrated.</em></p>
</div>
<div class="sect2">
<h3 id="_short_introduction"><a class="anchor" href="#_short_introduction"></a>75.1. Short Introduction.</h3>
<div class="paragraph">
<p>Integration between <strong>Tigase</strong> server and <strong>LibreSource</strong> is on database level. It is implemented in the same way as integration with <strong>Drupal</strong> but with slightly more functions available.</p>
</div>
<div class="paragraph">
<p>Basically LibreSource system maintains own database with all it&#8217;s data and Tigase connects to LibreSource database to authenticate users. All users data specific to Jabber/XMPP service are kept in separate tables which can be located in the same database as LibreSource data or in different database.</p>
</div>
<div class="paragraph">
<p>Current list of features included in the integration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jabber users authentication against user data stored in LibreSource database.</p>
</li>
<li>
<p>Recording Jabber user on-line status in LibreSource database. This can be displayed on the Web page as additional user onfo.</p>
</li>
<li>
<p>Recording user last login time and this information can also be available on Web page.</p>
</li>
<li>
<p>Checking user account status. So if the user account is disabled in LibreSource system then this user will not be able to login to Jabber/XMPP service too.</p>
</li>
<li>
<p>User account creation. This feature might be useful during testing time or user data transition from old Tigase installation to LibreSource system. <em>Please note! This feature should be normally disabled on live system. All user account management should be done from LibreSource system because of data caching.</em></p>
</li>
<li>
<p>User account deletion. <em>Please note! This feature should be normally disabled on live system. All user account management should be done from LibreSource system because of data caching.</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A few assumptions:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>LibreSource data are kept in PostgreSQL database - libresource and database user is demo.</p>
</li>
<li>
<p>For use cases where Tigase data are stored in MySQL database name is tigase, database user is dbuser and database user password is dbpass</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_set_tigase_up"><a class="anchor" href="#_how_to_set_tigase_up"></a>75.2. How to set Tigase up.</h3>
<div class="paragraph">
<p>Now we will focus on setting things up to have both services up and running together. Below is example of the most complex environment to run where LibreSource is using PostgreSQL database and Tigase is using MySQL database. All basic user data needed for authentication are kept by LibreSource so Tigase has to connect to PostgreSQL database too to authenticate users.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>First you need LibreSource system up and running. Please refer to LS documentation for details.</p>
</li>
<li>
<p>Install Tigase server in the normal way including loading Tigase database schema. Database tables used by Tigase server use different naming convention so you can simply load Tigase DB schema to the same database as LibreSource data. It is also possible and recommended to keep Tigase data in separate database.</p>
</li>
<li>
<p>Using configuration wizards generate configuration for Tigase server to connect to LibreSource database. Here is the sample file with parameters for configuration wizard assuming following setup:</p>
<div class="ulist">
<ul>
<li>
<p>LibreSource data are kept in PostgreSQL database: libresource, user: demo</p>
</li>
<li>
<p>Tigase data are kept in MySQL database: tigase, user: dbuser, password: dbpass</p>
</li>
<li>
<p>No external components are connected to Tigase server</p>
</li>
<li>
<p>Tigase works for domain: domain.net</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver&quot;

JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;
TIGASE_CONFIG=&quot;etc/tigase-mysql-libresource.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-def \
  --user-db mysql \
  --user-db-uri jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&amp;autoCreateUser=true \
  --auth-db libresource \
  --auth-db-uri jdbc:postgresql://localhost/libresource?user=demo \
  --virt-hosts domain.net,localhost &quot;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>And simpler example where all data (LibreSource and Tigase) are stored in the same database:</p>
<div class="ulist">
<ul>
<li>
<p>LibreSource data are kept in PostgreSQL database: libresource, user: demo</p>
</li>
<li>
<p>Tigase data are kept also in PostgreSQL database: libresource, user: demo</p>
</li>
<li>
<p>No external components are connected to Tigase server</p>
</li>
<li>
<p>Tigase works for domain: domain.net</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=com.mysql.jdbc.Driver:org.postgresql.Driver&quot;

JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;
TIGASE_CONFIG=&quot;etc/tigase-mysql-libresource.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-def \
  --user-db pgsql \
  --user-db-uri jdbc:postgresql://localhost/libresource?user=demo&amp;autoCreateUser=true \
  --auth-db libresource \
  --auth-db-uri jdbc:postgresql://localhost/libresource?user=demo \
  --virt-hosts domain.net,localhost &quot;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, you can run Tigase in usual way and all works.</p>
</div>
<div class="paragraph">
<p><strong>Note!</strong> <em>In any case you have to load Tigase database schema for user data. Please refer to guide for specific database: ////&lt;&lt;mysql2database,////MySQL or ////&lt;&lt;postgresDB2,////PostgreSQL.</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_migration_from_old_tigase_installation_to_libresource"><a class="anchor" href="#_migration_from_old_tigase_installation_to_libresource"></a>75.3. Migration From old Tigase Installation to LibreSource</h3>
<div class="paragraph">
<p>Tigase package includes additional tools to make it easier to manage and control you installation. One is used to change configuration settings - config.sh and another is used to manipulate user data in repository - repo.sh.</p>
</div>
<div class="paragraph">
<p>Depending on whether you use Tigase version built from sources or binary version these scripts might be available in either scripts/ or bin/ subdirectory. To make things simpler let&#8217;s assume they are stored in scripts/ directory.</p>
</div>
<div class="paragraph">
<p>Assuming you have old Tigase server installation with number of users in MySQL database and you want to migrate all of them to LibreSource there are 2 steps involved:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User data migration</p>
</li>
<li>
<p>Changing your existing configuration</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_data_migration"><a class="anchor" href="#_data_migration"></a>75.3.1. Data Migration</h4>
<div class="paragraph">
<p>First we need to migrate user data used for authentication. That data will be used by both services: <em>LibreSource</em> and <em>Tigase</em> and they normally stored in <em>LibreSource</em> database. Therefore we have to use <em>LibreSource</em> database connector to handle the data (write or read). <em>Tigase</em> server will be using <em>LibreSource</em> database for reading only but during migration time we need to write user accounts to LS database. Sample command to migrate user accounts looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/repo.sh -sc tigase.db.jdbc.JDBCRepository \
  -su &quot;jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&quot; \
  -dc tigase.db.jdbc.LibreSourceAuth \
  -du &quot;jdbc:postgresql://localhost/libresource?user=demo&quot; \
  -cp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Above command will copy all user accounts from MySQL tigase database to libresource database. Please refer to repository management tool documentation for information how to migrate single or selected user accounts.</p>
</div>
<div class="paragraph">
<p>If you want to also keep all Tigase server data in the same database you have to copy also all other user data like rosters, vCards and so on.</p>
</div>
<div class="paragraph">
<p>First thing to do we have to load database schema for Tigase data. You don&#8217;t have to worry. Tigase tables have distinct names from LibreSource so there is no danger for any conflict. As in example above let&#8217;s assume LibreSource data are stored in libresource database and database user name is demo:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">psql -q -U demo -d libresource -f database/postgresql-schema.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can load transfer all user data from our MySQL database to LibreSource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/repo.sh -sc tigase.db.jdbc.JDBCRepository \
  -su &quot;jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&quot; \
  -dc tigase.db.jdbc.JDBCRepository \
  -du &quot;jdbc:postgresql://localhost/libresource?user=demo&quot; \
  -cp</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command looks almost the same as a previous one. Just Java class used for handling destination database is different.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_windows_installation"><a class="anchor" href="#_windows_installation"></a>76. Windows Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Tigase server installation The server installation should be started with downloading the Tigase server from our <a href="http://www.tigase.org/pl/filebrowser/tigase-server">download area</a>. This guide describes installation procedure for the branch 3.x of the server so please pick up the latest version of the Tigase 3.x.</p>
</div>
<div class="paragraph">
<p>The Windows binary package is an executable file containing installer. Run the file and the server will be installed and icons will be added to your Windows start menu. Locate the Tigase group in your menu and execute: "Install Tigase service" which will install the Tigase server as the system service and it will be automatically started whenever your system starts.</p>
</div>
<div class="paragraph">
<p>If you are going to use the Tigase server with MySQL database have a look now in the directory where the Tigase server is installed. There is a directory etc/. Have a look inside and find file called init.properties. Open the file with a text editor and make sure you added there 2 following lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">--user-db=mysql
--user-db-uri=jdbc:mysql://localhost/tigasedb?user=tigase_user&amp;password=mypass</code></pre>
</div>
</div>
<div class="paragraph">
<p>The content of the file should look like the example screenshot below:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/init_properties1.jpg" alt="init_properties1"></span></p>
</div>
<div class="sect2">
<h3 id="_mysql_database_installation"><a class="anchor" href="#_mysql_database_installation"></a>76.1. MySQL Database Installation</h3>
<div class="paragraph">
<p>The section describes installation and configuration of the MySQL database to work with Tigase server.</p>
</div>
<div class="paragraph">
<p>Download the binary package from MySQL download area at <a href="http://dev.mysql.com/downloads/mysql/5.0.html#win32">mysql.com</a>. Make sure you select executable proper for your operating system.</p>
</div>
<div class="paragraph">
<p>Run the installation program and follow default installation steps. When the installation is complete find the MySQL elements in the Windows Start menu and run the MySQL Configuration Wizard. Follow the wizard and make sure to check settings with screenshots in guide below.</p>
</div>
<div class="paragraph">
<p>In Welcome window just press 'Next'.(pic.1)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql1.JPG" alt="sql1"></span></p>
</div>
<div class="paragraph">
<p>In the next window select option: 'Detailed Configuration' and press 'Next' (pic. 2)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql2.JPG" alt="sql2"></span></p>
</div>
<div class="paragraph">
<p>On the next screen select option: 'Server Machine' and press 'Next' (pic. 3)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql3.JPG" alt="sql3"></span></p>
</div>
<div class="paragraph">
<p>On the forth windows leave the default" 'Multifunctional Database' and press 'Next' (pic. 4)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql4.JPG" alt="sql4"></span></p>
</div>
<div class="paragraph">
<p>On the step number five just press 'Next' using defaults. (pic. 5)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql5.JPG" alt="sql5"></span></p>
</div>
<div class="paragraph">
<p>Again, on window 6 select the default - 'Decision Support (DSS)/OLAP' and press 'Next' (pic.6)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql6.JPG" alt="sql6"></span></p>
</div>
<div class="paragraph">
<p>Make sure you switch OFF the 'Strict mode' and and press 'Next' (pic. 7)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql7.JPG" alt="sql7"></span></p>
</div>
<div class="paragraph">
<p>On the character encoding page select: 'Manual Selected Default Character set/ Collation' and  'utf8', press 'Next' (pic.8)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql8.JPG" alt="sql8"></span></p>
</div>
<div class="paragraph">
<p>On next window select 'Include Bin Directory in Windows PATH' and press 'Next' (pic.9)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql9.JPG" alt="sql9"></span></p>
</div>
<div class="paragraph">
<p>On this window just enter  the database super user password and make sure you remember it. When ready press 'Next' (pic. 10)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql10.JPG" alt="sql10"></span></p>
</div>
<div class="paragraph">
<p>This is the last screen. Press 'Execute' to save the configuration parameters. (pic. 11)</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/sql11.JPG" alt="sql11"></span></p>
</div>
<div class="paragraph">
<p>When the configuration is saved you can repeat all the step and change settings at any time by running: <strong>START &#8658; Programs &#8658; MYSQL&#8658; MYSQL serwer machine&#8658;  MySQL Server Instance Config Wizard</strong></p>
</div>
<div class="paragraph">
<p>Now we have to set Tigase database up. From the Start menu run the MySQL console and enter all commands below finishing them with <strong>&lt;ENTER&gt;</strong>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create the database:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">mysql&gt;<span class="class">create</span> <span class="type">database</span> tigasedb;</code></pre>
</div>
</div>
</li>
<li>
<p>Add database user:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user@'%' IDENTIFIED BY 'tigase_passwd';
mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user@'localhost' IDENTIFIED BY 'tigase_passwd';
mysql&gt; GRANT ALL ON tigasedb.* TO tigase_user IDENTIFIED BY 'tigase_passwd';
mysql&gt; FLUSH PRIVILEGES;</code></pre>
</div>
</div>
</li>
<li>
<p>Load Tigase database schema:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">mysql&gt; use tigasedb;
mysql&gt; source c:/Program Files/Tigase/database/mysql-schema.sql;</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>There is a small configuration bug in the installation of the version 3.x. If you look in the <strong>run.bat</strong> file in the Tigase directory you have to replace string <strong>inital.propereties</strong> with <strong>init.properties</strong>.</p>
</div>
<div class="paragraph">
<p>You can now restart your machine and all services including the MySQL database and the Tigase server should be running. Alternatively if you don&#8217;t want to restart your computer you can start both services manually if you know how to do it.</p>
</div>
<div class="paragraph">
<p>When the system is up and running you can connect with any Jabber client (Psi for example) to your server to see if it is working.</p>
</div>
<div class="paragraph">
<p>Now, you can tweak the server configuration further. Use the ////&lt;&lt;initPropertiesGuide,////guide describing init.properties file for configuration details.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_5"><a class="anchor" href="#_configuration_5"></a>77. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>This section contains the Tigase server configuration manuals and guides.</p>
</div>
<div class="paragraph">
<p><em>Please note, this guides are for the Tigase server 2.x line which is no longer supported. Please upgrade to the last stable version and contact us if you have any problems.</em></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_wizards"><a class="anchor" href="#_configuration_wizards"></a>78. Configuration Wizards</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>From the build #247 you can use configuration generators to easily and quickly create configuration file for even complex case.</p>
</div>
<div class="paragraph">
<p><strong>Tigase</strong> configuration is not too easy to understand and maintain. Even with current command line tools you still have to know what the all options are for.</p>
</div>
<div class="paragraph">
<p>To make it easier for average administrators or people who run the server for the first time or even for those who want to quickly test <strong>Tigase</strong> server in different scenarios configuration generators have been created. For each generator you can have also a few extra options which allows you to create configuration which you don&#8217;t need to change for some time.</p>
</div>
<div class="paragraph">
<p>A few definitions first to make it easier to read the rest:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>sm</strong> - session manager component.</p>
</li>
<li>
<p><strong>c2s</strong> - client connection manager component</p>
</li>
<li>
<p><strong>s2s</strong> - server connection manager component</p>
</li>
<li>
<p><strong>ext2s</strong> - external component connection manager</p>
</li>
<li>
<p><strong>ssender</strong> - ////&lt;&lt;genericStanzaSender,////StanzaSender component</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The are 4 generators currently available:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>--gen-config-all - creating configuration file with all available components. That is: sm, c2s, s2s, ext2s, ssender.</p>
</li>
<li>
<p>--gen-config-default - creating default configuration file. That is configuration which is most likely needed for basic installation. Components included in configuration are: sm, c2s, s2s.</p>
</li>
<li>
<p>--gen-config-sm - creating configuration for instance with session manager and external component only. This is useful for distributed installation where you want to have session manager installed on separate machine and components managing network connections on different machines (one or more). Components included in configuration are: sm and ext2s.</p>
</li>
<li>
<p>--gen-config-cs - creating configuration for instance with components managing network connections. This is useful for distributed installation where you want to have session manager installed on separate machine and components managing network connections on different machines (one or more). Components included in configuration are: c2s, s2s, ext2s.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For each of above generator you can use additional parameters specifying other configuration details like database type you want to connect to, virtual hosts you want to support, administrator accounts and details for external component connection:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>--user-db db-type - where 'db-type' can be one of possible values: <strong>mysql, pgsql, xml</strong></p>
</li>
<li>
<p>--user-db-uri connection-uri - where 'connection-uri' is a full resource uri for user repository data source. If you skip this parameter default value is used depending on database type you selected:</p>
<div class="literalblock">
<div class="content">
<pre>-- jdbc:mysql://localhost/tigase?user=root&amp;password=mypass
-- jdbc:postgresql://localhost/tigase?user=tigase
-- user-repository.xml</pre>
</div>
</div>
</li>
<li>
<p>--auth-db db-type - where 'db-type' can be one of possible values: <strong>mysql, pgsql, xml, drupal, libresource</strong> (If omitted 'user-db' settings are used.)</p>
</li>
<li>
<p>--auth-db-uri connection-uri - where 'connection-uri' is a full resource uri for user repository data source. (If omitted 'user-db-uri' settings are used.)</p>
</li>
<li>
<p>--ext-comp connection-string - possible values: connection string 'localdomain,remotedomain,port,passwd,plain/ssl,accept/connect,routing'</p>
<div class="paragraph">
<p><strong>Note:</strong> It is also possible to generate configuration for many external components. To do so place --ext-comp_1 'parameters' --ext-comp_2 'parameters' and so on&#8230;&#8203;</p>
</div>
</li>
<li>
<p>--virt-hosts virtual-hosts-list - possible values: list of virtual domains to support 'domain1,domain2'. This option causes to use virtual hosts given here instead of default/automatically detected host names.</p>
</li>
<li>
<p>--admins admin-accounts-list - possible values: list of admin accounts: 'user1@domain,user2@domain2'</p>
</li>
<li>
<p>--test - this parameter informs that config is generated for test instance, which means that all loggings are turned off</p>
</li>
<li>
<p>--debug tigase-package - you can turn on debugs log for selected tigase package. For example if you want to turn debug logs on for package: <strong>tigase.server</strong> then you have to put parameter: --debug server. If you have any problems with your server the best way to get help from me is to generate configuration with --debug server and run the server. Then from the logs/tigase-console.log log file I can get all information I need to give you a help.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Note!</strong> <em>If configuration file already exists none of existing settings are overwritten. Configuration generator is activated only if config file does not exist at program startup or for config entries which are missing at startup time. So you can as well leave these settings in the file.</em></p>
</div>
<div class="paragraph">
<p><strong>Note!</strong> tigase.conf <em>property file is NOT read by the tigase server. These properties are read by the bash shell to create proper tigase server startup command. It will not work on MS Windows unless you run it in bash (using CygWin for example). On windows however you can use configuration wizards too by preparing proper server startup command manually. For example command for the first below presented conf file would look like (all in single line):</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">java -Djdbc.drivers=org.postgresql.Driver
 -Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8
 -server -Xms100M -Xmx100M
 -cp &quot;libs/pg73jdbc3.jar;jars/tigase-server.jar;libs/tigase-xmltools.jar;libs/tigase-utils.jar&quot;
 tigase.server.XMPPServer
 -c &quot;etc/tigase.xml&quot;
 --gen-config-def --user-db pgsql
 --user-db-uri &quot;jdbc:postgresql://localhost/tigase?user=tigase&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>So for example to take advantage of these options you can create tigase.conf and start Tigase server with usual command to generate ''tigase-config.xml'' configuration file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/tigase.sh run tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>A few sample files are included below for your convenience:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>tigase-def-pgsql.conf - default installation with PostgreSQL database support:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=org.postgresql.Driver&quot;
JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;

TIGASE_CONFIG=&quot;tigase-pgsql.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-def --user-db pgsql --user-db-uri jdbc:postgresql://localhost/tigase?user=tigase &quot;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=org.postgresql.Driver&quot;
JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;

TIGASE_CONFIG=&quot;tigase-pgsql.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-def --user-db pgsql &quot;</code></pre>
</div>
</div>
</li>
<li>
<p>tigase-cs.conf - installation of network connections management components (no DB is used by this instance):</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
JAVA_OPTIONS=&quot;${ENC} -server -Xms100M -Xmx100M &quot;

TIGASE_CONFIG=&quot;etc/tigase-cs.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-cs --virt-hosts cs.tigase.org,tigase.org,sm.tigase.org \
  --ext-comp cs.tigase.org,sm.tigase.org,5678,very-secret,plain,connect&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>tigase-sm-mysql.conf - installation of session manager instance and resource connection string is the same as default so we can skip '--user-db-uri' parameter:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ENC=&quot;-Dfile.encoding=UTF-8 -Dsun.jnu.encoding=UTF-8&quot;
DRV=&quot;-Djdbc.drivers=com.mysql.jdbc.Driver&quot;

JAVA_OPTIONS=&quot;${ENC} ${DRV} -server -Xms100M -Xmx100M &quot;
TIGASE_CONFIG=&quot;etc/tigase-sm-mysql.xml&quot;
TIGASE_OPTIONS=&quot;--gen-config-sm --user-db mysql --auth-db mysql --virt-hosts tigase.org,sm.tigase.org \
  --ext-comp sm.tigase.org,cs.tigase.org,5678,very-secret,plain,accept&quot;</code></pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_tigase_server_version_2_x"><a class="anchor" href="#_tigase_server_version_2_x"></a>79. Tigase Server version 2.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Administration manuals and guides for the Tigase server 2.x line.</p>
</div>
<div class="paragraph">
<p><em>Please note, this guides are for the Tigase server 2.x line which is no longer supported. Please upgrade to the last stable version and contact us if you have any problems.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;installation2,////Installation</p>
</li>
<li>
<p>////&lt;&lt;mysql2database,////MySQL Database Use</p>
</li>
<li>
<p>////&lt;&lt;postgresDB2,////PostgreSQL Database Use</p>
</li>
<li>
<p>////&lt;&lt;configuration2,////Configuration</p>
</li>
<li>
<p>////&lt;&lt;commandLineTools2,////Command Line Admin Tools</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_3"><a class="anchor" href="#_installation_3"></a>80. Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>To get server up and running you have to download from our site the most recent version of the binary package.</p>
</div>
<div class="paragraph">
<p>Unpack it with the following command:</p>
</div>
<div class="paragraph">
<p>On Unix like system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">tar -xzvf tigase-server-x.x.x-bx.tar.gz</code></pre>
</div>
</div>
<div class="paragraph">
<p>On MS Windows system use any application which can handle either zip files or tar.gz files and unpack server package to selected directory.</p>
</div>
<div class="paragraph">
<p>Sometimes after unpacking package on unix system startup script doesn&#8217;t have execution permissions. To fix the problem you have to run following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">chmod u+x ./bin/tigase.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>As there are also other useful scripts you could just set executable bit for all of them at the same time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">chmod u+x ./bin/*</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now all you need is <em>Java 6 (1.6 beta2 at the moment)</em> compliant virtual machine. You can run server from command line with simple command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/tigase.sh run etc/tigase.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see now a few messages with warning about missing configuration file and missin user repository file. These 2 files will be automaticaly created. Config file will be created just during first execution of the server and user repository file will be created when the first user is added to the system.</p>
</div>
<div class="paragraph">
<p>You should be able now to connect to the server with Jabber/XMPP client of your choice.</p>
</div>
<div class="paragraph">
<p>First parameter is a command, second parameter is a config file for startup script. Possible commands are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>start</strong> - Starts server in background redirecting all console messages to separate log file.</p>
</li>
<li>
<p><strong>stop</strong> - Stops the last started server Be carefull with this command if the server has been stopped in different way but the script still thinks the server is running. The script detects that the server has been started by looking for tigase.pid file. Then it reads server PID from the file and sends kill signal to the process. It may happen that the server is not running but there is another process with this PID. If you know that you server is not running but the script claims it is, it means that the script finds old tigase.pid file. In such case to make it possible to start server again you should either remove the file manually or run script with <strong>zap</strong> command.</p>
</li>
<li>
<p><strong>run</strong> - Starts the server as foreground process with all console messages printed onto console. To stop the server simply press Ctrl-C. It does not create tigase.pid file.</p>
</li>
<li>
<p><strong>restart</strong> - Restarts currently running server. It simply calls the script first with stop command and then with start command.</p>
</li>
<li>
<p><strong>check</strong> - This commands simply prints all the settings which would be used to start or stop the server. It is strongly recommended to use this command before the first server run.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Config file for startup script simply sets number of environment variables with location of required components. Possible  variables to set in this file are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>JAVA_HOME</strong> - location of Java installation home directory. <strong>Must be set</strong>.</p>
</li>
<li>
<p><strong>TIGASE_HOME</strong> - location of Tigase installation home directory. <em>By default script try to find this location by searching directories from the location where the script has been run.</em></p>
</li>
<li>
<p><strong>TIGASE_CONSOLE_LOG</strong> - file to which all console messages will be redirected if server is run in background. By default it will be: TIGASE_HOME/logs/tigase-console.log. <strong>If this file/directory is not writable by Tigase process all console messages will be redirected to /dev/null</strong></p>
</li>
<li>
<p><strong>TIGASE_PID</strong> location of the file with server PID number. By default it will be TIGASE_HOME/logs/tigase.pid.</p>
</li>
<li>
<p><strong>TIGASE_CONFIG</strong> - location of the Tigase server config file. This is main config XML file. Not to be confused with startup script parameters file. <em>If not set script trys to find it in following locations in given order:</em> /etc/conf.d/tigase-server.xml, /etc/tigase-server.xml, /etc/tigase/tigase-server.xml <em>or finally in</em> TIGASE_HOME/etc/tigase-server.xml</p>
</li>
<li>
<p><strong>JAVA_OPTIONS</strong> - options for JVM like size of RAM allocated for the JVM, properties and so on.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can now proceed to configuration section. Although in simple case installations most of default options should be correct sometimes you need to change server domain name if automatic detection didn&#8217;t work.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_mysql_database_use"><a class="anchor" href="#_mysql_database_use"></a>81. MySQL Database Use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>This guide describes how to configure Tigase server to use <a href="http://www.mysql.com/">MySQL</a> database as user repository.</p>
</div>
<div class="paragraph">
<p>If you used XML based user repository before you can copy all user data to MySQL database using repository management tool. All steps are described below.</p>
</div>
<div class="sect2">
<h3 id="_mysql_database_preparation"><a class="anchor" href="#_mysql_database_preparation"></a>81.1. MySQL Database Preparation</h3>
<div class="paragraph">
<p>To load db schema to your MySQL instance first create database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysqladmin -p create tigase</code></pre>
</div>
</div>
<div class="paragraph">
<p>And then you can load database schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">mysql -u dbuser -p tigase &lt; mysql-schema.sql</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_server_configuration"><a class="anchor" href="#_server_configuration"></a>81.2. Server Configuration</h3>
<div class="paragraph">
<p>Now you have to change configuration to load jdbc module instead of XML based repository. Using configuration management script, first change class name handling repository.</p>
</div>
<div class="paragraph">
<p>To see current settings run command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ ./scripts/config.sh -c tigase-config.xml -print -key session_1/user-repo-class</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result you should see something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">session_1/user-repo-class = tigase.db.xml.XMLRepository</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that current setting points to XML repository implementation. To use jdbc module for connection to MySQL database you have to set tigase.db.jdbc.JDBCRepository class (enter text below in one line):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ ./scripts/config.sh -c tigase-config.xml -print
      -key session_1/user-repo-class -value tigase.db.jdbc.JDBCRepository -set</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result you will see new value set for the parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/user-repo-class = tigase.db.jdbc.JDBCRepository</code></pre>
</div>
</div>
<div class="paragraph">
<p>You have also to set the same value as authorization repository unless you want to use different authorization data source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ ./scripts/config.sh -c tigase-config.xml -print
      -key session_1/auth-repo-class -value tigase.db.jdbc.JDBCRepository -set</code></pre>
</div>
</div>
<div class="paragraph">
<p>And again as a result we can see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/auth-repo-class = tigase.db.jdbc.JDBCRepository</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next step is to set database connection string. Assuming you have database: <strong>tigase</strong> on <strong>localhost</strong> with database user: <strong>dbuser</strong> and password <strong>dbpass</strong> your connection string will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass</code></pre>
</div>
</div>
<div class="paragraph">
<p>To set this in your configuration file you have to call again configuration management script 2 times. First for user data repository and second for authorization data repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ ./scripts/config.sh -c tigase-config.xml -print -key session_1/user-repo-url
       -value &quot;jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&quot; -set
$ ./scripts/config.sh -c tigase-config.xml -print -key session_1/auth-repo-url
       -value &quot;jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&quot; -set</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note quotes around connection string. They are needed to make sure shell won&#8217;t interpret special characters.</p>
</div>
<div class="paragraph">
<p>Now your configuration is ready to load jdbc module and connect to your database.</p>
</div>
<div class="paragraph">
<p>One more thing you need to do is to tell JVM which jdbc driver to use to connect to database. Depending on your MySQL and jdbc installation it might be: com.mysql.jdbc.Driver. To set is as database driver you have to set is a jdbc.drivers property value. Usually you do this by adding -D parameter to Java call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"> $ java -Djdbc.drivers=com.mysql.jdbc.Driver tigase.server.XMPPServer</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use tigase.sh script to run server you have to add -Djdbc.drivers=com.mysql.jdbc.Driver to startup script &lt;initProperties,property file&gt;&gt; to JAVA_OPTIONS values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_user_data_import"><a class="anchor" href="#_user_data_import"></a>81.3. User Data Import</h3>
<div class="paragraph">
<p>If you previously used XML based user repository you can import all data into MySQL database using repository management tool. This is quite long command so let me list all required parameters first with brief explanation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>-cp</strong> copy content of the source repository to destination repository.</p>
</li>
<li>
<p><strong>-sc</strong> <strong>tigase.db.xml.XMLRepository</strong> source repository class.</p>
</li>
<li>
<p><strong>-su</strong> <strong>user-repository.xml</strong> source repository connection string - assuming your user repository is in user-repository.xml file.</p>
</li>
<li>
<p><strong>-dc</strong> <strong>tigase.db.jdbc.JDBCRepository</strong> destination repository class.</p>
</li>
<li>
<p><strong>-du</strong> <strong>"jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass"</strong> destination repository connection string.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>And now whole command. Enter all in one line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">$ ./scripts/repo.sh -cp -sc tigase.db.xml.XMLRepository -su user-repository.xml
      -dc tigase.db.jdbc.JDBCRepository
      -du &quot;jdbc:mysql://localhost/tigase?user=dbuser&amp;password=dbpass&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information how to use command line administration tools refer to ////&lt;&lt;commandLineTools2,////command line tools guide.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgresql_database_use"><a class="anchor" href="#_postgresql_database_use"></a>82. PostgreSQL Database Use</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>This guide describes how to configure Tigase server to use <a href="http://www.postgresql.org/">PostgreSQL</a> database as user repository.</p>
</div>
<div class="paragraph">
<p>If you used XML based user repository before you can copy all user data to PostgreSQL database using repository management tool. All steps are described below.</p>
</div>
<div class="sect2">
<h3 id="_postgresql_database_preparation"><a class="anchor" href="#_postgresql_database_preparation"></a>82.1. PostgreSQL Database Preparation</h3>
<div class="paragraph">
<p>Create new database user account which will be used to connect to your database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># createuser
Enter name of user to add: tigase
Shall the new user be allowed to create databases? (y/n) y
Shall the new user be allowed to create more new users? (y/n) y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now using new database user account create database for your service:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># createdb -U tigase tigasedb
CREATE DATABASE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you can load <a href="http://server.tigase.org/browser/trunk/database/postgresql-schema.sql">database schema</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh"># psql -U tigase -d tigasedb -f postgresql-schema.sql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now database is ready for Tigase server to use it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_server_configuration_2"><a class="anchor" href="#_server_configuration_2"></a>82.2. Server Configuration</h3>
<div class="paragraph">
<p>Server configuration is identical as for MySQL database setup. The same jdbc module is used to connect to PostgreSQL database as for MySQL. The only difference is connection string which usually looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">jdbc:postgresql://localhost/tigasdb?user=tigase</code></pre>
</div>
</div>
<div class="paragraph">
<p>So for more detailed guide how to change configuration refer to ////&lt;&lt;mysql2database,////MySQL database use guide or if you look for more automatic config file generation refer to ////&lt;&lt;3xconfiguration,////configuration wizards page.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_6"><a class="anchor" href="#_configuration_6"></a>83. Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>This section contains documentation about the Tigase server configuration.</p>
</div>
<div class="paragraph">
<p><em>Please note, this guides are for the Tigase server 2.x line which is no longer supported. Please upgrade to the last stable version and contact us if you have any problems.</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>////&lt;&lt;shortConfigurationGuide2,////Short Configuration Guide</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_short_configuration_guide"><a class="anchor" href="#_short_configuration_guide"></a>84. Short Configuration Guide</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Options you most likely have to change at deployment time are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Admin</strong> <strong>accounts</strong> -  account names where all admin messages are sent.</p>
</li>
<li>
<p><strong>Hostnames</strong> -  real and virtual hostnames your server has to serve for.</p>
</li>
<li>
<p><strong>Logs</strong> - setting related to log file location and how much information should be logged there.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Please let me know if you think more options should be described here.</p>
</div>
<div class="paragraph">
<p><strong>Changing configuration using command line tool.</strong></p>
</div>
<div class="paragraph">
<p>Detailed description of configuration management tool in on project site on the: ////&lt;&lt;configurationManagement2,////Configuration management tool page.</p>
</div>
<div class="sect2">
<h3 id="_admin_accounts_2"><a class="anchor" href="#_admin_accounts_2"></a>84.1. Admin Accounts</h3>
<div class="paragraph">
<p>This is the most likely thing to change after you install server and generate default configuration. Actually it is also the easiest option to customize.</p>
</div>
<div class="paragraph">
<p>And yes, you can just remove entry with admin account: "admin@localhost" unless you really want to keep it. Be aware though all system messages will be sent to <strong>ALL</strong> admin accounts.</p>
</div>
<div class="paragraph">
<p>Well, if the account does not exists the message is discarded and a warning is be printed in log file. Again, read it again, the previous sentence&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>It means that the admin account has to be also created in normal way on the Jabber server. Just register it using your Jabber client. The admin accounts setting works just as a forward instruction. So as a result all system and admin messages are forwarded to all admin accounts if they exist.</p>
</div>
<div class="paragraph">
<p>Obviously you can have as many admin accounts as you like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/admins = frank@jabber.example.com, lucy@jabber.example.com,
    mark@jabber.example.com, brenda@jabber.example.com, luck@jabber.example.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, how to do it. First things is to find current settings. To see what are current admin accounts execute the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print -key session_1/admins</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result you can see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/admins = admin@yourhost, admin@localhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you could read in configuration management too guide '-add' command adds new entries to the list, '-set' command removes old values and sets new one.</p>
</div>
<div class="paragraph">
<p>As we want to create new admins list for the installation first command would be '-set' command. Let&#8217;s say we want set jack@yourhost as your first admin account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print -key session_1/admins -set -value &quot;jack@yourhost&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result program prints new setting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/admins = jack@yourhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>All old accounts have been replaced with new account. Now if you wich to add next admin account john@yourhost to the list execute slightly modified command (Note - '-add' instead of '-set'):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print -key session_1/admins -add -value &quot;john@yourhost&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">session_1/admins = jack@yourhost, john@yourhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>And&#8230;&#8203; this is it. You can add more admin accounts the same way.</p>
</div>
</div>
<div class="sect2">
<h3 id="_hostnames_2"><a class="anchor" href="#_hostnames_2"></a>84.2. Hostnames</h3>
<div class="paragraph">
<p>This one might be a little bit more tricky than previous as <strong>hostnames</strong> setting has to be changed in a few places. Don&#8217;t ask why now as this is the "<em>Short configuration guide</em>", you remember. Here we focus on <strong>how</strong> not on <strong>why</strong>.</p>
</div>
<div class="paragraph">
<p>The best way to find all places where hostnames should be changes execute following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print | grep hostnames</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a result you can see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">tigase-xmpp-server/hostnames = yourhost, localhost
client_1/hostnames = yourhost, localhost
server_1/hostnames = yourhost, localhost
session_1/hostnames = yourhost, localhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>It may also look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">tigase-xmpp-server/hostnames = localhost
client_1/hostnames = localhost
server_1/hostnames = localhost
session_1/hostnames = localhost</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending how successful was mechanism for automatic hostname detection. It of course does not depends on your luck. It depends on network configuration on your server.</p>
</div>
<div class="paragraph">
<p>The first form is more useful as it includes also hostname recognized in network environment. If it is correct then you can just leave it as it is. If it is incorrect you have to change it. Please remember, if you want your server to be able to communicate with other <em>Jabber/XMPP</em> servers the hostname you put there must resolve in DNS to your Jabber server machine IP address. In other words. If you try to connect from the Internet to machine with this hostname the connection should reach your Jabber server.</p>
</div>
<div class="paragraph">
<p>And remember your Jabber server users' JIDs (<em>Jabber IDs</em>) can include only those hostnames which are included in the configuration. So for our case you can use only <em>JIDs</em>: "user2@your.hostname.com", "user1@your.hostname.com" and so on.</p>
</div>
<div class="paragraph">
<p>If you server have more Internet addresses (virtual domains) assigned to it your Jabber server can use them all. So your configuration may look ike:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">tigase-xmpp-server/hostnames = yourhost, localhost, your.hostname.com, clien1.hostname.com
client_1/hostnames = yourhost, localhost, your.hostname.com, clien1.hostname.com
server_1/hostnames = yourhost, localhost, your.hostname.com, clien1.hostname.com
session_1/hostnames = yourhost, localhost, your.hostname.com, clien1.hostname.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>In such case users' <em>JIDs</em> on your Jabber server may include any of defined above domains like: "<a href="mailto:user1@your.hostname.com">user1@your.hostname.com</a>", <em>"<a href="mailto:user1@clien1.hostname.com">user1@clien1.hostname.com</a>",</em> <em>"user1@yourhost".</em> Each of these 3 sample <em>JIDs</em> refer to different user account.</p>
</div>
<div class="paragraph">
<p>Your server will accept connections only for domains defined in configuration file.</p>
</div>
<div class="paragraph">
<p>In majority cases it does not matter whether you leave <strong>"localhost"</strong> or remove it. It is sometimes better to leave it though. So if you are not sure if you can remove it in your environment just leave it as is.</p>
</div>
<div class="paragraph">
<p>Now it is a time to change hostnames. Assuming default configuration is not what you need than first you have to set all these settings to accept connections from localhost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print -key tigase-xmpp-server/hostnames -value localhost -set
./bin/config.sh -c etc/tigase-server.xml -print -key client_1/hostnames -value localhost -set
./bin/config.sh -c etc/tigase-server.xml -print -key server_1/hostnames -value localhost -set
./bin/config.sh -c etc/tigase-server.xml -print -key session_1/hostnames -value localhost -set</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can add you "real" host name, let&#8217;s say it is yourhost:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./bin/config.sh -c etc/tigase-server.xml -print -key tigase-xmpp-server/hostnames -value yourhost -add
./bin/config.sh -c etc/tigase-server.xml -print -key client_1/hostnames -value yourhost -add
./bin/config.sh -c etc/tigase-server.xml -print -key server_1/hostnames -value yourhost -add
./bin/config.sh -c etc/tigase-server.xml -print -key session_1/hostnames -value yourhost -add</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same way you can add more virtual hosts to you configuration.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_command_line_admin_tools"><a class="anchor" href="#_command_line_admin_tools"></a>85. Command Line Admin Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Two command line tools have been created to make it easier to manage server configuration and user repository.</p>
</div>
<div class="paragraph">
<p>Configuration tool allows to look at configuration settings and modify parameters. It takes care about proper parameters types and encoding.</p>
</div>
<div class="paragraph">
<p>Repository management tool allows to print repository content for all or for selected users. Modify repository data, add, delete users and copy data from one repository to another.</p>
</div>
<div class="paragraph">
<p>This guide describe how to efficiently use command line tools which are available for user repository and configuration management.</p>
</div>
<div class="paragraph">
<p>These 2 command line tools for managing configuration and repository are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://server.tigase.org/browser/trunk/scripts/config.sh">config.sh</a> for configuration management.</p>
</li>
<li>
<p><a href="http://server.tigase.org/browser/trunk/scripts/repo.sh">repo.sh</a> for repository management.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Both scripts call class from Tigase package. If you run any of those script with <strong>-h</strong> parameter you will get help screen describing all available parameters.</p>
</div>
<div class="paragraph">
<p>I will not concentrate on that help information which is easily accessible anyway. This guide will focus on particular use cases. So it will answer to questions: "How to do it with the tool?".</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_management_tool"><a class="anchor" href="#_configuration_management_tool"></a>86. Configuration Management Tool</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Artur Hefczyc &lt;<a href="mailto:artur.hefczyc@tigase.net">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2010-04-06 21:16</p>
</div>
<div class="paragraph">
<p>Configuration tool allows to look at configuration settings and modify parameters. It takes care about proper parameters types and encoding.</p>
</div>
<div class="paragraph">
<p>First answer to the question: "Why to use configuration tool instead of directly, manually edit config file?"</p>
</div>
<div class="paragraph">
<p>There are a couple of reason why you should NOT manually edit configuration file and use the tool to modify settings:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configuration is kept in XML file which can be easily broken if not edited carefully. The tool takes care of creating valid XML configuration file for you. So you can focus on your task - setting proper parameters for your server.</p>
</li>
<li>
<p>Configuration values are kept <strong>UUEncoded</strong> in config file. If you edit file manually you have to take care fo proper encoding special characters. The tool presents parameters to you in decoded form which is easy to read and accept all settings also in decoded form which is easier for you to write. Then when writing your parameters to configuration file settings are automaticly encoded to correct form.</p>
</li>
<li>
<p>Data in configuration file have <strong>TYPES</strong>. That is some parameters are expected to be <strong>Strings</strong> other are expected to be <strong>Integers</strong>, <strong>Booleans</strong> or arrays keeping data in any of that type. If data type is set incorrectly then server may have problems with reading configuration data. Configuration tool takes care of propert data type in configuration file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Configuration management tool is a Java class - <a href="http://server.tigase.org/browser/trunk/src/tigase/conf/Configurator.java">tigase.conf.Configurator</a>. To make it easier to use this class there is also shell script available - <a href="http://server.tigase.org/browser/trunk/scripts/config.sh">config.sh</a>.</p>
</div>
<div class="paragraph">
<p>First thing you can do is running the script with -h parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">./scripts/config.sh -h</code></pre>
</div>
</div>
<div class="paragraph">
<p>In response you get description of all available parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sh">Parameters:
 -h             this help message
 -c file        configuration file
 -key key       node/key for the value to set
 -value value   value to set in configuration file
 -set           set given value for given key
 -add           add given value to the values list for given key
 -print         print content of all configuration settings or of given node/key
 -f             force creation of the new property - dangerous option...
Samples:
 Setting admin account - overwriting any previous value(s)
 $ ./scripts/config.sh -c tigase-config.xml -print -set -key session_1/admins -value admin1@localhost
 Adding next admin account leaving old value(s)
 $ ./scripts/config.sh -c tigase-config.xml -print -add -key session_1/admins -value admin2@localhost

Note: adding -print option is useful always, even with -set or -add
      option as it prints set value afterwards.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s assume configuration for your server is located in <strong>tigase-config.xml</strong> file. So the first thing you need to set when calling the tool is location of the configuration file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best_practices_for_connecting_from_web_browser_to_tigase_xmpp_server"><a class="anchor" href="#_best_practices_for_connecting_from_web_browser_to_tigase_xmpp_server"></a>87. Best Practices for Connecting From Web Browser to Tigase XMPP Server</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Andrzej Wojcik &lt;<a href="mailto:andrzejw@tigase.org">andrzejw@tigase.org</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a href="http://tigase.net" class="bare">http://tigase.net</a>
:Date: 2013-12-15 19:27</p>
</div>
<div class="paragraph">
<p>Currently we have 2 ways to connect to Tigase XMPP Server from web browsers:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>BOSH (Bidirectional-streams Over Synchronous HTTP)</p>
</li>
<li>
<p>WebSocket (XMPP over WebSocket)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>You will find more informations about these ways for connecting to Tigase XMPP Server with some useful tips below.</p>
</div>
<div class="sect2">
<h3 id="_bosh"><a class="anchor" href="#_bosh"></a>87.1. BOSH</h3>
<div class="paragraph">
<p>BOSH protocol specified in <a href="http://xmpp.org/extensions/xep-0124.html">XEP-0124</a> is one of first protocols defined to allow to establish XMPP connection to XMPP servers from web browsers. Due to that this protocol is widely supported and used by many deployments. It is also easy to use in single server mode. It&#8217;s enabled by default in Tigase XMPP Server and available at port 5280.</p>
</div>
<div class="paragraph">
<p>In clustered mode we can deploy it with load balancer deployed with guarantees that each BOSH connection from web browser will be forwarded to same Tigase XMPP Server instance. So in clustered mode if we have two XMPP server t1 and t2 which are hosting domain example.com we would need to have load balancer which will respond for HTTP request to domain example.com and forward all requests from same IP address to same node of a cluster (i.e. all request from 192.168.122.32 should be forwarded always to node t1.</p>
</div>
<div class="sect3">
<h4 id="_tip_1_bosh_in_cluster_mode_without_load_balancer"><a class="anchor" href="#_tip_1_bosh_in_cluster_mode_without_load_balancer"></a>87.1.1. Tip #1 - BOSH in Cluster Mode Without Load Balancer</h4>
<div class="paragraph">
<p>There is also a way to use BOSH without load balancer. In this case XMPP client needs to have more logic and knowledge about all available cluster nodes (with names of nodes which will identify particular cluster nodes from internet). Using this knowledge XMPP client should select one random node from list of available nodes and always establish BOSH connections to this particular node. In case if BOSH connection fails due to network connection issues XMPP client should randomly pick other node from list of rest of available nodes.</p>
</div>
<div class="paragraph">
<p><em>Example:</em></p>
</div>
<div class="paragraph">
<p>We have servers t1.example.com and t2.example.com which are nodes of a cluster hosting domain example.com. Web client retrieves list of cluster nodes from web server and then when it needs to connect to XMPP server it picks random host from list of retrieved cluster nodes (i.e. t2.example.com) and tries to connect using BOSH protocol to host t2.example.com but it should send example.com as name of server to which it tries to connect (example.com should be value of to attribute of XMPP stream.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_websocket"><a class="anchor" href="#_websocket"></a>87.2. WebSocket</h3>
<div class="paragraph">
<p>WebSocket protocol is newly standarized protocol which is supported now by many of current versions of browsers. Currently there is a draft of protocol <a href="https://datatracker.ietf.org/doc/draft-ietf-xmpp-websocket/">draft-ietf-xmpp-websocket-00</a> which describes usage of WebSocket to connect to XMPP server. Tigase XMPP Server implementation of WebSocket protocol to connect to XMPP server is very close to this draft of this specification. By default Tigase XMPP Server has XMPP-over-WebSocket protocol enabled without encryption on port 5290. To use this protocol you need to use library which supports XMPP-ober-WebSocket protocol.</p>
</div>
<div class="sect3">
<h4 id="_tip_1_encrypted_websocket_connection"><a class="anchor" href="#_tip_1_encrypted_websocket_connection"></a>87.2.1. Tip #1 - Encrypted WebSocket Connection</h4>
<div class="paragraph">
<p>It is possible to enable encrypted WebSocket connection in Tigase XMPP Server. To do this you need to add following lines to etc/init.properties config file:</p>
</div>
<div class="paragraph">
<p>ws2s/connections/ports[i]=5290,5291</p>
</div>
<div class="paragraph">
<p>ws2s/connections/5291/socket=ssl</p>
</div>
<div class="paragraph">
<p>ws2s/connections/5291/type=accept</p>
</div>
<div class="paragraph">
<p>In this example we enabled WebSocket endpoint on port 5290 and encrypted WebSocket endpoint on port 5291. Connections on port 5291 are SSL connections which are encapsulating not encrypted WebSocket connections. As this is TLS/SSL connection (no STARTTLS) it uses default certificate installed in Tigase XMPP Server instance. This certificate is located in certs/default.pem.</p>
</div>
</div>
<div class="sect3">
<h4 id="_tip_2_encrypted_websocket_connection_dealing_with_multiple_vhosts"><a class="anchor" href="#_tip_2_encrypted_websocket_connection_dealing_with_multiple_vhosts"></a>87.2.2. Tip #2 - Encrypted WebSocket Connection - Dealing With Multiple VHosts</h4>
<div class="paragraph">
<p>As mentioned in Tip #1 WebSocket endpoint is plain TLS/SSL port, so it always serves default certificate for Tigase XMPP Server instance. It is ok, if we are hosting single domain and if default certificate matches matches our domain. But If we host multiple domain we cannot use wss://example1.com:5291/ connection URI, if our default certificate is for domain example2.com. In this situation it is recomended use default certificate for domain under which server is accessible from internet. This domain should identify this server, so this domain would not point i.e. on two nodes of a cluster. After we deploy separate certificate for each of cluster nodes, we should follow same tip as Tip #1 for BOSH. Our web-based XMPP client should have knowledge about each node of a cluster and when it needs to connect it should randomly select one node from list of available cluster nodes and try to connect to is using connection URL that would contain name of server under which it can be identified from internet.</p>
</div>
<div class="paragraph">
<p><em>Example:</em></p>
</div>
<div class="paragraph">
<p>We have servers t1.example1.com and t2.example1.com which are nodes of a cluster hosting domain example2.com. Each of our nodes contains default SSL certificate which domain matches name of cluster node. Web client retrieves list of cluster nodes from web server and then when it needs to connect to XMPP server it picks random host from list of retrieved cluster nodes (i.e. t2.example1.com) and tries to connect using WebSocket encrypted protocol to host t2.example1.com using following connections URL wss://t2.example1.com:5291/. During connection client should still send example2.com as name of server to which it tries to connect (example2.com should be value of to attribute of XMPP stream. This will allow browser to validate certificate as it will be for the same domain to which browser connects, and it will allow XMPP client to connect to domain example2.com, which is one of hosted vhosts.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-05-14 20:55:07 CEST
</div>
</div>
</body>
</html>