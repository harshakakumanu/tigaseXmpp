<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;69.&nbsp;Tigase Custom Auth Connector</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="index.html" title="Tigase Administration Guide"><link rel="prev" href="_custom_authentication_connectors.html" title="Chapter&nbsp;68.&nbsp;Custom Authentication Connectors"><link rel="next" href="_ldap_authentication_connector.html" title="Chapter&nbsp;70.&nbsp;LDAP Authentication Connector"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;69.&nbsp;Tigase Custom Auth Connector</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_custom_authentication_connectors.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="_ldap_authentication_connector.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_tigase_custom_auth_connector"></a>Chapter&nbsp;69.&nbsp;Tigase Custom Auth Connector</h1></div></div></div><p>Artur Hefczyc &lt;<a class="link" href="mailto:artur.hefczyc@tigase.net" target="_top">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a class="link" href="http://tigase.net" target="_top">http://tigase.net</a>
:Date: 2010-04-06 21:18</p><p>The Tigase Custom Auth connector with shortcut name: <span class="strong"><strong>tigase-custom</strong></span> is implemented in the class: <a class="link" href="http://projects.tigase.org/server/trac/browser/trunk/src/main/java/tigase/db/jdbc/TigaseCustomAuth.java" target="_top">tigase.db.jdbc.TigaseCustomAuth</a>. It allows you to connect to any external database to perform user authentication and use a custom queries for all actions..</p><p>You can find more details how to setup a custom connector in ////&lt;&lt;customAuthentication,////Custom Authentication Connectors guide.</p><p>The basic configuration is very simple:</p><pre class="programlisting">--auth-db = tigase-custom
--auth-db-uri = jdbc:mysql://localhost/drupal?user=user&amp;password=passwd</pre><p>That&#8217;s it.</p><p>The connector loads correctly and starts working using predefined, default list of queries. In most cases you also want to define your own queries in the configuration file. The shortest possible description is the following example of the content from ////&lt;&lt;initPropertiesGuide,////init.properties file:</p><pre class="programlisting"># This query is used to check connection to the database, whether it is still alive or not
basic-conf/auth-repo-params/conn-valid-query=select 1

# This is database initialization query, normally we do not use it, especially in
# clustered environment
basic-conf/auth-repo-params/init-db-query=update tig_users set online_status = 0

# Below query performs user authentication on the database level.
# The Tigase server does not need to know authentication algorithm or password
# encoding type, it simply passes user id (BareJID) and password in form
# which was received from the client, to the stored procedure. If the
# authentication was successful the procedure returns user bare JID or null otherwise.
# The Tigase checks whether the JID returned from the query matches
# JID passed as a parameter. If they match, the authentication is successful.
basic-conf/auth-repo-params/user-login-query={ call TigUserLoginPlainPw(?, ?) }

# Below query returns number of user accounts in the database, this is mainly used
# for the server metrics and monitoring components.
basic-conf/auth-repo-params/users-count-query={ call TigAllUsersCount() }

# Below query is used to add a new user account to the database
basic-conf/auth-repo-params/add-user-query={ call TigAddUserPlainPw(?, ?) }

# Below query is used to remove existing account with all user's data from the database
basic-conf/auth-repo-params/del-user-query={ call TigRemoveUser(?) }

# This query is used for the user authentication if "user-login-query" is not defined,
# that is if there is no database level user authentication algorithm available. In such
# a case the Tigase server loads user's password from the database and compares it
# with data received from the client.
basic-conf/auth-repo-params/get-password-query=select user_pw from tig_users where user_id = ?

# Below query is used for user password update in case user decides to change his password
basic-conf/auth-repo-params/update-password-query=update tig_users set user_pw = ? where user_id = ?

# Below query is called on user logout event. Usually we use a stored procedure which
# records user logout time and marks user as offline in the database
basic-conf/auth-repo-params/user-logout-query=update tig_users, set online_status = online_status - 1 where user_id = ?

# This is configuration setting to specify what non-sasl authentication mechanisms
# expose to the client
basic-conf/auth-repo-params/non-sasl-mechs=password,digest

# This is configuration setting to specify what sasl authentication mechanisms expose to the client
basic-conf/auth-repo-params/sasl-mechs=PLAIN,DIGEST-MD5</pre><p>Queries are defined in the configuration file and they can be either plain SQL queries or stored procedures. If the query starts with characters: '\{ call' then the server assumes this is a stored procedure call, otherwise it is executed as a plain SQL query. Each configuration value is stripped from white characters on both ends before processing.</p><p>Please don&#8217;t use semicolon ';' at the end of the query as many JDBC drivers get confused and the query may not work for unknown reason.</p><p>Some queries take arguments. Arguments are marked by question marks '?' in the query. Refer to the configuration parameters description for more details about what parameters are expected in each query.</p><p>The first example shows how to put a stored procedure as a query with 2 required parameters.</p><pre class="programlisting">add-user-query={ call TigAddUserPlainPw(?, ?) }</pre><p>The same query with plain SQL parameters instead:</p><pre class="programlisting">add-user-query=insert into users (user_id, password) values (?, ?)</pre><p>The order of the query arguments is important and must be exactly as described in specification for each parameter.</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p class="simpara">'conn-valid-query' - Query executing periodically to ensure active connection with the database.</p><p class="simpara">Takes no arguments.</p><p class="simpara">Example query: 'select 1'</p></li><li class="listitem"><p class="simpara">'init-db-query' - Database initialization query which is run after the server is started.</p><p class="simpara">Takes no arguments.</p><p class="simpara">Example query: 'update tig_users set online_status = 0'</p></li><li class="listitem"><p class="simpara">'add-user-query' - Query adding a new user to the database.</p><p class="simpara">Takes 2 arguments: (user_id (JID), password)</p><p class="simpara">Example query: 'insert into tig_users (user_id, user_pw) values (?, ?)'</p></li><li class="listitem"><p class="simpara">'del-user-query' - Removes a user from the database.</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'delete from tig_users where user_id = ?'</p></li><li class="listitem"><p class="simpara">'get-password-query' - Rertieves user password from the database for given user_id (JID).</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'select user_pw from tig_users where user_id = ?'</p></li><li class="listitem"><p class="simpara">'update-password-query' - Updates (changes) password for a given user_id (JID).</p><p class="simpara">Takes 2 arguments: (password, user_id (JID))</p><p class="simpara">Example query: 'update tig_users set user_pw = ? where user_id = ?'</p></li><li class="listitem"><p class="simpara">'user-login-query' - Performs user login. Normally used when there is a special SP used for this purpose. This is an alternative way to a method requiring retrieving user password. Therefore at least one of those queries must be defined: user-login-query or get-password-query.</p><p class="simpara">If both queries are defined then user-login-query is used. Normally this method should be only used with plain text password authentication or sasl-plain.</p><p class="simpara">The Tigase server expects a result set with user_id to be returned from the query if login is successful and empty results set if the login is unsuccessful.</p><p class="simpara">Takes 2 arguments: (user_id (JID), password)</p><p class="simpara">Example query: 'select user_id from tig_users where (user_id = ?) AND (user_pw = ?)'</p></li><li class="listitem"><p class="simpara">'user-logout-query' - This query is called when user logs out or disconnects. It can record that event in the database.</p><p class="simpara">Takes 1 argument: (user_id (JID))</p><p class="simpara">Example query: 'update tig_users, set online_status = online_status - 1 where user_id = ?'</p></li><li class="listitem">'non-sasl-mechs' - Comma separated list of NON-SASL authentication mechanisms. Possible mechanisms are: password and digest. digest mechanism can work only with get-password-query active and only when password are stored in plain text format in the database.</li><li class="listitem"><p class="simpara">'sasl-mechs' - Comma separated list of SASL authentication mechanisms. Possible mechanisms are all mechanisms supported by Java implementation. The most common are: PLAIN, DIGEST-MD5, CRAM-MD5.</p><p class="simpara">"Non-PLAIN" mechanisms will work only with the get-password-query active and only when passwords are stored in plain text format in the database.   Application: Tigase Server</p></li></ul></div></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_custom_authentication_connectors.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="_ldap_authentication_connector.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;68.&nbsp;Custom Authentication Connectors&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;70.&nbsp;LDAP Authentication Connector</td></tr></table></div></body></html>