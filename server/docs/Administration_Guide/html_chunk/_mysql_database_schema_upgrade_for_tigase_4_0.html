<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Chapter&nbsp;57.&nbsp;MySQL Database Schema Upgrade for Tigase 4.0</title><link rel="stylesheet" type="text/css" href="css/docbook-xsl.css"><meta name="generator" content="DocBook XSL Stylesheets V1.78.1"><link rel="home" href="index.html" title="Tigase Administration Guide"><link rel="up" href="index.html" title="Tigase Administration Guide"><link rel="prev" href="_tigase_server_version_4_x.html" title="Chapter&nbsp;56.&nbsp;Tigase Server Version 4.x"><link rel="next" href="_virtual_components_for_the_cluster_mode.html" title="Chapter&nbsp;58.&nbsp;Virtual Components for the Cluster Mode"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">Chapter&nbsp;57.&nbsp;MySQL Database Schema Upgrade for Tigase 4.0</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="_tigase_server_version_4_x.html">Prev</a>&nbsp;</td><th width="60%" align="center">&nbsp;</th><td width="20%" align="right">&nbsp;<a accesskey="n" href="_virtual_components_for_the_cluster_mode.html">Next</a></td></tr></table><hr></div><div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a name="_mysql_database_schema_upgrade_for_tigase_4_0"></a>Chapter&nbsp;57.&nbsp;MySQL Database Schema Upgrade for Tigase 4.0</h1></div></div></div><p>Artur Hefczyc &lt;<a class="link" href="mailto:artur.hefczyc@tigase.net" target="_top">artur.hefczyc@tigase.net</a>&gt;
v2.0, June 2014: Reformatted for AsciiDoc.
:toc:
:numbered:
:website: <a class="link" href="http://tigase.net" target="_top">http://tigase.net</a>
:Date: 2010-01-06 20:18</p><p>For number of reasons the database schema had to be changed for Tigase server version 4.0. The most important are:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">Compliance with the XMPP RFC which says that each part of JID may have up to 1023 characters. We store in the database user JIDs without resource name thus the maximum possible size of the user id is 2047. There aren&#8217;t really JIDs that long yet but we experienced quite long JIDs in a few installations already so we decided to prepare Tigase to accept any JID allowed by RFC.</li><li class="listitem">Performance and flexibility -  the Tigase server now accesses database using stored procedures. This allows for any database storage format and it doesn&#8217;t really matter for the Tigase server what is the database schema how data is organized inside. What it needs is just bunch of stored procedures to access the data. This allows for much more flexibility in storing user data as well as much easier integration with third-party systems and also organize data in more efficient way.</li></ul></div><p>Therefore when you run the Tigase server now it may (depending on what exact SVN revision you use) refuse to start if it detects that the database schema is not updated. If it happens just follow steps below to update the database schema and start the server again.  Updating of the database schema is very easy and almost fully automated process. Just follow the steps below and you should be able to run new version of the Tigase server in a few minutes or even seconds depending on your database size. It takes around 7 minutes to update database with 200k user accounts on an average machine.</p><p><span class="strong"><strong>Note. Do not update the database schema before the Tigase server tells you to do so. And do a database backup before starting the schema update.</strong></span></p><p><span class="emphasis"><em>Please note. I have done a few schema upgrades already in a different configurations and here are a few tips which might be useful if something goes wrong:</em></span></p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><span class="strong"><strong>You really, really have to do the DB backup (database dump) before upgrading.</strong></span> <span class="emphasis"><em>If you don&#8217;t you might not be able to revert database on your own. Contact me in case of problems.</em></span></li><li class="listitem"><span class="emphasis"><em>In case of error:</em></span> <span class="strong"><strong>ERROR 1419 (HY000) at line 31 in file: 'database/mysql-schema-4-sp.schema': You do not have the SUPER privilege and binary logging is enabled (you *might</strong></span> want to use the less safe log_bin_trust_function_creators variable)* <span class="emphasis"><em>Restore the database following description found below and run the update again as MySQL super user.</em></span></li><li class="listitem"><p class="simpara"><span class="emphasis"><em>The following error may manifest itself in many ways from the NullPointerException in the Tigase server log file to message like this:</em></span> <span class="strong"><strong>User does not have access to metadata required to determine stored procedure parameter types. If rights can not be granted, configure connection with "noAccessToProcedureBodies=true" to have driver generate parameters that represent INOUT strings irregardless of actual parameter types.</strong></span> <span class="emphasis"><em>The best solution to this is to grant proper permissions to this user. Enter the MySQL command line mode as MySQL super user:</em></span></p><pre class="programlisting">$ mysql -u root -proot_passwd mysql
mysql&gt; GRANT SELECT, INSERT, UPDATE ON \`mysql\`.\`proc\` TO 'tigase_user'@'localhost';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON \`mysql\`.\`proc\` TO 'tigase_user'@'%';
mysql&gt; GRANT SELECT, INSERT, UPDATE ON \`mysql\`.\`proc\` TO 'tigase_user';
mysql&gt; FLUSH PRIVILEGES;
$</pre></li></ol></div><p>Assumptions:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><span class="strong"><strong>tigasedb</strong></span> is a database name</li><li class="listitem"><span class="strong"><strong>tigase_user</strong></span> is a database user name</li><li class="listitem"><span class="strong"><strong>mypass</strong></span> is database user password</li></ol></div><p>First things first - make a database backup:</p><pre class="programlisting">mysqldump -u tigase_user -pmypass tigasedb &gt; tigasedb_dump.sql</pre><p>If you need to restore database for any reason execute following commands:</p><pre class="programlisting">msyqladmin -u tigase_user -pmypass drop tigasedb
mysqladmin -u tigase_user -pmypass create tigasedb
mysql -u tigase_user -pmypass tigasedb &lt; tigasedb_dump.sql</pre><p><span class="emphasis"><em>Note! You may be required to use</em></span> <span class="strong"><strong>root</strong></span> <span class="emphasis"><em>user and his password to execute mysqladmin commands.  Ok we have the database backup and we know how to restore it. Now we can run schema upgrade script:</em></span></p><pre class="programlisting">mysql -u tigase_user -pmypass tigasedb &lt; database/mysql-schema-upgrade-to-4.sql</pre><p><span class="emphasis"><em>The script should generate output like this:</em></span></p><pre class="programlisting">Droping index for user_id column
Resizing user_id column to 2049 characters to comply with RFC
Creating a new index for user_id column for first 765 bytes of the field
Adding sha1_user_id column
Adding user_pw column
Adding last_login column
Adding last_logout column
Adding online_status column
Adding failed_logins column
Adding account_status column
Creating a new index for user_pw column
Creating a new index for last_login column
Creating a new index for last_logout column
Creating a new index for account_status column
Creating a new index for online_status column
Resizing node column to 255 characters
Changing pval column type to mediumtext
Loading stored procedures definitions
Setting passwords encoding in the database
Converting database to a new format
Creating a new index for sha1_user_id column
Setting schema version to 4.0
All done, database ready to use!</pre></div><div class="navfooter"><hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="_tigase_server_version_4_x.html">Prev</a>&nbsp;</td><td width="20%" align="center">&nbsp;</td><td width="40%" align="right">&nbsp;<a accesskey="n" href="_virtual_components_for_the_cluster_mode.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Chapter&nbsp;56.&nbsp;Tigase Server Version 4.x&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;58.&nbsp;Virtual Components for the Cluster Mode</td></tr></table></div></body></html>